<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper plugin-docs plugin-id-default docs-version-current docs-doc-page docs-doc-id-source_content/design" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.8.1">
<title data-rh="true">design | EmpowerNow Docs</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://empowerid.github.io/empowernow_docs/img/empowernow-logo.svg"><meta data-rh="true" name="twitter:image" content="https://empowerid.github.io/empowernow_docs/img/empowernow-logo.svg"><meta data-rh="true" property="og:url" content="https://empowerid.github.io/empowernow_docs/docs/source_content/design"><meta data-rh="true" property="og:locale" content="en"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="design | EmpowerNow Docs"><meta data-rh="true" name="description" content="---"><meta data-rh="true" property="og:description" content="---"><link data-rh="true" rel="icon" href="/empowernow_docs/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://empowerid.github.io/empowernow_docs/docs/source_content/design"><link data-rh="true" rel="alternate" href="https://empowerid.github.io/empowernow_docs/docs/source_content/design" hreflang="en"><link data-rh="true" rel="alternate" href="https://empowerid.github.io/empowernow_docs/docs/source_content/design" hreflang="x-default"><link rel="stylesheet" href="/empowernow_docs/assets/css/styles.b212d4ba.css">
<script src="/empowernow_docs/assets/js/runtime~main.b7e4b38b.js" defer="defer"></script>
<script src="/empowernow_docs/assets/js/main.288af713.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<svg xmlns="http://www.w3.org/2000/svg" style="display: none;"><defs>
<symbol id="theme-svg-external-link" viewBox="0 0 24 24"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"/></symbol>
</defs></svg>
<script>!function(){var t="dark";var e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return window.localStorage.getItem("theme")}catch(t){}}();document.documentElement.setAttribute("data-theme",e||t),document.documentElement.setAttribute("data-theme-choice",e||t)}(),function(){try{const c=new URLSearchParams(window.location.search).entries();for(var[t,e]of c)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><link rel="preload" as="image" href="/empowernow_docs/img/en-logo-light.png"><link rel="preload" as="image" href="/empowernow_docs/img/en-logo-dark.png"><div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="theme-layout-navbar navbar navbar--fixed-top"><div class="navbar__inner"><div class="theme-layout-navbar-left navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/empowernow_docs/"><div class="navbar__logo"><img src="/empowernow_docs/img/en-logo-light.png" alt="EmpowerNow Logo" class="themedComponent_mlkZ themedComponent--light_NVdE"><img src="/empowernow_docs/img/en-logo-dark.png" alt="EmpowerNow Logo" class="themedComponent_mlkZ themedComponent--dark_xIcU"></div><b class="navbar__title text--truncate"></b></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/empowernow_docs/">Home</a><a class="navbar__item navbar__link" href="/empowernow_docs/docs/website_copy/solutions">Solutions</a><a class="navbar__item navbar__link" href="/empowernow_docs/docs/website_copy/products">Products</a><a class="navbar__item navbar__link" href="/empowernow_docs/docs/website_copy/pricing">Pricing</a><a class="navbar__item navbar__link" href="/empowernow_docs/docs/website_copy/trust">Trust</a><a class="navbar__item navbar__link" href="/empowernow_docs/docs/website_copy/resources">Resources</a><a class="navbar__item navbar__link" href="/empowernow_docs/docs/website_copy/company">Company</a><a class="navbar__item navbar__link" href="/empowernow_docs/docs/intro">Docs</a><a class="navbar__item navbar__link" href="/empowernow_docs/docs/services/crud-service/explanation/secrets-executive-overview">Secrets Overview</a><a class="navbar__item navbar__link" href="/empowernow_docs/docs/services/bff/explanation/executive-overview">BFF Overview</a><a class="navbar__item navbar__link" href="/empowernow_docs/docs/services/bff/explanation/bff-visual-guide">BFF Visual Guide</a></div><div class="theme-layout-navbar-right navbar__items navbar__items--right"><a href="https://github.com/empowerID/empowernow_docs" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a><div class="navbarSearchContainer_Bca1"><div class="navbar__search searchBarContainer_NW3z" dir="ltr"><input placeholder="Search" aria-label="Search" class="navbar__search-input searchInput_YFbd" value=""><div class="loadingRing_RJI3 searchBarLoadingRing_YnHq"><div></div><div></div><div></div><div></div></div></div></div><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="system mode" aria-label="Switch between dark and light mode (currently system mode)"><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_g3eP lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_g3eP darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_g3eP systemToggleIcon_QzmC"><path fill="currentColor" d="m12 21c4.971 0 9-4.029 9-9s-4.029-9-9-9-9 4.029-9 9 4.029 9 9 9zm4.95-13.95c1.313 1.313 2.05 3.093 2.05 4.95s-0.738 3.637-2.05 4.95c-1.313 1.313-3.093 2.05-4.95 2.05v-14c1.857 0 3.637 0.737 4.95 2.05z"></path></svg></button></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="theme-layout-main main-wrapper mainWrapper_z2l0"><div class="docsWrapper_hBAB"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docRoot_UBD9"><main class="docMainContainer_TBSr docMainContainerEnhanced_lQrH"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>design</h1></header><hr>
<h1>LDAP VDS — Implementation Spec v2 (incorporating protocol &amp; paging fixes)</h1>
<p>See also: <a href="/empowernow_docs/docs/source_content/virtualization_phase2">Virtualization Phase 2 — Data Shaping, Merging, and Projection</a> for merge rules, projection profiles, PDP attribute gating, and aggregator behavior.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="what-changed-since-v1-delta">What changed since v1 (delta)<a href="#what-changed-since-v1-delta" class="hash-link" aria-label="Direct link to What changed since v1 (delta)" title="Direct link to What changed since v1 (delta)">​</a></h2>
<ul>
<li><strong>Framing</strong>: robust per-connection BER reader using a growable buffer; handles partial/combined PDUs; catches <code>SubstrateUnderrunError</code>.</li>
<li><strong>Unknown ops</strong>: reply with <strong>Unsolicited Notice of Disconnection</strong> (OID <code>1.3.6.1.4.1.1466.20036</code>) and close; <strong>don’t</strong> send a BindResponse.</li>
<li><strong>RFC 2696 semantics</strong>: <strong>bad/expired cookie → <code>unwillingToPerform (53)</code></strong> and include a <strong>paged response control with empty cookie</strong>.</li>
<li><strong>Paging state</strong>: cookie now carries a <strong>stable composite cursor</strong> (from the aggregator) + <strong>global deterministic order</strong> (e.g., <code>subject</code> asc). Offset-only removed.</li>
<li><strong>Filter &amp; attr allowlist</strong>: <strong>single source of truth in YAML</strong>; translator reads it (no hardcoded <code>ALLOWED_ATTRS</code>).</li>
<li><strong>Matching rules</strong>: define and implement <strong>caseIgnore</strong> behavior for <code>uid/cn/mail</code> in equality/substring; explicit normalization rules documented.</li>
<li><strong>Controls</strong>: verify <code>criticality</code>; unknown <strong>critical</strong> control → <code>unavailableCriticalExtension (12)</code>.</li>
<li><strong>Backpressure</strong>: bounded async send-queue, <code>writer.drain()</code> with timeout, and graceful close on overflow.</li>
<li><strong>TLS policy</strong>: <strong>LDAPS-only in v1</strong> (StartTLS off) to avoid mid-stream state switches; minimum TLS version/ciphers set. SASL/EXTERNAL clarified (SAN precedence over CN).</li>
<li><strong>Client IP</strong>: trust boundary defined; support <strong>PROXY protocol v2</strong> (preferred) or explicit <code>X-Forwarded-For</code> when terminating upstream.</li>
<li><strong>Cookie HMAC rotation</strong>: cookie now carries a <code>kid</code>; verifier tries new+old secrets for a window.</li>
<li><strong>Single-flight</strong>: Redis <strong>Lua</strong> lock (TTL+jitter) to collapse stampedes; losers backoff/poll cache.</li>
<li><strong>DN normalization</strong>: RFC 4514 escaping + <strong>canonical case</strong> policy for RDN attributes to prevent duplicates across case variants.</li>
<li><strong>uvloop</strong>: optional; clean Windows fallback.</li>
</ul>
<hr>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="1-repository-unchanged-layout-noted-deltas">1) Repository (unchanged layout, noted deltas)<a href="#1-repository-unchanged-layout-noted-deltas" class="hash-link" aria-label="Direct link to 1) Repository (unchanged layout, noted deltas)" title="Direct link to 1) Repository (unchanged layout, noted deltas)">​</a></h2>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">vds/</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  server/</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    listener.py          # LDAPS only (v1), PROXY v2 optional</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    protocol.py          # PDU reader (buffered), dispatcher, backpressure</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    encoder.py           # Bind/Search encoders + Unsolicited Notice</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    controls.py          # RFC 2696 encode/decode (criticality checks)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    errors.py            # strict LDAP result mapping</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    session.py           # tenant + subject, cert → subject mapping</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  ldap/</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    filter_ast.py</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    filter_from_asn1.py  # reads YAML allowlist</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    filter_to_query.py   # caseIgnore normalization rules</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    dn.py                # RFC 4514 escaping + canonicalization</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  dsl/</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    mapping_loader.py    # YAML (objects/filters/limits)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    mapping_eval.py      # JSONPath + pure builtins (no templates)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  exec/</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    search_executor.py   # cursor paging, cookie HMAC(kid), PDP allowlist</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    directory_aggregator.py # merges provider pages with deterministic order</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    group_resolver.py</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    planner.py           # (optional) selectivity hints</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  connectors/</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    base.py              # Provider interface + cursor types</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    ldap_provider.py     # RFC 2696 client, optional server-side sort</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    rest_provider.py     # httpx client with provider token paging</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    sql_provider.py      # keyset pagination (ORDER BY lower(subject), id)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  deps/</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    redis_cache.py       # JSON, Lua single-flight</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    pdp.py</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    audit.py</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    ratelimit.py</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    breaker.py</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  utils/</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    paging_cookie.py     # HMAC(kid) sign/verify (dual keys)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    ids.py</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    fips.py</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  observability/</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    metrics.py           # low-card labels</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    tracing.py</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">tests/</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  # add: paging-invalid-cookie, unsolicited-disconnect, proxy-v2, caseIgnore equality</span><br></span></code></pre></div></div>
<hr>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="2-protocol-robust-pdu-framing-unknown-ops-backpressure">2) Protocol: robust PDU framing, unknown ops, backpressure<a href="#2-protocol-robust-pdu-framing-unknown-ops-backpressure" class="hash-link" aria-label="Direct link to 2) Protocol: robust PDU framing, unknown ops, backpressure" title="Direct link to 2) Protocol: robust PDU framing, unknown ops, backpressure">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="pdu-reader-per-connection-buffer">PDU reader (per-connection buffer)<a href="#pdu-reader-per-connection-buffer" class="hash-link" aria-label="Direct link to PDU reader (per-connection buffer)" title="Direct link to PDU reader (per-connection buffer)">​</a></h3>
<div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token comment" style="color:rgb(98, 114, 164)"># server/protocol.py (excerpt)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">from</span><span class="token plain"> pyasn1</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">codec</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">ber </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">import</span><span class="token plain"> decoder</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> encoder</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">from</span><span class="token plain"> pyasn1</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">error </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">import</span><span class="token plain"> SubstrateUnderrunError</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">from</span><span class="token plain"> pyasn1_modules </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">import</span><span class="token plain"> rfc4511</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">from</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">encoder </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">import</span><span class="token plain"> unsolicited_notice</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">class</span><span class="token plain"> </span><span class="token class-name">LDAPConnection</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">def</span><span class="token plain"> </span><span class="token function" style="color:rgb(80, 250, 123)">__init__</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        self</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">_buf </span><span class="token operator">=</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(189, 147, 249)">bytearray</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        self</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">_send_q </span><span class="token operator">=</span><span class="token plain"> asyncio</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">Queue</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">maxsize</span><span class="token operator">=</span><span class="token plain">self</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">deps</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">cfg</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">server</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">max_send_queue_items</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain">  </span><span class="token comment" style="color:rgb(98, 114, 164)"># backpressure</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        self</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">_sender_task </span><span class="token operator">=</span><span class="token plain"> asyncio</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">create_task</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">self</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">_sender</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">async</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">def</span><span class="token plain"> </span><span class="token function" style="color:rgb(80, 250, 123)">_read_message</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">self</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">while</span><span class="token plain"> </span><span class="token boolean">True</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">if</span><span class="token plain"> self</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">_buf</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">try</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                    msg</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> rest </span><span class="token operator">=</span><span class="token plain"> decoder</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">decode</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token builtin" style="color:rgb(189, 147, 249)">bytes</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">self</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">_buf</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> asn1Spec</span><span class="token operator">=</span><span class="token plain">rfc4511</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">LDAPMessage</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                    self</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">_buf </span><span class="token operator">=</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(189, 147, 249)">bytearray</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">rest</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                    </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">return</span><span class="token plain"> msg</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">except</span><span class="token plain"> SubstrateUnderrunError</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                    </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">pass</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            chunk </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">await</span><span class="token plain"> self</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">r</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">read</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">self</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">deps</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">cfg</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">server</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">read_chunk</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">if</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">not</span><span class="token plain"> chunk</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">return</span><span class="token plain"> </span><span class="token boolean">None</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            self</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">_buf</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">extend</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">chunk</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">async</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">def</span><span class="token plain"> </span><span class="token function" style="color:rgb(80, 250, 123)">_sender</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">self</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">try</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">while</span><span class="token plain"> </span><span class="token boolean">True</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                data </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">await</span><span class="token plain"> self</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">_send_q</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">get</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                self</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">w</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">write</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">data</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">await</span><span class="token plain"> asyncio</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">wait_for</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">self</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">w</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">drain</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> timeout</span><span class="token operator">=</span><span class="token plain">self</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">deps</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">cfg</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">server</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">drain_timeout_s</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">except</span><span class="token plain"> asyncio</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">TimeoutError</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">await</span><span class="token plain"> self</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">_send</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">unsolicited_notice</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token number">2</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;protocolError: drain timeout&quot;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            self</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">w</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">close</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">except</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">asyncio</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">CancelledError</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> ConnectionError</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">pass</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">async</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">def</span><span class="token plain"> </span><span class="token function" style="color:rgb(80, 250, 123)">_send</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">self</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> ldap_msg</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        data </span><span class="token operator">=</span><span class="token plain"> encoder</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">encode</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">ldap_msg</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">try</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            self</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">_send_q</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">put_nowait</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">data</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">except</span><span class="token plain"> asyncio</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">QueueFull</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token comment" style="color:rgb(98, 114, 164)"># On overflow, bypass queue to avoid recursion, write notice directly</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            notice </span><span class="token operator">=</span><span class="token plain"> encoder</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">encode</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">unsolicited_notice</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token number">2</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;protocolError: send queue overflow&quot;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            self</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">w</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">write</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">notice</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">with</span><span class="token plain"> contextlib</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">suppress</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">Exception</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">await</span><span class="token plain"> asyncio</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">wait_for</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">self</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">w</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">drain</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> timeout</span><span class="token operator">=</span><span class="token plain">self</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">deps</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">cfg</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">server</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">drain_timeout_s</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            self</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">w</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">close</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><br></span></code></pre></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="unknown-ops--notice-of-disconnection">Unknown ops → Notice of Disconnection<a href="#unknown-ops--notice-of-disconnection" class="hash-link" aria-label="Direct link to Unknown ops → Notice of Disconnection" title="Direct link to Unknown ops → Notice of Disconnection">​</a></h3>
<div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token comment" style="color:rgb(98, 114, 164)"># server/encoder.py (new util)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">from</span><span class="token plain"> pyasn1_modules </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">import</span><span class="token plain"> rfc4511</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">NOTICE_OID </span><span class="token operator">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&#x27;1.3.6.1.4.1.1466.20036&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">def</span><span class="token plain"> </span><span class="token function" style="color:rgb(80, 250, 123)">unsolicited_notice</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">result_code</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(189, 147, 249)">int</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> diag</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(189, 147, 249)">str</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token plain"> rfc4511</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">LDAPMessage</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    msg </span><span class="token operator">=</span><span class="token plain"> rfc4511</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">LDAPMessage</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    msg</span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token string" style="color:rgb(255, 121, 198)">&#x27;messageID&#x27;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token number">0</span><span class="token plain">  </span><span class="token comment" style="color:rgb(98, 114, 164)"># unsolicited</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    ext </span><span class="token operator">=</span><span class="token plain"> rfc4511</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">ExtendedResponse</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    ext</span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token string" style="color:rgb(255, 121, 198)">&#x27;resultCode&#x27;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> result_code</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    ext</span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token string" style="color:rgb(255, 121, 198)">&#x27;diagnosticMessage&#x27;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> diag</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    ext</span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token string" style="color:rgb(255, 121, 198)">&#x27;responseName&#x27;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> rfc4511</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">LDAPOID</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">NOTICE_OID</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    msg</span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token string" style="color:rgb(255, 121, 198)">&#x27;protocolOp&#x27;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> rfc4511</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">LDAPMessage_protocolOp</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">setComponentByName</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token string" style="color:rgb(255, 121, 198)">&#x27;extendedResp&#x27;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> ext</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">return</span><span class="token plain"> msg</span><br></span></code></pre></div></div>
<p>Usage on unknown op:</p>
<div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">await</span><span class="token plain"> self</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">_send</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">unsolicited_notice</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token number">2</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;protocolError: unsupported operation&quot;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">self</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">w</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">close</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><br></span></code></pre></div></div>
<hr>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="3-controls-rfc-2696--invalid-cookie-semantics">3) Controls (RFC 2696) + invalid-cookie semantics<a href="#3-controls-rfc-2696--invalid-cookie-semantics" class="hash-link" aria-label="Direct link to 3) Controls (RFC 2696) + invalid-cookie semantics" title="Direct link to 3) Controls (RFC 2696) + invalid-cookie semantics">​</a></h2>
<ul>
<li>Parse request controls, verify <code>criticality</code>.</li>
<li>If <strong>unknown critical</strong> control → <code>unavailableCriticalExtension (12)</code> response.</li>
<li><strong>Invalid/expired cookie → <code>unwillingToPerform (53)</code></strong> and include <strong>paged response control with empty cookie</strong>.</li>
</ul>
<div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token comment" style="color:rgb(98, 114, 164)"># server/controls.py (excerpt)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">from</span><span class="token plain"> pyasn1</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">codec</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">ber </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">import</span><span class="token plain"> decoder</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">from</span><span class="token plain"> pyasn1_modules</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">rfc2696 </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">import</span><span class="token plain"> PagedResultsRequestValue</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> PagedResultsResponseValue</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">def</span><span class="token plain"> </span><span class="token function" style="color:rgb(80, 250, 123)">parse_paged_req</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">controls</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    size</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> cookie</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> critical </span><span class="token operator">=</span><span class="token plain"> </span><span class="token boolean">None</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token boolean">None</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token boolean">False</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">if</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">not</span><span class="token plain"> controls</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">return</span><span class="token plain"> size</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> cookie</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> critical</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">for</span><span class="token plain"> ctl </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">in</span><span class="token plain"> controls</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">if</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(189, 147, 249)">str</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">ctl</span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token string" style="color:rgb(255, 121, 198)">&#x27;controlType&#x27;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token operator">==</span><span class="token plain"> PAGED_OID</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            critical </span><span class="token operator">=</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(189, 147, 249)">bool</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">ctl</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">getComponentByName</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token string" style="color:rgb(255, 121, 198)">&#x27;criticality&#x27;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            val </span><span class="token operator">=</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(189, 147, 249)">bytes</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">ctl</span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token string" style="color:rgb(255, 121, 198)">&#x27;controlValue&#x27;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            seq</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> _ </span><span class="token operator">=</span><span class="token plain"> decoder</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">decode</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">val</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> asn1Spec</span><span class="token operator">=</span><span class="token plain">PagedResultsRequestValue</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            size </span><span class="token operator">=</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(189, 147, 249)">int</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">seq</span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token string" style="color:rgb(255, 121, 198)">&#x27;size&#x27;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"> cookie </span><span class="token operator">=</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(189, 147, 249)">bytes</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">seq</span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token string" style="color:rgb(255, 121, 198)">&#x27;cookie&#x27;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">or</span><span class="token plain"> </span><span class="token boolean">None</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">else</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">if</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(189, 147, 249)">bool</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">ctl</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">getComponentByName</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token string" style="color:rgb(255, 121, 198)">&#x27;criticality&#x27;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">raise</span><span class="token plain"> LdapError</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token number">12</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;unavailableCriticalExtension&quot;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">return</span><span class="token plain"> size</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> cookie</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> critical</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)">### AbandonRequest (RFC 4511 §4.11)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token operator">*</span><span class="token plain"> Track `messageID → task` </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">for</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">in</span><span class="token operator">-</span><span class="token plain">flight ops</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain"> On Abandon</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> cancel the task </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">and</span><span class="token plain"> stop emitting entries</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain"> No response </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">is</span><span class="token plain"> sent </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">for</span><span class="token plain"> Abandon</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span></code></pre></div></div>
<p>On invalid cookie:</p>
<div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">if</span><span class="token plain"> cookie </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">and</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">not</span><span class="token plain"> state</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    done </span><span class="token operator">=</span><span class="token plain"> search_done</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">mid</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token number">53</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;invalid paging cookie&quot;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> controls</span><span class="token operator">=</span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token plain">make_paged_resp</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token boolean">None</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">await</span><span class="token plain"> self</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">_send</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">done</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">return</span><br></span></code></pre></div></div>
<hr>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="4-paging-state-aggregator--deterministic-order">4) Paging state: aggregator + deterministic order<a href="#4-paging-state-aggregator--deterministic-order" class="hash-link" aria-label="Direct link to 4) Paging state: aggregator + deterministic order" title="Direct link to 4) Paging state: aggregator + deterministic order">​</a></h2>
<ul>
<li>
<p><strong>Aggregator</strong> merges N provider streams with a global order:</p>
<ul>
<li><strong>Total ordering key</strong>: <code>subject.casefold()</code> asc, tiebreak on stable per-source id</li>
<li><strong>Composite cursor</strong>: <code>{ subject_cf, source_offsets: { &lt;sourceId&gt;: { cookie|token|last_key } } }</code></li>
<li>Connector contracts:<!-- -->
<ul>
<li>LDAP: RFC 2696 cookie (or keyset fallback)</li>
<li>REST: provider next-page token</li>
<li>SQL/ODBC: keyset (<code>last subject_cf</code>, <code>last id</code>)</li>
</ul>
</li>
</ul>
</li>
<li>
<p><strong>Cookie contents</strong> (signed, rotated):
<code>{&quot;kid&quot;:&quot;2025-08&quot;,&quot;tenant&quot;:&quot;t1&quot;,&quot;q&quot;:&quot;&lt;qhash&gt;&quot;,&quot;cur&quot;:&lt;composite_cursor&gt;,&quot;v&quot;:&lt;mapping_version&gt;}</code></p>
</li>
</ul>
<div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token comment" style="color:rgb(98, 114, 164)"># utils/paging_cookie.py (rotation)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">KMS </span><span class="token operator">=</span><span class="token plain"> KeyRing</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">primary</span><span class="token operator">=</span><span class="token plain">K_NEW</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> previous</span><span class="token operator">=</span><span class="token plain">K_OLD</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">def</span><span class="token plain"> </span><span class="token function" style="color:rgb(80, 250, 123)">sign_cookie</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">state</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    envelope </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token string" style="color:rgb(255, 121, 198)">&quot;kid&quot;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> KMS</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">primary</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token builtin" style="color:rgb(189, 147, 249)">id</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;state&quot;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> state</span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    body </span><span class="token operator">=</span><span class="token plain"> json</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">dumps</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">envelope</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> separators</span><span class="token operator">=</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token string" style="color:rgb(255, 121, 198)">&#x27;,&#x27;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token string" style="color:rgb(255, 121, 198)">&#x27;:&#x27;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> sort_keys</span><span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">encode</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    mac </span><span class="token operator">=</span><span class="token plain"> hmac</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">new</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">KMS</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">primary</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">key</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> body</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> hashlib</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">sha256</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">digest</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">return</span><span class="token plain"> base64</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">urlsafe_b64encode</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">mac </span><span class="token operator">+</span><span class="token plain"> body</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">def</span><span class="token plain"> </span><span class="token function" style="color:rgb(80, 250, 123)">verify_cookie</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">cookie</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">try</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        blob </span><span class="token operator">=</span><span class="token plain"> base64</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">urlsafe_b64decode</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">cookie</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        mac</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> body </span><span class="token operator">=</span><span class="token plain"> blob</span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token number">32</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> blob</span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token number">32</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        env </span><span class="token operator">=</span><span class="token plain"> json</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">loads</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">body</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        kid </span><span class="token operator">=</span><span class="token plain"> env</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">get</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token string" style="color:rgb(255, 121, 198)">&quot;kid&quot;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"> state </span><span class="token operator">=</span><span class="token plain"> env</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">get</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token string" style="color:rgb(255, 121, 198)">&quot;state&quot;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">for</span><span class="token plain"> key </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">in</span><span class="token plain"> KMS</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">keys_for</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">kid</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">if</span><span class="token plain"> hmac</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">compare_digest</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">mac</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> hmac</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">new</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">key</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> body</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> hashlib</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">sha256</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">digest</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">return</span><span class="token plain"> state</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">return</span><span class="token plain"> </span><span class="token boolean">None</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">except</span><span class="token plain"> Exception</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">return</span><span class="token plain"> </span><span class="token boolean">None</span><br></span></code></pre></div></div>
<hr>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="5-filter-whitelist--matching-rules-yaml-driven">5) Filter whitelist + matching rules (YAML-driven)<a href="#5-filter-whitelist--matching-rules-yaml-driven" class="hash-link" aria-label="Direct link to 5) Filter whitelist + matching rules (YAML-driven)" title="Direct link to 5) Filter whitelist + matching rules (YAML-driven)">​</a></h2>
<p><strong>YAML</strong></p>
<div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token key atrule">filters</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token key atrule">allow_attrs</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token string" style="color:rgb(255, 121, 198)">&quot;uid&quot;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token string" style="color:rgb(255, 121, 198)">&quot;cn&quot;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token string" style="color:rgb(255, 121, 198)">&quot;mail&quot;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token string" style="color:rgb(255, 121, 198)">&quot;memberOf&quot;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token string" style="color:rgb(255, 121, 198)">&quot;objectClass&quot;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token key atrule">matching</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token key atrule">uid</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain">  caseIgnore</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token key atrule">cn</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain">   caseIgnore</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token key atrule">mail</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> caseIgnore  </span><span class="token comment" style="color:rgb(98, 114, 164)"># (documented: full lowercasing)</span><br></span></code></pre></div></div>
<p><strong>Translator applies normalization:</strong></p>
<div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token comment" style="color:rgb(98, 114, 164)"># ldap/filter_to_query.py (excerpt)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">def</span><span class="token plain"> </span><span class="token function" style="color:rgb(80, 250, 123)">norm</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">attr</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> value</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">match</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> cfg</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">matching</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">get</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">attr</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;caseExact&quot;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">return</span><span class="token plain"> value</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">casefold</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">if</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">match</span><span class="token plain"> </span><span class="token operator">==</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;caseIgnore&quot;</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">else</span><span class="token plain"> value</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">def</span><span class="token plain"> </span><span class="token function" style="color:rgb(80, 250, 123)">ast_to_query</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">node</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> base_dn</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">if</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(189, 147, 249)">isinstance</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">node</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> Eq</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">return</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token string" style="color:rgb(255, 121, 198)">&quot;eq&quot;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain">node</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">attr</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> norm</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">node</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">attr</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> node</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">value</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">if</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(189, 147, 249)">isinstance</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">node</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> Substr</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        pfx </span><span class="token operator">=</span><span class="token plain"> node</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">prefix</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">casefold</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">if</span><span class="token plain"> node</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">prefix </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">else</span><span class="token plain"> </span><span class="token boolean">None</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        anys </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token plain">s</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">casefold</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">for</span><span class="token plain"> s </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">in</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">node</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token builtin" style="color:rgb(189, 147, 249)">any</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">or</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        sfx </span><span class="token operator">=</span><span class="token plain"> node</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">suffix</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">casefold</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">if</span><span class="token plain"> node</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">suffix </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">else</span><span class="token plain"> </span><span class="token boolean">None</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">return</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token string" style="color:rgb(255, 121, 198)">&quot;substr&quot;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token string" style="color:rgb(255, 121, 198)">&quot;attr&quot;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> node</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">attr</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;initial&quot;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> pfx</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;any&quot;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> anys</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;final&quot;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> sfx</span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><br></span></code></pre></div></div>
<p>Providers honor these semantics (translator enforces allowlist and normalization; per-provider translators map to native queries).</p>
<hr>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="20-realworld-operational-requirements">20) Real‑world operational requirements<a href="#20-realworld-operational-requirements" class="hash-link" aria-label="Direct link to 20) Real‑world operational requirements" title="Direct link to 20) Real‑world operational requirements">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="answer">Answer<a href="#answer" class="hash-link" aria-label="Direct link to Answer" title="Direct link to Answer">​</a></h3>
<ul>
<li>
<ol>
<li>Hot load/cache: Yes.</li>
</ol>
<ul>
<li>L1 process cache + L2 Redis (JSON-only) with single-flight and negative caching are in the design.</li>
<li>We can pre-warm hot keys at startup and add “stale-while-revalidate” for read paths.</li>
<li>Config hot-reload: add a file-watcher (or SIGHUP) to reload <code>connectors.yaml</code>, System Types/Definitions, <code>mapping.yaml</code>, and <code>filters.yaml</code> without restart.</li>
</ul>
</li>
<li>
<ol start="2">
<li>Backend outage (LDAP/AD down):</li>
</ol>
<ul>
<li>Reads: serve from Redis for the TTL window; aggregator continues with any remaining healthy connectors. Return consistent results using the composite cursor; log connector unavailability.</li>
<li>Binds (password verification): do not cache credentials. We should fail-safe (unavailable/busy) rather than accept cached binds. If you need continuity, route bind verification to another authoritative connector (e.g., secondary AD) via connectors config; otherwise, do not allow “offline” binds.</li>
</ul>
</li>
<li>
<ol start="3">
<li>Schema transform/unification: Yes.</li>
</ol>
<ul>
<li>Use CRUD-style System Types/Definitions for connector actions; VDS <code>connectors.yaml</code> wires directories to systems.</li>
<li>Aggregator merges rows across sources using a canonical key (<code>subject.casefold</code>, stable id).</li>
<li>Mapping layer (<code>mapping.yaml</code>) renders LDAP entries (DN, objectClass, attribute projections).</li>
<li>If you need cross-source attribute precedence, add merge rules (either a <code>unify.yaml</code> or a <code>merge_rules</code> section in <code>connectors.yaml</code>) to coalesce attributes before mapping.</li>
</ul>
</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="gaps-to-close-small">Gaps to close (small)<a href="#gaps-to-close-small" class="hash-link" aria-label="Direct link to Gaps to close (small)" title="Direct link to Gaps to close (small)">​</a></h3>
<ul>
<li>Add hot-reload watcher for config files.</li>
<li>Implement “stale-while-revalidate” and explicit “stale OK” flags per directory/source.</li>
<li>Add optional <code>merge_rules</code> config (source precedence, coalesce lists) if you need richer unification beyond mapping.</li>
<li>For bind continuity, document an explicit active/standby source list in <code>connectors.yaml</code> (no offline cache for credentials).</li>
</ul>
<p>Terminology</p>
<ul>
<li>We use “Connectors” in VDS to align with CRUD Service terminology (System Types/Definitions). The “Directory Aggregator” composes multiple connectors per directory to provide deterministic paging and a composite cursor.</li>
</ul>
<hr>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="21-deduplication-and-attribute-merge-policy">21) Deduplication and attribute merge policy<a href="#21-deduplication-and-attribute-merge-policy" class="hash-link" aria-label="Direct link to 21) Deduplication and attribute merge policy" title="Direct link to 21) Deduplication and attribute merge policy">​</a></h2>
<p>Recommended default</p>
<ul>
<li>Deduplicate by logical subject (subject.casefold). Emit one LDAP entry per subject per directory.</li>
<li>Merge attributes deterministically using a precedence list of systems.</li>
<li>Scalar attributes: pick the first present value following the precedence order.</li>
<li>Multi-value attributes (lists): merge unique while preserving a stable order (by precedence, then lexicographic/case-insensitive as needed).</li>
</ul>
<p>Design notes</p>
<ul>
<li>Ordering key for paging remains <code>(subject.casefold, stable id)</code> for internal merge/scan; dedup is applied before projection.</li>
<li>Keep merges deterministic: no “last writer wins” based on wall time; use explicit precedence.</li>
<li>Expose metrics: count of merged attributes, source contribution, and dedup rate per page.</li>
</ul>
<p>Example (connectors.yaml)</p>
<div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token key atrule">directories</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token key atrule">person</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token key atrule">sources</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain"> </span><span class="token key atrule">system</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> addomain_ad</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token key atrule">object_type</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> user</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token key atrule">action</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> search_users</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token key atrule">key_fields</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token key atrule">subject</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> sAMAccountName</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token key atrule">id</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> objectGUID</span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain"> </span><span class="token key atrule">system</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> auth0_eid</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token key atrule">object_type</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> users</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token key atrule">action</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> list</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token key atrule">key_fields</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token key atrule">subject</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> email</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token key atrule">id</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> user_id</span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token key atrule">merge_rules</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token key atrule">precedence</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token plain">addomain_ad</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> auth0_eid</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token key atrule">attributes</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token key atrule">mail</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">          </span><span class="token key atrule">pick</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> first_present</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">          </span><span class="token key atrule">sources</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token plain">addomain_ad.mail</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> auth0_eid.email</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token key atrule">givenName</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">          </span><span class="token key atrule">pick</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> first_present</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">          </span><span class="token key atrule">sources</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token plain">addomain_ad.givenName</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> auth0_eid.given_name</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token key atrule">sn</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">          </span><span class="token key atrule">pick</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> first_present</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">          </span><span class="token key atrule">sources</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token plain">addomain_ad.sn</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> auth0_eid.family_name</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token key atrule">memberOf</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">          </span><span class="token key atrule">merge_unique</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token key atrule">sources</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token plain">addomain_ad.memberOf</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> auth0_eid.groups</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><br></span></code></pre></div></div>
<p>Implementation sketch</p>
<ul>
<li>Aggregator groups rows by <code>subject_cf</code>; for each group, applies <code>merge_rules</code> to build a canonical subject record; mapping then renders DN/objectClasses/attributes.</li>
<li>If <code>merge_rules</code> is omitted, default precedence is the <code>sources</code> order; scalars use first_present, lists merge_unique.</li>
</ul>
<hr>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="22-implementation-alignment-v21">22) Implementation alignment (v2.1)<a href="#22-implementation-alignment-v21" class="hash-link" aria-label="Direct link to 22) Implementation alignment (v2.1)" title="Direct link to 22) Implementation alignment (v2.1)">​</a></h2>
<p>This section reflects what is now implemented in code and tested.</p>
<ul>
<li>
<p>Cookie envelope (executor)</p>
<ul>
<li>Envelope structure: <code>{ &quot;kid&quot;: &lt;key-id&gt;, &quot;state&quot;: { &quot;cur&quot;: &lt;composite-cursor&gt;, &quot;q&quot;: &lt;filter-hash?&gt;, &quot;v&quot;: &lt;mapping-version?&gt; } }</code></li>
<li><code>q</code> is a SHA1 of the normalized backend-agnostic filter JSON; <code>v</code> is a small hash of the loaded mapping config (objects/filters/limits). Both are optional.</li>
<li>Cookies are HMAC-SHA256 signed, key-rotated via <code>kid</code>, and size-enforced by <code>max_cookie_bytes</code> (oversize → 53 with empty paged cookie control at the protocol boundary).</li>
</ul>
</li>
<li>
<p>Observability (metrics/tracing)</p>
<ul>
<li>Counters/histograms implemented:<!-- -->
<ul>
<li><code>ldap_search_total{result}</code></li>
<li><code>ldap_pages_total</code></li>
<li><code>ldap_search_latency_seconds</code></li>
<li><code>provider_calls_total{outcome}</code></li>
<li><code>provider_latency_seconds</code></li>
<li><code>aggregator_latency_seconds</code></li>
</ul>
</li>
<li>Tracing shim provides <code>span(name, **attrs)</code>; aggregator and providers wrap calls with spans. Aggregator spans also emit timing to the aggregator latency histogram.</li>
</ul>
</li>
<li>
<p>Mapping DSL (JSONPath + built-ins)</p>
<ul>
<li>Built-ins implemented: <code>concat</code>, <code>groupsOf(subject)</code>, <code>membersAsDNs(groupId)</code>.</li>
<li>If <code>objects.&lt;type&gt;.attributes</code> is present in the mapping YAML, the evaluator uses it as the source of truth (JSONPath-driven); otherwise a sensible default mapping is used for <code>person</code> (uid, cn, mail, objectClass, dn).</li>
<li>Group/member resolvers are injected and safe by default; failures return empty lists.</li>
<li>DN policy: attribute type names normalized; RDN values preserve original case in output; equality should use the DN normalizer.</li>
</ul>
</li>
<li>
<p>Aggregator composite cursor</p>
<ul>
<li>Composite cursor shape remains: <code>{ subject_cf, source_offsets: { &lt;system&gt;: &lt;cursor&gt; } }</code>.</li>
<li>Start-after semantics are applied using <code>subject_cf</code> to avoid duplicates across pages.</li>
<li>When a fetched page contains additional rows for a system that were not yet emitted (e.g., multiple entries for the same subject or churn between pages), the aggregator records a per-system &quot;last consumed&quot; key <code>{subject_cf, id}</code> as the next offset instead of blindly advancing to the provider&#x27;s next token. This avoids duplicates and holes during churn.</li>
</ul>
</li>
<li>
<p>Tests</p>
<ul>
<li>Property-based tests (optional) cover caseIgnore equality/substring building.</li>
<li>Hot-reload watcher (<code>ConfigReloader</code>) tested for change detection.</li>
<li>Composite cursor round-trip tested for no duplicates on churn.</li>
</ul>
</li>
</ul>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="6-dn-canonicalization">6) DN canonicalization<a href="#6-dn-canonicalization" class="hash-link" aria-label="Direct link to 6) DN canonicalization" title="Direct link to 6) DN canonicalization">​</a></h2>
<ul>
<li><strong>RFC 4514</strong> escaping (unchanged).</li>
<li><strong>Do not lowercase DN values</strong>. Normalize <strong>attribute type names</strong> internally for matching/order, but <strong>preserve the original case of RDN values</strong> in returned DNs and attributes. Use an internal normalized key (e.g., casefold+escape) for dedup/sort only.</li>
</ul>
<hr>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="7-redis-single-flight-lua-json-only">7) Redis single-flight (Lua), JSON only<a href="#7-redis-single-flight-lua-json-only" class="hash-link" aria-label="Direct link to 7) Redis single-flight (Lua), JSON only" title="Direct link to 7) Redis single-flight (Lua), JSON only">​</a></h2>
<div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token comment" style="color:rgb(98, 114, 164)"># deps/redis_cache.py (excerpt)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)"># Acquire lock (SETNX), TTL ms in ARGV[2], token in ARGV[1]; returns 1 if owner</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">SF_ACQUIRE </span><span class="token operator">=</span><span class="token plain"> </span><span class="token triple-quoted-string string" style="color:rgb(255, 121, 198)">&quot;&quot;&quot;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token triple-quoted-string string" style="color:rgb(255, 121, 198)">if redis.call(&#x27;SETNX&#x27;, KEYS[1], ARGV[1]) == 1 then</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token triple-quoted-string string" style="color:rgb(255, 121, 198)">  redis.call(&#x27;PEXPIRE&#x27;, KEYS[1], ARGV[2])</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token triple-quoted-string string" style="color:rgb(255, 121, 198)">  return 1</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token triple-quoted-string string" style="color:rgb(255, 121, 198)">else</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token triple-quoted-string string" style="color:rgb(255, 121, 198)">  return 0</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token triple-quoted-string string" style="color:rgb(255, 121, 198)">end</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token triple-quoted-string string" style="color:rgb(255, 121, 198)">&quot;&quot;&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">async</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">def</span><span class="token plain"> </span><span class="token function" style="color:rgb(80, 250, 123)">single_flight</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">self</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> key</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> ttl_s</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> fn</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    lock </span><span class="token operator">=</span><span class="token plain"> </span><span class="token string-interpolation string" style="color:rgb(255, 121, 198)">f&quot;</span><span class="token string-interpolation interpolation punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token string-interpolation interpolation">key</span><span class="token string-interpolation interpolation punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token string-interpolation string" style="color:rgb(255, 121, 198)">:lock&quot;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"> token </span><span class="token operator">=</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(189, 147, 249)">str</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">uuid4</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    got </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">await</span><span class="token plain"> self</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">r</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token builtin" style="color:rgb(189, 147, 249)">eval</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">SF_ACQUIRE</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token number">1</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> lock</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> token</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(189, 147, 249)">int</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">ttl_s</span><span class="token operator">*</span><span class="token number">1000</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">if</span><span class="token plain"> got </span><span class="token operator">==</span><span class="token plain"> </span><span class="token number">1</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">try</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            val </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">await</span><span class="token plain"> fn</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">await</span><span class="token plain"> self</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">set_json</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">key</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> val</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> ttl</span><span class="token operator">=</span><span class="token plain">self</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">cfg</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">default_ttl</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">return</span><span class="token plain"> val</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">finally</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token comment" style="color:rgb(98, 114, 164)"># release only if we own it</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">await</span><span class="token plain"> self</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">r</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token builtin" style="color:rgb(189, 147, 249)">eval</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token string" style="color:rgb(255, 121, 198)">&quot;if redis.call(&#x27;GET&#x27;, KEYS[1])==ARGV[1] then return redis.call(&#x27;DEL&#x27;, KEYS[1]) else return 0 end&quot;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token number">1</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> lock</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> token</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token comment" style="color:rgb(98, 114, 164)"># loser: backoff+jitter and poll cache</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">for</span><span class="token plain"> _ </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">in</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(189, 147, 249)">range</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">self</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">cfg</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">sf_max_wait_iters</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">await</span><span class="token plain"> asyncio</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">sleep</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">random</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">uniform</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token number">0.01</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token number">0.05</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        val </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">await</span><span class="token plain"> self</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">get_json</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">key</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">if</span><span class="token plain"> val </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">is</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">not</span><span class="token plain"> </span><span class="token boolean">None</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">return</span><span class="token plain"> val</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token comment" style="color:rgb(98, 114, 164)"># fallback: run anyway</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">return</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">await</span><span class="token plain"> fn</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><br></span></code></pre></div></div>
<hr>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="8-backpressure--timeouts">8) Backpressure &amp; timeouts<a href="#8-backpressure--timeouts" class="hash-link" aria-label="Direct link to 8) Backpressure &amp; timeouts" title="Direct link to 8) Backpressure &amp; timeouts">​</a></h2>
<ul>
<li><strong>Send queue</strong> capped (<code>max_send_queue_items</code>).</li>
<li><code>drain()</code> <strong>timeout</strong>; on timeout → send unsolicited notice, close.</li>
<li><strong>Per request</strong> time budgets (search/bind) → cancel work if over budget and send <code>timeLimitExceeded (3)</code> or <code>busy (51)</code>.</li>
</ul>
<hr>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="9-tls--client-identity">9) TLS &amp; client identity<a href="#9-tls--client-identity" class="hash-link" aria-label="Direct link to 9) TLS &amp; client identity" title="Direct link to 9) TLS &amp; client identity">​</a></h2>
<ul>
<li>
<p><strong>LDAPS-only</strong> for v1; StartTLS disabled (can be toggled later).</p>
</li>
<li>
<p>TLS: <code>minimum_version=TLS1.2</code>, FIPS ciphers if required.</p>
</li>
<li>
<p>SASL/EXTERNAL: map <strong>SAN:otherName/UPN → rfc822Name → CN</strong> (in that order). Reject subject ambiguity.</p>
</li>
<li>
<p><strong>Client IP</strong> extraction:</p>
<ul>
<li>If listener enabled <code>proxy_protocol=True</code>, parse <strong>PROXY v2</strong> TLVs for the original src IP.</li>
<li>Else, if behind L7 and you trust it, read <code>X-Forwarded-For</code> <strong>only if</strong> mTLS terminates there (documented trust boundary).</li>
</ul>
</li>
<li>
<p>For UPN extraction (<code>otherName/UPN</code>), use <code>cryptography</code> with <code>getpeercert(binary_form=True)</code>; stdlib <code>ssl</code> dicts may omit UPN.</p>
</li>
</ul>
<hr>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="91-rootdse-and-base-search">9.1) RootDSE and base search<a href="#91-rootdse-and-base-search" class="hash-link" aria-label="Direct link to 9.1) RootDSE and base search" title="Direct link to 9.1) RootDSE and base search">​</a></h2>
<ul>
<li>Implement <code>base=&quot;&quot;</code>, <code>scope=base</code> returning at minimum:<!-- -->
<ul>
<li><code>supportedLDAPVersion: [&quot;3&quot;]</code></li>
<li><code>supportedControl: [&quot;1.2.840.113556.1.4.319&quot;]</code> (RFC 2696)</li>
<li><code>namingContexts: [ &quot;ou=people,dc=…&quot;, &quot;ou=groups,dc=…&quot; ]</code></li>
<li>Optional: <code>vendorName</code>, <code>vendorVersion</code></li>
</ul>
</li>
</ul>
<hr>
<hr>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="10-connectors--pdp-contracts-frozen">10) Connectors &amp; PDP contracts (frozen)<a href="#10-connectors--pdp-contracts-frozen" class="hash-link" aria-label="Direct link to 10) Connectors &amp; PDP contracts (frozen)" title="Direct link to 10) Connectors &amp; PDP contracts (frozen)">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="connectors-per-source">Connectors (per source)<a href="#connectors-per-source" class="hash-link" aria-label="Direct link to Connectors (per source)" title="Direct link to Connectors (per source)">​</a></h3>
<ul>
<li>LDAP connector: RFC 2696 paging, optional server-side sort; returns rows + cookie</li>
<li>REST connector: provider/API next token paging; returns rows + token</li>
<li>SQL/ODBC connector: keyset paging (<code>ORDER BY lower(subject), id</code>); returns rows + last-key</li>
<li>All connectors must honor normalized filter inputs (caseIgnore) and produce deterministic ordering keys: <code>(subject.casefold, id)</code></li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="pdp">PDP<a href="#pdp" class="hash-link" aria-label="Direct link to PDP" title="Direct link to PDP">​</a></h3>
<ul>
<li><code>POST /v1/ldap/bind</code> → <code>{&quot;allow&quot;:bool,&quot;obligations&quot;:{...}}</code></li>
<li><code>POST /v1/ldap/search</code> → <code>{&quot;allow&quot;:bool,&quot;allowed_attrs&quot;:[&quot;cn&quot;,&quot;mail&quot;,...],&quot;obligations&quot;:{&quot;max_size&quot;:1000,&quot;redact&quot;:[&quot;...&quot;]}}</code></li>
<li><strong>Default deny</strong>; breaker → treat as <strong>deny</strong> (fail-closed).</li>
</ul>
<hr>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="11-search-executor-cursor-paging-cookie-rotation">11) Search executor (cursor paging, cookie rotation)<a href="#11-search-executor-cursor-paging-cookie-rotation" class="hash-link" aria-label="Direct link to 11) Search executor (cursor paging, cookie rotation)" title="Direct link to 11) Search executor (cursor paging, cookie rotation)">​</a></h2>
<div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token comment" style="color:rgb(98, 114, 164)"># exec/search_executor.py (excerpt)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">state </span><span class="token operator">=</span><span class="token plain"> verify_cookie</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">cookie</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">if</span><span class="token plain"> cookie </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">else</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token string" style="color:rgb(255, 121, 198)">&quot;cur&quot;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token boolean">None</span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">if</span><span class="token plain"> cookie </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">and</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">not</span><span class="token plain"> state</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">raise</span><span class="token plain"> LdapError</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token number">53</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;invalid paging cookie&quot;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">rows</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> next_cur </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">await</span><span class="token plain"> self</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">aggregator</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">search</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    base_dn</span><span class="token operator">=</span><span class="token plain">base_dn</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    scope</span><span class="token operator">=</span><span class="token plain">scope</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    filter_ast</span><span class="token operator">=</span><span class="token plain">normalized_ast</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    page_size</span><span class="token operator">=</span><span class="token plain">page_size</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    cursor</span><span class="token operator">=</span><span class="token plain">state</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">get</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token string" style="color:rgb(255, 121, 198)">&quot;cur&quot;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">entries </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">for</span><span class="token plain"> subj </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">in</span><span class="token plain"> rows</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    dn </span><span class="token operator">=</span><span class="token plain"> self</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">map_engine</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">user_dn</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">base_dn</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> rdn_attr</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> subj</span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token string" style="color:rgb(255, 121, 198)">&quot;subject&quot;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    attrs </span><span class="token operator">=</span><span class="token plain"> self</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">_project</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">self</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">map_engine</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">map_person</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">subj</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> person_cfg</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> req_attrs</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">if</span><span class="token plain"> pdp_gate</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        allowed </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">await</span><span class="token plain"> self</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">pdp</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">allowed_attributes</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">subj</span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token string" style="color:rgb(255, 121, 198)">&quot;subject&quot;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(189, 147, 249)">set</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">req_attrs</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        attrs </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain">k</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> v </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">for</span><span class="token plain"> k</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> v </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">in</span><span class="token plain"> attrs</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">items</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">if</span><span class="token plain"> k </span><span class="token operator">==</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;dn&quot;</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">or</span><span class="token plain"> k </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">in</span><span class="token plain"> allowed</span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    entries</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">append</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">attrs </span><span class="token operator">|</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token string" style="color:rgb(255, 121, 198)">&quot;dn&quot;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> dn</span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">next_cookie </span><span class="token operator">=</span><span class="token plain"> sign_cookie</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token string" style="color:rgb(255, 121, 198)">&quot;cur&quot;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> next_cur</span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">if</span><span class="token plain"> next_cur </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">else</span><span class="token plain"> </span><span class="token boolean">None</span><br></span></code></pre></div></div>
<hr>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="12-testing-additions-must-haves">12) Testing additions (must-haves)<a href="#12-testing-additions-must-haves" class="hash-link" aria-label="Direct link to 12) Testing additions (must-haves)" title="Direct link to 12) Testing additions (must-haves)">​</a></h2>
<ul>
<li><strong>Framing</strong>: multiple PDUs in one TCP packet; fragmented BER; random chunking.</li>
<li><strong>Controls</strong>: invalid cookie → 53 + empty cookie control; unknown critical control → 12.</li>
<li><strong>Filters</strong>: property-based tests (Hypothesis) for caseIgnore equality/substring; escaped chars.</li>
<li><strong>Paging</strong>: churn (subject insert/delete mid-page) still yields no duplicates/holes; cursor monotonic.</li>
<li><strong>Unsolicited notice</strong>: unknown op triggers OID and close.</li>
<li><strong>Backpressure</strong>: flood client (slow consumer) triggers send-queue overflow path.</li>
<li><strong>Proxy v2</strong>: parse TLVs; fall back safely.</li>
<li><strong>Windows</strong>: run tests without uvloop.</li>
<li><strong>DN normalization parity</strong>: <code>member</code> values generated by mapping compare equal to <code>memberOf</code> via the DN normalizer.</li>
<li><strong>RootDSE</strong>: <code>base=&quot;&quot;</code>, <code>scope=base</code> returns version and controls.</li>
<li><strong>Abandon</strong>: slow search then Abandon cancels by messageID; no DoneResponse for that op.</li>
<li><strong>Cookie size</strong>: composite cursor stays ≤ configured <code>max_cookie_bytes</code> or yields <code>53</code> + empty cookie.</li>
<li><strong>Filter DoS</strong>: AST depth/size caps, wildcard limits.</li>
</ul>
<hr>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="13-metricstracing-cardinality-safe">13) Metrics/tracing (cardinality-safe)<a href="#13-metricstracing-cardinality-safe" class="hash-link" aria-label="Direct link to 13) Metrics/tracing (cardinality-safe)" title="Direct link to 13) Metrics/tracing (cardinality-safe)">​</a></h2>
<ul>
<li>
<p>Counters:</p>
<ul>
<li><code>ldap_bind_total{result}</code> (map to small set: success, invalidCreds, insufficient, unavailable, other)</li>
<li><code>ldap_search_total{result}</code> (success, unwilling, insufficient, unavailable, timeLimit, other)</li>
<li><code>ldap_rate_limit_hits_total</code>, <code>ldap_lockouts_total</code>, <code>ldap_pages_total</code></li>
</ul>
</li>
<li>
<p>Histograms: <code>ldap_bind_latency_seconds</code>, <code>ldap_search_latency_seconds</code>, <code>aggregator_latency_seconds</code>, <code>provider_latency_seconds</code>, <code>pdp_latency_seconds</code></p>
</li>
<li>
<p>Gauges: <code>ldap_connections_active</code></p>
</li>
<li>
<p>Tracing attrs: <code>tenant</code>, <code>message_id</code>, <code>filter_hash</code>, <code>page_size</code>, <code>cursor_present</code>, <strong>no raw DNs/subjects</strong>.</p>
</li>
</ul>
<hr>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="14-example-unsolicited-notice-on-overflowunknown-op">14) Example: Unsolicited notice on overflow/unknown op<a href="#14-example-unsolicited-notice-on-overflowunknown-op" class="hash-link" aria-label="Direct link to 14) Example: Unsolicited notice on overflow/unknown op" title="Direct link to 14) Example: Unsolicited notice on overflow/unknown op">​</a></h2>
<div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token comment" style="color:rgb(98, 114, 164)"># server/protocol.py (excerpt)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">from</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">encoder </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">import</span><span class="token plain"> unsolicited_notice</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">async</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">def</span><span class="token plain"> </span><span class="token function" style="color:rgb(80, 250, 123)">_handle_unknown</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">self</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> msg_id</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(189, 147, 249)">int</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> name</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(189, 147, 249)">str</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">await</span><span class="token plain"> self</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">_send</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">unsolicited_notice</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token number">2</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token string-interpolation string" style="color:rgb(255, 121, 198)">f&quot;protocolError: unsupported </span><span class="token string-interpolation interpolation punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token string-interpolation interpolation">name</span><span class="token string-interpolation interpolation punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token string-interpolation string" style="color:rgb(255, 121, 198)">&quot;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    self</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">w</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">close</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><br></span></code></pre></div></div>
<hr>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="15-example-yaml-driven-allowlist-in-translator">15) Example: YAML-driven allowlist in translator<a href="#15-example-yaml-driven-allowlist-in-translator" class="hash-link" aria-label="Direct link to 15) Example: YAML-driven allowlist in translator" title="Direct link to 15) Example: YAML-driven allowlist in translator">​</a></h2>
<div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token comment" style="color:rgb(98, 114, 164)"># ldap/filter_from_asn1.py (excerpt)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">class</span><span class="token plain"> </span><span class="token class-name">FilterTranslator</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">def</span><span class="token plain"> </span><span class="token function" style="color:rgb(80, 250, 123)">__init__</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">self</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> cfg</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        self</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">allowed </span><span class="token operator">=</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(189, 147, 249)">set</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">cfg</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">filters</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">allow_attrs</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        self</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">matching </span><span class="token operator">=</span><span class="token plain"> cfg</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">filters</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">matching </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">or</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">def</span><span class="token plain"> </span><span class="token function" style="color:rgb(80, 250, 123)">_guard</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">self</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> attr</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">if</span><span class="token plain"> attr </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">not</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">in</span><span class="token plain"> self</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">allowed</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">raise</span><span class="token plain"> LdapError</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token number">53</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token string-interpolation string" style="color:rgb(255, 121, 198)">f&quot;attribute </span><span class="token string-interpolation interpolation punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token string-interpolation interpolation">attr</span><span class="token string-interpolation interpolation punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token string-interpolation string" style="color:rgb(255, 121, 198)"> not allowed&quot;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><br></span></code></pre></div></div>
<hr>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="16-open-questions-unchanged-now-precise">16) Open questions (unchanged, now precise)<a href="#16-open-questions-unchanged-now-precise" class="hash-link" aria-label="Direct link to 16) Open questions (unchanged, now precise)" title="Direct link to 16) Open questions (unchanged, now precise)">​</a></h2>
<ul>
<li>StartTLS: still out for v1? (Recommend <strong>yes</strong>.)</li>
<li>Membership guarantees stable <strong>cursor</strong> across concurrent writes? If not, we may need snapshot/isolation hints.</li>
<li>PDP allow-list granularity: per-attr only, or per-attr+value patterns (e.g., domains)? (v1: per-attr.)</li>
<li>Any attributes needing locale-aware matching beyond <code>caseIgnore</code>? (Default: no.)</li>
</ul>
<hr>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="17-ready-to-build-checklist">17) Ready-to-build checklist<a href="#17-ready-to-build-checklist" class="hash-link" aria-label="Direct link to 17) Ready-to-build checklist" title="Direct link to 17) Ready-to-build checklist">​</a></h2>
<ul class="contains-task-list containsTaskList_mC6p">
<li class="task-list-item"><input type="checkbox" disabled=""> <!-- -->Listener (LDAPS, PROXY v2, TLS policy) + Protocol (framing/backpressure).</li>
<li class="task-list-item"><input type="checkbox" disabled=""> <!-- -->Controls (RFC 2696) + invalid-cookie path.</li>
<li class="task-list-item"><input type="checkbox" disabled=""> <!-- -->Filter translator wired to YAML allowlist + matching rules.</li>
<li class="task-list-item"><input type="checkbox" disabled=""> <!-- -->Search executor (cursor paging, cookie rotation, PDP allowlist).</li>
<li class="task-list-item"><input type="checkbox" disabled=""> <!-- -->Mapping DSL (compiled JSONPath, pure builtins).</li>
<li class="task-list-item"><input type="checkbox" disabled=""> <!-- -->Redis cache (JSON, Lua single-flight, negative cache).</li>
<li class="task-list-item"><input type="checkbox" disabled=""> <!-- -->Group resolver (transitive, cached).</li>
<li class="task-list-item"><input type="checkbox" disabled=""> <!-- -->Rate limit/lockout + CB wrappers.</li>
<li class="task-list-item"><input type="checkbox" disabled=""> <!-- -->Observability + audit.</li>
<li class="task-list-item"><input type="checkbox" disabled=""> <!-- -->Tests: framing/controls/paging/fuzz/perf.</li>
</ul>
<hr>
<p>If you want, I can spit out the <strong>scaffold files + basic tests</strong> next so the team can <code>poetry run pytest</code> and iterate on membership/PDP stubs immediately.</p>
<p>Short answer:</p>
<ul>
<li>
<p><strong>Replace it.</strong> Make the v2 spec the new source of truth and add a short “delta/migration” appendix at the end so readers coming from v1 can see what changed (paging semantics, unsolicited disconnect, YAML-driven allowlist, etc.).</p>
</li>
<li>
<p><strong>Yes, the TAK/IGA info nudges the VDS</strong>—not the core protocol—but the mapping, bind, and caching profiles should be tailored for TAK. See the concrete tweaks below; I’d add them as an <strong>Appendix: “TAK Profile”</strong> in the design.</p>
</li>
</ul>
<hr>
<h1>What to do with the docs</h1>
<ol>
<li>
<p><strong>Promote v2 to the main design.</strong></p>
</li>
<li>
<p>Add two appendices:</p>
<ul>
<li><strong>Appendix A – Delta from v1</strong> (one page of bullets so no one has to diff):
framing fix, bad cookie → 53 + empty cookie, YAML allowlist, caseIgnore matching, HMAC <code>kid</code>, unsolicited disconnect, LDAPS-only v1, backpressure, Redis single-flight.</li>
<li><strong>Appendix B – TAK Profile</strong> (below).</li>
</ul>
</li>
</ol>
<hr>
<h1>Appendix B — TAK Profile (what changes for our LDAP VDS)</h1>
<p>These don’t alter the core engine; they’re <strong>config + integration</strong> choices that make TAK happy and let your IGA/PKI drive certs and groups.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="1-bind-modes-to-support">1) Bind modes to support<a href="#1-bind-modes-to-support" class="hash-link" aria-label="Direct link to 1) Bind modes to support" title="Direct link to 1) Bind modes to support">​</a></h2>
<ul>
<li>
<p><strong>SASL/EXTERNAL (client cert)</strong>: keep it first-class.</p>
<ul>
<li>Identity extraction order: <strong>SAN otherName/UPN → SAN rfc822Name → CN</strong> (reject ambiguity).</li>
<li>Map to canonical <code>subject</code> via membership; audit cert FP/issuer.</li>
</ul>
</li>
<li>
<p><strong>Simple bind</strong>: still supported, but rate-limited/lockout; most TAK installs will prefer client-cert.</p>
</li>
</ul>
<p><em>No code changes to the engine—just ensure the SASL/EXTERNAL path is fully wired and audited.</em></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="2-attribute--filter-profile-keep-tak-queries-fast">2) Attribute &amp; filter profile (keep TAK queries fast)<a href="#2-attribute--filter-profile-keep-tak-queries-fast" class="hash-link" aria-label="Direct link to 2) Attribute &amp; filter profile (keep TAK queries fast)" title="Direct link to 2) Attribute &amp; filter profile (keep TAK queries fast)">​</a></h2>
<p>Use a TAK-friendly allowlist and matching rules:</p>
<div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token comment" style="color:rgb(98, 114, 164)"># config/schema.yaml (excerpt)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token key atrule">filters</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token key atrule">allow_attrs</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token string" style="color:rgb(255, 121, 198)">&quot;uid&quot;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token string" style="color:rgb(255, 121, 198)">&quot;sAMAccountName&quot;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token string" style="color:rgb(255, 121, 198)">&quot;cn&quot;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token string" style="color:rgb(255, 121, 198)">&quot;mail&quot;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token string" style="color:rgb(255, 121, 198)">&quot;memberOf&quot;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token string" style="color:rgb(255, 121, 198)">&quot;objectClass&quot;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token key atrule">matching</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token key atrule">uid</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> caseIgnore</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token key atrule">sAMAccountName</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> caseIgnore</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token key atrule">cn</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> caseIgnore</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token key atrule">mail</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> caseIgnore</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token key atrule">limits</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token key atrule">sizeLimit</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token number">1000</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token key atrule">timeLimitMs</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token number">3000</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token key atrule">defaultPageSize</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token number">500</span><br></span></code></pre></div></div>
<p>Notes:</p>
<ul>
<li>TAK commonly looks up by <code>uid</code>/<code>sAMAccountName</code> and reads <code>memberOf</code>. Keep those indexed in your membership service and fast-path them in <code>ast_to_query</code>.</li>
<li>Stick to <code>Eq</code>, <code>Present</code>, and prefix <code>Substr</code> for performance.</li>
</ul>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="3-tak-object-mappings-vds-virtualization">3) TAK object mappings (VDS virtualization)<a href="#3-tak-object-mappings-vds-virtualization" class="hash-link" aria-label="Direct link to 3) TAK object mappings (VDS virtualization)" title="Direct link to 3) TAK object mappings (VDS virtualization)">​</a></h2>
<p>Give TAK a flat, cached view of people and groups. Example DSL:</p>
<div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token key atrule">objects</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token key atrule">person</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token key atrule">base_dn</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;ou=people,dc=example,dc=com&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token key atrule">objectClasses</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token string" style="color:rgb(255, 121, 198)">&quot;inetOrgPerson&quot;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token string" style="color:rgb(255, 121, 198)">&quot;organizationalPerson&quot;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token string" style="color:rgb(255, 121, 198)">&quot;person&quot;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token string" style="color:rgb(255, 121, 198)">&quot;top&quot;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token key atrule">rdn</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;uid&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token key atrule">attributes</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token key atrule">uid</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;$.subject&quot;</span><span class="token plain">                 </span><span class="token comment" style="color:rgb(98, 114, 164)"># canonical username</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token key atrule">sAMAccountName</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;$.windows.sam&quot;</span><span class="token plain">  </span><span class="token comment" style="color:rgb(98, 114, 164)"># if present; else omit</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token key atrule">cn</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"> </span><span class="token key atrule">func</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;concat&quot;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token key atrule">args</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token string" style="color:rgb(255, 121, 198)">&quot;$.profile.given_name&quot;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token string" style="color:rgb(255, 121, 198)">&quot; &quot;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;$.profile.family_name&quot;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token key atrule">givenName</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;$.profile.given_name&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token key atrule">sn</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;$.profile.family_name&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token key atrule">mail</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token string" style="color:rgb(255, 121, 198)">&quot;$.emails.primary&quot;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token string" style="color:rgb(255, 121, 198)">&quot;$.emails.work&quot;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token comment" style="color:rgb(98, 114, 164)"># map IGA roles/teams to TAK groups:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token key atrule">memberOf</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"> </span><span class="token key atrule">func</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;groupsOf&quot;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token key atrule">args</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token string" style="color:rgb(255, 121, 198)">&quot;$.subject&quot;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token key atrule">group</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token key atrule">base_dn</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;ou=groups,dc=example,dc=com&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token key atrule">objectClasses</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token string" style="color:rgb(255, 121, 198)">&quot;groupOfNames&quot;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token string" style="color:rgb(255, 121, 198)">&quot;top&quot;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token key atrule">rdn</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;cn&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token key atrule">attributes</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token key atrule">cn</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;$.name&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token key atrule">description</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;$.description&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token key atrule">member</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"> </span><span class="token key atrule">func</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;membersAsDNs&quot;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token key atrule">args</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token string" style="color:rgb(255, 121, 198)">&quot;$.id&quot;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><br></span></code></pre></div></div>
<p><em>This uses the same DSL from v2: JSONPath + built-ins, no templates.</em></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="4-deterministic-paging-for-large-tak-reads">4) Deterministic paging for large TAK reads<a href="#4-deterministic-paging-for-large-tak-reads" class="hash-link" aria-label="Direct link to 4) Deterministic paging for large TAK reads" title="Direct link to 4) Deterministic paging for large TAK reads">​</a></h2>
<ul>
<li>Keep the v2 <strong>cursor-based paging</strong> and <strong>subject_asc</strong> total ordering.</li>
<li>Clients like TAK are fine with RFC 2696; our <strong>stateless HMAC cookie</strong> w/ <code>kid</code> rotation is exactly what we want.</li>
</ul>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="5-caching-profile-for-tak">5) Caching profile for TAK<a href="#5-caching-profile-for-tak" class="hash-link" aria-label="Direct link to 5) Caching profile for TAK" title="Direct link to 5) Caching profile for TAK">​</a></h2>
<ul>
<li>
<p><strong>L1 60s</strong>, <strong>L2 Redis 5–10 min</strong> for per-subject attribute blobs (<code>attrs:{subject}</code>) and <strong>1–2 min</strong> for <code>groups:{subject}</code> (group churn is higher).</p>
</li>
<li>
<p>Enable <strong>negative cache</strong> for missing users/groups (60s) to blunt brute-force probes.</p>
</li>
<li>
<p>Keep <strong>CDC-driven invalidation</strong> (IGA/HR/PKI events):</p>
<ul>
<li>user change → <code>DEL attrs:{subject}</code></li>
<li>membership change → <code>DEL groups:{subject}</code>, <code>DEL attrs:{subject}</code></li>
</ul>
</li>
</ul>
<p><em>No engine code change; just TTLs and Kafka/Redis wiring.</em></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="6-certificate-lifecycle-signals-from-igapki-not-vds">6) Certificate lifecycle signals (from IGA/PKI, not VDS)<a href="#6-certificate-lifecycle-signals-from-igapki-not-vds" class="hash-link" aria-label="Direct link to 6) Certificate lifecycle signals (from IGA/PKI, not VDS)" title="Direct link to 6) Certificate lifecycle signals (from IGA/PKI, not VDS)">​</a></h2>
<ul>
<li>
<p>VDS doesn’t issue or revoke; it <strong>exposes state</strong> needed by TAK:</p>
<ul>
<li>Add optional attributes: <code>certificateSerialNumber</code>, <code>certificateNotAfter</code>, <code>revoked</code> (boolean), or separate <code>takStatus</code> attribute.</li>
<li>Your mapping DSL can surface these from the PKI system for ops/forensics; PDP can redact if not needed.</li>
</ul>
</li>
</ul>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="7-dn--ou-conventions-for-tak">7) DN &amp; OU conventions for TAK<a href="#7-dn--ou-conventions-for-tak" class="hash-link" aria-label="Direct link to 7) DN &amp; OU conventions for TAK" title="Direct link to 7) DN &amp; OU conventions for TAK">​</a></h2>
<ul>
<li>
<p>If you embed organizational data in cert OUs, reflect it in the directory DNs for clarity:</p>
<ul>
<li>Example RDN policy: <code>uid=&lt;lowercased subject&gt;</code>, base <code>ou=people,dc=...</code>.</li>
<li>Ensure <strong>RFC 4514 escaping</strong> and <strong>lowercase canonicalization</strong> for RDN values to avoid duplicate DNs across case variants.</li>
</ul>
</li>
</ul>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="8-tls-and-ca-hygiene-interop-more-than-code">8) TLS and CA hygiene (interop more than code)<a href="#8-tls-and-ca-hygiene-interop-more-than-code" class="hash-link" aria-label="Direct link to 8) TLS and CA hygiene (interop more than code)" title="Direct link to 8) TLS and CA hygiene (interop more than code)">​</a></h2>
<ul>
<li>Stick with <strong>LDAPS-only</strong> in v1.</li>
<li>If you enable SASL/EXTERNAL, configure the listener with your TAK-trusted CA chain; publish any CRL/OCSP endpoints as required by your PKI.</li>
<li>None of this changes the LDAP engine; it’s deployment policy.</li>
</ul>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="9-observability-that-helps-tak-ops">9) Observability that helps TAK ops<a href="#9-observability-that-helps-tak-ops" class="hash-link" aria-label="Direct link to 9) Observability that helps TAK ops" title="Direct link to 9) Observability that helps TAK ops">​</a></h2>
<p>Add a TAK-focused dashboard slice:</p>
<ul>
<li><code>ldap_search_total{client=&quot;tak&quot;}</code> (derive via SNI or cert OU)</li>
<li>p95 search latency, cache hit %, rate-limit hits</li>
<li>membership/PDP latencies</li>
<li>count of <code>memberOf</code> values per subject (sanity)</li>
<li>pages per search (watch for inefficient queries)</li>
</ul>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="10-safe-defaults-for-tak">10) Safe defaults for TAK<a href="#10-safe-defaults-for-tak" class="hash-link" aria-label="Direct link to 10) Safe defaults for TAK" title="Direct link to 10) Safe defaults for TAK">​</a></h2>
<ul>
<li>Default <strong>allowlist</strong> as above, <strong>pageSize=500</strong>, <strong>sizeLimit=1000</strong>, <strong>timeLimit=3s</strong>.</li>
<li>Disable persistent search / VLV / server-side sort in v1 (TAK doesn’t need them), return <code>12</code> if critical.</li>
</ul>
<hr>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="bottom-line">Bottom line<a href="#bottom-line" class="hash-link" aria-label="Direct link to Bottom line" title="Direct link to Bottom line">​</a></h2>
<ul>
<li>
<p><strong>Make v2 the main doc</strong>; it’s the right core.</p>
</li>
<li>
<p>The TAK/IGA info <strong>doesn’t change the engine</strong>, it <strong>configures it</strong>:</p>
<ul>
<li>certify SASL/EXTERNAL path,</li>
<li>set TAK-friendly filter/attribute allowlist,</li>
<li>ship a <strong>TAK mapping profile</strong> (YAML),</li>
<li>tune cache TTLs/invalidations,</li>
<li>expose optional PKI metadata attributes.</li>
</ul>
</li>
</ul>
<p>If you want, I can drop a PR-ready <strong>“TAK Profile”</strong> YAML, the <strong>membership search contract</strong> stub with cursor paging, and the tests for the <strong>bad-cookie → 53</strong> behavior so you can merge and move on.</p>
<p>Replace it. Make the v2 spec your primary doc, and fold the latest nits in as <strong>v2.1</strong> so nobody has to diff across messages. Below is a clean “final cut” you can drop in, plus tiny code patches and a ready-to-scaffold checklist.</p>
<hr>
<h1>LDAP VDS — Implementation Spec v2.1 (final)</h1>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="protocol--paging-locked">Protocol &amp; Paging (locked)<a href="#protocol--paging-locked" class="hash-link" aria-label="Direct link to Protocol &amp; Paging (locked)" title="Direct link to Protocol &amp; Paging (locked)">​</a></h2>
<ul>
<li>
<p><strong>Framing</strong>: per-connection growable buffer; decode BER in a loop; guard with <code>max_pdu_bytes</code>; handle <code>SubstrateUnderrunError</code> <strong>and</strong> generic <code>PyAsn1Error</code>.</p>
</li>
<li>
<p><strong>Unknown op</strong>: send <strong>Unsolicited Notice of Disconnection</strong> (<code>1.3.6.1.4.1.1466.20036</code>) with <code>protocolError (2)</code> and close.</p>
</li>
<li>
<p><strong>RFC 2696</strong>:</p>
<ul>
<li>
<p>Bad/expired cookie → <strong><code>unwillingToPerform (53)</code></strong> and include a <strong>paged response control with empty cookie</strong>.</p>
</li>
<li>
<p><strong>Global</strong> <code>sizeLimit</code>/<code>timeLimit</code> (not per-page):</p>
<ul>
<li>If the search hits <code>sizeLimit</code>, return <code>sizeLimitExceeded (4)</code> and <strong>do not</strong> include a continuation cookie.</li>
<li>If <code>timeLimit</code> elapses, return <code>timeLimitExceeded (3)</code> and <strong>cancel</strong> downstream calls; <strong>no cookie</strong>.</li>
</ul>
</li>
</ul>
</li>
<li>
<p><strong>Backpressure</strong>: bounded send queue, <code>drain()</code> timeout; on overflow/timeouts: unsolicited notice → close; cancel in-flight tasks.</p>
</li>
<li>
<p><strong>TLS</strong>: <strong>LDAPS-only v1</strong>; StartTLS off. If PROXY v2 is used, it must be <strong>pre-TLS</strong> (TLS passthrough LB); the listener consumes PROXY v2 before handshake.</p>
</li>
</ul>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="filters--matching-locked">Filters &amp; Matching (locked)<a href="#filters--matching-locked" class="hash-link" aria-label="Direct link to Filters &amp; Matching (locked)" title="Direct link to Filters &amp; Matching (locked)">​</a></h2>
<ul>
<li><strong>ASN.1-first</strong> (rfc4511) → internal AST. Allowed attrs &amp; rules <strong>only from YAML</strong>.</li>
<li>Allowed ops: <code>Eq</code>, <code>Present</code>, <code>Substr</code> (prefix/any/final), <code>And</code>, <code>Or</code>, <code>Not</code>.</li>
<li>Matching rules: <code>caseIgnore</code> for <code>uid/cn/mail/sAMAccountName</code>; equality and substring inputs are <strong>normalized</strong> via <code>casefold()</code> before translation.</li>
</ul>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="paging-state--cookies-locked">Paging State &amp; Cookies (locked)<a href="#paging-state--cookies-locked" class="hash-link" aria-label="Direct link to Paging State &amp; Cookies (locked)" title="Direct link to Paging State &amp; Cookies (locked)">​</a></h2>
<ul>
<li>Deterministic global order (<code>subject</code> casefold asc).</li>
<li>Aggregator returns a <strong>composite cursor</strong> (per-source offsets/cookies); cookie is stateless and <strong>HMAC-signed envelope that includes <code>kid</code></strong> (supports rotation).</li>
<li>Enforce <code>max_cookie_bytes</code> (target ≤ 2 KiB). If exceeded, return <code>unwillingToPerform (53)</code> with empty cookie.</li>
</ul>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="controls-locked">Controls (locked)<a href="#controls-locked" class="hash-link" aria-label="Direct link to Controls (locked)" title="Direct link to Controls (locked)">​</a></h2>
<ul>
<li>Parse/verify criticality. Unknown <strong>critical</strong> control → <code>unavailableCriticalExtension (12)</code>.</li>
<li>Supported in v1: <strong>RFC 2696</strong> only.</li>
</ul>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="caching-locked">Caching (locked)<a href="#caching-locked" class="hash-link" aria-label="Direct link to Caching (locked)" title="Direct link to Caching (locked)">​</a></h2>
<ul>
<li>L1 per-proc (60s). L2 Redis (JSON; no pickle). Lua single-flight + jitter.</li>
<li>Keys:
<code>vds:{tenant}:attrs:{subject}</code>, <code>vds:{tenant}:groups:{subject}</code>, <code>vds:{tenant}:subjects:{qhash}:{cursor|none}:{n}</code></li>
<li>CDC/Kafka invalidation: user change → <code>DEL attrs:{subject}</code>; membership change → <code>DEL groups:{subject}</code> and <code>attrs:{subject}</code>.</li>
</ul>
<hr>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="drop-in-code-patches-apply-as-is">Drop-in code patches (apply as-is)<a href="#drop-in-code-patches-apply-as-is" class="hash-link" aria-label="Direct link to Drop-in code patches (apply as-is)" title="Direct link to Drop-in code patches (apply as-is)">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="1-unsolicited-notice-correct-oid-type">1) Unsolicited notice (correct OID type)<a href="#1-unsolicited-notice-correct-oid-type" class="hash-link" aria-label="Direct link to 1) Unsolicited notice (correct OID type)" title="Direct link to 1) Unsolicited notice (correct OID type)">​</a></h3>
<div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token comment" style="color:rgb(98, 114, 164)"># vds/server/encoder.py</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">from</span><span class="token plain"> pyasn1_modules </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">import</span><span class="token plain"> rfc4511</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">NOTICE_OID </span><span class="token operator">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&#x27;1.3.6.1.4.1.1466.20036&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">def</span><span class="token plain"> </span><span class="token function" style="color:rgb(80, 250, 123)">unsolicited_notice</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">result_code</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(189, 147, 249)">int</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> diag</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(189, 147, 249)">str</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token plain"> rfc4511</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">LDAPMessage</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    msg </span><span class="token operator">=</span><span class="token plain"> rfc4511</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">LDAPMessage</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    msg</span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token string" style="color:rgb(255, 121, 198)">&#x27;messageID&#x27;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token number">0</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    ext </span><span class="token operator">=</span><span class="token plain"> rfc4511</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">ExtendedResponse</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    ext</span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token string" style="color:rgb(255, 121, 198)">&#x27;resultCode&#x27;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> result_code</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    ext</span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token string" style="color:rgb(255, 121, 198)">&#x27;diagnosticMessage&#x27;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> diag</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    ext</span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token string" style="color:rgb(255, 121, 198)">&#x27;responseName&#x27;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> rfc4511</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">LDAPOID</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">NOTICE_OID</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    msg</span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token string" style="color:rgb(255, 121, 198)">&#x27;protocolOp&#x27;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> rfc4511</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">LDAPMessage_protocolOp</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">setComponentByName</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token string" style="color:rgb(255, 121, 198)">&#x27;extendedResp&#x27;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> ext</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">return</span><span class="token plain"> msg</span><br></span></code></pre></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="2-reader-hardening--cleanup">2) Reader hardening + cleanup<a href="#2-reader-hardening--cleanup" class="hash-link" aria-label="Direct link to 2) Reader hardening + cleanup" title="Direct link to 2) Reader hardening + cleanup">​</a></h3>
<div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token comment" style="color:rgb(98, 114, 164)"># vds/server/protocol.py (excerpts)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">from</span><span class="token plain"> pyasn1</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">codec</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">ber </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">import</span><span class="token plain"> decoder</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> encoder</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">from</span><span class="token plain"> pyasn1</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">error </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">import</span><span class="token plain"> SubstrateUnderrunError</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> PyAsn1Error</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">from</span><span class="token plain"> pyasn1_modules </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">import</span><span class="token plain"> rfc4511</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">import</span><span class="token plain"> contextlib</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">async</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">def</span><span class="token plain"> </span><span class="token function" style="color:rgb(80, 250, 123)">_read_message</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">self</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">while</span><span class="token plain"> </span><span class="token boolean">True</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">if</span><span class="token plain"> self</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">_buf</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">try</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                msg</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> rest </span><span class="token operator">=</span><span class="token plain"> decoder</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">decode</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token builtin" style="color:rgb(189, 147, 249)">bytes</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">self</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">_buf</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> asn1Spec</span><span class="token operator">=</span><span class="token plain">rfc4511</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">LDAPMessage</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                self</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">_buf </span><span class="token operator">=</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(189, 147, 249)">bytearray</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">rest</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">return</span><span class="token plain"> msg</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">except</span><span class="token plain"> SubstrateUnderrunError</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">pass</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">except</span><span class="token plain"> PyAsn1Error</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">await</span><span class="token plain"> self</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">_send</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">unsolicited_notice</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token number">2</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;protocolError: decode failure&quot;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                self</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">w</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">close</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">return</span><span class="token plain"> </span><span class="token boolean">None</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">if</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(189, 147, 249)">len</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">self</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">_buf</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token operator">&gt;</span><span class="token plain"> self</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">deps</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">cfg</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">server</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">max_pdu_bytes</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">await</span><span class="token plain"> self</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">_send</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">unsolicited_notice</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token number">2</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;protocolError: PDU too large&quot;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            self</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">w</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">close</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">return</span><span class="token plain"> </span><span class="token boolean">None</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        chunk </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">await</span><span class="token plain"> self</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">r</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">read</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">self</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">deps</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">cfg</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">server</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">read_chunk</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">if</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">not</span><span class="token plain"> chunk</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">return</span><span class="token plain"> </span><span class="token boolean">None</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        self</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">_buf</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">extend</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">chunk</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">async</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">def</span><span class="token plain"> </span><span class="token function" style="color:rgb(80, 250, 123)">run</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">self</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">try</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">while</span><span class="token plain"> </span><span class="token boolean">True</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            msg </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">await</span><span class="token plain"> self</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">_read_message</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">if</span><span class="token plain"> msg </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">is</span><span class="token plain"> </span><span class="token boolean">None</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">break</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token comment" style="color:rgb(98, 114, 164)"># dispatch...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">finally</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        self</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">_sender_task</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">cancel</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">with</span><span class="token plain"> contextlib</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">suppress</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">asyncio</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">CancelledError</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">await</span><span class="token plain"> self</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">_sender_task</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        self</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">w</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">close</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">with</span><span class="token plain"> contextlib</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">suppress</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">Exception</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">await</span><span class="token plain"> self</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">w</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">wait_closed</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><br></span></code></pre></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="3-controls-criticality--invalid-cookie--53--empty-cookie">3) Controls criticality &amp; invalid cookie → 53 + empty cookie<a href="#3-controls-criticality--invalid-cookie--53--empty-cookie" class="hash-link" aria-label="Direct link to 3) Controls criticality &amp; invalid cookie → 53 + empty cookie" title="Direct link to 3) Controls criticality &amp; invalid cookie → 53 + empty cookie">​</a></h3>
<div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token comment" style="color:rgb(98, 114, 164)"># vds/server/controls.py (excerpts)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">def</span><span class="token plain"> </span><span class="token function" style="color:rgb(80, 250, 123)">parse_paged_req</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">controls</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    size</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> cookie </span><span class="token operator">=</span><span class="token plain"> </span><span class="token boolean">None</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token boolean">None</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">if</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">not</span><span class="token plain"> controls</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">return</span><span class="token plain"> size</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> cookie</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">for</span><span class="token plain"> ctl </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">in</span><span class="token plain"> controls</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        oid </span><span class="token operator">=</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(189, 147, 249)">str</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">ctl</span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token string" style="color:rgb(255, 121, 198)">&#x27;controlType&#x27;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        critical </span><span class="token operator">=</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(189, 147, 249)">bool</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">ctl</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">getComponentByName</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token string" style="color:rgb(255, 121, 198)">&#x27;criticality&#x27;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain">  </span><span class="token comment" style="color:rgb(98, 114, 164)"># defaults False</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">if</span><span class="token plain"> oid </span><span class="token operator">==</span><span class="token plain"> PAGED_OID</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            val </span><span class="token operator">=</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(189, 147, 249)">bytes</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">ctl</span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token string" style="color:rgb(255, 121, 198)">&#x27;controlValue&#x27;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        seq</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> _ </span><span class="token operator">=</span><span class="token plain"> decoder</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">decode</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">val</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> asn1Spec</span><span class="token operator">=</span><span class="token plain">PagedResultsRequestValue</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        size </span><span class="token operator">=</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(189, 147, 249)">int</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">seq</span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token string" style="color:rgb(255, 121, 198)">&#x27;size&#x27;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"> cookie </span><span class="token operator">=</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(189, 147, 249)">bytes</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">seq</span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token string" style="color:rgb(255, 121, 198)">&#x27;cookie&#x27;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">or</span><span class="token plain"> </span><span class="token boolean">None</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">elif</span><span class="token plain"> critical</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">raise</span><span class="token plain"> LdapError</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token number">12</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;unavailableCriticalExtension&quot;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">return</span><span class="token plain"> size</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> cookie</span><br></span></code></pre></div></div>
<p>Caller side:</p>
<div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token comment" style="color:rgb(98, 114, 164)"># when cookie is present but verify_cookie(...) returns None:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">done </span><span class="token operator">=</span><span class="token plain"> search_done</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">mid</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token number">53</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;invalid paging cookie&quot;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> controls</span><span class="token operator">=</span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token plain">make_paged_resp</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token boolean">None</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">await</span><span class="token plain"> self</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">_send</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">done</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">return</span><br></span></code></pre></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="4-cookie-hmac-over-the-full-envelope-bind-kid">4) Cookie HMAC over the full envelope (bind <code>kid</code>)<a href="#4-cookie-hmac-over-the-full-envelope-bind-kid" class="hash-link" aria-label="Direct link to 4-cookie-hmac-over-the-full-envelope-bind-kid" title="Direct link to 4-cookie-hmac-over-the-full-envelope-bind-kid">​</a></h3>
<div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token comment" style="color:rgb(98, 114, 164)"># vds/utils/paging_cookie.py</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">def</span><span class="token plain"> </span><span class="token function" style="color:rgb(80, 250, 123)">sign_cookie</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">state</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(189, 147, 249)">dict</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(189, 147, 249)">bytes</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    envelope </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token string" style="color:rgb(255, 121, 198)">&quot;kid&quot;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> KEYS</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">primary</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token builtin" style="color:rgb(189, 147, 249)">id</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;state&quot;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> state</span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    body </span><span class="token operator">=</span><span class="token plain"> json</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">dumps</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">envelope</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> separators</span><span class="token operator">=</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token string" style="color:rgb(255, 121, 198)">&#x27;,&#x27;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token string" style="color:rgb(255, 121, 198)">&#x27;:&#x27;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> sort_keys</span><span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">encode</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    mac </span><span class="token operator">=</span><span class="token plain"> hmac</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">new</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">KEYS</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">primary</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">key</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> body</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> hashlib</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">sha256</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">digest</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">return</span><span class="token plain"> base64</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">urlsafe_b64encode</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">mac </span><span class="token operator">+</span><span class="token plain"> body</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">def</span><span class="token plain"> </span><span class="token function" style="color:rgb(80, 250, 123)">verify_cookie</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">cookie</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(189, 147, 249)">bytes</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(189, 147, 249)">dict</span><span class="token plain"> </span><span class="token operator">|</span><span class="token plain"> </span><span class="token boolean">None</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">try</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        blob </span><span class="token operator">=</span><span class="token plain"> base64</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">urlsafe_b64decode</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">cookie</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        mac</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> body </span><span class="token operator">=</span><span class="token plain"> blob</span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token number">32</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> blob</span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token number">32</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        env </span><span class="token operator">=</span><span class="token plain"> json</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">loads</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">body</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"> kid </span><span class="token operator">=</span><span class="token plain"> env</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">get</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token string" style="color:rgb(255, 121, 198)">&quot;kid&quot;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"> state </span><span class="token operator">=</span><span class="token plain"> env</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">get</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token string" style="color:rgb(255, 121, 198)">&quot;state&quot;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">for</span><span class="token plain"> key </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">in</span><span class="token plain"> KEYS</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">keys_for</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">kid</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">if</span><span class="token plain"> hmac</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">compare_digest</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">mac</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> hmac</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">new</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">key</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> body</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> hashlib</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">sha256</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">digest</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">return</span><span class="token plain"> state</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">return</span><span class="token plain"> </span><span class="token boolean">None</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">except</span><span class="token plain"> Exception</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">return</span><span class="token plain"> </span><span class="token boolean">None</span><br></span></code></pre></div></div>
<hr>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="spec-clarifications-document-these-in-the-design">Spec clarifications (document these in the design)<a href="#spec-clarifications-document-these-in-the-design" class="hash-link" aria-label="Direct link to Spec clarifications (document these in the design)" title="Direct link to Spec clarifications (document these in the design)">​</a></h2>
<ul>
<li>
<p><strong>Limits semantics</strong>:</p>
<ul>
<li><code>sizeLimit</code> is <strong>global across the search</strong>, not per page. When exceeded, respond <strong><code>4</code></strong> and <strong>no cookie</strong>.</li>
<li><code>timeLimit</code> is <strong>global</strong>; cancel backend work; respond <strong><code>3</code></strong>; <strong>no cookie</strong>.</li>
</ul>
</li>
<li>
<p><strong>Case rules</strong>:</p>
<ul>
<li>Sorting key: <code>subject.casefold()</code> ascending.</li>
<li>Equality/substring matching for <code>uid</code>, <code>cn</code>, <code>mail</code>, <code>sAMAccountName</code> uses case-insensitive normalization.</li>
</ul>
</li>
<li>
<p><strong>DN canonicalization</strong>:</p>
<ul>
<li>RDN attributes (<code>uid</code>, <code>cn</code>) are lowercased when building the DN (attributes themselves keep original case); escape per RFC 4514.</li>
</ul>
</li>
</ul>
<hr>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="tests-to-add-before-scaffolding">Tests to add (before scaffolding)<a href="#tests-to-add-before-scaffolding" class="hash-link" aria-label="Direct link to Tests to add (before scaffolding)" title="Direct link to Tests to add (before scaffolding)">​</a></h2>
<ul>
<li><strong>Cookie integrity</strong>: tamper <code>kid</code> with same MAC → reject.</li>
<li><strong>Decode error</strong>: malformed BER triggers unsolicited notice + close.</li>
<li><strong>Oversized PDU</strong>: exceeds <code>max_pdu_bytes</code> → notice + close.</li>
<li><strong>Drain timeout</strong>: force slow consumer; verify overflow metric + close.</li>
<li><strong>Invalid cookie</strong>: returns <code>53</code> with empty paged cookie control.</li>
<li><strong>Limits</strong>: global <code>sizeLimit</code>/<code>timeLimit</code> behavior (no continuation cookie).</li>
<li><strong>PROXY v2</strong>: header consumed pre-TLS; fallback disabled when TLS terminates upstream.</li>
<li><strong>CaseIgnore</strong>: property-based tests for equality/substring normalization.</li>
</ul>
<hr>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="ready-to-scaffold-checklist">Ready-to-scaffold checklist<a href="#ready-to-scaffold-checklist" class="hash-link" aria-label="Direct link to Ready-to-scaffold checklist" title="Direct link to Ready-to-scaffold checklist">​</a></h2>
<ul class="contains-task-list containsTaskList_mC6p">
<li class="task-list-item"><input type="checkbox" disabled=""> <!-- -->Land patches above in <code>encoder.py</code>, <code>protocol.py</code>, <code>controls.py</code>, <code>paging_cookie.py</code>.</li>
<li class="task-list-item"><input type="checkbox" disabled=""> <!-- -->Lock YAML <code>filters.allow_attrs</code> + <code>matching</code> and remove any hardcoded allowlists.</li>
<li class="task-list-item"><input type="checkbox" disabled=""> <!-- -->Define provider contracts (LDAP/REST/SQL) with deterministic order &amp; cursor/token.</li>
<li class="task-list-item"><input type="checkbox" disabled=""> <!-- -->Implement <code>exec.search_executor</code> to <strong>raise</strong> <code>LdapError</code> (not return tuples) on invalid cookie/time/size violations; the protocol layer maps to result codes + controls.</li>
<li class="task-list-item"><input type="checkbox" disabled=""> <!-- -->Add <code>max_pdu_bytes</code>, <code>read_chunk</code>, <code>drain_timeout_s</code>, <code>max_send_queue_items</code> to config; cover with tests.</li>
<li class="task-list-item"><input type="checkbox" disabled=""> <!-- -->Add task cancellation hooks on disconnect/error (membership, PDP, groups).</li>
<li class="task-list-item"><input type="checkbox" disabled=""> <!-- -->Wire Lua single-flight &amp; negative caches with tests.</li>
<li class="task-list-item"><input type="checkbox" disabled=""> <!-- -->Write the limits/controls test suite (above).</li>
</ul>
<hr>
<p>If you want, I can spit out a repo skeleton (files + minimal tests) with these exact behaviors wired so you can <code>poetry run pytest</code> and start stubbing membership/PDP immediately.</p>
<hr>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="18-connector-extraction-from-crudservice-inventory--plan">18) Connector extraction from CRUDService (inventory &amp; plan)<a href="#18-connector-extraction-from-crudservice-inventory--plan" class="hash-link" aria-label="Direct link to 18) Connector extraction from CRUDService (inventory &amp; plan)" title="Direct link to 18) Connector extraction from CRUDService (inventory &amp; plan)">​</a></h2>
<p>Goal: reuse the battle‑tested connector logic while removing CRUDService‑specific dependencies and keeping VDS standalone. Keep the YAML schema (System Types/Definitions) identical for consistency.</p>
<p>What to bring (by connector)</p>
<ul>
<li>LDAP/AD<!-- -->
<ul>
<li>Keep: ldap3 client, LDAPS/StartTLS options, connection pooling, RFC 2696 paged search, optional server‑side sort, DN validation (<code>safe_dn</code> equivalent), retry/backoff (tenacity), timeouts, idempotent read paths.</li>
<li>Drop for VDS v1: write/modify flows (add/modify/delete, group membership updates, password reset), Kafka hooks, CRUD metrics wrappers.</li>
<li>Replace: FastAPI <code>HTTPException</code> → <code>ProviderError</code>; Vault/CredentialManager → <code>SecretsProvider</code> (env first, pluggable); TemplateRendererConfigurator → minimal jinja2.</li>
</ul>
</li>
<li>REST<!-- -->
<ul>
<li>Keep: httpx client with retries/backoff, path templating, header injection hook (auth builder), expected outcomes mapping.</li>
<li>Drop: FastAPI/CRUD wrappers, plugin loader coupling.</li>
<li>Replace: exceptions/metrics with VDS equivalents.</li>
</ul>
</li>
<li>SQL/ODBC<!-- -->
<ul>
<li>Keep: parameterized execution, keyset pagination (<code>ORDER BY lower(subject), id</code>), timeout handling.</li>
<li>Drop: CRUD‑specific mapping scaffolding beyond query execution.</li>
<li>Note: prefer SQLAlchemy core or pyodbc; strictly no string‑built SQL in VDS.</li>
</ul>
</li>
</ul>
<p>Neutral interfaces to implement in VDS</p>
<ul>
<li><code>class Provider</code> with <code>async def search(filter_ast, base_dn, scope, page_size, cursor) -&gt; (rows, next_cursor)</code></li>
<li><code>class SecretsProvider</code> with <code>get(name) -&gt; str | None</code> (env; vault/azure optional later)</li>
<li><code>class ConnectorError(ProviderError)</code> hierarchy for consistent error handling</li>
</ul>
<p>Dependencies required in VDS (runtime)</p>
<ul>
<li>ldap3, httpx, jinja2, PyYAML, tenacity</li>
<li>One of: SQLAlchemy + appropriate DB driver (e.g., pyodbc) if using SQL providers</li>
<li>Optional: pydantic (only if we keep strict models; can be avoided)</li>
</ul>
<p>What to exclude from CRUDService</p>
<ul>
<li>FastAPI types (<code>HTTPException</code>), VaultService/CredentialManager, TemplateRendererConfigurator, ExecutionContext coupling, Kafka producers, plugin registry specifics, CRUD‑specific metrics wrappers.</li>
</ul>
<p>Vended code structure in VDS</p>
<ul>
<li><code>vds/providers/connectors/</code>
<ul>
<li><code>ldap.py</code>, <code>ad.py</code> (if you keep vendor differences), <code>rest.py</code>, <code>odbc.py</code>, <code>base.py</code></li>
<li><code>config_loader.py</code> (YAML + jinja2; env substitution), <code>secrets.py</code> (env‑first), <code>registry.py</code> (type→class map)</li>
</ul>
</li>
<li>All connectors use VDS metrics facade and raise VDS exceptions.</li>
</ul>
<p>Testing focus after extraction</p>
<ul>
<li>LDAP: RFC 2696 page loop, server‑sort off/on (optional), DN validation, retry/backoff paths</li>
<li>REST: token paging, retry/backoff, header injection</li>
<li>SQL: keyset paging correctness and deterministic ordering</li>
</ul>
<hr>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="19-config-conventions-system-types-and-system-definitions">19) Config conventions: System Types and System Definitions<a href="#19-config-conventions-system-types-and-system-definitions" class="hash-link" aria-label="Direct link to 19) Config conventions: System Types and System Definitions" title="Direct link to 19) Config conventions: System Types and System Definitions">​</a></h2>
<p>Use the same layout and schema as CRUDService, without a runtime dependency:</p>
<ul>
<li><code>ServiceConfigs/connectors/system_types/*.yaml</code> (e.g., <code>AD.yaml</code>, <code>openldap.yaml</code>, <code>auth0.yaml</code>, <code>ODBC.yaml</code>)</li>
<li><code>ServiceConfigs/connectors/systems/*.yaml</code> (e.g., <code>addomain_ad.yaml</code>, <code>auth0_eid.yaml</code>, <code>hr_db.yaml</code>)</li>
</ul>
<p>VDS wiring (<code>connectors.yaml</code>) points to System Definitions and the action to run:</p>
<div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token key atrule">directories</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token key atrule">person</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token key atrule">sources</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain"> </span><span class="token key atrule">system</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> addomain_ad</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token key atrule">object_type</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> user</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token key atrule">action</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> search_users</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token key atrule">key_fields</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token key atrule">subject</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> sAMAccountName</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token key atrule">id</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> objectGUID</span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain"> </span><span class="token key atrule">system</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> auth0_eid</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token key atrule">object_type</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> users</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token key atrule">action</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> list</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token key atrule">key_fields</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token key atrule">subject</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> email</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token key atrule">id</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> user_id</span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token key atrule">group</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token key atrule">sources</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain"> </span><span class="token key atrule">system</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> addomain_ad</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token key atrule">object_type</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> group</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token key atrule">action</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> search_groups</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token key atrule">key_fields</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token key atrule">subject</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> cn</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token key atrule">id</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> objectGUID</span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><br></span></code></pre></div></div>
<p>Notes</p>
<ul>
<li>Keep CRUD’s YAML semantics (object_types/commands, templated params). VDS supplies normalized filter parameters; providers translate to native queries.</li>
<li>Place configs in a neutral path and validate them in CI; VDS reads them directly (no CRUD imports).</li>
</ul>
<hr>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="191-crudservice-parity-plan-factory-credentials-templating">19.1) CRUDService Parity Plan (factory, credentials, templating)<a href="#191-crudservice-parity-plan-factory-credentials-templating" class="hash-link" aria-label="Direct link to 19.1) CRUDService Parity Plan (factory, credentials, templating)" title="Direct link to 19.1) CRUDService Parity Plan (factory, credentials, templating)">​</a></h2>
<p>We will mirror the mature CRUDService patterns where they add robustness and reduce reinvention, while keeping VDS standalone and LDAP-focused.</p>
<p>Adopt as-is (or minimalized):</p>
<ul>
<li>Provider factory via registry file (connectors.yaml)<!-- -->
<ul>
<li>Load <code>connector_registry</code> and map Type → module/class</li>
<li>Constructor introspection to pass optional kwargs when accepted (e.g., <code>system_name</code>, <code>credential_manager</code>, <code>auth_header_builder</code>, <code>vault_service</code>) and otherwise fall back to simplified config kwargs</li>
</ul>
</li>
<li>Templating<!-- -->
<ul>
<li>Use a lightweight Jinja2 renderer for connectors; consistent render context exposing <code>params</code>, <code>connection</code>, and <code>system.connection</code> so existing system-type templates render unchanged</li>
</ul>
</li>
<li>Credentials<!-- -->
<ul>
<li>Start with env/static <code>CredentialManager</code> (basic, bearer, api-key) and keep an interface point to plug a vault provider later; preserve precedence (request → vault → static) when vault is enabled</li>
</ul>
</li>
<li>Error envelope<!-- -->
<ul>
<li>Providers return structured errors with status_code and upstream diagnostic payload; executor maps to LDAP results or forwards detail as needed</li>
</ul>
</li>
<li>Observability<!-- -->
<ul>
<li>Wrap provider actions with latency metrics and tracing attributes (cardinality-safe)</li>
</ul>
</li>
</ul>
<p>Justified deviations (VDS-specific):</p>
<ul>
<li>Keep LDAP write operations (ADD/MOD/DEL) out of scope for v1; only search flows are needed by VDS</li>
<li>No runtime dependency on CRUDService; we only replicate the necessary patterns and interfaces</li>
<li>Simplify connectors surface to the VDS Provider interface; reuse system-types commands for REST/LDAP where available</li>
</ul>
<p>Actionable backlog (tracked in repo TODOs):</p>
<ul>
<li>Add constructor introspection and DI in the provider registry</li>
<li>Implement minimal <code>CredentialManager</code> (env/static) with future vault hook</li>
<li>Add Jinja renderer + context enrichment in providers</li>
<li>Extend REST provider with <code>perform_action</code> (templated endpoint/body/headers) and structured errors</li>
<li>Deep-merge system types and system definitions (object_types/commands) with overrides</li>
<li>Wire aggregator to resolve command definitions (object_type/action) and invoke providers accordingly</li>
<li>Instrument providers with metrics/tracing; keep labels low-cardinality</li>
</ul>
<p>Compatibility impact:</p>
<ul>
<li>Existing CRUD-style system types/definitions and connectors.yaml can be reused in VDS without authors learning a new schema. Optional vault and advanced flows can be enabled later without breaking changes.</li>
</ul></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="row margin-top--sm theme-doc-footer-edit-meta-row"><div class="col"><a href="https://github.com/facebook/docusaurus/tree/main/packages/create-docusaurus/templates/shared/docs/source_content/design.md" target="_blank" rel="noopener noreferrer" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_Z9Sw" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_JAkA"></div></div></footer></article><nav class="docusaurus-mt-lg pagination-nav" aria-label="Docs pages"></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#what-changed-since-v1-delta" class="table-of-contents__link toc-highlight">What changed since v1 (delta)</a></li><li><a href="#1-repository-unchanged-layout-noted-deltas" class="table-of-contents__link toc-highlight">1) Repository (unchanged layout, noted deltas)</a></li><li><a href="#2-protocol-robust-pdu-framing-unknown-ops-backpressure" class="table-of-contents__link toc-highlight">2) Protocol: robust PDU framing, unknown ops, backpressure</a><ul><li><a href="#pdu-reader-per-connection-buffer" class="table-of-contents__link toc-highlight">PDU reader (per-connection buffer)</a></li><li><a href="#unknown-ops--notice-of-disconnection" class="table-of-contents__link toc-highlight">Unknown ops → Notice of Disconnection</a></li></ul></li><li><a href="#3-controls-rfc-2696--invalid-cookie-semantics" class="table-of-contents__link toc-highlight">3) Controls (RFC 2696) + invalid-cookie semantics</a></li><li><a href="#4-paging-state-aggregator--deterministic-order" class="table-of-contents__link toc-highlight">4) Paging state: aggregator + deterministic order</a></li><li><a href="#5-filter-whitelist--matching-rules-yaml-driven" class="table-of-contents__link toc-highlight">5) Filter whitelist + matching rules (YAML-driven)</a></li><li><a href="#20-realworld-operational-requirements" class="table-of-contents__link toc-highlight">20) Real‑world operational requirements</a><ul><li><a href="#answer" class="table-of-contents__link toc-highlight">Answer</a></li><li><a href="#gaps-to-close-small" class="table-of-contents__link toc-highlight">Gaps to close (small)</a></li></ul></li><li><a href="#21-deduplication-and-attribute-merge-policy" class="table-of-contents__link toc-highlight">21) Deduplication and attribute merge policy</a></li><li><a href="#22-implementation-alignment-v21" class="table-of-contents__link toc-highlight">22) Implementation alignment (v2.1)</a></li><li><a href="#6-dn-canonicalization" class="table-of-contents__link toc-highlight">6) DN canonicalization</a></li><li><a href="#7-redis-single-flight-lua-json-only" class="table-of-contents__link toc-highlight">7) Redis single-flight (Lua), JSON only</a></li><li><a href="#8-backpressure--timeouts" class="table-of-contents__link toc-highlight">8) Backpressure &amp; timeouts</a></li><li><a href="#9-tls--client-identity" class="table-of-contents__link toc-highlight">9) TLS &amp; client identity</a></li><li><a href="#91-rootdse-and-base-search" class="table-of-contents__link toc-highlight">9.1) RootDSE and base search</a></li><li><a href="#10-connectors--pdp-contracts-frozen" class="table-of-contents__link toc-highlight">10) Connectors &amp; PDP contracts (frozen)</a><ul><li><a href="#connectors-per-source" class="table-of-contents__link toc-highlight">Connectors (per source)</a></li><li><a href="#pdp" class="table-of-contents__link toc-highlight">PDP</a></li></ul></li><li><a href="#11-search-executor-cursor-paging-cookie-rotation" class="table-of-contents__link toc-highlight">11) Search executor (cursor paging, cookie rotation)</a></li><li><a href="#12-testing-additions-must-haves" class="table-of-contents__link toc-highlight">12) Testing additions (must-haves)</a></li><li><a href="#13-metricstracing-cardinality-safe" class="table-of-contents__link toc-highlight">13) Metrics/tracing (cardinality-safe)</a></li><li><a href="#14-example-unsolicited-notice-on-overflowunknown-op" class="table-of-contents__link toc-highlight">14) Example: Unsolicited notice on overflow/unknown op</a></li><li><a href="#15-example-yaml-driven-allowlist-in-translator" class="table-of-contents__link toc-highlight">15) Example: YAML-driven allowlist in translator</a></li><li><a href="#16-open-questions-unchanged-now-precise" class="table-of-contents__link toc-highlight">16) Open questions (unchanged, now precise)</a></li><li><a href="#17-ready-to-build-checklist" class="table-of-contents__link toc-highlight">17) Ready-to-build checklist</a></li><li><a href="#1-bind-modes-to-support" class="table-of-contents__link toc-highlight">1) Bind modes to support</a></li><li><a href="#2-attribute--filter-profile-keep-tak-queries-fast" class="table-of-contents__link toc-highlight">2) Attribute &amp; filter profile (keep TAK queries fast)</a></li><li><a href="#3-tak-object-mappings-vds-virtualization" class="table-of-contents__link toc-highlight">3) TAK object mappings (VDS virtualization)</a></li><li><a href="#4-deterministic-paging-for-large-tak-reads" class="table-of-contents__link toc-highlight">4) Deterministic paging for large TAK reads</a></li><li><a href="#5-caching-profile-for-tak" class="table-of-contents__link toc-highlight">5) Caching profile for TAK</a></li><li><a href="#6-certificate-lifecycle-signals-from-igapki-not-vds" class="table-of-contents__link toc-highlight">6) Certificate lifecycle signals (from IGA/PKI, not VDS)</a></li><li><a href="#7-dn--ou-conventions-for-tak" class="table-of-contents__link toc-highlight">7) DN &amp; OU conventions for TAK</a></li><li><a href="#8-tls-and-ca-hygiene-interop-more-than-code" class="table-of-contents__link toc-highlight">8) TLS and CA hygiene (interop more than code)</a></li><li><a href="#9-observability-that-helps-tak-ops" class="table-of-contents__link toc-highlight">9) Observability that helps TAK ops</a></li><li><a href="#10-safe-defaults-for-tak" class="table-of-contents__link toc-highlight">10) Safe defaults for TAK</a></li><li><a href="#bottom-line" class="table-of-contents__link toc-highlight">Bottom line</a></li><li><a href="#protocol--paging-locked" class="table-of-contents__link toc-highlight">Protocol &amp; Paging (locked)</a></li><li><a href="#filters--matching-locked" class="table-of-contents__link toc-highlight">Filters &amp; Matching (locked)</a></li><li><a href="#paging-state--cookies-locked" class="table-of-contents__link toc-highlight">Paging State &amp; Cookies (locked)</a></li><li><a href="#controls-locked" class="table-of-contents__link toc-highlight">Controls (locked)</a></li><li><a href="#caching-locked" class="table-of-contents__link toc-highlight">Caching (locked)</a></li><li><a href="#drop-in-code-patches-apply-as-is" class="table-of-contents__link toc-highlight">Drop-in code patches (apply as-is)</a><ul><li><a href="#1-unsolicited-notice-correct-oid-type" class="table-of-contents__link toc-highlight">1) Unsolicited notice (correct OID type)</a></li><li><a href="#2-reader-hardening--cleanup" class="table-of-contents__link toc-highlight">2) Reader hardening + cleanup</a></li><li><a href="#3-controls-criticality--invalid-cookie--53--empty-cookie" class="table-of-contents__link toc-highlight">3) Controls criticality &amp; invalid cookie → 53 + empty cookie</a></li><li><a href="#4-cookie-hmac-over-the-full-envelope-bind-kid" class="table-of-contents__link toc-highlight">4) Cookie HMAC over the full envelope (bind <code>kid</code>)</a></li></ul></li><li><a href="#spec-clarifications-document-these-in-the-design" class="table-of-contents__link toc-highlight">Spec clarifications (document these in the design)</a></li><li><a href="#tests-to-add-before-scaffolding" class="table-of-contents__link toc-highlight">Tests to add (before scaffolding)</a></li><li><a href="#ready-to-scaffold-checklist" class="table-of-contents__link toc-highlight">Ready-to-scaffold checklist</a></li><li><a href="#18-connector-extraction-from-crudservice-inventory--plan" class="table-of-contents__link toc-highlight">18) Connector extraction from CRUDService (inventory &amp; plan)</a></li><li><a href="#19-config-conventions-system-types-and-system-definitions" class="table-of-contents__link toc-highlight">19) Config conventions: System Types and System Definitions</a></li><li><a href="#191-crudservice-parity-plan-factory-credentials-templating" class="table-of-contents__link toc-highlight">19.1) CRUDService Parity Plan (factory, credentials, templating)</a></li></ul></div></div></div></div></main></div></div></div><footer class="theme-layout-footer footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="theme-layout-footer-column col footer__col"><div class="footer__title">Docs</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/empowernow_docs/docs/intro">Getting Started</a></li></ul></div><div class="theme-layout-footer-column col footer__col"><div class="footer__title">Marketing</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/empowernow_docs/">Home</a></li><li class="footer__item"><a class="footer__link-item" href="/empowernow_docs/docs/website_copy/solutions">Solutions</a></li><li class="footer__item"><a class="footer__link-item" href="/empowernow_docs/docs/website_copy/pricing">Pricing</a></li><li class="footer__item"><a class="footer__link-item" href="/empowernow_docs/docs/website_copy/products">Products</a></li><li class="footer__item"><a class="footer__link-item" href="/empowernow_docs/docs/website_copy/trust">Trust</a></li><li class="footer__item"><a class="footer__link-item" href="/empowernow_docs/docs/website_copy/resources">Resources</a></li><li class="footer__item"><a class="footer__link-item" href="/empowernow_docs/docs/website_copy/company">Company</a></li></ul></div><div class="theme-layout-footer-column col footer__col"><div class="footer__title">More</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://github.com/empowerID/empowernow_docs" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-hidden="true" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2025 EmpowerNow. Built with Docusaurus.</div></div></div></footer></div>
</body>
</html>