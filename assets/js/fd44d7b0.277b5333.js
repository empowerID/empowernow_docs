"use strict";(self.webpackChunkempowernow_docs=self.webpackChunkempowernow_docs||[]).push([[9832],{28453:(e,s,r)=>{r.d(s,{R:()=>c,x:()=>a});var n=r(96540);const i={},t=n.createContext(i);function c(e){const s=n.useContext(t);return n.useMemo(function(){return"function"==typeof e?e(s):{...s,...e}},[s,e])}function a(e){let s;return s=e.disableParentContext?"function"==typeof e.components?e.components(i):e.components||i:c(e.components),n.createElement(t.Provider,{value:s},e.children)}},79178:(e,s,r)=>{r.r(s),r.d(s,{assets:()=>o,contentTitle:()=>a,default:()=>u,frontMatter:()=>c,metadata:()=>n,toc:()=>d});const n=JSON.parse('{"id":"services/crud-service/how-to/audits-and-metrics","title":"Secret audits and metrics (non\u2011leaky)","description":"Audit schema, sampling, and key PEP/PDP/provider metrics for secrets usage.","source":"@site/docs/services/crud-service/how-to/audits-and-metrics.md","sourceDirName":"services/crud-service/how-to","slug":"/services/crud-service/how-to/audits-and-metrics","permalink":"/empowernow_docs/docs/services/crud-service/how-to/audits-and-metrics","draft":false,"unlisted":false,"editUrl":"https://github.com/facebook/docusaurus/tree/main/packages/create-docusaurus/templates/shared/docs/services/crud-service/how-to/audits-and-metrics.md","tags":[],"version":"current","frontMatter":{"title":"Secret audits and metrics (non\u2011leaky)","description":"Audit schema, sampling, and key PEP/PDP/provider metrics for secrets usage."}}');var i=r(74848),t=r(28453);const c={title:"Secret audits and metrics (non\u2011leaky)",description:"Audit schema, sampling, and key PEP/PDP/provider metrics for secrets usage."},a=void 0,o={},d=[{value:"Audit schema",id:"audit-schema",level:3},{value:"Visual: audit emission sequence",id:"visual-audit-emission-sequence",level:3},{value:"Sampling rules",id:"sampling-rules",level:3},{value:"Metrics",id:"metrics",level:3}];function l(e){const s={code:"code",h3:"h3",li:"li",mermaid:"mermaid",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,t.R)(),...e.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(s.h3,{id:"audit-schema",children:"Audit schema"}),"\n",(0,i.jsxs)(s.p,{children:["Required fields: ",(0,i.jsx)(s.code,{children:'timestamp, tenant_id, system_id, workflow_run_id, node_id, subject{sub, act?}, action="use", resource_ref, decision_id, policy_version, classification, purpose_of_use, kv_version?, lease_id?, lease_ttl?, cnf_jkt|mtls_thumbprint, token_jti'}),"."]}),"\n",(0,i.jsx)(s.h3,{id:"visual-audit-emission-sequence",children:"Visual: audit emission sequence"}),"\n",(0,i.jsx)(s.mermaid,{value:"sequenceDiagram\r\n  participant W as Workflow (/execute)\r\n  participant V as VaultService (PEP)\r\n  participant P as Provider (KVv2/DB)\r\n  participant K as Kafka (Audit)\r\n\r\n  W->>V: Request secret (pointer, ctx)\r\n  V->>V: Canonicalize \u2192 resource_ref\r\n  V->>P: Fetch secret (per grant)\r\n  P--\x3e>V: Value + metadata/lease\r\n  V->>K: Emit audit (resource_ref, decision, kv_version, lease, cnf, jti)\r\n  V--\x3e>W: Secret slot (redacted)"}),"\n",(0,i.jsx)(s.p,{children:"Example payload:"}),"\n",(0,i.jsx)(s.pre,{children:(0,i.jsx)(s.code,{className:"language-json",children:'{\r\n  "ts":"2025-01-01T00:00:00Z",\r\n  "tenant_id":"t-123",\r\n  "system_id":"jira",\r\n  "workflow_run_id":"wr-1",\r\n  "node_id":"n-2",\r\n  "subject":{"sub":"auth:account:github:octocat","act":null},\r\n  "action":"use",\r\n  "resource_ref":"hmac-abc",\r\n  "resource_arn":"auth:v1:resource:secret:openbao-X:abc",\r\n  "decision_id":"d-789",\r\n  "policy_version":"p-42",\r\n  "classification":"confidential",\r\n  "purpose_of_use":"execute",\r\n  "kv_version":12,\r\n  "lease_id":null,\r\n  "lease_ttl":null,\r\n  "cnf_jkt":"thumb",\r\n  "token_jti":"1a2b3c",\r\n  "event":"SECRET_PERMIT",\r\n  "sampled":true\r\n}\n'})}),"\n",(0,i.jsx)(s.h3,{id:"sampling-rules",children:"Sampling rules"}),"\n",(0,i.jsxs)(s.ul,{children:["\n",(0,i.jsxs)(s.li,{children:["Sample cache\u2011hit audits (1",":N","). Always emit DENY/ERROR/ROTATE."]}),"\n"]}),"\n",(0,i.jsx)(s.h3,{id:"metrics",children:"Metrics"}),"\n",(0,i.jsxs)(s.ul,{children:["\n",(0,i.jsxs)(s.li,{children:[(0,i.jsx)(s.strong,{children:"PEP latency"}),": ",(0,i.jsx)(s.code,{children:'pep_latency_ms{hit="grant|first"}'})]}),"\n",(0,i.jsxs)(s.li,{children:[(0,i.jsx)(s.strong,{children:"Grant hit ratio"}),": ",(0,i.jsx)(s.code,{children:"grant_hit_total"}),", ",(0,i.jsx)(s.code,{children:"grant_miss_total"})]}),"\n",(0,i.jsxs)(s.li,{children:[(0,i.jsx)(s.strong,{children:"Negative cache"}),": ",(0,i.jsx)(s.code,{children:"grant_negative_cache_hit_total"})]}),"\n",(0,i.jsxs)(s.li,{children:[(0,i.jsx)(s.strong,{children:"PDP"}),": ",(0,i.jsx)(s.code,{children:"pdp_latency_ms"}),", ",(0,i.jsx)(s.code,{children:"pdp_error_total"})]}),"\n",(0,i.jsxs)(s.li,{children:[(0,i.jsx)(s.strong,{children:"Provider circuits"}),": ",(0,i.jsx)(s.code,{children:"provider_circuit_open_total"})]}),"\n",(0,i.jsxs)(s.li,{children:[(0,i.jsx)(s.strong,{children:"Denies/sec by policy"}),": ",(0,i.jsx)(s.code,{children:"secret_denies_total{policy=...}"})]}),"\n",(0,i.jsxs)(s.li,{children:[(0,i.jsx)(s.strong,{children:"Anti\u2011replay"}),": ",(0,i.jsx)(s.code,{children:"anti_replay_total"})]}),"\n"]})]})}function u(e={}){const{wrapper:s}={...(0,t.R)(),...e.components};return s?(0,i.jsx)(s,{...e,children:(0,i.jsx)(l,{...e})}):l(e)}}}]);