"use strict";(self.webpackChunkempowernow_docs=self.webpackChunkempowernow_docs||[]).push([[5248],{28453:(e,n,s)=>{s.d(n,{R:()=>t,x:()=>o});var r=s(96540);const i={},c=r.createContext(i);function t(e){const n=r.useContext(c);return r.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function o(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(i):e.components||i:t(e.components),r.createElement(c.Provider,{value:n},e.children)}},81273:(e,n,s)=>{s.r(n),s.d(n,{assets:()=>d,contentTitle:()=>o,default:()=>h,frontMatter:()=>t,metadata:()=>r,toc:()=>l});const r=JSON.parse('{"id":"services/bff/how-to/update-routes-after-structure-change","title":"Update BFF routes after backend or path restructure","description":"Goal: fix broken SPA calls after service renames, path changes, or config moves.","source":"@site/docs/services/bff/how-to/update-routes-after-structure-change.md","sourceDirName":"services/bff/how-to","slug":"/services/bff/how-to/update-routes-after-structure-change","permalink":"/empowernow_docs/docs/services/bff/how-to/update-routes-after-structure-change","draft":false,"unlisted":false,"editUrl":"https://github.com/facebook/docusaurus/tree/main/packages/create-docusaurus/templates/shared/docs/services/bff/how-to/update-routes-after-structure-change.md","tags":[{"inline":true,"label":"service:bff","permalink":"/empowernow_docs/docs/tags/service-bff"},{"inline":true,"label":"type:how-to","permalink":"/empowernow_docs/docs/tags/type-how-to"},{"inline":true,"label":"roles:developer","permalink":"/empowernow_docs/docs/tags/roles-developer"},{"inline":true,"label":"roles:devops","permalink":"/empowernow_docs/docs/tags/roles-devops"}],"version":"current","frontMatter":{"id":"update-routes-after-structure-change","title":"Update BFF routes after backend or path restructure","sidebar_label":"Update routes after restructure","tags":["service:bff","type:how-to","roles:developer","roles:devops"]},"sidebar":"tutorialSidebar","previous":{"title":"Tune CB/cache","permalink":"/empowernow_docs/docs/services/bff/how-to/tune-legacy-circuit-cache"},"next":{"title":"Uploads, Downloads, and Streaming via the BFF","permalink":"/empowernow_docs/docs/services/bff/how-to/uploads-downloads-streaming"}}');var i=s(74848),c=s(28453);const t={id:"update-routes-after-structure-change",title:"Update BFF routes after backend or path restructure",sidebar_label:"Update routes after restructure",tags:["service:bff","type:how-to","roles:developer","roles:devops"]},o=void 0,d={},l=[];function a(e){const n={code:"code",li:"li",ol:"ol",p:"p",pre:"pre",ul:"ul",...(0,c.R)(),...e.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(n.p,{children:"Goal: fix broken SPA calls after service renames, path changes, or config moves."}),"\n",(0,i.jsx)(n.p,{children:"Prereqs"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["BFF running with ",(0,i.jsx)(n.code,{children:"ServiceConfigs/BFF/config"})," mounted to ",(0,i.jsx)(n.code,{children:"/app/config"})]}),"\n",(0,i.jsxs)(n.li,{children:["Access to edit ",(0,i.jsx)(n.code,{children:"routes.yaml"}),", ",(0,i.jsx)(n.code,{children:"settings.yaml"}),", and ",(0,i.jsx)(n.code,{children:"pdp.yaml"})]}),"\n"]}),"\n",(0,i.jsx)(n.p,{children:"Where to change things"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"ServiceConfigs/BFF/config/services"})," (inside ",(0,i.jsx)(n.code,{children:"routes.yaml"}),"): base URLs/timeouts per upstream"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"ServiceConfigs/BFF/config/routes.yaml"}),": client ",(0,i.jsx)(n.code,{children:"path"}),", ",(0,i.jsx)(n.code,{children:"target_service"}),", ",(0,i.jsx)(n.code,{children:"upstream_path"}),", ",(0,i.jsx)(n.code,{children:"methods"}),", ",(0,i.jsx)(n.code,{children:"auth"}),", ",(0,i.jsx)(n.code,{children:"authz"})]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"ServiceConfigs/BFF/config/pdp.yaml"}),": ",(0,i.jsx)(n.code,{children:"endpoint_map"})," for resource/action/id mapping"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"ServiceConfigs/BFF/config/settings.yaml"}),": CORS allowlist and redirect origins (dev vs prod)"]}),"\n"]}),"\n",(0,i.jsx)(n.p,{children:"Common symptoms \u2192 likely causes"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["404 at ",(0,i.jsx)(n.code,{children:"/api/..."}),": missing or mismatched ",(0,i.jsx)(n.code,{children:"path"})," in ",(0,i.jsx)(n.code,{children:"routes.yaml"}),"; Traefik not routing ",(0,i.jsx)(n.code,{children:"/api/**"})," to BFF"]}),"\n",(0,i.jsx)(n.li,{children:"401: missing session/cookies or wrong CORS/base URL in dev"}),"\n",(0,i.jsxs)(n.li,{children:["403 with ",(0,i.jsx)(n.code,{children:"NoMapping"}),": missing or outdated ",(0,i.jsx)(n.code,{children:"endpoint_map"})," entry in ",(0,i.jsx)(n.code,{children:"pdp.yaml"})]}),"\n",(0,i.jsxs)(n.li,{children:["403 with ",(0,i.jsx)(n.code,{children:"Deny"}),": PDP policy denies; mapping exists but subject lacks permission"]}),"\n",(0,i.jsxs)(n.li,{children:["502/timeout: wrong ",(0,i.jsx)(n.code,{children:"services.*.base_url"})," or upstream down"]}),"\n"]}),"\n",(0,i.jsx)(n.p,{children:"Step-by-step"}),"\n",(0,i.jsxs)(n.ol,{children:["\n",(0,i.jsxs)(n.li,{children:["Verify Traefik forwards ",(0,i.jsx)(n.code,{children:"/api/**"})," to BFF on your host","\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["Check Traefik config/labels for your host: ",(0,i.jsx)(n.code,{children:"PathPrefix(/api/)"})," \u2192 BFF service"]}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["Update services and upstreams","\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["In ",(0,i.jsx)(n.code,{children:"routes.yaml:services"}),", ensure the renamed service and ",(0,i.jsx)(n.code,{children:"base_url"})," are correct (port/path)"]}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["Update route entries","\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["Ensure ",(0,i.jsx)(n.code,{children:"path"})," reflects the new client shape (canonical ",(0,i.jsx)(n.code,{children:"/api/<app>/*"}),")"]}),"\n",(0,i.jsxs)(n.li,{children:["Point ",(0,i.jsx)(n.code,{children:"target_service"})," at the correct service key"]}),"\n",(0,i.jsxs)(n.li,{children:["Update ",(0,i.jsx)(n.code,{children:"upstream_path"})," to match backend path; use ",(0,i.jsx)(n.code,{children:"{path}"})," when forwarding a suffix"]}),"\n",(0,i.jsxs)(n.li,{children:["Set ",(0,i.jsx)(n.code,{children:"auth: session"})," (or ",(0,i.jsx)(n.code,{children:"bearer"})," for M2M) and ",(0,i.jsx)(n.code,{children:"authz: pdp"})," if PDP applies"]}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["Update PDP endpoint mapping","\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["In ",(0,i.jsx)(n.code,{children:"pdp.yaml:endpoint_map"}),", add/update exact or templated keys for the new client path(s)"]}),"\n",(0,i.jsxs)(n.li,{children:["Ensure methods map to ",(0,i.jsx)(n.code,{children:"resource"}),", ",(0,i.jsx)(n.code,{children:"action"}),", and optionally ",(0,i.jsx)(n.code,{children:"id_from"})," and ",(0,i.jsx)(n.code,{children:"props"})," (JSONPath)"]}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["Align per-service token audiences (if ",(0,i.jsx)(n.code,{children:"target_service"})," changed)","\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"See How\u2011to \u2192 Session-to-service token bridging; ensure the service name is recognized for token minting"}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["Dev vs prod base URL and CORS","\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["Dev: set ",(0,i.jsx)(n.code,{children:"VITE_BFF_BASE_URL"})," to the BFF origin (e.g., ",(0,i.jsx)(n.code,{children:"http://localhost:8000/api"}),") and include your UI origin in CORS in ",(0,i.jsx)(n.code,{children:"settings.yaml"})]}),"\n",(0,i.jsxs)(n.li,{children:["Prod: same-origin; set ",(0,i.jsx)(n.code,{children:"VITE_BFF_BASE_URL"})," to ",(0,i.jsx)(n.code,{children:"/api"})]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,i.jsx)(n.p,{children:"Quick validation"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:"# Health\r\ncurl -v http://<bff-host>/health\r\n\r\n# Expect 401 when unauthenticated\r\ncurl -v http://<bff-host>/api/<app>/items\r\n\r\n# After login (browser), expect 200 or 403 depending on PDP\r\n# Check BFF logs for mapping lines and PDP decision\n"})}),"\n",(0,i.jsx)(n.p,{children:"Minimal examples"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-yaml",metastring:'title="ServiceConfigs/BFF/config/routes.yaml (excerpt)"',children:'services:\r\n  my_service:\r\n    base_url: "http://my-service:8080"\r\nroutes:\r\n  - id: "my-items"\r\n    path: "/api/myapp/items/*"\r\n    target_service: "my_service"\r\n    upstream_path: "/items/{path}"\r\n    methods: ["GET", "POST", "PUT", "DELETE", "OPTIONS"]\r\n    auth: "session"\r\n    authz: "pdp"\n'})}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-yaml",metastring:'title="ServiceConfigs/BFF/config/pdp.yaml (excerpt)"',children:'endpoint_map:\r\n  /api/myapp/items:\r\n    GET:\r\n      resource: "my:item"\r\n      action: "list"\r\n  /api/myapp/items/{id}:\r\n    GET:\r\n      resource: "my:item"\r\n      action: "read"\r\n      id_from: "{id}"\n'})}),"\n",(0,i.jsx)(n.p,{children:"Triage checklist"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["VITE base URL correct; avoid double ",(0,i.jsx)(n.code,{children:"/api"})]}),"\n",(0,i.jsxs)(n.li,{children:["Traefik forwards ",(0,i.jsx)(n.code,{children:"/api/**"})," to BFF"]}),"\n",(0,i.jsxs)(n.li,{children:["Route ",(0,i.jsx)(n.code,{children:"path"})," and ",(0,i.jsx)(n.code,{children:"upstream_path"})," match new shapes"]}),"\n",(0,i.jsxs)(n.li,{children:["Service ",(0,i.jsx)(n.code,{children:"base_url"})," points to correct host/port"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"endpoint_map"})," covers new paths/methods"]}),"\n",(0,i.jsxs)(n.li,{children:["Token audience mapping matches ",(0,i.jsx)(n.code,{children:"target_service"})]}),"\n",(0,i.jsx)(n.li,{children:"CORS allowlist covers dev origin"}),"\n"]}),"\n",(0,i.jsx)(n.p,{children:"See also"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"Reference \u2192 YAML proxy (routes.yaml)"}),"\n",(0,i.jsx)(n.li,{children:"Reference \u2192 routes.yaml Reference"}),"\n",(0,i.jsx)(n.li,{children:"How\u2011to \u2192 Session-to-service token bridging"}),"\n",(0,i.jsx)(n.li,{children:"How\u2011to \u2192 Validate endpoint_map entries"}),"\n",(0,i.jsx)(n.li,{children:"Tutorials \u2192 React SPA + BFF \u2014 Golden Path"}),"\n"]})]})}function h(e={}){const{wrapper:n}={...(0,c.R)(),...e.components};return n?(0,i.jsx)(n,{...e,children:(0,i.jsx)(a,{...e})}):a(e)}}}]);