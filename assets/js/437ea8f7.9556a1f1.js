"use strict";(self.webpackChunkempowernow_docs=self.webpackChunkempowernow_docs||[]).push([[6418],{21658:(e,n,i)=>{i.r(n),i.d(n,{assets:()=>d,contentTitle:()=>c,default:()=>u,frontMatter:()=>o,metadata:()=>s,toc:()=>l});const s=JSON.parse('{"id":"services/nowconnect/reference/idp-and-auth","title":"idp-and-auth","description":"IdP support, authentication, and authorization","source":"@site/docs/services/nowconnect/reference/idp-and-auth.md","sourceDirName":"services/nowconnect/reference","slug":"/services/nowconnect/reference/idp-and-auth","permalink":"/empowernow_docs/docs/services/nowconnect/reference/idp-and-auth","draft":false,"unlisted":false,"editUrl":"https://github.com/facebook/docusaurus/tree/main/packages/create-docusaurus/templates/shared/docs/services/nowconnect/reference/idp-and-auth.md","tags":[],"version":"current","frontMatter":{},"sidebar":"tutorialSidebar","previous":{"title":"faq","permalink":"/empowernow_docs/docs/services/nowconnect/reference/faq"},"next":{"title":"logging-and-retention","permalink":"/empowernow_docs/docs/services/nowconnect/reference/logging-and-retention"}}');var r=i(74848),t=i(28453);const o={},c=void 0,d={},l=[{value:"IdP support, authentication, and authorization",id:"idp-support-authentication-and-authorization",level:2},{value:"IdP support and configuration",id:"idp-support-and-configuration",level:3},{value:"FAPI 2.0 (DPoP, mTLS)",id:"fapi-20-dpop-mtls",level:3},{value:"What security features are currently supported",id:"what-security-features-are-currently-supported",level:3},{value:"OpenID AuthZEN PDP (authorization)",id:"openid-authzen-pdp-authorization",level:3},{value:"PDP request/response schema (example)",id:"pdp-requestresponse-schema-example",level:4},{value:"Summary answers",id:"summary-answers",level:3}];function a(e){const n={code:"code",h2:"h2",h3:"h3",h4:"h4",li:"li",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,t.R)(),...e.components};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(n.h2,{id:"idp-support-authentication-and-authorization",children:"IdP support, authentication, and authorization"}),"\n",(0,r.jsx)(n.h3,{id:"idp-support-and-configuration",children:"IdP support and configuration"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Yes, we support any standards-compliant IdP that issues JWTs with a JWKS endpoint (e.g., Azure AD, Auth0, Keycloak, Entra ID, Okta)."}),"\n",(0,r.jsxs)(n.li,{children:["Configure the Cloud Hub with:","\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["Env: ",(0,r.jsx)(n.code,{children:"NOWCONNECT_JWKS_URL"}),", ",(0,r.jsx)(n.code,{children:"NOWCONNECT_AUDIENCE"})]}),"\n",(0,r.jsxs)(n.li,{children:["Or YAML (",(0,r.jsx)(n.code,{children:"ServiceConfigs/NowConnect/config/cloud.yaml"}),"): ",(0,r.jsx)(n.code,{children:"security.jwks_url"}),", ",(0,r.jsx)(n.code,{children:"security.audience"})]}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["The Cloud validates Bearer tokens on WebSocket upgrade using JWKS and ",(0,r.jsx)(n.code,{children:"aud"}),", and requires ",(0,r.jsx)(n.code,{children:"agent_id"})," in claims. ",(0,r.jsx)(n.code,{children:"HELLO.agent_id"})," must match the claim. See ",(0,r.jsx)(n.code,{children:"nowconnect_cloud/auth.py"})," and ",(0,r.jsx)(n.code,{children:"nowconnect_cloud/settings.py"}),"."]}),"\n"]}),"\n",(0,r.jsx)(n.h3,{id:"fapi-20-dpop-mtls",children:"FAPI 2.0 (DPoP, mTLS)"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["Not implemented today:","\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"DPoP-bound access tokens: no"}),"\n",(0,r.jsx)(n.li,{children:"OAuth mTLS-bound tokens / client cert verification in app: no"}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["Workarounds/near-term options:","\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Terminate TLS at your ingress with client mTLS and only forward requests that pass mTLS; the app will still do JWT validation. App-level client-cert validation would be a small extension if required."}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(n.h3,{id:"what-security-features-are-currently-supported",children:"What security features are currently supported"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["WebSocket upgrade authentication:","\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["Bearer JWT validated against IdP JWKS and audience; ",(0,r.jsx)(n.code,{children:"agent_id"})," claim required."]}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["Network controls:","\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["TCP listeners explicitly configured; optional source IP allowlist (",(0,r.jsx)(n.code,{children:"security.allow_cidrs"}),")."]}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["Transport:","\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"wss://"})," tunnel; agent supports corporate proxies (",(0,r.jsx)(n.code,{children:"NC_TRUST_ENV=true"}),") and system CA trust."]}),"\n",(0,r.jsx)(n.li,{children:"Protocol payloads are raw TCP; if the app protocol is TLS (LDAPS/HTTPS/etc.), TLS is end-to-end."}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["Secrets:","\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["Agent reads token from file (",(0,r.jsx)(n.code,{children:"NC_TOKEN_FILE"}),"); mount as read-only Secret/volume; restart to rotate."]}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["Observability:","\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["Structured logs (JSON on cloud by default; agent supports ",(0,r.jsx)(n.code,{children:"NC_LOG_FORMAT=json"}),")."]}),"\n",(0,r.jsxs)(n.li,{children:["Prometheus metrics on cloud; health endpoints on both sides (agent TCP health, cloud ",(0,r.jsx)(n.code,{children:"/healthz"}),"/",(0,r.jsx)(n.code,{children:"/readyz"}),")."]}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["Safety:","\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Bounded per-connection queues, idle sweeper, FIN/RST handling."}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(n.h3,{id:"openid-authzen-pdp-authorization",children:"OpenID AuthZEN PDP (authorization)"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["Not integrated yet in the tunnel control plane. Current behavior:","\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["On ",(0,r.jsx)(n.code,{children:"HELLO"}),", agent registers its ",(0,r.jsx)(n.code,{children:"connectors"}),"; Cloud does not enforce per-connector authorization against token claims or PDP."]}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["How to add (recommended pattern):","\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["Enforce connector scopes in the JWT (behind ",(0,r.jsx)(n.code,{children:"NOWCONNECT_REQUIRE_CONNECTOR_SCOPES"}),") and reconcile in ",(0,r.jsx)(n.code,{children:"nowconnect_cloud/hub.py"})," on ",(0,r.jsx)(n.code,{children:"HELLO"}),"."]}),"\n",(0,r.jsxs)(n.li,{children:["On each ",(0,r.jsx)(n.code,{children:"OPEN(connector)"}),", call your PDP to authorize ",(0,r.jsx)(n.code,{children:"subject=agent_id"}),", ",(0,r.jsx)(n.code,{children:"action=connect"}),", ",(0,r.jsx)(n.code,{children:'resource={type:"connector", id:<name>}'}),". Deny fast on policy failure."]}),"\n",(0,r.jsx)(n.li,{children:"Cache allow decisions briefly to limit PDP load."}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(n.h4,{id:"pdp-requestresponse-schema-example",children:"PDP request/response schema (example)"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-json",children:'{\r\n  "subject": { "agent_id": "agent-foo-01" },\r\n  "action": "connect",\r\n  "resource": { "type": "connector", "id": "ldap" },\r\n  "context": { "replica_id": "hub-a", "aud": "nowconnect" }\r\n}\n'})}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-json",children:'{ "allow": true, "ttl_sec": 5 }\n'})}),"\n",(0,r.jsxs)(n.p,{children:["Failure/timeout behavior (recommended): default deny on explicit deny; default deny on PDP timeout unless ",(0,r.jsx)(n.code,{children:"pdp.fail_open=true"})," is explicitly set for non-critical environments."]}),"\n",(0,r.jsx)(n.h3,{id:"summary-answers",children:"Summary answers"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"IdP"}),": Yes, any OIDC/OAuth2 IdP with JWKS and JWTs; configure via ",(0,r.jsx)(n.code,{children:"NOWCONNECT_JWKS_URL"}),"/",(0,r.jsx)(n.code,{children:"NOWCONNECT_AUDIENCE"})," or YAML security settings."]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"FAPI 2.0 DPoP/mTLS"}),": Not today; feasible to add. mTLS can be enforced at ingress immediately."]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Other security"}),": JWT on WS upgrade, CIDR allowlist, structured logging, metrics, health, proxy/CA support, secret handling via files/secrets."]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Authzen PDP"}),": Not currently; recommended integration points identified and can be implemented quickly if required."]}),"\n"]})]})}function u(e={}){const{wrapper:n}={...(0,t.R)(),...e.components};return n?(0,r.jsx)(n,{...e,children:(0,r.jsx)(a,{...e})}):a(e)}},28453:(e,n,i)=>{i.d(n,{R:()=>o,x:()=>c});var s=i(96540);const r={},t=s.createContext(r);function o(e){const n=s.useContext(t);return s.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function c(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(r):e.components||r:o(e.components),s.createElement(t.Provider,{value:n},e.children)}}}]);