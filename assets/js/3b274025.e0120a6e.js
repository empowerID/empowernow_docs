"use strict";(self.webpackChunkempowernow_docs=self.webpackChunkempowernow_docs||[]).push([[7570],{28453:(e,n,s)=>{s.d(n,{R:()=>t,x:()=>i});var c=s(96540);const o={},r=c.createContext(o);function t(e){const n=c.useContext(r);return c.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function i(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(o):e.components||o:t(e.components),c.createElement(r.Provider,{value:n},e.children)}},29498:(e,n,s)=>{s.r(n),s.d(n,{assets:()=>l,contentTitle:()=>i,default:()=>h,frontMatter:()=>t,metadata:()=>c,toc:()=>a});const c=JSON.parse('{"id":"services/nowconnect/how-to/enable-ha","title":"Enable NowConnect HA (shadow \u2192 active)","description":"How to configure cloud.yaml for HA, validate readiness/metrics, and roll out active mesh across replicas.","source":"@site/docs/services/nowconnect/how-to/enable-ha.md","sourceDirName":"services/nowconnect/how-to","slug":"/services/nowconnect/how-to/enable-ha","permalink":"/empowernow_docs/docs/services/nowconnect/how-to/enable-ha","draft":false,"unlisted":false,"editUrl":"https://github.com/facebook/docusaurus/tree/main/packages/create-docusaurus/templates/shared/docs/services/nowconnect/how-to/enable-ha.md","tags":[],"version":"current","frontMatter":{"id":"enable-ha","title":"Enable NowConnect HA (shadow \u2192 active)","description":"How to configure cloud.yaml for HA, validate readiness/metrics, and roll out active mesh across replicas.","sidebar_label":"Enable HA"},"sidebar":"tutorialSidebar","previous":{"title":"connect-common-protocols","permalink":"/empowernow_docs/docs/services/nowconnect/how-to/connect-common-protocols"},"next":{"title":"kubernetes-deploy","permalink":"/empowernow_docs/docs/services/nowconnect/how-to/kubernetes-deploy"}}');var o=s(74848),r=s(28453);const t={id:"enable-ha",title:"Enable NowConnect HA (shadow \u2192 active)",description:"How to configure cloud.yaml for HA, validate readiness/metrics, and roll out active mesh across replicas.",sidebar_label:"Enable HA"},i=void 0,l={},a=[{value:"Prerequisites",id:"prerequisites",level:2},{value:"Configure cloud.yaml",id:"configure-cloudyaml",level:2},{value:"Ingress mTLS for <code>/mesh</code>",id:"ingress-mtls-for-mesh",level:3},{value:"Validate",id:"validate",level:2},{value:"Activate",id:"activate",level:2},{value:"Rollback",id:"rollback",level:2}];function d(e){const n={code:"code",h2:"h2",h3:"h3",li:"li",ol:"ol",p:"p",pre:"pre",ul:"ul",...(0,r.R)(),...e.components};return(0,o.jsxs)(o.Fragment,{children:[(0,o.jsx)(n.h2,{id:"prerequisites",children:"Prerequisites"}),"\n",(0,o.jsxs)(n.ul,{children:["\n",(0,o.jsx)(n.li,{children:"Redis reachable by Cloud hubs"}),"\n",(0,o.jsxs)(n.li,{children:["mTLS certs/keys for mesh (",(0,o.jsx)(n.code,{children:"ha.mesh.tls"}),") and ingress route to expose ",(0,o.jsx)(n.code,{children:"/mesh"})]}),"\n"]}),"\n",(0,o.jsx)(n.h2,{id:"configure-cloudyaml",children:"Configure cloud.yaml"}),"\n",(0,o.jsxs)(n.p,{children:["File: ",(0,o.jsx)(n.code,{children:"ServiceConfigs/NowConnect/config/cloud.yaml"})]}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-yaml",children:"listeners:\n  - { name: l1, bind: '0.0.0.0:389', connector: 'ldap' }\nha:\n  enabled: true\n  mode: shadow\n  replica_id: <hub\u2011name>\n  redis_url: redis://shared_redis:6379/0\n  mesh:\n    peers: [\"wss://<peer\u2011hub>/mesh\"]\n    require_mtls: true\n    tls:\n      ca_bundle: /app/certs/ca.pem\n      cert_file: /app/certs/<hub>.crt\n      key_file: /app/certs/<hub>.key\n    send_queue_depth: 1000\n    per_link_max_inflight_bytes: 8388608\n"})}),"\n",(0,o.jsxs)(n.p,{children:["Set ",(0,o.jsx)(n.code,{children:"NC_CONFIG=/app/config/cloud.yaml"})," for the container."]}),"\n",(0,o.jsxs)(n.h3,{id:"ingress-mtls-for-mesh",children:["Ingress mTLS for ",(0,o.jsx)(n.code,{children:"/mesh"})]}),"\n",(0,o.jsxs)(n.p,{children:["When ",(0,o.jsx)(n.code,{children:"ha.mesh.require_mtls: true"}),", enforce client mTLS at the edge for the ",(0,o.jsx)(n.code,{children:"/mesh"})," route so only verified hubs can connect. The app expects TLS-terminated traffic at ingress."]}),"\n",(0,o.jsx)(n.p,{children:"Traefik (Docker, using a dynamic TLS options file):"}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-yaml",children:'# nowconnect-cloud service labels (add alongside existing /tunnel labels)\nlabels:\n  - "traefik.http.routers.nowconnect-mesh.rule=Host(`cloud-a.example.com`) && Path(`/mesh`)"\n  - "traefik.http.routers.nowconnect-mesh.entrypoints=websecure"\n  - "traefik.http.routers.nowconnect-mesh.tls=true"\n  - "traefik.http.routers.nowconnect-mesh.tls.options=mtls@file"\n  - "traefik.http.services.nowconnect-mesh.loadbalancer.server.port=8765"\n'})}),"\n",(0,o.jsx)(n.p,{children:"Traefik dynamic options (mounted into the Traefik container):"}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-yaml",children:"# traefik_dynamic.yml\ntls:\n  options:\n    mtls:\n      clientAuth:\n        clientAuthType: RequireAndVerifyClientCert\n        caFiles:\n          - /etc/traefik/mesh/mesh_ca.pem\n"})}),"\n",(0,o.jsx)(n.p,{children:"Nginx (reverse proxy in front of the Cloud Hub):"}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-nginx",children:'server {\n    listen 443 ssl;\n    server_name cloud-a.example.com;\n\n    ssl_certificate     /etc/nginx/tls/fullchain.pem;\n    ssl_certificate_key /etc/nginx/tls/privkey.pem;\n\n    # Require and verify client certs for /mesh only\n    location = /mesh {\n        proxy_http_version 1.1;\n        proxy_set_header Upgrade $http_upgrade;\n        proxy_set_header Connection "Upgrade";\n        proxy_set_header Host $host;\n\n        ssl_verify_client on;\n        ssl_client_certificate /etc/nginx/mesh/mesh_ca.pem;\n\n        proxy_read_timeout 3600s;\n        proxy_send_timeout 3600s;\n        proxy_pass http://nowconnect-cloud:8765/mesh;\n    }\n}\n'})}),"\n",(0,o.jsx)(n.p,{children:"Notes:"}),"\n",(0,o.jsxs)(n.ul,{children:["\n",(0,o.jsxs)(n.li,{children:["The peer hub\u2019s client certificate must chain to ",(0,o.jsx)(n.code,{children:"mesh_ca.pem"})," and include a SAN matching the peer hostname in ",(0,o.jsx)(n.code,{children:"ha.mesh.peers"}),"."]}),"\n",(0,o.jsxs)(n.li,{children:["Keep ",(0,o.jsx)(n.code,{children:"/tunnel"})," as TLS (no client cert). Authentication is via JWT on WebSocket upgrade."]}),"\n"]}),"\n",(0,o.jsx)(n.h2,{id:"validate",children:"Validate"}),"\n",(0,o.jsxs)(n.ul,{children:["\n",(0,o.jsxs)(n.li,{children:[(0,o.jsx)(n.code,{children:"/readyz"})," returns ",(0,o.jsx)(n.code,{children:"ready"})," in shadow; ",(0,o.jsx)(n.code,{children:"degraded"})," in active if mesh/registry unhealthy"]}),"\n",(0,o.jsxs)(n.li,{children:["Metrics show mesh links and frames:","\n",(0,o.jsxs)(n.ul,{children:["\n",(0,o.jsx)(n.li,{children:(0,o.jsx)(n.code,{children:"nowconnect_mesh_links{peer,state}"})}),"\n",(0,o.jsx)(n.li,{children:(0,o.jsx)(n.code,{children:"nowconnect_mesh_frames_total{dir,type}"})}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,o.jsx)(n.h2,{id:"activate",children:"Activate"}),"\n",(0,o.jsxs)(n.ol,{children:["\n",(0,o.jsxs)(n.li,{children:["Flip ",(0,o.jsx)(n.code,{children:"ha.mode"})," to ",(0,o.jsx)(n.code,{children:"active"})," on each hub and reload"]}),"\n",(0,o.jsx)(n.li,{children:"Add LB/VIP for client traffic to target both hubs"}),"\n",(0,o.jsxs)(n.li,{children:["Monitor:","\n",(0,o.jsxs)(n.ul,{children:["\n",(0,o.jsxs)(n.li,{children:["Mesh RTT: ",(0,o.jsx)(n.code,{children:"nowconnect_mesh_rtt_ms"})]}),"\n",(0,o.jsxs)(n.li,{children:["Backpressure/overflows: ",(0,o.jsx)(n.code,{children:"nowconnect_mesh_backpressure_total{reason}"})]}),"\n",(0,o.jsxs)(n.li,{children:["Epoch/dedup safety: ",(0,o.jsx)(n.code,{children:"nowconnect_owner_epoch_mismatch_total"}),", ",(0,o.jsx)(n.code,{children:"nowconnect_cid_dedup_dropped_total"})]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,o.jsx)(n.h2,{id:"rollback",children:"Rollback"}),"\n",(0,o.jsxs)(n.p,{children:["Set ",(0,o.jsx)(n.code,{children:"ha.mode: off"})," (or ",(0,o.jsx)(n.code,{children:"shadow"}),") to disable cross\u2011replica delivery; local flows continue."]}),"\n",(0,o.jsxs)(n.p,{children:["See also: ",(0,o.jsx)(n.code,{children:"services/nowconnect/explanation/ha-v2-architecture"}),"."]})]})}function h(e={}){const{wrapper:n}={...(0,r.R)(),...e.components};return n?(0,o.jsx)(n,{...e,children:(0,o.jsx)(d,{...e})}):d(e)}}}]);