"use strict";(self.webpackChunkempowernow_docs=self.webpackChunkempowernow_docs||[]).push([[7832],{28453:(e,n,i)=>{i.d(n,{R:()=>a,x:()=>d});var s=i(96540);const r={},l=s.createContext(r);function a(e){const n=s.useContext(l);return s.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function d(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(r):e.components||r:a(e.components),s.createElement(l.Provider,{value:n},e.children)}},86899:(e,n,i)=>{i.r(n),i.d(n,{assets:()=>o,contentTitle:()=>d,default:()=>h,frontMatter:()=>a,metadata:()=>s,toc:()=>c});const s=JSON.parse('{"id":"services/bff/explanation/bff_gateway_technical","title":"bff_gateway_technical","description":"BFF Gateway Authorization and Kafka Business Logging \u2013 Technical Guide","source":"@site/docs/services/bff/explanation/bff_gateway_technical.md","sourceDirName":"services/bff/explanation","slug":"/services/bff/explanation/bff_gateway_technical","permalink":"/empowernow_docs/docs/services/bff/explanation/bff_gateway_technical","draft":false,"unlisted":false,"editUrl":"https://github.com/facebook/docusaurus/tree/main/packages/create-docusaurus/templates/shared/docs/services/bff/explanation/bff_gateway_technical.md","tags":[],"version":"current","frontMatter":{},"sidebar":"tutorialSidebar","previous":{"title":"bff_gateway","permalink":"/empowernow_docs/docs/services/bff/explanation/bff_gateway"},"next":{"title":"FAPI 2.0 design & plan","permalink":"/empowernow_docs/docs/services/bff/explanation/fapi2-production-design"}}');var r=i(74848),l=i(28453);const a={},d=void 0,o={},c=[{value:"BFF Gateway Authorization and Kafka Business Logging \u2013 Technical Guide",id:"bff-gateway-authorization-and-kafka-business-logging--technical-guide",level:3},{value:"1) Overview",id:"1-overview",level:2},{value:"Audience",id:"audience",level:3},{value:"Prerequisites",id:"prerequisites",level:3},{value:"2) Configuration surfaces",id:"2-configuration-surfaces",level:2},{value:"2.1 Global toggle",id:"21-global-toggle",level:3},{value:"2.2 Route-level enablement",id:"22-route-level-enablement",level:3},{value:"2.3 Request mapping to PDP inputs",id:"23-request-mapping-to-pdp-inputs",level:3},{value:"2.4 Environment variables reference",id:"24-environment-variables-reference",level:3},{value:"3) Enforcement flow",id:"3-enforcement-flow",level:2},{value:"3.1 Standard HTTP routes",id:"31-standard-http-routes",level:3},{value:"3.2 SSE/Streaming routes",id:"32-ssestreaming-routes",level:3},{value:"3.3 Failure modes and decision mapping",id:"33-failure-modes-and-decision-mapping",level:3},{value:"4) Structured business logging (Kafka)",id:"4-structured-business-logging-kafka",level:2},{value:"4.1 Event: AUTHZ_DECISION",id:"41-event-authz_decision",level:3},{value:"4.2 Topics",id:"42-topics",level:3},{value:"4.3 Example AUTHZ_DECISION payload",id:"43-example-authz_decision-payload",level:3},{value:"5) Prometheus metrics and dashboards",id:"5-prometheus-metrics-and-dashboards",level:2},{value:"5.1 Example PromQL queries",id:"51-example-promql-queries",level:3},{value:"5.2 Suggested SLOs (tune per service)",id:"52-suggested-slos-tune-per-service",level:3},{value:"6) DevOps: deployment and operations",id:"6-devops-deployment-and-operations",level:2},{value:"6.1 Minimal steps to enable BFF authorization",id:"61-minimal-steps-to-enable-bff-authorization",level:3},{value:"6.2 Migration from CRUDService authorization",id:"62-migration-from-crudservice-authorization",level:3},{value:"6.3 Rollback plan",id:"63-rollback-plan",level:3},{value:"6.4 Tuning",id:"64-tuning",level:3},{value:"6.5 Blue/green rollout checklist",id:"65-bluegreen-rollout-checklist",level:3},{value:"6.6 Security hardening checklist",id:"66-security-hardening-checklist",level:3},{value:"7) Security administrators: policy mapping and validation",id:"7-security-administrators-policy-mapping-and-validation",level:2},{value:"7.1 Resource/action mapping",id:"71-resourceaction-mapping",level:3},{value:"7.2 Validation workflow",id:"72-validation-workflow",level:3},{value:"7.3 Audit readiness",id:"73-audit-readiness",level:3},{value:"8) QA: test plans",id:"8-qa-test-plans",level:2},{value:"8.1 Unit/integration tests (in-repo)",id:"81-unitintegration-tests-in-repo",level:3},{value:"8.2 Manual verification checklist",id:"82-manual-verification-checklist",level:3},{value:"8.3 Negative paths",id:"83-negative-paths",level:3},{value:"9) Code touchpoints",id:"9-code-touchpoints",level:2},{value:"10) Known scope and non-goals",id:"10-known-scope-and-non-goals",level:2},{value:"11) Quickstart examples",id:"11-quickstart-examples",level:2},{value:"Protect a new route",id:"protect-a-new-route",level:3},{value:"12) Troubleshooting",id:"12-troubleshooting",level:2},{value:"13) FAQ",id:"13-faq",level:2}];function t(e){const n={code:"code",h2:"h2",h3:"h3",hr:"hr",li:"li",mermaid:"mermaid",ol:"ol",p:"p",pre:"pre",ul:"ul",...(0,l.R)(),...e.components};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(n.h3,{id:"bff-gateway-authorization-and-kafka-business-logging--technical-guide",children:"BFF Gateway Authorization and Kafka Business Logging \u2013 Technical Guide"}),"\n",(0,r.jsx)(n.p,{children:"This document provides detailed, production-focused guidance for configuring, operating, and validating the BFF\u2019s gateway authorization (PDP) and Kafka business logging. It is written for DevOps, Security Administrators, and QA."}),"\n",(0,r.jsx)(n.hr,{}),"\n",(0,r.jsx)(n.h2,{id:"1-overview",children:"1) Overview"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Purpose: Centralize policy enforcement at the BFF layer for all routed APIs, with rich business context and auditable decisions."}),"\n",(0,r.jsxs)(n.li,{children:["Key capabilities","\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["Route-level authorization via ",(0,r.jsx)(n.code,{children:"authz: pdp"})," in ",(0,r.jsx)(n.code,{children:"routes.yaml"}),"."]}),"\n",(0,r.jsxs)(n.li,{children:["Request-to-policy mapping via ",(0,r.jsx)(n.code,{children:"endpoint_map"})," in ",(0,r.jsx)(n.code,{children:"pdp.yaml"})," (supports JSONPath and path params)."]}),"\n",(0,r.jsx)(n.li,{children:"Fail-secure enforcement (errors \u2192 deny), with structured Kafka audit events and Prometheus metrics."}),"\n",(0,r.jsx)(n.li,{children:"SSE-aware checks before opening streams."}),"\n",(0,r.jsx)(n.li,{children:"Global toggle to enable/disable BFF authz enforcement."}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(n.hr,{}),"\n",(0,r.jsx)(n.h3,{id:"audience",children:"Audience"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Platform/Infrastructure engineers operating gateway, routing, and observability stacks."}),"\n",(0,r.jsx)(n.li,{children:"Backend service owners adopting centralized authorization and audit."}),"\n",(0,r.jsx)(n.li,{children:"Security/Identity administrators responsible for policy enforcement and audit readiness."}),"\n",(0,r.jsx)(n.li,{children:"QA/Release engineering validating behavior, rollouts, and monitoring."}),"\n"]}),"\n",(0,r.jsx)(n.h3,{id:"prerequisites",children:"Prerequisites"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Central PDP reachable by the BFF and policies defined for your resources."}),"\n",(0,r.jsxs)(n.li,{children:["Routes declared in ",(0,r.jsx)(n.code,{children:"ServiceConfigs/BFF/config/routes.yaml"})," and mappings in ",(0,r.jsx)(n.code,{children:"ServiceConfigs/BFF/config/pdp.yaml"}),"."]}),"\n",(0,r.jsxs)(n.li,{children:["Authentication configured per route (",(0,r.jsx)(n.code,{children:"auth: session|bearer|none"}),") and session/JWT issuance working."]}),"\n",(0,r.jsxs)(n.li,{children:["Optional: Kafka and Prometheus configured via ",(0,r.jsx)(n.code,{children:"settings"})," (for audit and metrics)."]}),"\n"]}),"\n",(0,r.jsx)(n.hr,{}),"\n",(0,r.jsx)(n.h2,{id:"2-configuration-surfaces",children:"2) Configuration surfaces"}),"\n",(0,r.jsx)(n.h3,{id:"21-global-toggle",children:"2.1 Global toggle"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["File: ",(0,r.jsx)(n.code,{children:"ms_bff_spike/ms_bff/src/core/config.py"})]}),"\n",(0,r.jsxs)(n.li,{children:["Setting: ",(0,r.jsx)(n.code,{children:"settings.authz_enabled"})," (default ",(0,r.jsx)(n.code,{children:"True"}),")"]}),"\n",(0,r.jsxs)(n.li,{children:["Env override: ",(0,r.jsx)(n.code,{children:"MS_BFF_AUTHZ_ENABLED=false"})," to disable checks globally (useful during migration or emergency)."]}),"\n"]}),"\n",(0,r.jsx)(n.p,{children:"Example (YAML settings):"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-yaml",children:"feature_flags:\n  authz_enabled: true\n"})}),"\n",(0,r.jsx)(n.h3,{id:"22-route-level-enablement",children:"2.2 Route-level enablement"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["File: ",(0,r.jsx)(n.code,{children:"ServiceConfigs/BFF/config/routes.yaml"})]}),"\n",(0,r.jsxs)(n.li,{children:["Add ",(0,r.jsx)(n.code,{children:"authz: pdp"})," to any route that must be authorized at the BFF."]}),"\n"]}),"\n",(0,r.jsx)(n.p,{children:"Example:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-yaml",children:'- id: "crud-execute"\n  path: "/api/crud/execute"\n  target_service: "crud_service"\n  upstream_path: "/execute"\n  methods: ["POST"]\n  auth: "session"\n  authz: "pdp"\n'})}),"\n",(0,r.jsx)(n.h3,{id:"23-request-mapping-to-pdp-inputs",children:"2.3 Request mapping to PDP inputs"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["File: ",(0,r.jsx)(n.code,{children:"ServiceConfigs/BFF/config/pdp.yaml"})]}),"\n",(0,r.jsxs)(n.li,{children:["Section: ",(0,r.jsx)(n.code,{children:"endpoint_map"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["Keys are request paths (exact) or templated (e.g., ",(0,r.jsx)(n.code,{children:"/api/workflows/{workflow_id}/start"}),")."]}),"\n",(0,r.jsxs)(n.li,{children:["Methods under each key map to ",(0,r.jsx)(n.code,{children:"resource"}),", ",(0,r.jsx)(n.code,{children:"action"}),", and ",(0,r.jsx)(n.code,{children:"props"})," extracted from body/path."]}),"\n",(0,r.jsxs)(n.li,{children:["JSONPath-style lookups supported: ",(0,r.jsx)(n.code,{children:"$.a.b.c"}),"."]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(n.p,{children:"Examples:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-yaml",children:'endpoint_map:\n  /api/crud/execute:\n    POST:\n      resource: "crud:command"\n      action: "execute"\n      props:\n        system: "$.system"\n        object_type: "$.object_type"\n        command: "$.action"\n        id: "$.params.id"\n\n  /api/workflows/{workflow_id}/start:\n    POST:\n      resource: "workflow"\n      action: "execute"\n      props:\n        workflow_id: "{workflow_id}"\n'})}),"\n",(0,r.jsx)(n.p,{children:"Behavior when no mapping is found:"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["Authorization is denied with a structured audit log (decision=",(0,r.jsx)(n.code,{children:"NoMapping"}),"). This is fail-secure by default."]}),"\n"]}),"\n",(0,r.jsx)(n.hr,{}),"\n",(0,r.jsx)(n.h3,{id:"24-environment-variables-reference",children:"2.4 Environment variables reference"}),"\n",(0,r.jsxs)(n.p,{children:["Note: Exact names depend on your settings loader. Examples below illustrate common mappings to ",(0,r.jsx)(n.code,{children:"settings"})," fields."]}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"MS_BFF_AUTHZ_ENABLED"}),": Enables/disables BFF authorization globally (",(0,r.jsx)(n.code,{children:"true"}),"/",(0,r.jsx)(n.code,{children:"false"}),")."]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"KAFKA_ENABLED"}),": Turns Kafka business logging on/off."]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"KAFKA_BOOTSTRAP_SERVERS"}),": Comma-separated brokers for Kafka producer."]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"KAFKA_TOPIC_PREFIX"})," or ",(0,r.jsx)(n.code,{children:"KAFKA_AUDIT_TOPIC"}),": Topic naming; aligns with your Kafka conventions."]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"PDP_BASE_URL"}),": Base URL of the PDP service."]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"PDP_TIMEOUT_MS"}),": PDP request timeout."]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"PDP_CACHE_TTL"}),": Cache time-to-live for PDP decisions (if enabled)."]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"LOG_LEVEL"}),": Application log level."]}),"\n"]}),"\n",(0,r.jsx)(n.hr,{}),"\n",(0,r.jsx)(n.h2,{id:"3-enforcement-flow",children:"3) Enforcement flow"}),"\n",(0,r.jsx)(n.h3,{id:"31-standard-http-routes",children:"3.1 Standard HTTP routes"}),"\n",(0,r.jsx)(n.mermaid,{value:"sequenceDiagram\n  participant Client\n  participant Traefik\n  participant BFF\n  participant PDP\n  participant Backend as Backend Service\n\n  Client->>Traefik: HTTP /api/... (session cookie/bearer)\n  Traefik->>BFF: Route to BFF\n  BFF->>BFF: Authenticate session/JWT\n  BFF->>BFF: Resolve mapping (resource/action/props)\n  alt Mapping found\n    BFF->>PDP: CheckPermission(resource, action, props, subject)\n    PDP--\x3e>BFF: decision=Allow/Deny\n  else No mapping\n    BFF->>BFF: decision=NoMapping (deny)\n  end\n  alt Allow\n    BFF->>Backend: Proxy request\n    Note right of BFF: inject service token and ARNs\n    Backend--\x3e>BFF: Response\n    BFF--\x3e>Client: Response\n  else Deny/NoMapping/Error\n    BFF--\x3e>Client: 403 Forbidden\n  end"}),"\n",(0,r.jsx)(n.h3,{id:"32-ssestreaming-routes",children:"3.2 SSE/Streaming routes"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Same as standard, but the PDP check runs before opening the stream. On deny, the stream is not opened and a 403 is returned."}),"\n"]}),"\n",(0,r.jsx)(n.hr,{}),"\n",(0,r.jsx)(n.h3,{id:"33-failure-modes-and-decision-mapping",children:"3.3 Failure modes and decision mapping"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["Mapping not found (",(0,r.jsx)(n.code,{children:"endpoint_map"}),"): decision=",(0,r.jsx)(n.code,{children:"NoMapping"}),", HTTP 403. Kafka emits ",(0,r.jsx)(n.code,{children:"AUTHZ_DECISION"})," with ",(0,r.jsx)(n.code,{children:"reason=NoMapping"}),"; ",(0,r.jsx)(n.code,{children:'bff_authz_requests_total{decision="NoMapping"}'})," increments."]}),"\n",(0,r.jsxs)(n.li,{children:["PDP returns Deny: decision=",(0,r.jsx)(n.code,{children:"Deny"}),", HTTP 403. Kafka includes ",(0,r.jsx)(n.code,{children:"reason"})," if available."]}),"\n",(0,r.jsxs)(n.li,{children:["PDP unavailable/timeout/error: fail-secure decision=",(0,r.jsx)(n.code,{children:"Deny"}),", HTTP 403. ",(0,r.jsx)(n.code,{children:'service_errors_total{service="pdp"}'})," increments; latency observed in ",(0,r.jsx)(n.code,{children:"bff_authz_latency_seconds"}),"."]}),"\n",(0,r.jsxs)(n.li,{children:["Resolver error/missing required props: decision=",(0,r.jsx)(n.code,{children:"Deny"}),", HTTP 403 with ",(0,r.jsx)(n.code,{children:"reason=ResolverError"})," (or equivalent short reason)."]}),"\n",(0,r.jsxs)(n.li,{children:["Global toggle off (",(0,r.jsx)(n.code,{children:"authz_enabled=false"}),"): PDP check is bypassed for all routes; requests proxy without emitting ",(0,r.jsx)(n.code,{children:"AUTHZ_DECISION"}),"."]}),"\n",(0,r.jsx)(n.li,{children:"SSE routes: deny occurs before opening the stream; no connection is established on unauthorized."}),"\n"]}),"\n",(0,r.jsx)(n.hr,{}),"\n",(0,r.jsx)(n.h2,{id:"4-structured-business-logging-kafka",children:"4) Structured business logging (Kafka)"}),"\n",(0,r.jsx)(n.h3,{id:"41-event-authz_decision",children:"4.1 Event: AUTHZ_DECISION"}),"\n",(0,r.jsxs)(n.p,{children:["Emitted for every protected route (",(0,r.jsx)(n.code,{children:"authz: pdp"}),") with decision context."]}),"\n",(0,r.jsx)(n.p,{children:"Core fields (typical):"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"event"}),": ",(0,r.jsx)(n.code,{children:"AUTHZ_DECISION"})]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"decision"}),": ",(0,r.jsx)(n.code,{children:"Allow"})," | ",(0,r.jsx)(n.code,{children:"Deny"})," | ",(0,r.jsx)(n.code,{children:"NoMapping"})]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"resource"}),", ",(0,r.jsx)(n.code,{children:"action"}),", ",(0,r.jsx)(n.code,{children:"resource_id"})," (if derived)"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"props"}),": flattened subset of authorization context (safe keys)"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"route_id"}),", ",(0,r.jsx)(n.code,{children:"path"}),", ",(0,r.jsx)(n.code,{children:"method"}),", ",(0,r.jsx)(n.code,{children:"target_service"})]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"user_id"}),", ",(0,r.jsx)(n.code,{children:"principal_arn"}),", ",(0,r.jsx)(n.code,{children:"actor_arn"})," (when available)"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"correlation_id"}),", ",(0,r.jsx)(n.code,{children:"session_id"})," (if available)"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"latency_ms"})," (PDP time)"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"reason"}),": short text for deny/no mapping/errors"]}),"\n"]}),"\n",(0,r.jsx)(n.p,{children:"Enablement:"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"init_enterprise_logging()"})," in startup wiring routes structured logs to Kafka when Kafka is enabled."]}),"\n",(0,r.jsxs)(n.li,{children:["Kafka settings in ",(0,r.jsx)(n.code,{children:"settings"}),":","\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"kafka.enabled"}),", ",(0,r.jsx)(n.code,{children:"kafka.bootstrap_servers"}),", ",(0,r.jsx)(n.code,{children:"kafka.topic_prefix"})," or service-level ",(0,r.jsx)(n.code,{children:"kafka.audit_topic"}),"."]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(n.h3,{id:"42-topics",children:"4.2 Topics"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["Default pattern: ",(0,r.jsx)(n.code,{children:"bff.audit"})," or ",(0,r.jsx)(n.code,{children:"empowernow.bff.audit"})," (depending on your Kafka config module)."]}),"\n",(0,r.jsx)(n.li,{children:"Align with your enterprise Kafka topic conventions; the logger will use configured topic names."}),"\n"]}),"\n",(0,r.jsx)(n.hr,{}),"\n",(0,r.jsx)(n.h3,{id:"43-example-authz_decision-payload",children:"4.3 Example AUTHZ_DECISION payload"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-json",children:'{\n  "event": "AUTHZ_DECISION",\n  "decision": "Allow",\n  "resource": "crud:command",\n  "action": "execute",\n  "resource_id": "12345",\n  "props": {\n    "system": "hr",\n    "object_type": "user",\n    "command": "create"\n  },\n  "route_id": "crud-execute",\n  "path": "/api/crud/execute",\n  "method": "POST",\n  "target_service": "crud_service",\n  "user_id": "u-9ab8c7",\n  "principal_arn": "arn:emp:user:u-9ab8c7",\n  "actor_arn": "arn:emp:app:web",\n  "correlation_id": "c-3a1b-5d6e",\n  "session_id": "s-2f4c-7e8a",\n  "latency_ms": 42,\n  "reason": null\n}\n'})}),"\n",(0,r.jsx)(n.hr,{}),"\n",(0,r.jsx)(n.h2,{id:"5-prometheus-metrics-and-dashboards",children:"5) Prometheus metrics and dashboards"}),"\n",(0,r.jsx)(n.p,{children:"Metrics emitted (non-exhaustive):"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.code,{children:"bff_authz_requests_total{resource,action,decision}"})}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"bff_authz_latency_seconds_bucket{resource,...}"})," (histogram)"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:'service_requests_total{service="pdp"}'})," and ",(0,r.jsx)(n.code,{children:'service_errors_total{service="pdp",error_type=...}'})]}),"\n"]}),"\n",(0,r.jsx)(n.p,{children:"Provided assets:"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["Dashboard: ",(0,r.jsx)(n.code,{children:"observability/grafana/dashboard_bff_authz.json"})]}),"\n",(0,r.jsxs)(n.li,{children:["Alerts: ",(0,r.jsx)(n.code,{children:"observability/grafana/alerts_bff_authz.yaml"})]}),"\n"]}),"\n",(0,r.jsx)(n.p,{children:"Key visuals:"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["Deny rate (5m): ",(0,r.jsx)(n.code,{children:'sum(rate(bff_authz_requests_total{decision="Deny"}[5m])) / sum(rate(bff_authz_requests_total[5m]))'})]}),"\n",(0,r.jsx)(n.li,{children:"Decision volume by decision/resource"}),"\n",(0,r.jsx)(n.li,{children:"PDP error rate and latency"}),"\n",(0,r.jsx)(n.li,{children:"AuthZ P95 latency by resource"}),"\n"]}),"\n",(0,r.jsx)(n.p,{children:"Alerts include:"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"High deny rate, PDP errors spike, NoMapping anomalies"}),"\n"]}),"\n",(0,r.jsx)(n.hr,{}),"\n",(0,r.jsx)(n.h3,{id:"51-example-promql-queries",children:"5.1 Example PromQL queries"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:'# Deny rate (5m)\nsum(rate(bff_authz_requests_total{decision="Deny"}[5m]))\n  / sum(rate(bff_authz_requests_total[5m]))\n\n# NoMapping rate (5m)\nsum(rate(bff_authz_requests_total{decision="NoMapping"}[5m]))\n  / sum(rate(bff_authz_requests_total[5m]))\n\n# PDP p95 latency (5m)\nhistogram_quantile(\n  0.95,\n  sum(rate(bff_authz_latency_seconds_bucket[5m])) by (le)\n)\n\n# PDP error rate (5m)\nsum(rate(service_errors_total{service="pdp"}[5m]))\n  / sum(rate(service_requests_total{service="pdp"}[5m]))\n\n# Top resources by decision volume (5m)\ntopk(10, sum(rate(bff_authz_requests_total[5m])) by (resource))\n'})}),"\n",(0,r.jsx)(n.h3,{id:"52-suggested-slos-tune-per-service",children:"5.2 Suggested SLOs (tune per service)"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"AuthZ p95 latency: \u2264 150 ms."}),"\n",(0,r.jsx)(n.li,{children:"PDP availability: error rate \u2264 0.1% over 1h."}),"\n",(0,r.jsx)(n.li,{children:"NoMapping rate: < 0.5% of total authorized traffic (production steady state)."}),"\n",(0,r.jsx)(n.li,{children:"Alert when deny rate deviates >3\xd7 baseline for \u226515m."}),"\n"]}),"\n",(0,r.jsx)(n.hr,{}),"\n",(0,r.jsx)(n.h2,{id:"6-devops-deployment-and-operations",children:"6) DevOps: deployment and operations"}),"\n",(0,r.jsx)(n.h3,{id:"61-minimal-steps-to-enable-bff-authorization",children:"6.1 Minimal steps to enable BFF authorization"}),"\n",(0,r.jsxs)(n.ol,{children:["\n",(0,r.jsxs)(n.li,{children:["Mark protected routes with ",(0,r.jsx)(n.code,{children:"authz: pdp"})," in ",(0,r.jsx)(n.code,{children:"ServiceConfigs/BFF/config/routes.yaml"}),"."]}),"\n",(0,r.jsxs)(n.li,{children:["Define mappings in ",(0,r.jsx)(n.code,{children:"ServiceConfigs/BFF/config/pdp.yaml"})," under ",(0,r.jsx)(n.code,{children:"endpoint_map"})," for those routes."]}),"\n",(0,r.jsxs)(n.li,{children:["Ensure ",(0,r.jsx)(n.code,{children:"MS_BFF_AUTHZ_ENABLED=true"})," (default is true)."]}),"\n",(0,r.jsxs)(n.li,{children:["Verify PDP service reachability and credentials (",(0,r.jsx)(n.code,{children:"settings.pdp.*"}),")."]}),"\n",(0,r.jsx)(n.li,{children:"Deploy; monitor metrics and Kafka events."}),"\n"]}),"\n",(0,r.jsx)(n.h3,{id:"62-migration-from-crudservice-authorization",children:"6.2 Migration from CRUDService authorization"}),"\n",(0,r.jsxs)(n.ol,{children:["\n",(0,r.jsxs)(n.li,{children:["Ensure BFF routes covering CRUD endpoints have ",(0,r.jsx)(n.code,{children:"authz: pdp"})," and proper ",(0,r.jsx)(n.code,{children:"endpoint_map"})," entries."]}),"\n",(0,r.jsxs)(n.li,{children:["Disable CRUDService-side authorization (e.g., set ",(0,r.jsx)(n.code,{children:"enable_authorization: false"})," in ",(0,r.jsx)(n.code,{children:"ServiceConfigs/CRUDService/config/pdp.yaml"})," or equivalent flag). Confirm exact setting name in that service\u2019s config."]}),"\n",(0,r.jsx)(n.li,{children:"Roll out BFF changes first in staging; validate allow/deny parity."}),"\n",(0,r.jsx)(n.li,{children:"Enable Kafka and import Grafana dashboard; verify AUTHZ_DECISION stream."}),"\n",(0,r.jsx)(n.li,{children:"Cut over traffic; keep an eye on deny rates and PDP error rates."}),"\n"]}),"\n",(0,r.jsx)(n.h3,{id:"63-rollback-plan",children:"6.3 Rollback plan"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["Flip ",(0,r.jsx)(n.code,{children:"MS_BFF_AUTHZ_ENABLED=false"})," to bypass BFF checks temporarily."]}),"\n",(0,r.jsx)(n.li,{children:"Re-enable CRUDService authorization if needed while investigating."}),"\n"]}),"\n",(0,r.jsx)(n.h3,{id:"64-tuning",children:"6.4 Tuning"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["PDP cache TTL: ",(0,r.jsx)(n.code,{children:"settings.pdp.cache_ttl"}),"."]}),"\n",(0,r.jsx)(n.li,{children:"Retry/circuit-breaker at HTTP client level for PDP."}),"\n",(0,r.jsx)(n.li,{children:"Metrics-based SLOs: AuthZ latency and PDP error rate."}),"\n"]}),"\n",(0,r.jsx)(n.hr,{}),"\n",(0,r.jsx)(n.h3,{id:"65-bluegreen-rollout-checklist",children:"6.5 Blue/green rollout checklist"}),"\n",(0,r.jsxs)(n.ol,{children:["\n",(0,r.jsx)(n.li,{children:"Enable metrics and (optionally) Kafka in lower environments; import dashboard and alerts."}),"\n",(0,r.jsxs)(n.li,{children:["Add ",(0,r.jsx)(n.code,{children:"authz: pdp"})," to a small, low-risk route group; verify mappings exist for all paths."]}),"\n",(0,r.jsx)(n.li,{children:"Compare allow/deny parity with legacy authorization in staging."}),"\n",(0,r.jsx)(n.li,{children:"Deploy to production behind a small canary (5\u201310%) and monitor deny rate, NoMapping, PDP errors, and p95 latency."}),"\n",(0,r.jsx)(n.li,{children:"Gradually increase traffic allocation; keep rollback ready (see 6.3)."}),"\n"]}),"\n",(0,r.jsx)(n.h3,{id:"66-security-hardening-checklist",children:"6.6 Security hardening checklist"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Enforce TLS to PDP and Kafka; prefer mTLS where available."}),"\n",(0,r.jsx)(n.li,{children:"Limit and rotate credentials for PDP and Kafka producers."}),"\n",(0,r.jsxs)(n.li,{children:["Emit only safe ",(0,r.jsx)(n.code,{children:"props"})," fields; avoid logging secrets or PII."]}),"\n",(0,r.jsx)(n.li,{children:"Restrict CORS and enforce strict origin checks (especially for SSE routes)."}),"\n",(0,r.jsxs)(n.li,{children:["Use ",(0,r.jsx)(n.code,{children:"auth: bearer"})," for service-to-service; scope tokens to least privilege."]}),"\n",(0,r.jsx)(n.li,{children:"Rate-limit and protect at the edge (Traefik/Kong) for volumetric attacks."}),"\n"]}),"\n",(0,r.jsx)(n.hr,{}),"\n",(0,r.jsx)(n.h2,{id:"7-security-administrators-policy-mapping-and-validation",children:"7) Security administrators: policy mapping and validation"}),"\n",(0,r.jsx)(n.h3,{id:"71-resourceaction-mapping",children:"7.1 Resource/action mapping"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["Use ",(0,r.jsx)(n.code,{children:"endpoint_map"})," to translate API shape to policy inputs."]}),"\n",(0,r.jsxs)(n.li,{children:["Prefer stable resource kinds: e.g., ",(0,r.jsx)(n.code,{children:"crud:command"}),", ",(0,r.jsx)(n.code,{children:"workflow"}),"."]}),"\n",(0,r.jsxs)(n.li,{children:["Include key props: ",(0,r.jsx)(n.code,{children:"system"}),", ",(0,r.jsx)(n.code,{children:"object_type"}),", ",(0,r.jsx)(n.code,{children:"command"}),", ",(0,r.jsx)(n.code,{children:"id"}),", ",(0,r.jsx)(n.code,{children:"workflow_id"}),"."]}),"\n",(0,r.jsxs)(n.li,{children:["Use path params via ",(0,r.jsx)(n.code,{children:"{param}"})," and request body via JSONPath ",(0,r.jsx)(n.code,{children:"$.field.nested"}),"."]}),"\n"]}),"\n",(0,r.jsx)(n.h3,{id:"72-validation-workflow",children:"7.2 Validation workflow"}),"\n",(0,r.jsxs)(n.ol,{children:["\n",(0,r.jsxs)(n.li,{children:["For a given API, confirm a mapping exists (grep ",(0,r.jsx)(n.code,{children:"endpoint_map"}),")."]}),"\n",(0,r.jsxs)(n.li,{children:["Exercise an allow case; verify ",(0,r.jsx)(n.code,{children:"decision=Allow"})," in Kafka and ",(0,r.jsx)(n.code,{children:'bff_authz_requests_total{decision="Allow"}'})," increments."]}),"\n",(0,r.jsxs)(n.li,{children:["Exercise a deny case; verify ",(0,r.jsx)(n.code,{children:"decision=Deny"})," with ",(0,r.jsx)(n.code,{children:"reason"})," populated."]}),"\n",(0,r.jsxs)(n.li,{children:["Remove mapping temporarily to confirm ",(0,r.jsx)(n.code,{children:"decision=NoMapping"})," events are visible (optional test-only)."]}),"\n"]}),"\n",(0,r.jsx)(n.h3,{id:"73-audit-readiness",children:"7.3 Audit readiness"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Kafka payloads contain principal identifiers (user_id, ARNs where available), route_id, resource/action, and props\u2014sufficient for forensics."}),"\n",(0,r.jsxs)(n.li,{children:["Correlate via ",(0,r.jsx)(n.code,{children:"correlation_id"})," end-to-end."]}),"\n"]}),"\n",(0,r.jsx)(n.hr,{}),"\n",(0,r.jsx)(n.h2,{id:"8-qa-test-plans",children:"8) QA: test plans"}),"\n",(0,r.jsx)(n.h3,{id:"81-unitintegration-tests-in-repo",children:"8.1 Unit/integration tests (in-repo)"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["Unit tests cover parsing (",(0,r.jsx)(n.code,{children:"authz"})," in routes loader) and resolver mapping."]}),"\n",(0,r.jsx)(n.li,{children:"Router integration tests cover allow/deny, toggle-off bypass, SSE pre-check."}),"\n"]}),"\n",(0,r.jsx)(n.h3,{id:"82-manual-verification-checklist",children:"8.2 Manual verification checklist"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["Allow case: valid subject, policy grants \u2192 200 from backend, Kafka ",(0,r.jsx)(n.code,{children:"Allow"})," event."]}),"\n",(0,r.jsxs)(n.li,{children:["Deny case: subject lacks permission \u2192 403 from BFF, Kafka ",(0,r.jsx)(n.code,{children:"Deny"})," event."]}),"\n",(0,r.jsxs)(n.li,{children:["No mapping: remove route mapping \u2192 403, Kafka ",(0,r.jsx)(n.code,{children:"NoMapping"})," (staging only)."]}),"\n",(0,r.jsx)(n.li,{children:"SSE route: pre-check denies stream opening when unauthorized."}),"\n",(0,r.jsxs)(n.li,{children:["Toggle-off: set ",(0,r.jsx)(n.code,{children:"MS_BFF_AUTHZ_ENABLED=false"})," \u2192 traffic proxies without PDP calls."]}),"\n"]}),"\n",(0,r.jsx)(n.h3,{id:"83-negative-paths",children:"8.3 Negative paths"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["PDP unavailable/timeouts: verify fail-secure deny and ",(0,r.jsx)(n.code,{children:'service_errors_total{service="pdp"}'})," increments."]}),"\n",(0,r.jsx)(n.li,{children:"Malformed bodies: resolver handles gracefully; if required props missing, deny with reason."}),"\n"]}),"\n",(0,r.jsx)(n.hr,{}),"\n",(0,r.jsx)(n.h2,{id:"9-code-touchpoints",children:"9) Code touchpoints"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["Route loader: accepts ",(0,r.jsx)(n.code,{children:"authz"})," field and validates it."]}),"\n",(0,r.jsxs)(n.li,{children:["Dynamic router: performs PDP pre-check for ",(0,r.jsx)(n.code,{children:"authz: pdp"}),", including SSE."]}),"\n",(0,r.jsxs)(n.li,{children:["AuthZ resolver: derives ",(0,r.jsx)(n.code,{children:"resource/action/props"})," via ",(0,r.jsx)(n.code,{children:"endpoint_map"})," (JSONPath/path params)."]}),"\n",(0,r.jsx)(n.li,{children:"Policy client: invokes PDP and records latency/decision metrics."}),"\n",(0,r.jsxs)(n.li,{children:["Logging: emits ",(0,r.jsx)(n.code,{children:"AUTHZ_DECISION"})," with business context; Kafka configuration controlled via settings."]}),"\n"]}),"\n",(0,r.jsx)(n.p,{children:"Key files:"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.code,{children:"ms_bff_spike/ms_bff/src/routing/yaml_loader.py"})}),"\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.code,{children:"ms_bff_spike/ms_bff/src/routing/dynamic_router.py"})}),"\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.code,{children:"ms_bff_spike/ms_bff/src/services/authz_resolver.py"})}),"\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.code,{children:"ServiceConfigs/BFF/config/routes.yaml"})}),"\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.code,{children:"ServiceConfigs/BFF/config/pdp.yaml"})}),"\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.code,{children:"ms_bff_spike/ms_bff/src/core/config.py"})}),"\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.code,{children:"ms_bff_spike/observability/grafana/dashboard_bff_authz.json"})}),"\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.code,{children:"ms_bff_spike/observability/grafana/alerts_bff_authz.yaml"})}),"\n"]}),"\n",(0,r.jsx)(n.hr,{}),"\n",(0,r.jsx)(n.h2,{id:"10-known-scope-and-non-goals",children:"10) Known scope and non-goals"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Edge security (WAF/bot detection, global anycast/CDN) handled by Traefik or edge providers."}),"\n",(0,r.jsx)(n.li,{children:"Non-HTTP protocols are out of scope."}),"\n",(0,r.jsx)(n.li,{children:"Policy definitions reside in the central PDP, not in the BFF."}),"\n"]}),"\n",(0,r.jsx)(n.hr,{}),"\n",(0,r.jsx)(n.h2,{id:"11-quickstart-examples",children:"11) Quickstart examples"}),"\n",(0,r.jsx)(n.h3,{id:"protect-a-new-route",children:"Protect a new route"}),"\n",(0,r.jsxs)(n.ol,{children:["\n",(0,r.jsxs)(n.li,{children:["Add to ",(0,r.jsx)(n.code,{children:"routes.yaml"}),":"]}),"\n"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-yaml",children:'- id: "orders-exec"\n  path: "/api/orders/execute"\n  target_service: "orders_service"\n  upstream_path: "/execute"\n  methods: ["POST"]\n  auth: "session"\n  authz: "pdp"\n'})}),"\n",(0,r.jsxs)(n.ol,{start:"2",children:["\n",(0,r.jsxs)(n.li,{children:["Map in ",(0,r.jsx)(n.code,{children:"pdp.yaml"}),":"]}),"\n"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-yaml",children:'endpoint_map:\n  /api/orders/execute:\n    POST:\n      resource: "orders:command"\n      action: "execute"\n      props:\n        command: "$.action"\n        order_id: "$.params.id"\n'})}),"\n",(0,r.jsxs)(n.ol,{start:"3",children:["\n",(0,r.jsxs)(n.li,{children:["Deploy and verify: 200 on allow, 403 on deny; Kafka ",(0,r.jsx)(n.code,{children:"AUTHZ_DECISION"})," and Prometheus metrics update."]}),"\n"]}),"\n",(0,r.jsx)(n.hr,{}),"\n",(0,r.jsx)(n.h2,{id:"12-troubleshooting",children:"12) Troubleshooting"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["Unexpected 403 with ",(0,r.jsx)(n.code,{children:"NoMapping"}),": confirm the exact path/method has an ",(0,r.jsx)(n.code,{children:"endpoint_map"})," entry; check JSONPath expressions resolve on your payload."]}),"\n",(0,r.jsxs)(n.li,{children:["Unexpected 403 with ",(0,r.jsx)(n.code,{children:"Deny"}),": verify subject identity and PDP policy; inspect Kafka ",(0,r.jsx)(n.code,{children:"reason"})," and PDP client logs."]}),"\n",(0,r.jsxs)(n.li,{children:["High PDP latency: check PDP health, network, and timeouts; consider adjusting ",(0,r.jsx)(n.code,{children:"PDP_TIMEOUT_MS"})," and client retry budgets."]}),"\n",(0,r.jsxs)(n.li,{children:["No Kafka events: ensure ",(0,r.jsx)(n.code,{children:"KAFKA_ENABLED=true"}),", brokers reachable, and topic configured; check producer errors in logs."]}),"\n",(0,r.jsx)(n.li,{children:"Metrics missing: verify Prometheus scraping for the BFF and that metrics endpoint is exposed."}),"\n",(0,r.jsxs)(n.li,{children:["SSE not opening: verify pre-check passes; confirm CORS/origin settings and that the route is marked with ",(0,r.jsx)(n.code,{children:"authz: pdp"})," and mapped."]}),"\n"]}),"\n",(0,r.jsx)(n.hr,{}),"\n",(0,r.jsx)(n.h2,{id:"13-faq",children:"13) FAQ"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["Do we call PDP on every request? Only for routes with ",(0,r.jsx)(n.code,{children:"authz: pdp"})," and when ",(0,r.jsx)(n.code,{children:"authz_enabled=true"}),". PDP caching may reduce call volume depending on configuration."]}),"\n",(0,r.jsxs)(n.li,{children:["How do we bypass BFF authorization temporarily? Set ",(0,r.jsx)(n.code,{children:"MS_BFF_AUTHZ_ENABLED=false"})," and redeploy. Use only for emergency rollback."]}),"\n",(0,r.jsxs)(n.li,{children:["How do we handle machine-to-machine calls? Mark routes with ",(0,r.jsx)(n.code,{children:"auth: bearer"}),"; the BFF will validate tokens and still enforce PDP if ",(0,r.jsx)(n.code,{children:"authz: pdp"})," is set."]}),"\n",(0,r.jsxs)(n.li,{children:["How do we add SSE protection? Mark route with ",(0,r.jsx)(n.code,{children:"authz: pdp"})," and provide an ",(0,r.jsx)(n.code,{children:"endpoint_map"}),"; the BFF runs the check before opening the stream."]}),"\n",(0,r.jsxs)(n.li,{children:["Where do I correlate decisions with requests? Use ",(0,r.jsx)(n.code,{children:"correlation_id"})," and ",(0,r.jsx)(n.code,{children:"route_id"})," in Kafka events and propagate them in logs/traces end-to-end."]}),"\n"]}),"\n",(0,r.jsx)(n.hr,{}),"\n",(0,r.jsx)(n.p,{children:"For questions or escalation paths, include this doc in change tickets and link the dashboard and alert rules to your monitoring runbooks."})]})}function h(e={}){const{wrapper:n}={...(0,l.R)(),...e.components};return n?(0,r.jsx)(n,{...e,children:(0,r.jsx)(t,{...e})}):t(e)}}}]);