"use strict";(self.webpackChunkempowernow_docs=self.webpackChunkempowernow_docs||[]).push([[6332],{5433:(e,n,r)=>{r.r(n),r.d(n,{assets:()=>a,contentTitle:()=>d,default:()=>u,frontMatter:()=>i,metadata:()=>s,toc:()=>o});const s=JSON.parse('{"id":"services/crud-service/secrets/SECRETS_PDP_ENRICHMENT","title":"Secrets PDP enrichment","description":"Exact subject, resource, purpose, and context fields sent to the PDP for secrets decisions","source":"@site/docs/services/crud-service/secrets/SECRETS_PDP_ENRICHMENT.md","sourceDirName":"services/crud-service/secrets","slug":"/services/crud-service/secrets/pdp-enrichment","permalink":"/empowernow_docs/docs/services/crud-service/secrets/pdp-enrichment","draft":false,"unlisted":false,"editUrl":"https://github.com/facebook/docusaurus/tree/main/packages/create-docusaurus/templates/shared/docs/services/crud-service/secrets/SECRETS_PDP_ENRICHMENT.md","tags":[],"version":"current","frontMatter":{"title":"Secrets PDP enrichment","description":"Exact subject, resource, purpose, and context fields sent to the PDP for secrets decisions","slug":"pdp-enrichment"},"sidebar":"tutorialSidebar","previous":{"title":"SECRETS_MIGRATION_GUIDE","permalink":"/empowernow_docs/docs/services/crud-service/secrets/SECRETS_MIGRATION_GUIDE"},"next":{"title":"Azure Key Vault","permalink":"/empowernow_docs/docs/services/crud-service/secrets/azure_keyvault_vault"}}');var c=r(74848),t=r(28453);const i={title:"Secrets PDP enrichment",description:"Exact subject, resource, purpose, and context fields sent to the PDP for secrets decisions",slug:"pdp-enrichment"},d=void 0,a={},o=[{value:"Secrets PDP Enrichment: Subject, Resource, Action, Context",id:"secrets-pdp-enrichment-subject-resource-action-context",level:2},{value:"Where the PDP call happens",id:"where-the-pdp-call-happens",level:3},{value:"What we send (fields)",id:"what-we-send-fields",level:3},{value:"Subject",id:"subject",level:4},{value:"Action (purpose)",id:"action-purpose",level:4},{value:"Resource",id:"resource",level:4},{value:"Context (enriched)",id:"context-enriched",level:4},{value:"Code references",id:"code-references",level:3},{value:"Example payloads",id:"example-payloads",level:3},{value:"1) Provider-backed read (PEP) of a fragment",id:"1-provider-backed-read-pep-of-a-fragment",level:4},{value:"2) Rotate a secret value (KVv2)",id:"2-rotate-a-secret-value-kvv2",level:4},{value:"3) Update owner metadata",id:"3-update-owner-metadata",level:4},{value:"Security notes",id:"security-notes",level:3}];function l(e){const n={code:"code",h2:"h2",h3:"h3",h4:"h4",hr:"hr",li:"li",p:"p",pre:"pre",ul:"ul",...(0,t.R)(),...e.components};return(0,c.jsxs)(c.Fragment,{children:[(0,c.jsx)(n.h2,{id:"secrets-pdp-enrichment-subject-resource-action-context",children:"Secrets PDP Enrichment: Subject, Resource, Action, Context"}),"\n",(0,c.jsx)(n.p,{children:"This document describes exactly what we send to the PDP for authorization decisions in the secrets engine, with code-backed details and concrete examples."}),"\n",(0,c.jsx)(n.h3,{id:"where-the-pdp-call-happens",children:"Where the PDP call happens"}),"\n",(0,c.jsxs)(n.ul,{children:["\n",(0,c.jsxs)(n.li,{children:["Provider-enforced reads (PEP): ",(0,c.jsx)(n.code,{children:"VaultService.get_credentials(...)"})," calls ",(0,c.jsx)(n.code,{children:"SecretPolicyService.authorize_use(...)"})," with purpose ",(0,c.jsx)(n.code,{children:"execute"})," and an enriched context before any provider access."]}),"\n",(0,c.jsxs)(n.li,{children:["Admin/CRUD operations (API): ",(0,c.jsx)(n.code,{children:"src/api/secrets_routes.py"})," guards write, delete, rotate, versions, etc., by calling ",(0,c.jsx)(n.code,{children:"SecretPolicyService.authorize_batch(...)"})," with a purpose specific to the endpoint (e.g., ",(0,c.jsx)(n.code,{children:"write"}),", ",(0,c.jsx)(n.code,{children:"delete"}),", ",(0,c.jsx)(n.code,{children:"rotate"}),", ",(0,c.jsx)(n.code,{children:"read_metadata"}),", ",(0,c.jsx)(n.code,{children:"destroy_versions"}),", ",(0,c.jsx)(n.code,{children:"undelete"}),", ",(0,c.jsx)(n.code,{children:"owner_update"}),")."]}),"\n"]}),"\n",(0,c.jsx)(n.h3,{id:"what-we-send-fields",children:"What we send (fields)"}),"\n",(0,c.jsx)(n.h4,{id:"subject",children:"Subject"}),"\n",(0,c.jsxs)(n.ul,{children:["\n",(0,c.jsxs)(n.li,{children:[(0,c.jsx)(n.code,{children:"subject_arn"}),": Extracted from ",(0,c.jsx)(n.code,{children:"request.state.subject"}),". If missing, defaults to ",(0,c.jsx)(n.code,{children:"anonymous"}),"."]}),"\n"]}),"\n",(0,c.jsx)(n.h4,{id:"action-purpose",children:"Action (purpose)"}),"\n",(0,c.jsxs)(n.ul,{children:["\n",(0,c.jsxs)(n.li,{children:["PEP read path (provider-backed): purpose is ",(0,c.jsx)(n.code,{children:"execute"}),"."]}),"\n",(0,c.jsxs)(n.li,{children:["API routes purposes:","\n",(0,c.jsxs)(n.ul,{children:["\n",(0,c.jsxs)(n.li,{children:["Create/Update: ",(0,c.jsx)(n.code,{children:"write"})]}),"\n",(0,c.jsxs)(n.li,{children:["Delete (soft): ",(0,c.jsx)(n.code,{children:"delete"})]}),"\n",(0,c.jsxs)(n.li,{children:["Destroy versions (hard): ",(0,c.jsx)(n.code,{children:"destroy_versions"})]}),"\n",(0,c.jsxs)(n.li,{children:["Undelete versions: ",(0,c.jsx)(n.code,{children:"undelete"})]}),"\n",(0,c.jsxs)(n.li,{children:["Rotate: ",(0,c.jsx)(n.code,{children:"rotate"})]}),"\n",(0,c.jsxs)(n.li,{children:["Metadata listing/detail/search/keys/versions: ",(0,c.jsx)(n.code,{children:"read_metadata"})]}),"\n",(0,c.jsxs)(n.li,{children:["Owner update: ",(0,c.jsx)(n.code,{children:"owner_update"})]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,c.jsx)(n.h4,{id:"resource",children:"Resource"}),"\n",(0,c.jsxs)(n.ul,{children:["\n",(0,c.jsxs)(n.li,{children:[(0,c.jsx)(n.code,{children:"canonical_uri"}),": The Canonical Secret URI (e.g., ",(0,c.jsx)(n.code,{children:"openbao+kv2://secret/app/api#token"})," or without fragment for path-level operations)."]}),"\n",(0,c.jsxs)(n.li,{children:["Tenant guard ensures the mount is allowed (",(0,c.jsx)(n.code,{children:"TENANT_ALLOWED_MOUNTS"}),")."]}),"\n"]}),"\n",(0,c.jsx)(n.h4,{id:"context-enriched",children:"Context (enriched)"}),"\n",(0,c.jsxs)(n.p,{children:["For provider-backed reads (PEP in ",(0,c.jsx)(n.code,{children:"VaultService"}),"), we send:"]}),"\n",(0,c.jsxs)(n.ul,{children:["\n",(0,c.jsxs)(n.li,{children:[(0,c.jsx)(n.code,{children:"issuer"}),": ",(0,c.jsx)(n.code,{children:"request.state.issuer"})]}),"\n",(0,c.jsxs)(n.li,{children:[(0,c.jsx)(n.code,{children:"client_id"}),": ",(0,c.jsx)(n.code,{children:"request.state.client_id"})," (or ",(0,c.jsx)(n.code,{children:"azp"}),")"]}),"\n",(0,c.jsxs)(n.li,{children:[(0,c.jsx)(n.code,{children:"aud"}),": ",(0,c.jsx)(n.code,{children:"request.state.aud"})," (list/string); we also enforce that it includes ",(0,c.jsx)(n.code,{children:"SECRETS_AUDIENCE"})," at the PEP layer when present"]}),"\n",(0,c.jsxs)(n.li,{children:[(0,c.jsx)(n.code,{children:"token_jti"}),": ",(0,c.jsx)(n.code,{children:"request.state.token_jti"})," (for anti-replay)"]}),"\n",(0,c.jsxs)(n.li,{children:[(0,c.jsx)(n.code,{children:"correlation_id"}),": ",(0,c.jsx)(n.code,{children:"request.state.correlation_id"})]}),"\n",(0,c.jsxs)(n.li,{children:[(0,c.jsx)(n.code,{children:"workflow_run_id"}),": ",(0,c.jsx)(n.code,{children:"request.state.workflow_run_id"})]}),"\n",(0,c.jsxs)(n.li,{children:[(0,c.jsx)(n.code,{children:"node_id"}),": ",(0,c.jsx)(n.code,{children:"request.state.node_id"})]}),"\n",(0,c.jsxs)(n.li,{children:[(0,c.jsx)(n.code,{children:"system_id"}),": ",(0,c.jsx)(n.code,{children:"request.state.system_id"})]}),"\n",(0,c.jsxs)(n.li,{children:[(0,c.jsx)(n.code,{children:"resource_attributes"}),": owner and provenance attributes when available (see below)"]}),"\n"]}),"\n",(0,c.jsx)(n.p,{children:"Sender-binding (if available):"}),"\n",(0,c.jsxs)(n.ul,{children:["\n",(0,c.jsxs)(n.li,{children:[(0,c.jsx)(n.code,{children:"cnf_binding"}),": extracted as either DPoP ",(0,c.jsx)(n.code,{children:"jkt"})," (",(0,c.jsx)(n.code,{children:"request.state.cnf_jkt"}),") or mTLS thumbprint (",(0,c.jsx)(n.code,{children:"request.state.mtls_thumbprint"}),"). This value is bound to the grant and enforced for drift."]}),"\n"]}),"\n",(0,c.jsx)(n.p,{children:"Resource attributes (KVv2 custom metadata):"}),"\n",(0,c.jsxs)(n.ul,{children:["\n",(0,c.jsxs)(n.li,{children:["From provider metadata read, we attach:","\n",(0,c.jsxs)(n.ul,{children:["\n",(0,c.jsxs)(n.li,{children:[(0,c.jsx)(n.code,{children:"owner"}),": mutable owner ARN"]}),"\n",(0,c.jsxs)(n.li,{children:[(0,c.jsx)(n.code,{children:"created_by"}),": immutable creator ARN"]}),"\n",(0,c.jsxs)(n.li,{children:[(0,c.jsx)(n.code,{children:"created_at"}),": ISO timestamp"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,c.jsx)(n.p,{children:"These are automatically stamped on first write/rotation for KVv2 providers and fetched during PEP evaluation."}),"\n",(0,c.jsx)(n.h3,{id:"code-references",children:"Code references"}),"\n",(0,c.jsxs)(n.ul,{children:["\n",(0,c.jsxs)(n.li,{children:["\n",(0,c.jsx)(n.p,{children:"PEP: Context build and PDP call (execute):"}),"\n",(0,c.jsx)(n.pre,{children:(0,c.jsx)(n.code,{className:"language-391:413:CRUDService/src/services/vault_service.py",children:'pdp_context = {\r\n  "issuer": issuer,\r\n  "client_id": client_id,\r\n  "aud": audiences,\r\n  "token_jti": token_jti,\r\n  "correlation_id": correlation_id,\r\n  "workflow_run_id": workflow_run_id,\r\n  "node_id": node_id,\r\n  "system_id": system_id,\r\n}\r\n# resource_attributes added if present\r\ngrant = await self._policy.authorize_use(subject_arn or "anonymous", tenant_id, canonical_uri, "execute", cnf_binding, context=pdp_context)\n'})}),"\n"]}),"\n",(0,c.jsxs)(n.li,{children:["\n",(0,c.jsx)(n.p,{children:"Resource attributes enrichment (metadata \u2192 context.resource_attributes):"}),"\n",(0,c.jsx)(n.pre,{children:(0,c.jsx)(n.code,{className:"language-401:413:CRUDService/src/services/vault_service.py",children:'meta = await strat.read_secret_metadata(path_only)\r\ncustom = (meta or {}).get("custom_metadata", {})\r\npdp_context["resource_attributes"] = {k: v for k, v in custom.items() if k in {"owner","created_by","created_at"}}\n'})}),"\n"]}),"\n",(0,c.jsxs)(n.li,{children:["\n",(0,c.jsx)(n.p,{children:"Purpose mapping on API routes:"}),"\n",(0,c.jsxs)(n.ul,{children:["\n",(0,c.jsxs)(n.li,{children:["Create/Update (write):","\n",(0,c.jsx)(n.pre,{children:(0,c.jsx)(n.code,{className:"language-156:163:CRUDService/src/api/secrets_routes.py",children:'grants, failures = await svc.authorize_batch(..., purpose="write")\n'})}),"\n"]}),"\n",(0,c.jsxs)(n.li,{children:["Delete/Destroy/Undelete:","\n",(0,c.jsx)(n.pre,{children:(0,c.jsx)(n.code,{className:"language-380:395,1315:1322,1267:1274:CRUDService/src/api/secrets_routes.py",children:'purpose="delete" | "destroy_versions" | "undelete"\n'})}),"\n"]}),"\n",(0,c.jsxs)(n.li,{children:["Rotate:","\n",(0,c.jsx)(n.pre,{children:(0,c.jsx)(n.code,{className:"language-1112:1119:CRUDService/src/api/secrets_routes.py",children:'purpose="rotate"\n'})}),"\n"]}),"\n",(0,c.jsxs)(n.li,{children:["Metadata (list/detail/search/keys/versions):","\n",(0,c.jsx)(n.pre,{children:(0,c.jsx)(n.code,{className:"language-491:496,545:552,601:609,1075:1081,1225:1227:CRUDService/src/api/secrets_routes.py",children:'purpose="read_metadata"\n'})}),"\n"]}),"\n",(0,c.jsxs)(n.li,{children:["Owner update:","\n",(0,c.jsx)(n.pre,{children:(0,c.jsx)(n.code,{className:"language-...:CRUDService/src/api/secrets_routes.py",children:'purpose="owner_update"\n'})}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,c.jsx)(n.h3,{id:"example-payloads",children:"Example payloads"}),"\n",(0,c.jsx)(n.h4,{id:"1-provider-backed-read-pep-of-a-fragment",children:"1) Provider-backed read (PEP) of a fragment"}),"\n",(0,c.jsxs)(n.p,{children:["Request: ",(0,c.jsx)(n.code,{children:"GET /api/secrets/value?uri=openbao+kv2://secret/app/api#token"})]}),"\n",(0,c.jsx)(n.p,{children:"PDP input (conceptual):"}),"\n",(0,c.jsx)(n.pre,{children:(0,c.jsx)(n.code,{className:"language-json",children:'{\r\n  "subject_arn": "auth:account:idp:alice",\r\n  "tenant_id": "acme",\r\n  "canonical_uri": "openbao+kv2://secret/app/api#token",\r\n  "purpose": "execute",\r\n  "cnf_binding": "dp0p-jkt-sha256...",\r\n  "context": {\r\n    "issuer": "https://idp.example.com/api/oidc",\r\n    "client_id": "spa-client",\r\n    "aud": ["crud.secrets"],\r\n    "token_jti": "af2d...",\r\n    "correlation_id": "6c0d...",\r\n    "workflow_run_id": null,\r\n    "node_id": null,\r\n    "system_id": null,\r\n    "resource_attributes": {\r\n      "owner": "auth:account:idp:platform-team",\r\n      "created_by": "auth:account:idp:alice",\r\n      "created_at": "2025-01-25T12:34:56Z"\r\n    }\r\n  }\r\n}\n'})}),"\n",(0,c.jsx)(n.h4,{id:"2-rotate-a-secret-value-kvv2",children:"2) Rotate a secret value (KVv2)"}),"\n",(0,c.jsxs)(n.p,{children:["Request: ",(0,c.jsx)(n.code,{children:"POST /api/secrets/rotate { uri, value }"})]}),"\n",(0,c.jsx)(n.p,{children:"PDP input (conceptual):"}),"\n",(0,c.jsx)(n.pre,{children:(0,c.jsx)(n.code,{className:"language-json",children:'{\r\n  "subject_arn": "auth:account:idp:bob",\r\n  "tenant_id": "dev",\r\n  "canonical_uri": "openbao+kv2://secret/app/api#token",\r\n  "purpose": "rotate"\r\n}\n'})}),"\n",(0,c.jsx)(n.h4,{id:"3-update-owner-metadata",children:"3) Update owner metadata"}),"\n",(0,c.jsxs)(n.p,{children:["Request: ",(0,c.jsx)(n.code,{children:'POST /api/secrets/metadata/owner { uri: "openbao+kv2://secret/app/api", owner: "auth:account:idp:data-team" }'})]}),"\n",(0,c.jsx)(n.p,{children:"PDP input (conceptual):"}),"\n",(0,c.jsx)(n.pre,{children:(0,c.jsx)(n.code,{className:"language-json",children:'{\r\n  "subject_arn": "auth:account:idp:admin",\r\n  "tenant_id": "acme",\r\n  "canonical_uri": "openbao+kv2://secret/app/api",\r\n  "purpose": "owner_update"\r\n}\n'})}),"\n",(0,c.jsx)(n.h3,{id:"security-notes",children:"Security notes"}),"\n",(0,c.jsxs)(n.ul,{children:["\n",(0,c.jsxs)(n.li,{children:["Audience check at the PEP enforces that ",(0,c.jsx)(n.code,{children:"aud"})," includes ",(0,c.jsx)(n.code,{children:"SECRETS_AUDIENCE"})," when present."]}),"\n",(0,c.jsxs)(n.li,{children:["Anti-replay: ",(0,c.jsx)(n.code,{children:"token_jti"})," is checked in the grant cache; replays are denied."]}),"\n",(0,c.jsxs)(n.li,{children:["Sender-binding drift: if the ",(0,c.jsx)(n.code,{children:"cnf_binding"})," differs mid\u2011TTL, further uses are denied."]}),"\n",(0,c.jsx)(n.li,{children:"Resource attributes (owner/created_by/created_at) are fetched server-side from the provider to avoid trusting client-provided metadata."}),"\n"]}),"\n",(0,c.jsx)(n.hr,{}),"\n",(0,c.jsx)(n.p,{children:"See also:"}),"\n",(0,c.jsxs)(n.ul,{children:["\n",(0,c.jsxs)(n.li,{children:["Authorization model overview: ",(0,c.jsx)(n.code,{children:"./11-authorization-model-authzen.md"})]}),"\n",(0,c.jsxs)(n.li,{children:["API reference (purposes and scopes): ",(0,c.jsx)(n.code,{children:"./09-api-reference.md"})]}),"\n"]})]})}function u(e={}){const{wrapper:n}={...(0,t.R)(),...e.components};return n?(0,c.jsx)(n,{...e,children:(0,c.jsx)(l,{...e})}):l(e)}},28453:(e,n,r)=>{r.d(n,{R:()=>i,x:()=>d});var s=r(96540);const c={},t=s.createContext(c);function i(e){const n=s.useContext(t);return s.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function d(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(c):e.components||c:i(e.components),s.createElement(t.Provider,{value:n},e.children)}}}]);