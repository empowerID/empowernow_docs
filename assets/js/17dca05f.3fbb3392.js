"use strict";(self.webpackChunkempowernow_docs=self.webpackChunkempowernow_docs||[]).push([[4654],{28453:(e,s,n)=>{n.d(s,{R:()=>o,x:()=>c});var t=n(96540);const i={},r=t.createContext(i);function o(e){const s=t.useContext(r);return t.useMemo(function(){return"function"==typeof e?e(s):{...s,...e}},[s,e])}function c(e){let s;return s=e.disableParentContext?"function"==typeof e.components?e.components(i):e.components||i:o(e.components),t.createElement(r.Provider,{value:s},e.children)}},31848:(e,s,n)=>{n.r(s),n.d(s,{assets:()=>d,contentTitle:()=>c,default:()=>h,frontMatter:()=>o,metadata:()=>t,toc:()=>l});const t=JSON.parse('{"id":"services/bff/how-to/dcr-compose-wiring","title":"Wire the IAT into docker\u2011compose and run the BFF DCR bootstrap","description":"Where to paste the Initial Access Token (IAT) in compose, the restart sequence, verification, and how DCR_* settings affect behavior.","source":"@site/docs/services/bff/how-to/dcr-compose-wiring.md","sourceDirName":"services/bff/how-to","slug":"/services/bff/how-to/dcr-compose-wiring","permalink":"/empowernow_docs/docs/services/bff/how-to/dcr-compose-wiring","draft":false,"unlisted":false,"editUrl":"https://github.com/facebook/docusaurus/tree/main/packages/create-docusaurus/templates/shared/docs/services/bff/how-to/dcr-compose-wiring.md","tags":[],"version":"current","frontMatter":{"id":"dcr-compose-wiring","title":"Wire the IAT into docker\u2011compose and run the BFF DCR bootstrap","description":"Where to paste the Initial Access Token (IAT) in compose, the restart sequence, verification, and how DCR_* settings affect behavior.","sidebar_label":"DCR: wire IAT in compose"},"sidebar":"tutorialSidebar","previous":{"title":"Dynamic Client Registration (DCR) Runbook \u2014 BFF Client","permalink":"/empowernow_docs/docs/services/bff/how-to/dcr-bootstrap"},"next":{"title":"Deploy on Kubernetes","permalink":"/empowernow_docs/docs/services/bff/how-to/deploy-k8s"}}');var i=n(74848),r=n(28453);const o={id:"dcr-compose-wiring",title:"Wire the IAT into docker\u2011compose and run the BFF DCR bootstrap",description:"Where to paste the Initial Access Token (IAT) in compose, the restart sequence, verification, and how DCR_* settings affect behavior.",sidebar_label:"DCR: wire IAT in compose"},c=void 0,d={},l=[{value:"Where to edit",id:"where-to-edit",level:2},{value:"Restart sequence",id:"restart-sequence",level:2},{value:"Verify",id:"verify",level:2},{value:"How DCR settings impact behavior",id:"how-dcr-settings-impact-behavior",level:2},{value:"Next steps",id:"next-steps",level:2}];function a(e){const s={code:"code",h2:"h2",li:"li",ol:"ol",p:"p",pre:"pre",ul:"ul",...(0,r.R)(),...e.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(s.h2,{id:"where-to-edit",children:"Where to edit"}),"\n",(0,i.jsxs)(s.p,{children:["File: ",(0,i.jsx)(s.code,{children:"CRUDService/docker-compose-authzen4.yml"})," \u2192 service ",(0,i.jsx)(s.code,{children:"bff:"})," \u2192 ",(0,i.jsx)(s.code,{children:"environment:"})]}),"\n",(0,i.jsxs)(s.p,{children:["Replace ",(0,i.jsx)(s.code,{children:"DCR_IAT"})," with the short\u2011lived token you minted in the IdP step."]}),"\n",(0,i.jsx)(s.pre,{children:(0,i.jsx)(s.code,{className:"language-yaml",children:'bff:\n  # ...\n  environment:\n    DCR_ENABLED: "true"\n    SKIP_DCR_BOOTSTRAP: "false"\n    IDP_BASE_URL: http://idp-app:8002\n    DCR_IAT: <PASTE_IAT_TOKEN_HERE>\n    DCR_CLIENT_ID: bff-server\n    DCR_CLIENT_PROFILE: code-flow-pkjwt\n    DCR_REDIRECT_URIS: https://automate.ocg.labs.empowernow.ai/auth/callback,https://authn.ocg.labs.empowernow.ai/auth/callback,https://authz.ocg.labs.empowernow.ai/auth/callback\n    DCR_SIGNING_KEY: /app/keys/bff-sig-001.pem\n    BFF_KID: bff-sig-001\n    DCR_ROTATION_SAFE: "true"\n    DCR_REDIRECT_UPDATE_MODE: auto\n  # ...\n'})}),"\n",(0,i.jsx)(s.p,{children:"Notes"}),"\n",(0,i.jsxs)(s.ul,{children:["\n",(0,i.jsx)(s.li,{children:"Redirect URIs must be a comma\u2011 or space\u2011separated list your IdP accepts."}),"\n",(0,i.jsxs)(s.li,{children:[(0,i.jsx)(s.code,{children:"BFF_JWT_SIGNING_KEY"}),"/",(0,i.jsx)(s.code,{children:"BFF_KID"})," must correspond to the key published at ",(0,i.jsx)(s.code,{children:"/.well-known/jwks.json"}),"."]}),"\n"]}),"\n",(0,i.jsx)(s.h2,{id:"restart-sequence",children:"Restart sequence"}),"\n",(0,i.jsxs)(s.ol,{children:["\n",(0,i.jsx)(s.li,{children:"Apply compose changes."}),"\n",(0,i.jsx)(s.li,{children:"Restart IdP (if you changed DCR settings there), then restart BFF."}),"\n",(0,i.jsx)(s.li,{children:"Watch BFF logs for successful registration (201) or PATCH (200)."}),"\n",(0,i.jsxs)(s.li,{children:["After success, remove ",(0,i.jsx)(s.code,{children:"DCR_IAT"})," from compose and restart BFF once more."]}),"\n"]}),"\n",(0,i.jsx)(s.h2,{id:"verify",children:"Verify"}),"\n",(0,i.jsxs)(s.ul,{children:["\n",(0,i.jsxs)(s.li,{children:["IdP: ",(0,i.jsx)(s.code,{children:"GET /api/oidc/register/{client_id}"})," shows ",(0,i.jsx)(s.code,{children:"bff-server"})," with your ",(0,i.jsx)(s.code,{children:"jwks_uri"})," and ",(0,i.jsx)(s.code,{children:"kid"}),"."]}),"\n",(0,i.jsxs)(s.li,{children:["BFF: creds JSON present (if persisted), and JWKS served at ",(0,i.jsx)(s.code,{children:"/.well-known/jwks.json"})," includes ",(0,i.jsx)(s.code,{children:"bff-sig-001"}),"."]}),"\n"]}),"\n",(0,i.jsx)(s.h2,{id:"how-dcr-settings-impact-behavior",children:"How DCR settings impact behavior"}),"\n",(0,i.jsxs)(s.ul,{children:["\n",(0,i.jsxs)(s.li,{children:[(0,i.jsx)(s.code,{children:"DCR_ENABLED"})," (true): turns on bootstrap logic; if false, no DCR calls are made."]}),"\n",(0,i.jsxs)(s.li,{children:[(0,i.jsx)(s.code,{children:"SKIP_DCR_BOOTSTRAP"})," (false): run bootstrap on start; if true, skip DCR entirely."]}),"\n",(0,i.jsxs)(s.li,{children:[(0,i.jsx)(s.code,{children:"DCR_IAT"})," (token): used only when no cached client exists; remove after success."]}),"\n",(0,i.jsxs)(s.li,{children:[(0,i.jsx)(s.code,{children:"DCR_FORCE_REPLACE"})," (false): if true, delete/re\u2011register the client; use for hard resets."]}),"\n",(0,i.jsxs)(s.li,{children:[(0,i.jsx)(s.code,{children:"DCR_CLIENT_ID"})," (bff-server): desired client identifier; leave unset to let IdP assign."]}),"\n",(0,i.jsxs)(s.li,{children:[(0,i.jsx)(s.code,{children:"DCR_CLIENT_PROFILE"})," (code-flow-pkjwt): IdP template controlling defaults (grant types, auth method)."]}),"\n",(0,i.jsxs)(s.li,{children:[(0,i.jsx)(s.code,{children:"DCR_REDIRECT_URIS"}),": required for auth code flow; must exactly match SPA callback URLs."]}),"\n",(0,i.jsxs)(s.li,{children:[(0,i.jsx)(s.code,{children:"DCR_SIGNING_KEY"}),", ",(0,i.jsx)(s.code,{children:"BFF_KID"}),": private key and key id for ",(0,i.jsx)(s.code,{children:"private_key_jwt"}),"; IdP validates inline ",(0,i.jsx)(s.code,{children:"jwks"})," during PATCH."]}),"\n",(0,i.jsxs)(s.li,{children:[(0,i.jsx)(s.code,{children:"BFF_JWK_ROTATE_AFTER_DAYS"}),", ",(0,i.jsx)(s.code,{children:"BFF_JWK_RETIRE_AFTER_DAYS"}),", ",(0,i.jsx)(s.code,{children:"BFF_JWK_MAX_KEYS"}),": tune safe key rotation overlap."]}),"\n",(0,i.jsxs)(s.li,{children:[(0,i.jsx)(s.code,{children:"DCR_ROTATION_SAFE"}),", ",(0,i.jsx)(s.code,{children:"DCR_REDIRECT_UPDATE_MODE"}),": enable non-destructive redirect updates."]}),"\n"]}),"\n",(0,i.jsx)(s.h2,{id:"next-steps",children:"Next steps"}),"\n",(0,i.jsxs)(s.ul,{children:["\n",(0,i.jsxs)(s.li,{children:["If you haven\u2019t minted an IAT yet, see: ",(0,i.jsx)(s.code,{children:"services/idp/how-to/mint-iat-and-dcr"}),"."]}),"\n",(0,i.jsxs)(s.li,{children:["Operational policy and deeper details: ",(0,i.jsx)(s.code,{children:"services/bff/how-to/dcr-bootstrap"}),"."]}),"\n"]})]})}function h(e={}){const{wrapper:s}={...(0,r.R)(),...e.components};return s?(0,i.jsx)(s,{...e,children:(0,i.jsx)(a,{...e})}):a(e)}}}]);