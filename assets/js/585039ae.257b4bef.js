"use strict";(self.webpackChunkempowernow_docs=self.webpackChunkempowernow_docs||[]).push([[2685],{28453:(e,r,t)=>{t.d(r,{R:()=>i,x:()=>o});var a=t(96540);const s={},n=a.createContext(s);function i(e){const r=a.useContext(n);return a.useMemo(function(){return"function"==typeof e?e(r):{...r,...e}},[r,e])}function o(e){let r;return r=e.disableParentContext?"function"==typeof e.components?e.components(s):e.components||s:i(e.components),a.createElement(n.Provider,{value:r},e.children)}},43770:(e,r,t)=>{t.r(r),t.d(r,{assets:()=>d,contentTitle:()=>o,default:()=>l,frontMatter:()=>i,metadata:()=>a,toc:()=>c});const a=JSON.parse('{"id":"services/bff/reference/traefik-forwardauth","title":"Traefik ForwardAuth with the BFF (Verified)","description":"What this is","source":"@site/docs/services/bff/reference/traefik-forwardauth.md","sourceDirName":"services/bff/reference","slug":"/services/bff/reference/traefik-forwardauth","permalink":"/empowernow_docs/docs/services/bff/reference/traefik-forwardauth","draft":false,"unlisted":false,"editUrl":"https://github.com/facebook/docusaurus/tree/main/packages/create-docusaurus/templates/shared/docs/services/bff/reference/traefik-forwardauth.md","tags":[],"version":"current","frontMatter":{"title":"Traefik ForwardAuth with the BFF (Verified)"},"sidebar":"tutorialSidebar","previous":{"title":"Streaming / SSE","permalink":"/empowernow_docs/docs/services/bff/reference/streaming"},"next":{"title":"Permission Gating in the UI","permalink":"/empowernow_docs/docs/services/bff/reference/ui-permissions"}}');var s=t(74848),n=t(28453);const i={title:"Traefik ForwardAuth with the BFF (Verified)"},o=void 0,d={},c=[];function h(e){const r={code:"code",li:"li",mermaid:"mermaid",p:"p",pre:"pre",ul:"ul",...(0,n.R)(),...e.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(r.p,{children:"What this is"}),"\n",(0,s.jsxs)(r.ul,{children:["\n",(0,s.jsxs)(r.li,{children:["Traefik ForwardAuth lets the proxy ask an external HTTP endpoint whether to allow a request. In our setup, Traefik calls the BFF at ",(0,s.jsx)(r.code,{children:"/auth/forward"})," (alias of ",(0,s.jsx)(r.code,{children:"/auth/verify"}),")."]}),"\n",(0,s.jsxs)(r.li,{children:["If the BFF returns 200, Traefik forwards the original request to the target service and injects auth context headers (for example ",(0,s.jsx)(r.code,{children:"Authorization"}),", ",(0,s.jsx)(r.code,{children:"X-Session-ID"}),"). If the BFF returns 401, Traefik denies the request at the edge."]}),"\n",(0,s.jsxs)(r.li,{children:["We enable ForwardAuth only for service hosts that must be protected at the edge (for example ",(0,s.jsx)(r.code,{children:"pdp.ocg..."}),", Traefik dashboard). For same-origin SPA API calls to the BFF (",(0,s.jsx)(r.code,{children:"automate/authn/authz.ocg... \u2192 /api/**"}),"), ForwardAuth is intentionally disabled; the BFF performs auth and returns CORS-friendly JSON errors."]}),"\n"]}),"\n",(0,s.jsx)(r.p,{children:"Diagram"}),"\n",(0,s.jsx)(r.mermaid,{value:"flowchart LR\r\n  subgraph Client\r\n    B[Browser / Service Client]\r\n  end\r\n\r\n  subgraph Edge[Traefik]\r\n    R[Router (e.g., pdp-protected)]\r\n    FA[Middleware: bff-forwardauth]\r\n    SH[Security Headers]\r\n    RL[Rate Limit]\r\n  end\r\n\r\n  subgraph BFF\r\n    V[/GET /auth/forward\\n(alias of /auth/verify)/]\r\n  end\r\n\r\n  subgraph Backend\r\n    S[Protected Service (e.g., PDP)]\r\n  end\r\n\r\n  B --\x3e R\r\n  R --\x3e SH\r\n  R --\x3e RL\r\n  R --\x3e|ForwardAuth| FA --\x3e V\r\n  V --\x3e|200 + authResponseHeaders\\n(Authorization, X-Session-ID, ...)| R\r\n  V --\x3e|401 Unauthorized| R\r\n  R --\x3e|Allow| S\r\n  R --\x3e|Deny 401| B\r\n\r\n  %% SPA same-origin note (no ForwardAuth)\r\n  classDef note fill:#fff,stroke:#bbb,color:#555;\r\n  N1[[SPA hosts automate/authn/authz: /api/** \u2192 BFF directly\\nForwardAuth disabled; BFF authenticates and returns JSON 401]]:::note\r\n  N1 --- R"}),"\n",(0,s.jsx)(r.p,{children:"Endpoints and aliases (verified)"}),"\n",(0,s.jsxs)(r.ul,{children:["\n",(0,s.jsxs)(r.li,{children:["BFF exposes ",(0,s.jsx)(r.code,{children:"/auth/verify"})," and alias ",(0,s.jsx)(r.code,{children:"/auth/forward"})," (see ",(0,s.jsx)(r.code,{children:"ms_bff_spike/ms_bff/src/main.py"})," and ",(0,s.jsx)(r.code,{children:"ms_bff_spike/ms_bff/src/api/v1/endpoints/auth.py"}),"). Tests and configs reference both."]}),"\n"]}),"\n",(0,s.jsxs)(r.p,{children:["Traefik middleware (as in ",(0,s.jsx)(r.code,{children:"CRUDService/traefik/dynamic.yml"}),")"]}),"\n",(0,s.jsx)(r.pre,{children:(0,s.jsx)(r.code,{className:"language-yaml",children:'# ForwardAuth Middleware Configuration (dynamic.yml)\r\nhttp:\r\n  middlewares:\r\n    bff-forwardauth:\r\n      forwardAuth:\r\n        address: "http://bff_app:8000/auth/forward"  # alias of /auth/verify in BFF\r\n        trustForwardHeader: true\r\n        authResponseHeaders:\r\n          - "Authorization"      # JWT for backend services\r\n          - "X-User-ID"          # User context\r\n          - "X-Session-ID"       # Session reference\r\n          - "X-Auth-Time"        # Auth timestamp\r\n          - "X-User-Email"       # Optional\r\n          - "X-User-Name"        # Optional\r\n        authRequestHeaders:\r\n          - "Cookie"\r\n          - "X-Forwarded-For"\r\n          - "X-Real-IP"\r\n          - "User-Agent"\r\n          - "Accept"\r\n          - "Origin"\r\n          - "Referer"\r\n          - "Host"\n'})}),"\n",(0,s.jsxs)(r.p,{children:["Routers (selected, from ",(0,s.jsx)(r.code,{children:"dynamic.yml"}),")"]}),"\n",(0,s.jsx)(r.pre,{children:(0,s.jsx)(r.code,{className:"language-yaml",children:'http:\r\n  routers:\r\n    bff-public:\r\n      rule: "Host(`api.ocg.labs.empowernow.ai`) && (PathPrefix(`/auth/login`) || PathPrefix(`/auth/callback`) || PathPrefix(`/auth/forward`) || PathPrefix(`/auth/csrf`) || PathPrefix(`/health`))"\r\n      service: bff-service\r\n      middlewares: [security-headers, rate-limit]\r\n\r\n    bff-protected:\r\n      rule: "Host(`api.ocg.labs.empowernow.ai`) && !PathPrefix(`/auth/login`) && !PathPrefix(`/auth/callback`) && !PathPrefix(`/auth/forward`) && !PathPrefix(`/auth/csrf`) && !PathPrefix(`/health`)"\r\n      service: bff-service\r\n      middlewares: [security-headers, rate-limit]\r\n      # ForwardAuth intentionally disabled here; BFF returns CORS-enabled 401 JSON for SPA flows\r\n\r\n    pdp-protected:\r\n      rule: "Host(`pdp.ocg.labs.empowernow.ai`)"\r\n      service: pdp-service\r\n      middlewares: [bff-forwardauth, security-headers, rate-limit]\r\n\r\n    traefik-dashboard:\r\n      rule: "Host(`traefik.ocg.labs.empowernow.ai`) && (PathPrefix(`/api`) || PathPrefix(`/dashboard`))"\r\n      service: api@internal\r\n      middlewares: [bff-forwardauth, security-headers]\r\n\r\n    spa-auth:\r\n      rule: "(Host(`automate.ocg.labs.empowernow.ai`) || Host(`authn.ocg.labs.empowernow.ai`) || Host(`authz.ocg.labs.empowernow.ai`)) && PathPrefix(`/auth/`)"\r\n      service: bff-service\r\n      middlewares: [security-headers, rate-limit]\r\n\r\n    spa-api:\r\n      rule: "(Host(`automate.ocg.labs.empowernow.ai`) || Host(`authn.ocg.labs.empowernow.ai`) || Host(`authz.ocg.labs.empowernow.ai`)) && PathPrefix(`/api/`)"\r\n      service: bff-service\r\n      middlewares: [security-headers, rate-limit]\r\n      # ForwardAuth disabled for same-origin SPA pattern\n'})}),"\n",(0,s.jsx)(r.p,{children:"Behavior"}),"\n",(0,s.jsxs)(r.ul,{children:["\n",(0,s.jsxs)(r.li,{children:["Where ForwardAuth is enabled (e.g., PDP and dashboard), Traefik calls ",(0,s.jsx)(r.code,{children:"/auth/forward"}),"; BFF validates session and returns 200 with headers (including ",(0,s.jsx)(r.code,{children:"Authorization"}),") or 401."]}),"\n",(0,s.jsxs)(r.li,{children:["For SPA same-origin ",(0,s.jsx)(r.code,{children:"/api/**"})," routes, ForwardAuth is intentionally disabled and BFF performs auth, returning CORS-enabled 401 JSON when unauthenticated."]}),"\n",(0,s.jsxs)(r.li,{children:["SPA routers must exclude API/auth/stream/PDP paths so the SPA assets router does not intercept API traffic. Create separate routers on the BFF host that forward ",(0,s.jsx)(r.code,{children:"/api/"}),", ",(0,s.jsx)(r.code,{children:"/auth/"}),", ",(0,s.jsx)(r.code,{children:"/access/v1/"}),", and stream paths to the BFF app."]}),"\n"]}),"\n",(0,s.jsx)(r.p,{children:"SPA PDP calls (AuthZEN) via preserved paths"}),"\n",(0,s.jsxs)(r.ul,{children:["\n",(0,s.jsxs)(r.li,{children:["On SPA hosts, PDP calls use preserved paths (",(0,s.jsx)(r.code,{children:"/access/v1/evaluation(s)"}),") and still route to the BFF (ForwardAuth disabled on SPA hosts). The BFF proxies to ",(0,s.jsx)(r.code,{children:"pdp_service"})," with ",(0,s.jsx)(r.code,{children:"preserve_path: true"})," per ",(0,s.jsx)(r.code,{children:"routes.yaml"}),"."]}),"\n",(0,s.jsxs)(r.li,{children:["The ",(0,s.jsx)(r.code,{children:"pdp-protected"})," router with ForwardAuth is for direct access to the PDP host (e.g., non-SPA clients), not for SPA same-origin calls."]}),"\n"]}),"\n",(0,s.jsx)(r.p,{children:"Where it\u2019s configured (source of truth)"}),"\n",(0,s.jsxs)(r.ul,{children:["\n",(0,s.jsxs)(r.li,{children:[(0,s.jsx)(r.code,{children:"CRUDService/traefik/dynamic.yml"}),": defines ",(0,s.jsx)(r.code,{children:"middlewares.bff-forwardauth.forwardAuth.address"})," and sets ",(0,s.jsx)(r.code,{children:"authResponseHeaders"}),"/",(0,s.jsx)(r.code,{children:"authRequestHeaders"}),". Routers like ",(0,s.jsx)(r.code,{children:"pdp-protected"})," and ",(0,s.jsx)(r.code,{children:"traefik-dashboard"})," attach this middleware."]}),"\n",(0,s.jsxs)(r.li,{children:[(0,s.jsx)(r.code,{children:"CRUDService/docker-compose-authzen4.yml"}),": Traefik service labels apply ",(0,s.jsx)(r.code,{children:"bff-forwardauth@file"})," to the dashboard; BFF router labels route SPA hosts ",(0,s.jsx)(r.code,{children:"/api/**"})," and ",(0,s.jsx)(r.code,{children:"/auth/**"})," without ForwardAuth."]}),"\n",(0,s.jsxs)(r.li,{children:[(0,s.jsx)(r.code,{children:"ServiceConfigs/BFF/config/routes.yaml"}),": the BFF\u2019s own upstream proxy map; unrelated to ForwardAuth itself but explains what ",(0,s.jsx)(r.code,{children:"/api/**"})," the BFF will handle after authentication. For PDP preserved paths, ensure routes exist for ",(0,s.jsx)(r.code,{children:"/access/v1/evaluation(s)"})," with ",(0,s.jsx)(r.code,{children:"preserve_path: true"}),"."]}),"\n"]}),"\n",(0,s.jsx)(r.p,{children:"Testing (from QA guide)"}),"\n",(0,s.jsx)(r.pre,{children:(0,s.jsx)(r.code,{className:"language-bash",children:"curl http://localhost:8000/auth/forward  # 401/403 unauthenticated\n"})})]})}function l(e={}){const{wrapper:r}={...(0,n.R)(),...e.components};return r?(0,s.jsx)(r,{...e,children:(0,s.jsx)(h,{...e})}):h(e)}}}]);