"use strict";(self.webpackChunkempowernow_docs=self.webpackChunkempowernow_docs||[]).push([[6328],{28453:(e,n,i)=>{i.d(n,{R:()=>d,x:()=>r});var s=i(96540);const l={},c=s.createContext(l);function d(e){const n=s.useContext(c);return s.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function r(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(l):e.components||l:d(e.components),s.createElement(c.Provider,{value:n},e.children)}},80388:(e,n,i)=>{i.r(n),i.d(n,{assets:()=>a,contentTitle:()=>r,default:()=>h,frontMatter:()=>d,metadata:()=>s,toc:()=>o});const s=JSON.parse('{"id":"services/bff/how-to/analytics-audience-bridged-via-bff","title":"Audience\u2011bridged Analytics via BFF (Admin & Dev brief)","description":"Admin and developer brief for enabling Analytics via the BFF using audience\u2011scoped tokens, including config ownership, rollout steps, verification, and troubleshooting.","source":"@site/docs/services/bff/how-to/analytics-audience-bridged-via-bff.md","sourceDirName":"services/bff/how-to","slug":"/services/bff/how-to/analytics-audience-bridged-via-bff","permalink":"/empowernow_docs/docs/services/bff/how-to/analytics-audience-bridged-via-bff","draft":false,"unlisted":false,"editUrl":"https://github.com/facebook/docusaurus/tree/main/packages/create-docusaurus/templates/shared/docs/services/bff/how-to/analytics-audience-bridged-via-bff.md","tags":[],"version":"current","frontMatter":{"id":"analytics-audience-bridged-via-bff","title":"Audience\u2011bridged Analytics via BFF (Admin & Dev brief)","description":"Admin and developer brief for enabling Analytics via the BFF using audience\u2011scoped tokens, including config ownership, rollout steps, verification, and troubleshooting.","sidebar_label":"Analytics via BFF (audience\u2011bridged)"},"sidebar":"tutorialSidebar","previous":{"title":"Alerting Cookbook \u2014 Metrics and SLO Hints","permalink":"/empowernow_docs/docs/services/bff/how-to/alerting-cookbook"},"next":{"title":"Backup and Restore Sessions (Redis)","permalink":"/empowernow_docs/docs/services/bff/how-to/backup-restore-sessions"}}');var l=i(74848),c=i(28453);const d={id:"analytics-audience-bridged-via-bff",title:"Audience\u2011bridged Analytics via BFF (Admin & Dev brief)",description:"Admin and developer brief for enabling Analytics via the BFF using audience\u2011scoped tokens, including config ownership, rollout steps, verification, and troubleshooting.",sidebar_label:"Analytics via BFF (audience\u2011bridged)"},r=void 0,a={},o=[{value:"What changed",id:"what-changed",level:2},{value:"Why",id:"why",level:2},{value:"Files and ownership",id:"files-and-ownership",level:2},{value:"Admin guide (rollout)",id:"admin-guide-rollout",level:2},{value:"Dev guide (SPA teams)",id:"dev-guide-spa-teams",level:2},{value:"Snippets",id:"snippets",level:2},{value:"See also",id:"see-also",level:2}];function t(e){const n={code:"code",h2:"h2",li:"li",p:"p",pre:"pre",ul:"ul",...(0,c.R)(),...e.components};return(0,l.jsxs)(l.Fragment,{children:[(0,l.jsx)(n.h2,{id:"what-changed",children:"What changed"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:["Added Analytics as a first\u2011class BFF\u2011proxied service. The BFF now mints/uses a service token for ",(0,l.jsx)(n.code,{children:"analytics_service"})," so SPA calls to ",(0,l.jsx)(n.code,{children:"/api/v1/analytics/*"})," succeed under session auth."]}),"\n"]}),"\n",(0,l.jsx)(n.h2,{id:"why",children:"Why"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:["Backends don\u2019t accept browser cookies. The BFF validates the SPA session and forwards with a service\u2011scoped access token (audience\u2011bound to the target backend). Without a token for the target service, the BFF returns ",(0,l.jsx)(n.code,{children:"401"}),"."]}),"\n"]}),"\n",(0,l.jsx)(n.h2,{id:"files-and-ownership",children:"Files and ownership"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"BFF routing (unchanged; for reference)"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsx)(n.li,{children:(0,l.jsx)(n.code,{children:"ServiceConfigs/BFF/config/routes.yaml"})}),"\n",(0,l.jsxs)(n.li,{children:["Route id: ",(0,l.jsx)(n.code,{children:"api-analytics"})," mapping ",(0,l.jsx)(n.code,{children:"/api/v1/analytics/*"})," \u2192 ",(0,l.jsx)(n.code,{children:"analytics_service"})," (session auth)."]}),"\n",(0,l.jsx)(n.li,{children:"Owner: BFF platform team."}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"IdP configuration (audiences/scopes)"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"ServiceConfigs/IdP/config/settings.yaml"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:["Added Analytics audience under scope mapping for ",(0,l.jsx)(n.code,{children:"application.all"}),"."]}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"ServiceConfigs/IdP/config/clients.yaml"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"bff-server.allowed_audiences"})," includes ",(0,l.jsx)(n.code,{children:"https://analytics.ocg.labs.empowernow.ai"}),"."]}),"\n"]}),"\n"]}),"\n",(0,l.jsx)(n.li,{children:"Owner: IdP platform team."}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"BFF settings"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"ms_bff_spike/config/settings.yaml"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:["Ensured login scopes include ",(0,l.jsx)(n.code,{children:"application.all"}),"."]}),"\n"]}),"\n"]}),"\n",(0,l.jsx)(n.li,{children:"Owner: BFF platform team."}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"BFF token mapping (temporary V1)"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"ms_bff_spike/ms_bff/src/api/v1/endpoints/auth.py"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:["Extended service token map with:","\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"analytics_service"})," \u2192 audience ",(0,l.jsx)(n.code,{children:"https://analytics.ocg.labs.empowernow.ai"})]}),"\n",(0,l.jsxs)(n.li,{children:["required scopes: ",(0,l.jsx)(n.code,{children:"api.read | api.write | application.all"})]}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,l.jsx)(n.li,{children:"Owner: BFF platform team (will move to config in V2)."}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,l.jsx)(n.h2,{id:"admin-guide-rollout",children:"Admin guide (rollout)"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"Pre\u2011reqs"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:["Confirm ",(0,l.jsx)(n.code,{children:"routes.yaml"})," has ",(0,l.jsx)(n.code,{children:"api-analytics"})," and ",(0,l.jsx)(n.code,{children:"target_service: analytics_service"}),"."]}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"Change set"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:["IdP: add Analytics audience to ",(0,l.jsx)(n.code,{children:"application.all"}),", allow for ",(0,l.jsx)(n.code,{children:"bff-server"})," client."]}),"\n",(0,l.jsxs)(n.li,{children:["BFF: ensure ",(0,l.jsx)(n.code,{children:"auth.oauth_scopes"})," includes ",(0,l.jsx)(n.code,{children:"application.all"}),"."]}),"\n",(0,l.jsxs)(n.li,{children:["BFF: add ",(0,l.jsx)(n.code,{children:"analytics_service"})," to the service token mapping (V1)."]}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"Deploy"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsx)(n.li,{children:"Restart IdP, then restart BFF."}),"\n",(0,l.jsx)(n.li,{children:"Ask users to log out/in (new session) and hard refresh SPA."}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"Verify"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:["DevTools Network:","\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"GET /api/v1/analytics/*"})," returns 200."]}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["BFF logs:","\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:["Look for ",(0,l.jsx)(n.code,{children:"bff_service_tokens_mapped"})," including ",(0,l.jsx)(n.code,{children:"analytics_service"}),"."]}),"\n",(0,l.jsxs)(n.li,{children:["Proxy lines show ",(0,l.jsx)(n.code,{children:"token_found=True"})," for ",(0,l.jsx)(n.code,{children:"service=analytics_service"}),"."]}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"Troubleshooting"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"401"})," and logs show ",(0,l.jsx)(n.code,{children:"NO_TOKEN_AVAILABLE service=analytics_service"}),":","\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsx)(n.li,{children:"The service wasn\u2019t in the token map or IdP audience wasn\u2019t permitted."}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"401"})," with ",(0,l.jsx)(n.code,{children:"token_found=True"}),":","\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:["Token audience mismatch; confirm audience exactly equals ",(0,l.jsx)(n.code,{children:"https://analytics.ocg.labs.empowernow.ai"}),"."]}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["Old session:","\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsx)(n.li,{children:"Log out/in to refresh tokens after config changes."}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"Security notes"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:["Keep audiences least\u2011privileged. Prefer ",(0,l.jsx)(n.code,{children:"api.read"})," where possible; ",(0,l.jsx)(n.code,{children:"application.all"})," is used here for compatibility and will be narrowed in V2."]}),"\n",(0,l.jsx)(n.li,{children:"BFF is the only component that holds/forwards service tokens."}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,l.jsx)(n.h2,{id:"dev-guide-spa-teams",children:"Dev guide (SPA teams)"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"Canonical paths (no change)"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:["Always call Analytics via BFF:","\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsx)(n.li,{children:(0,l.jsx)(n.code,{children:"/api/v1/analytics/workflows"})}),"\n",(0,l.jsx)(n.li,{children:(0,l.jsx)(n.code,{children:"/api/v1/analytics/authorization-metrics?service=crud"})}),"\n",(0,l.jsx)(n.li,{children:(0,l.jsx)(n.code,{children:"/api/v1/analytics/anomalous-access-patterns?..."})}),"\n"]}),"\n"]}),"\n",(0,l.jsx)(n.li,{children:"Include credentials in fetch; our helper does this."}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"Expected responses"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"200"})," with JSON on success; ",(0,l.jsx)(n.code,{children:"401"})," means the BFF service token isn\u2019t available (not a front\u2011end bug)."]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,l.jsx)(n.h2,{id:"snippets",children:"Snippets"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:["IdP scope \u2192 audience mapping (",(0,l.jsx)(n.code,{children:"settings.yaml"}),")"]}),"\n"]}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-yaml",children:"token:\r\n  audience_mappings:\r\n    scope_mappings:\r\n      - scope: application.all\r\n        audiences:\r\n          - https://idp.ocg.labs.empowernow.ai/api/admin\r\n          - https://idp.ocg.labs.empowernow.ai/api/v1\r\n          - https://crud.ocg.labs.empowernow.ai\r\n          - empowernow\r\n          - https://analytics.ocg.labs.empowernow.ai\n"})}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:["IdP ",(0,l.jsx)(n.code,{children:"bff-server"})," allowed audiences (",(0,l.jsx)(n.code,{children:"clients.yaml"}),")"]}),"\n"]}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-yaml",children:"bff-server:\r\n  allowed_audiences:\r\n    - empowernow\r\n    - https://analytics.ocg.labs.empowernow.ai\n"})}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:["BFF login scopes (",(0,l.jsx)(n.code,{children:"settings.yaml"}),")"]}),"\n"]}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-yaml",children:'auth:\r\n  oauth_scopes: "openid profile email application.all offline_access"\n'})}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:["BFF service token map (V1, ",(0,l.jsx)(n.code,{children:"auth.py"}),")"]}),"\n"]}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-python",children:'"analytics_service": {\r\n  "audience": "https://analytics.ocg.labs.empowernow.ai",\r\n  "scopes": ["api.read", "api.write", "application.all"]\r\n}\n'})}),"\n",(0,l.jsx)(n.h2,{id:"see-also",children:"See also"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsx)(n.li,{children:(0,l.jsx)(n.code,{children:"services/bff/how-to/session-to-service-token-bridging"})}),"\n"]})]})}function h(e={}){const{wrapper:n}={...(0,c.R)(),...e.components};return n?(0,l.jsx)(n,{...e,children:(0,l.jsx)(t,{...e})}):t(e)}}}]);