"use strict";(self.webpackChunkempowernow_docs=self.webpackChunkempowernow_docs||[]).push([[660],{10800:(e,r,s)=>{s.r(r),s.d(r,{assets:()=>a,contentTitle:()=>l,default:()=>h,frontMatter:()=>o,metadata:()=>n,toc:()=>t});const n=JSON.parse('{"id":"services/bff/how-to/add-legacy-service","title":"Add a legacy service to the proxy","description":"Goal: register a new legacy C# service behind /api/v1/proxy/.","source":"@site/docs/services/bff/how-to/add-legacy-service.md","sourceDirName":"services/bff/how-to","slug":"/services/bff/how-to/add-legacy-service","permalink":"/empowernow_docs/docs/services/bff/how-to/add-legacy-service","draft":false,"unlisted":false,"editUrl":"https://github.com/facebook/docusaurus/tree/main/packages/create-docusaurus/templates/shared/docs/services/bff/how-to/add-legacy-service.md","tags":[{"inline":true,"label":"service:bff","permalink":"/empowernow_docs/docs/tags/service-bff"},{"inline":true,"label":"type:how-to","permalink":"/empowernow_docs/docs/tags/type-how-to"},{"inline":true,"label":"roles:devops","permalink":"/empowernow_docs/docs/tags/roles-devops"},{"inline":true,"label":"roles:developer","permalink":"/empowernow_docs/docs/tags/roles-developer"}],"version":"current","frontMatter":{"id":"add-legacy-service","title":"Add a legacy service to the proxy","sidebar_label":"Add legacy service","tags":["service:bff","type:how-to","roles:devops","roles:developer"]},"sidebar":"tutorialSidebar","previous":{"title":"Integrate a React SPA with the BFF","permalink":"/empowernow_docs/docs/services/bff/how-to/spa-with-bff"},"next":{"title":"Admin Quickstart \u2014 Bring up the BFF","permalink":"/empowernow_docs/docs/services/bff/how-to/admin-quickstart"}}');var i=s(74848),c=s(28453);const o={id:"add-legacy-service",title:"Add a legacy service to the proxy",sidebar_label:"Add legacy service",tags:["service:bff","type:how-to","roles:devops","roles:developer"]},l=void 0,a={},t=[];function d(e){const r={code:"code",li:"li",mermaid:"mermaid",ol:"ol",p:"p",pre:"pre",ul:"ul",...(0,c.R)(),...e.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsxs)(r.p,{children:["Goal: register a new legacy C# service behind ",(0,i.jsx)(r.code,{children:"/api/v1/proxy/{service}"}),"."]}),"\n",(0,i.jsx)(r.p,{children:"Steps"}),"\n",(0,i.jsxs)(r.ol,{children:["\n",(0,i.jsxs)(r.li,{children:["Edit ",(0,i.jsx)(r.code,{children:"ServiceConfigs/BFF/config/legacy_services.yaml"}),"\n",(0,i.jsxs)(r.ul,{children:["\n",(0,i.jsxs)(r.li,{children:["Add entry under ",(0,i.jsx)(r.code,{children:"legacy_services:"})]}),"\n"]}),"\n",(0,i.jsx)(r.pre,{children:(0,i.jsx)(r.code,{className:"language-yaml",children:'legacy_services:\r\n  my-service: "https://myservice.example.com/api"\n'})}),"\n",(0,i.jsxs)(r.ul,{children:["\n",(0,i.jsxs)(r.li,{children:["Optional per\u2011service timeout under ",(0,i.jsx)(r.code,{children:"legacy_service_timeouts:"})]}),"\n"]}),"\n"]}),"\n",(0,i.jsx)(r.li,{children:"Deploy config and restart BFF"}),"\n",(0,i.jsx)(r.li,{children:"Test:"}),"\n"]}),"\n",(0,i.jsx)(r.pre,{children:(0,i.jsx)(r.code,{className:"language-bash",children:'curl -I --cookie "_eid_sid=..." https://.../api/v1/proxy/my-service/health\n'})}),"\n",(0,i.jsx)(r.p,{children:"Tips"}),"\n",(0,i.jsxs)(r.ul,{children:["\n",(0,i.jsxs)(r.li,{children:["Override URL per environment with ",(0,i.jsx)(r.code,{children:"LEGACY_SERVICE_MY_SERVICE_URL"})]}),"\n",(0,i.jsxs)(r.li,{children:["Watch ",(0,i.jsx)(r.code,{children:"/api/v1/proxy/health"})," for CB/cache status"]}),"\n"]}),"\n",(0,i.jsxs)(r.p,{children:["See also: ",(0,i.jsx)(r.code,{children:"../reference/legacy-proxy"})]}),"\n",(0,i.jsx)(r.p,{children:"When to use this vs routes.yaml vs custom BFF endpoints"}),"\n",(0,i.jsxs)(r.ul,{children:["\n",(0,i.jsx)(r.li,{children:"Use this legacy proxy when you need a compatibility bridge to an existing service and a straight pass\u2011through is sufficient."}),"\n",(0,i.jsxs)(r.li,{children:["Prefer ",(0,i.jsx)(r.code,{children:"routes.yaml"})," for canonical ",(0,i.jsx)(r.code,{children:"/api/..."})," routes to modern services. It gives typed mapping, PDP authorization mapping, and streaming flags."]}),"\n",(0,i.jsx)(r.li,{children:"Create a custom BFF endpoint when you need aggregation/orchestration, token transformations (e.g., DPoP), request/response shaping, uploads, background jobs, or per\u2011user business limits. See Reference \u2192 Amazing FAQ \u2192 \u201cWhen do I need a custom BFF endpoint?\u201d."}),"\n"]}),"\n",(0,i.jsx)(r.p,{children:"Prerequisites"}),"\n",(0,i.jsxs)(r.ul,{children:["\n",(0,i.jsxs)(r.li,{children:["Your BFF is running with the config volume: ",(0,i.jsx)(r.code,{children:"ServiceConfigs/BFF/config"})," mounted to ",(0,i.jsx)(r.code,{children:"/app/config"})," (already set in compose)."]}),"\n",(0,i.jsxs)(r.li,{children:["You are logged in so your browser has the BFF session cookie (",(0,i.jsx)(r.code,{children:"_eid_sid"}),")."]}),"\n"]}),"\n",(0,i.jsx)(r.p,{children:"Minimal working example"}),"\n",(0,i.jsx)(r.pre,{children:(0,i.jsx)(r.code,{className:"language-yaml",children:'# ServiceConfigs/BFF/config/legacy_services.yaml\r\nlegacy_services:\r\n  res-admin: "${LEGACY_SERVICE_RES_ADMIN_URL:-https://api.empoweriam.com/api}"\r\n\r\n# Optional per\u2011service timeouts (seconds)\r\nlegacy_service_timeouts:\r\n  res-admin: ${LEGACY_SERVICE_RES_ADMIN_TIMEOUT:-30.0}\r\n\r\n# Optional (defaults exist): circuit breaker, cache, request size\r\ncircuit_breaker:\r\n  threshold: 5\r\n  reset_time: 60\r\nresponse_cache:\r\n  enabled: true\r\n  default_ttl: 30\r\nrequest_limits:\r\n  max_body_size: 10485760\n'})}),"\n",(0,i.jsx)(r.p,{children:"Environment overrides"}),"\n",(0,i.jsxs)(r.ul,{children:["\n",(0,i.jsxs)(r.li,{children:[(0,i.jsx)(r.code,{children:"LEGACY_SERVICE_<NAME>_URL"})," overrides the base URL at runtime, e.g. ",(0,i.jsx)(r.code,{children:"LEGACY_SERVICE_RES_ADMIN_URL=https://staging.example.com/api"}),"."]}),"\n",(0,i.jsxs)(r.li,{children:[(0,i.jsx)(r.code,{children:"LEGACY_SERVICE_<NAME>_TIMEOUT"})," overrides per\u2011service timeouts."]}),"\n"]}),"\n",(0,i.jsx)(r.p,{children:"Flow"}),"\n",(0,i.jsx)(r.mermaid,{value:'flowchart LR\r\n  SPA[SPA / API Client] --\x3e|"/api/v1/proxy/[service]/[path]"| BFF\r\n  subgraph BFF\r\n    CB[Circuit breaker]\r\n    RC[Response cache]\r\n    LP[Legacy Proxy]\r\n  end\r\n  BFF --\x3e CB --\x3e RC --\x3e LP --\x3e SVC\r\n  SVC["Legacy Service base_url + /[path]"] --\x3e RC\r\n  RC --\x3e BFF\r\n  BFF --\x3e SPA'}),"\n",(0,i.jsx)(r.p,{children:"Test it"}),"\n",(0,i.jsx)(r.pre,{children:(0,i.jsx)(r.code,{className:"language-bash",children:'# HEAD/health check (requires logged\u2011in session cookie)\r\ncurl -I --cookie "_eid_sid=..." \\\r\n  https://api.ocg.labs.empowernow.ai/api/v1/proxy/res-admin/health\r\n\r\n# GET with query params\r\ncurl --cookie "_eid_sid=..." \\\r\n  "https://api.ocg.labs.empowernow.ai/api/v1/proxy/res-admin/services/v1/resadmin/resources/people/getsearch?top=25"\r\n\r\n# POST example\r\ncurl -X POST --cookie "_eid_sid=..." \\\r\n  -H "Content-Type: application/json" \\\r\n  -d \'{"name":"Example"}\' \\\r\n  https://api.ocg.labs.empowernow.ai/api/v1/proxy/res-admin/services/v1/resadmin/resources/People/create\n'})}),"\n",(0,i.jsx)(r.p,{children:"Troubleshooting"}),"\n",(0,i.jsxs)(r.ul,{children:["\n",(0,i.jsxs)(r.li,{children:["404 unknown service: the ",(0,i.jsx)(r.code,{children:"{service}"})," segment must match a key in ",(0,i.jsx)(r.code,{children:"legacy_services"})," (e.g., ",(0,i.jsx)(r.code,{children:"res-admin"}),")."]}),"\n",(0,i.jsx)(r.li,{children:"401/403: ensure you\u2019re logged in (401) and have authorization to call the upstream action (403 via PDP)."}),"\n",(0,i.jsxs)(r.li,{children:["502/timeout: increase ",(0,i.jsx)(r.code,{children:"legacy_service_timeouts.<service>"})," or fix upstream URL/health."]}),"\n",(0,i.jsxs)(r.li,{children:["Circuit open quickly: tune ",(0,i.jsx)(r.code,{children:"circuit_breaker.threshold"})," and ",(0,i.jsx)(r.code,{children:"reset_time"}),"; check upstream errors."]}),"\n",(0,i.jsxs)(r.li,{children:["Large uploads rejected: raise ",(0,i.jsx)(r.code,{children:"request_limits.max_body_size"})," accordingly."]}),"\n",(0,i.jsxs)(r.li,{children:["Cache confusion: temporarily set ",(0,i.jsx)(r.code,{children:"response_cache.enabled: false"})," when debugging."]}),"\n"]}),"\n",(0,i.jsx)(r.p,{children:"References"}),"\n",(0,i.jsxs)(r.ul,{children:["\n",(0,i.jsx)(r.li,{children:"Reference \u2192 Legacy proxy"}),"\n",(0,i.jsx)(r.li,{children:"Reference \u2192 legacy_services.yaml"}),"\n",(0,i.jsx)(r.li,{children:"Reference \u2192 routes.yaml"}),"\n",(0,i.jsx)(r.li,{children:"How\u2011to \u2192 Tune legacy proxy circuit breaker and cache"}),"\n"]})]})}function h(e={}){const{wrapper:r}={...(0,c.R)(),...e.components};return r?(0,i.jsx)(r,{...e,children:(0,i.jsx)(d,{...e})}):d(e)}},28453:(e,r,s)=>{s.d(r,{R:()=>o,x:()=>l});var n=s(96540);const i={},c=n.createContext(i);function o(e){const r=n.useContext(c);return n.useMemo(function(){return"function"==typeof e?e(r):{...r,...e}},[r,e])}function l(e){let r;return r=e.disableParentContext?"function"==typeof e.components?e.components(i):e.components||i:o(e.components),n.createElement(c.Provider,{value:r},e.children)}}}]);