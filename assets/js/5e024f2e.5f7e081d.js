"use strict";(self.webpackChunkempowernow_docs=self.webpackChunkempowernow_docs||[]).push([[8058],{28453:(e,n,i)=>{i.d(n,{R:()=>o,x:()=>l});var s=i(96540);const r={},c=s.createContext(r);function o(e){const n=s.useContext(c);return s.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function l(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(r):e.components||r:o(e.components),s.createElement(c.Provider,{value:n},e.children)}},99336:(e,n,i)=>{i.r(n),i.d(n,{assets:()=>t,contentTitle:()=>l,default:()=>h,frontMatter:()=>o,metadata:()=>s,toc:()=>d});const s=JSON.parse('{"id":"services/nowconnect/explanation/metrics-and-reliability","title":"NowConnect and LDAP connector reliability enhancements","description":"New NowConnect cloud metrics and LDAP connector idempotency to improve reliability, observability, and operations.","source":"@site/docs/services/nowconnect/explanation/metrics-and-reliability.md","sourceDirName":"services/nowconnect/explanation","slug":"/services/nowconnect/explanation/metrics-and-reliability","permalink":"/empowernow_docs/docs/services/nowconnect/explanation/metrics-and-reliability","draft":false,"unlisted":false,"editUrl":"https://github.com/facebook/docusaurus/tree/main/packages/create-docusaurus/templates/shared/docs/services/nowconnect/explanation/metrics-and-reliability.md","tags":[],"version":"current","frontMatter":{"id":"metrics-and-reliability","title":"NowConnect and LDAP connector reliability enhancements","description":"New NowConnect cloud metrics and LDAP connector idempotency to improve reliability, observability, and operations.","sidebar_label":"Metrics and reliability"},"sidebar":"tutorialSidebar","previous":{"title":"HA V2 architecture & ops","permalink":"/empowernow_docs/docs/services/nowconnect/explanation/ha-v2-architecture"},"next":{"title":"visual-guide","permalink":"/empowernow_docs/docs/services/nowconnect/explanation/visual-guide"}}');var r=i(74848),c=i(28453);const o={id:"metrics-and-reliability",title:"NowConnect and LDAP connector reliability enhancements",description:"New NowConnect cloud metrics and LDAP connector idempotency to improve reliability, observability, and operations.",sidebar_label:"Metrics and reliability"},l=void 0,t={},d=[{value:"Scope",id:"scope",level:3},{value:"What changed",id:"what-changed",level:2},{value:"NowConnect cloud observability",id:"nowconnect-cloud-observability",level:3},{value:"LDAP connector idempotency",id:"ldap-connector-idempotency",level:3},{value:"Why it matters",id:"why-it-matters",level:2},{value:"How to use",id:"how-to-use",level:2},{value:"Runbooks",id:"runbooks",level:2},{value:"Developer guidance",id:"developer-guidance",level:2},{value:"Compatibility and deployment",id:"compatibility-and-deployment",level:2},{value:"Success criteria (visibility)",id:"success-criteria-visibility",level:2}];function a(e){const n={code:"code",h2:"h2",h3:"h3",li:"li",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,c.R)(),...e.components};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(n.h3,{id:"scope",children:"Scope"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Services"}),": ",(0,r.jsx)(n.code,{children:"nowconnect-cloud"}),", ",(0,r.jsx)(n.code,{children:"nowconnect-premise"})]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Client path"}),": LDAP over NowConnect tunnel (",(0,r.jsx)(n.code,{children:"addomain"})," \u2192 ",(0,r.jsx)(n.code,{children:"openldap"}),")"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Connector"}),": ",(0,r.jsx)(n.code,{children:"CRUDService/src/connectors/ldap_connector.py"})]}),"\n"]}),"\n",(0,r.jsx)(n.h2,{id:"what-changed",children:"What changed"}),"\n",(0,r.jsx)(n.h3,{id:"nowconnect-cloud-observability",children:"NowConnect cloud observability"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsxs)(n.p,{children:["Added Prometheus metrics in ",(0,r.jsx)(n.code,{children:"nowconnect_cloud/metrics.py"}),":"]}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"nowconnect_write_drain_seconds{connector,phase}"}),": histogram for socket write and drain latency.","\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"write"}),": time to enqueue bytes on socket"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"drain"}),": time to flush to kernel (backpressure visibility)"]}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"nowconnect_inbound_queue_size{connector}"}),": gauge of per\u2011session inbound queue size (agent\u2192cloud)"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"nowconnect_listener_errors_total{connector,type}"}),": counter for listener/session errors","\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.code,{children:"type=write | session | pdp"})}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["Existing counters remain: ",(0,r.jsx)(n.code,{children:"tcp_connections_total"}),", ",(0,r.jsx)(n.code,{children:"tcp_bytes_total"}),", ",(0,r.jsx)(n.code,{children:"FIN/RST"}),", PDP decisions, ",(0,r.jsx)(n.code,{children:"connection_duration_seconds"}),"."]}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsxs)(n.p,{children:["Instrumentation in ",(0,r.jsx)(n.code,{children:"nowconnect_cloud/listeners.py"}),":"]}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["a2c path:","\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["Records queue size (",(0,r.jsx)(n.code,{children:"q.qsize"}),") on each frame"]}),"\n",(0,r.jsx)(n.li,{children:"Times write and drain and observes into histograms"}),"\n",(0,r.jsx)(n.li,{children:"Increments listener error counter on write failure"}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["PDP checks:","\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["On PDP error increments PDP error decision counter and listener error (",(0,r.jsx)(n.code,{children:"type=pdp"}),")"]}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["Session exception path increments listener error (",(0,r.jsx)(n.code,{children:"type=session"}),")"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(n.h3,{id:"ldap-connector-idempotency",children:"LDAP connector idempotency"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["In ",(0,r.jsx)(n.code,{children:"update_group_members"})," for group membership changes:","\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["Treats LDAP result ",(0,r.jsx)(n.strong,{children:"16 (noSuchAttribute)"})," on delete and ",(0,r.jsx)(n.strong,{children:"20 (typeOrValueExists)"})," on add as success; logs at info."]}),"\n",(0,r.jsx)(n.li,{children:"Reduces flakiness during high\u2011churn tests and retries (benign duplicates no longer fail the flow)."}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(n.h2,{id:"why-it-matters",children:"Why it matters"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Reliability"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Idempotent group membership updates prevent benign failures when tests or workflows retry/remove already\u2011removed members or re\u2011add existing members."}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Observability"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Per\u2011write and per\u2011drain latency exposes backpressure and downstream slowness."}),"\n",(0,r.jsx)(n.li,{children:"Queue size highlights burst pressure on agent\u2192cloud delivery."}),"\n",(0,r.jsx)(n.li,{children:"Explicit listener error counters (write/session/PDP) allow clean alerting without log parsing."}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(n.h2,{id:"how-to-use",children:"How to use"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["Metrics endpoint","\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["Inside ",(0,r.jsx)(n.code,{children:"nowconnect-cloud"})," container: ",(0,r.jsx)(n.code,{children:"http://localhost:8765/metrics"})]}),"\n",(0,r.jsx)(n.li,{children:"Prometheus scrape example:"}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-yaml",children:"- job_name: 'nowconnect'\r\n  static_configs:\r\n    - targets: ['nowconnect-cloud:8765']\r\n  metrics_path: /metrics\n"})}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsx)(n.p,{children:"Grafana panels (suggested)"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["Write/drain latency:","\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["p50/p95 for ",(0,r.jsx)(n.code,{children:'nowconnect_write_drain_seconds{phase="write"}'}),", ",(0,r.jsx)(n.code,{children:'{phase="drain"}'})," by connector"]}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["Queue pressure:","\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"nowconnect_inbound_queue_size"})," by connector (gauge; use max over time)"]}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["Traffic:","\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.code,{children:"rate(nowconnect_tcp_bytes_total[1m]) by (direction,connector)"})}),"\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.code,{children:"rate(nowconnect_tcp_connections_total[5m]) by (connector)"})}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["Errors:","\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.code,{children:"increase(nowconnect_listener_errors_total[5m]) by (connector,type)"})}),"\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.code,{children:'increase(nowconnect_pdp_decisions_total{result="error"}[5m]) by (connector)'})}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsx)(n.p,{children:"Alerting (examples)"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Backpressure: p95 write or drain > 100ms for 5m (connector=addomain)"}),"\n",(0,r.jsxs)(n.li,{children:["Queue overrun early\u2011warning: ",(0,r.jsx)(n.code,{children:"nowconnect_inbound_queue_size"})," > 75% of ",(0,r.jsx)(n.code,{children:"queue_depth_per_cid"})," for 2m"]}),"\n",(0,r.jsxs)(n.li,{children:["Listener error spike: ",(0,r.jsx)(n.code,{children:"increase(nowconnect_listener_errors_total[5m]) > threshold"})]}),"\n",(0,r.jsxs)(n.li,{children:["PDP decision errors: ",(0,r.jsx)(n.code,{children:'increase(nowconnect_pdp_decisions_total{result="error"}[5m]) > 0'})]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(n.h2,{id:"runbooks",children:"Runbooks"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsx)(n.p,{children:"Validate tunnel and metrics"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["Generate traffic (read\u2011only LDAP) via ",(0,r.jsx)(n.code,{children:"nowconnect-cloud:389"})]}),"\n",(0,r.jsxs)(n.li,{children:["Check counters: ",(0,r.jsx)(n.code,{children:"nowconnect_tcp_connections_total"}),", ",(0,r.jsx)(n.code,{children:"nowconnect_tcp_bytes_total"})," increase; ",(0,r.jsx)(n.code,{children:"nowconnect_write_drain_seconds"})," and queue size present; write/drain near 0\u201310ms on local env"]}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsx)(n.p,{children:"Investigate latency regressions"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"High drain latency \u2192 target or network backpressure"}),"\n",(0,r.jsx)(n.li,{children:"High write latency \u2192 CPU saturation in hub (consider more workers) or GIL contention"}),"\n",(0,r.jsx)(n.li,{children:"Growing queue size \u2192 agent or target slow; verify agent connectivity and OpenLDAP health"}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsx)(n.p,{children:"Investigate errors"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"listener_errors_total{type=session}"})," rising \u2192 inspect cloud logs for exceptions and stack traces"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"{type=write}"})," rising \u2192 socket write failures; inspect Docker network and target service health"]}),"\n",(0,r.jsx)(n.li,{children:"PDP errors \u2192 verify PDP URL, timeouts, and PDP service logs"}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(n.h2,{id:"developer-guidance",children:"Developer guidance"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsx)(n.p,{children:"Where to extend metrics"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"nowconnect_cloud/listeners.py"}),":","\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Add additional labels if you route multiple connectors"}),"\n",(0,r.jsx)(n.li,{children:"Consider measuring per\u2011frame size buckets if needed"}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["Hub\u2011level metrics (",(0,r.jsx)(n.code,{children:"nowconnect_cloud/hub.py"}),") can expose per\u2011session counts if deeper visibility is required."]}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsx)(n.p,{children:"Connector behavior"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["Idempotency currently scoped to LDAP group membership adds/deletes:","\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Codes handled: 16 (noSuchAttribute), 20 (typeOrValueExists)"}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(n.li,{children:"Extend similar patterns to other modify paths where safe and expected."}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(n.h2,{id:"compatibility-and-deployment",children:"Compatibility and deployment"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Backward\u2011compatible: new metrics and idempotency do not change API surfaces."}),"\n",(0,r.jsxs)(n.li,{children:["Requires rebuild/redeploy of ",(0,r.jsx)(n.code,{children:"nowconnect-cloud"})," for metrics and ",(0,r.jsx)(n.code,{children:"crud-service"})," for connector changes."]}),"\n",(0,r.jsx)(n.li,{children:"No config changes required. Optional: expose cloud hub 8765/metrics externally via Traefik for Prometheus outside the Docker network."}),"\n"]}),"\n",(0,r.jsx)(n.h2,{id:"success-criteria-visibility",children:"Success criteria (visibility)"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Grafana shows low, non\u2011zero write/drain histograms; queue size near zero at steady state."}),"\n",(0,r.jsx)(n.li,{children:"Listener error counters near zero; PDP errors absent on healthy systems."}),"\n",(0,r.jsx)(n.li,{children:"During perf tests: byte rates scale, latency p95 meets SLOs, no error spikes or sustained queue growth."}),"\n"]}),"\n",(0,r.jsx)(n.p,{children:"See also:"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.code,{children:"services/nowconnect/how-to/operational-validation-health"})}),"\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.code,{children:"services/crud-service/explanation/ldap-connector-idempotency"})}),"\n"]})]})}function h(e={}){const{wrapper:n}={...(0,c.R)(),...e.components};return n?(0,r.jsx)(n,{...e,children:(0,r.jsx)(a,{...e})}):a(e)}}}]);