"use strict";(self.webpackChunkempowernow_docs=self.webpackChunkempowernow_docs||[]).push([[1058],{6511:(e,i,n)=>{n.r(i),n.d(i,{assets:()=>c,contentTitle:()=>r,default:()=>p,frontMatter:()=>o,metadata:()=>s,toc:()=>d});const s=JSON.parse('{"id":"services/pdp/explanation/admin-guide","title":"PDP Admin Guide \u2014 Domain & Application Policy Model","description":"Config locations, admin APIs, feature flags, observability, rollout, and ops for the domain/application policy model.","source":"@site/docs/services/pdp/explanation/admin-guide.md","sourceDirName":"services/pdp/explanation","slug":"/services/pdp/explanation/admin-guide","permalink":"/empowernow_docs/docs/services/pdp/explanation/admin-guide","draft":false,"unlisted":false,"editUrl":"https://github.com/facebook/docusaurus/tree/main/packages/create-docusaurus/templates/shared/docs/services/pdp/explanation/admin-guide.md","tags":[],"version":"current","frontMatter":{"title":"PDP Admin Guide \u2014 Domain & Application Policy Model","description":"Config locations, admin APIs, feature flags, observability, rollout, and ops for the domain/application policy model."},"sidebar":"tutorialSidebar","previous":{"title":"Policy Decision Point (PDP) \u2013 Overview","permalink":"/empowernow_docs/docs/services/pdp/"},"next":{"title":"REST API Contract \u2014 Application-Only Pattern","permalink":"/empowernow_docs/docs/services/pdp/explanation/rest_api_contract"}}');var l=n(74848),a=n(28453);const o={title:"PDP Admin Guide \u2014 Domain & Application Policy Model",description:"Config locations, admin APIs, feature flags, observability, rollout, and ops for the domain/application policy model."},r=void 0,c={},d=[{value:"Config locations",id:"config-locations",level:2},{value:"Admin APIs (via BFF)",id:"admin-apis-via-bff",level:2},{value:"Policy review and merge workflow",id:"policy-review-and-merge-workflow",level:2},{value:"End-to-end steps",id:"end-to-end-steps",level:3},{value:"cURL example (authorized)",id:"curl-example-authorized",level:3},{value:"Troubleshooting",id:"troubleshooting",level:3},{value:"Observability: Grafana dashboards",id:"observability-grafana-dashboards",level:2},{value:"SPA performance",id:"spa-performance",level:2},{value:"Feature flags",id:"feature-flags",level:2},{value:"Curl checks",id:"curl-checks",level:2},{value:"Playwright",id:"playwright",level:2},{value:"Recovery",id:"recovery",level:2},{value:"Operations playbook",id:"operations-playbook",level:2},{value:"Restart services",id:"restart-services",level:3},{value:"Verify config mount",id:"verify-config-mount",level:3},{value:"Add an application (UI)",id:"add-an-application-ui",level:3},{value:"Add a domain (UI)",id:"add-a-domain-ui",level:3},{value:"Toggle a PIP",id:"toggle-a-pip",level:3},{value:"Concepts and architecture",id:"concepts-and-architecture",level:2},{value:"Troubleshooting",id:"troubleshooting-1",level:2}];function t(e){const i={code:"code",h2:"h2",h3:"h3",li:"li",ol:"ol",p:"p",pre:"pre",ul:"ul",...(0,a.R)(),...e.components};return(0,l.jsxs)(l.Fragment,{children:[(0,l.jsx)(i.h2,{id:"config-locations",children:"Config locations"}),"\n",(0,l.jsxs)(i.p,{children:["Root: ",(0,l.jsx)(i.code,{children:"SERVICE_CONFIG_DIR"})," (Compose mounts ",(0,l.jsx)(i.code,{children:"../ServiceConfigs/pdp/config"}),")."]}),"\n",(0,l.jsxs)(i.ul,{children:["\n",(0,l.jsxs)(i.li,{children:["Applications: ",(0,l.jsx)(i.code,{children:"config/applications/*.yaml"})]}),"\n",(0,l.jsxs)(i.li,{children:["Domains: ",(0,l.jsx)(i.code,{children:"config/domains/*.yaml"})]}),"\n",(0,l.jsxs)(i.li,{children:["PIP Registry: ",(0,l.jsx)(i.code,{children:"config/pip_registry.yaml"})]}),"\n",(0,l.jsxs)(i.li,{children:["Policies:","\n",(0,l.jsxs)(i.ul,{children:["\n",(0,l.jsxs)(i.li,{children:["Global: ",(0,l.jsx)(i.code,{children:"config/policies/global/"})]}),"\n",(0,l.jsxs)(i.li,{children:["Domain shared: ",(0,l.jsx)(i.code,{children:"config/policies/domains/{domain}/shared/"})]}),"\n",(0,l.jsxs)(i.li,{children:["Environment: ",(0,l.jsx)(i.code,{children:"config/policies/domains/{domain}/{environment}/"})]}),"\n",(0,l.jsxs)(i.li,{children:["Application: ",(0,l.jsx)(i.code,{children:"config/policies/applications/{app_id}/"})]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,l.jsx)(i.h2,{id:"admin-apis-via-bff",children:"Admin APIs (via BFF)"}),"\n",(0,l.jsxs)(i.ul,{children:["\n",(0,l.jsxs)(i.li,{children:["Apps: ",(0,l.jsx)(i.code,{children:"/api/authz/applications"})," (GET, POST), ",(0,l.jsx)(i.code,{children:"/api/authz/applications/{id}"})," (GET, PUT, DELETE)"]}),"\n",(0,l.jsxs)(i.li,{children:["Domains: ",(0,l.jsx)(i.code,{children:"/api/authz/domains"})," (GET, POST), ",(0,l.jsx)(i.code,{children:"/api/authz/domains/{id}"})," (GET, PUT, DELETE)"]}),"\n",(0,l.jsxs)(i.li,{children:["PIPs: ",(0,l.jsx)(i.code,{children:"/api/authz/pips"})," (GET, PUT), ",(0,l.jsx)(i.code,{children:"/api/authz/pips/{name}"})," (GET, PUT, DELETE)"]}),"\n",(0,l.jsxs)(i.li,{children:["Debug: ",(0,l.jsx)(i.code,{children:"/api/authz/debug/applications/{app_id}/policy-sources"})]}),"\n"]}),"\n",(0,l.jsx)(i.h2,{id:"policy-review-and-merge-workflow",children:"Policy review and merge workflow"}),"\n",(0,l.jsxs)(i.ul,{children:["\n",(0,l.jsxs)(i.li,{children:["Feature flag: ",(0,l.jsx)(i.code,{children:"FEATURE_POLICY_MERGE_ENABLED"})," (default: off). When enabled, PDP exposes ",(0,l.jsx)(i.code,{children:"POST /access/v1/policies/merge"}),"."]}),"\n",(0,l.jsxs)(i.li,{children:["Self-authorization: PDP evaluates an AuthZEN request internally to authorize merges.","\n",(0,l.jsxs)(i.ul,{children:["\n",(0,l.jsxs)(i.li,{children:["Resource: ",(0,l.jsx)(i.code,{children:"pdp:policy"})]}),"\n",(0,l.jsxs)(i.li,{children:["Action: ",(0,l.jsx)(i.code,{children:"merge"})]}),"\n",(0,l.jsx)(i.li,{children:"Required permit example:"}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,l.jsx)(i.pre,{children:(0,l.jsx)(i.code,{className:"language-yaml",children:"id: pdp-merge-admin\r\nrules:\r\n  - resource: pdp:policy\r\n    action: merge\r\n    effect: PERMIT\r\n    when: \"'pdp_admin' in subject.properties.roles\"\n"})}),"\n",(0,l.jsx)(i.h3,{id:"end-to-end-steps",children:"End-to-end steps"}),"\n",(0,l.jsxs)(i.ol,{children:["\n",(0,l.jsx)(i.li,{children:"Open workspace in Authorization Studio \u2192 edit YAML (Diff/Lints/Impact tabs)."}),"\n",(0,l.jsx)(i.li,{children:"Click \u201cReview & Merge\u201d \u2192 client validates and posts draft to PDP validate endpoint."}),"\n",(0,l.jsxs)(i.li,{children:["If clean, client calls ",(0,l.jsx)(i.code,{children:"POST /access/v1/policies/merge"})," with ",(0,l.jsx)(i.code,{children:"{ policy_id, yaml, message }"}),"."]}),"\n",(0,l.jsx)(i.li,{children:"PDP checks flag, performs self-authorization, writes YAML, refreshes caches."}),"\n",(0,l.jsx)(i.li,{children:"UI shows success with updated effective policies; failures include PDP explanation."}),"\n"]}),"\n",(0,l.jsx)(i.h3,{id:"curl-example-authorized",children:"cURL example (authorized)"}),"\n",(0,l.jsx)(i.pre,{children:(0,l.jsx)(i.code,{className:"language-bash",children:'curl -sS -X POST https://authz.ocg.labs.empowernow.ai/access/v1/policies/merge \\\r\n  -H "Cookie: <session>" \\\r\n  -H "Content-Type: application/json" \\\r\n  -d \'{"policy_id":"global-base-security","yaml":"id: global-base-security\\n...","message":"Tighten base guards"}\'\n'})}),"\n",(0,l.jsx)(i.h3,{id:"troubleshooting",children:"Troubleshooting"}),"\n",(0,l.jsxs)(i.ul,{children:["\n",(0,l.jsxs)(i.li,{children:["404: feature flag off \u2192 set ",(0,l.jsx)(i.code,{children:"FEATURE_POLICY_MERGE_ENABLED=true"})," and restart PDP."]}),"\n",(0,l.jsxs)(i.li,{children:["403: missing ",(0,l.jsx)(i.code,{children:"pdp:policy merge"})," permit \u2192 add/adjust admin policy and reload."]}),"\n",(0,l.jsxs)(i.li,{children:["400: YAML invalid \u2192 use ",(0,l.jsx)(i.code,{children:"/access/v1/policies/validate"})," first; fix lints."]}),"\n"]}),"\n",(0,l.jsx)(i.h2,{id:"observability-grafana-dashboards",children:"Observability: Grafana dashboards"}),"\n",(0,l.jsxs)(i.ul,{children:["\n",(0,l.jsxs)(i.li,{children:["Grafana provisioned via ",(0,l.jsx)(i.code,{children:"ServiceConfigs/observability/grafana"}),"."]}),"\n",(0,l.jsxs)(i.li,{children:["\u201cPDP Debugging\u201d includes:","\n",(0,l.jsxs)(i.ul,{children:["\n",(0,l.jsxs)(i.li,{children:["Explain requests/min (Loki ",(0,l.jsx)(i.code,{children:"api.request.start"})," + ",(0,l.jsx)(i.code,{children:"debug_explain"}),")."]}),"\n",(0,l.jsxs)(i.li,{children:["Sandbox streams/min (Loki ",(0,l.jsx)(i.code,{children:"api.request.start"})," + ",(0,l.jsx)(i.code,{children:"sandbox_stream"}),")."]}),"\n",(0,l.jsxs)(i.li,{children:["Explain latency p50/p95 from ",(0,l.jsx)(i.code,{children:"duration_ms"}),"."]}),"\n",(0,l.jsxs)(i.li,{children:["Cache hits/min from ",(0,l.jsx)(i.code,{children:"cache.hit"}),"."]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,l.jsx)(i.p,{children:"Restart Grafana:"}),"\n",(0,l.jsx)(i.pre,{children:(0,l.jsx)(i.code,{className:"language-bash",children:"docker compose -f docker-compose-authzen4.yml restart grafana\n"})}),"\n",(0,l.jsx)(i.h2,{id:"spa-performance",children:"SPA performance"}),"\n",(0,l.jsxs)(i.ul,{children:["\n",(0,l.jsxs)(i.li,{children:["ETag + Last-Modified on GETs; ",(0,l.jsx)(i.code,{children:"Cache-Control: public, max-age=60"})]}),"\n",(0,l.jsxs)(i.li,{children:["Client sends ",(0,l.jsx)(i.code,{children:"If-None-Match"}),"/",(0,l.jsx)(i.code,{children:"If-Modified-Since"})," for 304s"]}),"\n"]}),"\n",(0,l.jsx)(i.p,{children:"Expected headers when cached:"}),"\n",(0,l.jsx)(i.pre,{children:(0,l.jsx)(i.code,{children:'ETag: W/"<sha256>"\r\nLast-Modified: Tue, 24 Sep 2025 20:41:15 GMT\r\nCache-Control: public, max-age=60\n'})}),"\n",(0,l.jsx)(i.h2,{id:"feature-flags",children:"Feature flags"}),"\n",(0,l.jsxs)(i.ul,{children:["\n",(0,l.jsxs)(i.li,{children:[(0,l.jsx)(i.code,{children:"FEATURE_POLICY_ADMIN_SELF_AUTH"})," (default: false): PDP self-authorizes admin ops by evaluating AuthZEN requests (",(0,l.jsx)(i.code,{children:"pdp:domain edit"}),", ",(0,l.jsx)(i.code,{children:"pdp:application delete"}),")."]}),"\n"]}),"\n",(0,l.jsxs)(i.p,{children:["Example policy snippet (enable domain edits for ",(0,l.jsx)(i.code,{children:"pdp_admin"}),"):"]}),"\n",(0,l.jsx)(i.pre,{children:(0,l.jsx)(i.code,{className:"language-yaml",children:"id: pdp-admin-ops\r\npolicy_type: AuthZ\r\nrules:\r\n  - resource: pdp:domain\r\n    action: edit\r\n    effect: PERMIT\r\n    allowIf: \"subject.role == 'pdp_admin'\"\n"})}),"\n",(0,l.jsx)(i.h2,{id:"curl-checks",children:"Curl checks"}),"\n",(0,l.jsx)(i.pre,{children:(0,l.jsx)(i.code,{className:"language-bash",children:'curl -i https://authz.ocg.labs.empowernow.ai/api/authz/applications -H "Cookie: <session>"\r\n\r\n# Conditional GET\r\ncurl -i https://authz.ocg.labs.empowernow.ai/api/authz/applications \\\r\n  -H "If-None-Match: W/\\"<etag>\\"" -H "Cookie: <session>"\r\n\r\n# Domains list\r\ncurl -i https://authz.ocg.labs.empowernow.ai/api/authz/domains -H "Cookie: <session>"\n'})}),"\n",(0,l.jsx)(i.h2,{id:"playwright",children:"Playwright"}),"\n",(0,l.jsx)(i.pre,{children:(0,l.jsx)(i.code,{className:"language-bash",children:"cd pdp_ui/frontend\r\nnpx playwright test --project=chromium\n"})}),"\n",(0,l.jsx)(i.h2,{id:"recovery",children:"Recovery"}),"\n",(0,l.jsxs)(i.ul,{children:["\n",(0,l.jsxs)(i.li,{children:["Revert YAML under ",(0,l.jsx)(i.code,{children:"ServiceConfigs/pdp/config"})," via Git."]}),"\n",(0,l.jsxs)(i.li,{children:["Disable self-auth quickly by unsetting ",(0,l.jsx)(i.code,{children:"FEATURE_POLICY_ADMIN_SELF_AUTH"})," and restarting PDP."]}),"\n"]}),"\n",(0,l.jsx)(i.h2,{id:"operations-playbook",children:"Operations playbook"}),"\n",(0,l.jsx)(i.h3,{id:"restart-services",children:"Restart services"}),"\n",(0,l.jsx)(i.pre,{children:(0,l.jsx)(i.code,{className:"language-bash",children:"docker compose -f docker-compose-authzen4.yml restart bff\r\ndocker compose -f docker-compose-authzen4.yml restart pdp\r\ndocker compose -f docker-compose-authzen4.yml restart traefik\n"})}),"\n",(0,l.jsx)(i.p,{children:"Verify health:"}),"\n",(0,l.jsx)(i.pre,{children:(0,l.jsx)(i.code,{className:"language-bash",children:"curl -sf https://authz.ocg.labs.empowernow.ai/api/authz/health || echo fail\n"})}),"\n",(0,l.jsx)(i.h3,{id:"verify-config-mount",children:"Verify config mount"}),"\n",(0,l.jsx)(i.pre,{children:(0,l.jsx)(i.code,{className:"language-bash",children:"docker exec -it pdp_app sh -c 'ls -la /app/config && grep -H \"id:\" /app/config/applications/*.yaml | head'\n"})}),"\n",(0,l.jsx)(i.h3,{id:"add-an-application-ui",children:"Add an application (UI)"}),"\n",(0,l.jsxs)(i.p,{children:["Admin \u2192 Applications \u2192 New Application \u2192 Save. YAML is written under ",(0,l.jsx)(i.code,{children:"config/applications/<id>.yaml"}),"."]}),"\n",(0,l.jsx)(i.h3,{id:"add-a-domain-ui",children:"Add a domain (UI)"}),"\n",(0,l.jsx)(i.p,{children:"Admin \u2192 Domains \u2192 New Domain \u2192 set environments and shared folder \u2192 Save."}),"\n",(0,l.jsx)(i.h3,{id:"toggle-a-pip",children:"Toggle a PIP"}),"\n",(0,l.jsxs)(i.p,{children:["Admin \u2192 PIPs \u2192 switch a PIP on/off. Configuration persists to ",(0,l.jsx)(i.code,{children:"pip_registry.yaml"}),"."]}),"\n",(0,l.jsx)(i.h2,{id:"concepts-and-architecture",children:"Concepts and architecture"}),"\n",(0,l.jsxs)(i.ul,{children:["\n",(0,l.jsxs)(i.li,{children:["Single identifier (",(0,l.jsx)(i.code,{children:"pdp_application"}),") selects app; domain/env resolution is internal."]}),"\n",(0,l.jsx)(i.li,{children:"Inheritance order (if defined): global \u2192 domain shared \u2192 env \u2192 app-specific."}),"\n",(0,l.jsxs)(i.li,{children:["SPA calls BFF; BFF proxies to PDP. Traefik routes ",(0,l.jsx)(i.code,{children:"/api/**"})," from SPA hosts to BFF."]}),"\n"]}),"\n",(0,l.jsx)(i.h2,{id:"troubleshooting-1",children:"Troubleshooting"}),"\n",(0,l.jsxs)(i.ul,{children:["\n",(0,l.jsxs)(i.li,{children:["HTML instead of JSON: ensure Traefik SPA static routers exclude ",(0,l.jsx)(i.code,{children:"/access/v1/"})," and BFF API router includes ",(0,l.jsx)(i.code,{children:"/access/v1/"})," and ",(0,l.jsx)(i.code,{children:"/api/"})," for SPA hosts."]}),"\n",(0,l.jsx)(i.li,{children:"403 on admin ops: either self-auth flag is on and policy denies, or session missing. Check PDP logs and BFF logs; disable self-auth to confirm."}),"\n",(0,l.jsx)(i.li,{children:"No 304 responses: confirm ETag/Last-Modified present; check intermediary stripping headers; retry with direct curl; ensure clocks are reasonably synced."}),"\n",(0,l.jsxs)(i.li,{children:["Admin routes 404: ensure BFF routes include ",(0,l.jsx)(i.code,{children:"/api/authz/{applications,domains,pips,debug}"})," and BFF is restarted."]}),"\n",(0,l.jsxs)(i.li,{children:["Policy changes ignored: validate YAML; check PDP logs for load errors; ensure file paths under ",(0,l.jsx)(i.code,{children:"config/policies/**"})," are correct."]}),"\n"]})]})}function p(e={}){const{wrapper:i}={...(0,a.R)(),...e.components};return i?(0,l.jsx)(i,{...e,children:(0,l.jsx)(t,{...e})}):t(e)}},28453:(e,i,n)=>{n.d(i,{R:()=>o,x:()=>r});var s=n(96540);const l={},a=s.createContext(l);function o(e){const i=s.useContext(a);return s.useMemo(function(){return"function"==typeof e?e(i):{...i,...e}},[i,e])}function r(e){let i;return i=e.disableParentContext?"function"==typeof e.components?e.components(l):e.components||l:o(e.components),s.createElement(a.Provider,{value:i},e.children)}}}]);