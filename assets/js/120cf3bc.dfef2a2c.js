"use strict";(self.webpackChunkempowernow_docs=self.webpackChunkempowernow_docs||[]).push([[8205],{28453:(e,n,r)=>{r.d(n,{R:()=>t,x:()=>o});var i=r(96540);const s={},a=i.createContext(s);function t(e){const n=i.useContext(a);return i.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function o(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(s):e.components||s:t(e.components),i.createElement(a.Provider,{value:n},e.children)}},47274:(e,n,r)=>{r.r(n),r.d(n,{assets:()=>c,contentTitle:()=>o,default:()=>p,frontMatter:()=>t,metadata:()=>i,toc:()=>d});const i=JSON.parse('{"id":"services/bff/explanation/authorization","title":"Authorization Model (PDP, Mapping, Caching)","description":"What the BFF authorizes","source":"@site/docs/services/bff/explanation/authorization.md","sourceDirName":"services/bff/explanation","slug":"/services/bff/explanation/authorization","permalink":"/empowernow_docs/docs/services/bff/explanation/authorization","draft":false,"unlisted":false,"editUrl":"https://github.com/facebook/docusaurus/tree/main/packages/create-docusaurus/templates/shared/docs/services/bff/explanation/authorization.md","tags":[],"version":"current","sidebarPosition":3,"frontMatter":{"title":"Authorization Model (PDP, Mapping, Caching)","sidebar_position":3},"sidebar":"tutorialSidebar","previous":{"title":"Visual Guide","permalink":"/empowernow_docs/docs/services/bff/explanation/bff-visual-guide"},"next":{"title":"Backend\u2011for\u2011Frontend (BFF) Design Pattern","permalink":"/empowernow_docs/docs/services/bff/explanation/bff-design-pattern"}}');var s=r(74848),a=r(28453);const t={title:"Authorization Model (PDP, Mapping, Caching)",sidebar_position:3},o=void 0,c={},d=[];function l(e){const n={code:"code",li:"li",mermaid:"mermaid",p:"p",pre:"pre",ul:"ul",...(0,a.R)(),...e.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(n.p,{children:"What the BFF authorizes"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"Protects API calls using a Policy Decision Point (PDP) following AuthZEN semantics"}),"\n",(0,s.jsx)(n.li,{children:"Maps incoming requests to resource/action using config rules"}),"\n",(0,s.jsx)(n.li,{children:"Caches allow/deny decisions with separate TTLs to reduce latency and load"}),"\n"]}),"\n",(0,s.jsx)(n.p,{children:"High\u2011level flow"}),"\n",(0,s.jsx)(n.mermaid,{value:"sequenceDiagram\r\n  autonumber\r\n  participant Client\r\n  participant BFF\r\n  participant Mapper as PathMapper\r\n  participant PDP as PDP Service\r\n  Client->>BFF: GET /api/crud/forms/123\r\n  BFF->>Mapper: map path \u2192 (resource=form, id=123, action=read)\r\n  alt cached decision\r\n    BFF--\x3e>Client: 200 (cached allow)\r\n  else cache miss\r\n    BFF->>PDP: POST /v1/evaluation {subject, resource, action, context}\r\n    PDP--\x3e>BFF: {decision: true, context: {...}}\r\n    BFF--\x3e>Client: 200 and caches decision\r\n  end"}),"\n",(0,s.jsx)(n.p,{children:"Where it\u2019s implemented"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:["Mapping: prefer inline ",(0,s.jsx)(n.code,{children:"authz_map"})," defined on routes in ",(0,s.jsx)(n.code,{children:"routes.yaml"})," for PDP\u2011protected endpoints. Legacy external ",(0,s.jsx)(n.code,{children:"pdp.yaml:endpoint_map"})," remains supported as a fallback during migration."]}),"\n",(0,s.jsxs)(n.li,{children:["Decision: ",(0,s.jsx)(n.code,{children:"services/pdp_client.py"})," builds an AuthZEN request, retrieves a bearer token, calls PDP, handles errors, and caches results in Redis when configured."]}),"\n",(0,s.jsxs)(n.li,{children:["Enforcement: ",(0,s.jsx)(n.code,{children:"core/permissions.py"})," provides dependencies (",(0,s.jsx)(n.code,{children:"has_permission"}),", ",(0,s.jsx)(n.code,{children:"requires_auth"}),") and helpers to assemble the authorization context (headers, query, body subset, roles/permissions, correlation ID)."]}),"\n"]}),"\n",(0,s.jsx)(n.p,{children:"Mapping precedence and defaults"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:["Resolver order: inline ",(0,s.jsx)(n.code,{children:"authz_map"})," \u2192 external ",(0,s.jsx)(n.code,{children:"pdp.yaml"})," \u2192 derived defaults (if enabled)"]}),"\n",(0,s.jsxs)(n.li,{children:["Feature flags:","\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"authz_validation_strict"}),": fail startup when PDP\u2011protected routes lack a mapping"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"authz_default_mapping_enabled"}),": allow deriving defaults (GET\u2192read, POST\u2192create, etc.)"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,s.jsx)(n.p,{children:"Caching"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:["Allow and deny decisions are cached with separate TTLs from ",(0,s.jsx)(n.code,{children:"pdp.yaml"})," (",(0,s.jsx)(n.code,{children:"cache.ttl_allow"}),", ",(0,s.jsx)(n.code,{children:"cache.ttl_deny"}),")."]}),"\n",(0,s.jsx)(n.li,{children:"Keys include subject, subject type, resource type/ID, and action; special characters are base64\u2011encoded."}),"\n"]}),"\n",(0,s.jsx)(n.p,{children:"Examples (mapping snippets)"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-yaml",children:'# Inline on route (preferred)\r\n- id: "crud-workflow-start"\r\n  path: "/api/crud/workflow/start"\r\n  target_service: "crud_service"\r\n  upstream_path: "/workflow/start"\r\n  methods: ["POST"]\r\n  auth: "session"\r\n  authz: "pdp"\r\n  authz_map:\r\n    POST:\r\n      resource: workflow\r\n      action: execute\r\n      props:\r\n        workflow_name: "$.workflow_name"\r\n\r\n# Legacy external mapping (supported during migration)\r\nendpoint_map:\r\n  /api/crud/workflow/status/{execution_id}:\r\n    GET:\r\n      resource: workflow_execution\r\n      id_from: "{execution_id}"\r\n      action: read\n'})}),"\n",(0,s.jsx)(n.p,{children:"Payload behavior for AuthZEN (SPAs)"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"The BFF does not rewrite SPA AuthZEN payloads; it forwards as\u2011is."}),"\n",(0,s.jsxs)(n.li,{children:["Minimal normalization only: a default ",(0,s.jsx)(n.code,{children:"resource.id"})," may be provided for collection\u2011level checks when omitted."]}),"\n"]}),"\n",(0,s.jsx)(n.p,{children:"Quick validate"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:'curl -I --cookie "_eid_sid=..." https://.../api/crud/workflow/status/abc-123\r\n# Expect 200/403 depending on PDP decision; see How\u2011to \u2192 endpoint-map-validation\n'})})]})}function p(e={}){const{wrapper:n}={...(0,a.R)(),...e.components};return n?(0,s.jsx)(n,{...e,children:(0,s.jsx)(l,{...e})}):l(e)}}}]);