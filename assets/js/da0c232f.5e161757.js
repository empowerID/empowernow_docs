"use strict";(self.webpackChunkempowernow_docs=self.webpackChunkempowernow_docs||[]).push([[6928],{6042:(e,n,i)=>{i.r(n),i.d(n,{assets:()=>c,contentTitle:()=>d,default:()=>h,frontMatter:()=>l,metadata:()=>r,toc:()=>a});const r=JSON.parse('{"id":"services/crud-service/secrets/security-model","title":"Security model","description":"Grants, sender binding, anti\u2011replay, and least privilege","source":"@site/docs/services/crud-service/secrets/05-security-model.md","sourceDirName":"services/crud-service/secrets","slug":"/services/crud-service/secrets/security-model","permalink":"/empowernow_docs/docs/services/crud-service/secrets/security-model","draft":false,"unlisted":false,"editUrl":"https://github.com/facebook/docusaurus/tree/main/packages/create-docusaurus/templates/shared/docs/services/crud-service/secrets/05-security-model.md","tags":[],"version":"current","sidebarPosition":5,"frontMatter":{"title":"Security model","description":"Grants, sender binding, anti\u2011replay, and least privilege"},"sidebar":"tutorialSidebar","previous":{"title":"Providers","permalink":"/empowernow_docs/docs/services/crud-service/secrets/providers"},"next":{"title":"Observability","permalink":"/empowernow_docs/docs/services/crud-service/secrets/observability"}}');var s=i(74848),t=i(28453);const l={title:"Security model",description:"Grants, sender binding, anti\u2011replay, and least privilege"},d=void 0,c={},a=[{value:"What this model provides (at a glance)",id:"what-this-model-provides-at-a-glance",level:2},{value:"Threat model and goals",id:"threat-model-and-goals",level:2},{value:"End\u2011to\u2011end request flow (security checks)",id:"endtoend-request-flow-security-checks",level:2},{value:"Grants and obligations",id:"grants-and-obligations",level:2},{value:"Sender binding (who is really calling?)",id:"sender-binding-who-is-really-calling",level:2},{value:"Anti\u2011replay (JTI)",id:"antireplay-jti",level:2},{value:"Tenant/mount safety",id:"tenantmount-safety",level:2},{value:"Least privilege on the API surface",id:"least-privilege-on-the-api-surface",level:2},{value:"Provider specifics and metadata",id:"provider-specifics-and-metadata",level:2},{value:"Enforcement flow (permit branch)",id:"enforcement-flow-permit-branch",level:2},{value:"Configuration summary (ops)",id:"configuration-summary-ops",level:2},{value:"Auditing and redaction",id:"auditing-and-redaction",level:2}];function o(e){const n={code:"code",h2:"h2",li:"li",mermaid:"mermaid",p:"p",ul:"ul",...(0,t.R)(),...e.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(n.h2,{id:"what-this-model-provides-at-a-glance",children:"What this model provides (at a glance)"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:["Purpose\u2011bound, short\u2011lived usage grants enforced at the point of use (PEP in ",(0,s.jsx)(n.code,{children:"VaultService"})," / Secrets API)"]}),"\n",(0,s.jsx)(n.li,{children:"Strong caller binding (DPoP/mTLS when available; audience checks otherwise)"}),"\n",(0,s.jsx)(n.li,{children:"Anti\u2011replay and tenancy/mount safety by construction"}),"\n",(0,s.jsx)(n.li,{children:"Uniform auditing that avoids leaking sensitive paths/keys"}),"\n",(0,s.jsx)(n.li,{children:"Optional OAuth scopes to layer least\u2011privilege on the API surface"}),"\n"]}),"\n",(0,s.jsx)(n.p,{children:"See also:"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:["Authorization model: ",(0,s.jsx)(n.code,{children:"./11-authorization-model-authzen.md"})]}),"\n",(0,s.jsxs)(n.li,{children:["PDP enrichment (exact fields sent to PDP): ",(0,s.jsx)(n.code,{children:"./SECRETS_PDP_ENRICHMENT.md"})]}),"\n",(0,s.jsxs)(n.li,{children:["API reference (purposes and scopes): ",(0,s.jsx)(n.code,{children:"./09-api-reference.md"})]}),"\n"]}),"\n",(0,s.jsx)(n.h2,{id:"threat-model-and-goals",children:"Threat model and goals"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:["Goals","\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"Prevent secret exfiltration (values leaving the intended boundary)"}),"\n",(0,s.jsx)(n.li,{children:"Prevent misuse (wrong subject, wrong purpose, wrong tenant/mount)"}),"\n",(0,s.jsx)(n.li,{children:"Enable forensics (who/what/purpose/when) without leaking resource paths"}),"\n"]}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["Key mitigations","\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"Default\u2011deny policy; explicit permit for a concrete purpose per use"}),"\n",(0,s.jsx)(n.li,{children:"Short\u2011lived grants with obligations (TTL, max_uses)"}),"\n",(0,s.jsx)(n.li,{children:"Sender binding (DPoP/mTLS preferred; audience checks when needed)"}),"\n",(0,s.jsx)(n.li,{children:"Anti\u2011replay (JTI enforcement) and correlation with traces"}),"\n",(0,s.jsxs)(n.li,{children:["Non\u2011leaky audits (HMAC of canonical URI as ",(0,s.jsx)(n.code,{children:"resource_ref"}),")"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,s.jsx)(n.h2,{id:"endtoend-request-flow-security-checks",children:"End\u2011to\u2011end request flow (security checks)"}),"\n",(0,s.jsx)(n.mermaid,{value:'sequenceDiagram\r\n  participant Caller as "Caller (App/Workflow/Agent)"\r\n  participant PEP as "VaultService / Secrets API (PEP)"\r\n  participant PDP as "SecretPolicyService (PDP)"\r\n  participant Provider as "Provider (KVv2/YAML)"\r\n  Caller->>PEP: "get_credentials / API call (canonical URI)"\r\n  Note over PEP: "Tenant/mount guard (reject cross\u2011tenant)"\r\n  PEP->>PDP: "authorize(subject, tenant, resource, purpose, context)"\r\n  Note over PDP: "Policy decision with obligations (ttl, max_uses)"\r\n  PDP--\x3e>PEP: "Permit/Deny + obligations"\r\n  alt Permit\r\n    Note over PEP: "Check binding (DPoP/mTLS/audience) + anti\u2011replay (jti)"\r\n    PEP->>Provider: "Provider op (read/rotate/metadata)"\r\n    Provider--\x3e>PEP: "Value/metadata"\r\n    PEP--\x3e>Caller: "200 result"\r\n    PEP--\x3e>PEP: "Emit audit (resource_ref), metrics, traces"\r\n  else Deny\r\n    PEP--\x3e>Caller: "403 Forbidden (structured)"\r\n    PEP--\x3e>PEP: "Emit audit (deny)"\r\n  end'}),"\n",(0,s.jsx)(n.h2,{id:"grants-and-obligations",children:"Grants and obligations"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"The PDP issues a decision with obligations the PEP must enforce before contacting providers."}),"\n",(0,s.jsxs)(n.li,{children:["Typical obligations","\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"ttl_seconds"}),": maximum time the decision is valid"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"max_uses"}),": maximum successful invocations before re\u2011authorization"]}),"\n"]}),"\n"]}),"\n",(0,s.jsx)(n.li,{children:"The PEP caches and decrements usage; expired or exhausted grants force a fresh PDP check."}),"\n"]}),"\n",(0,s.jsx)(n.p,{children:"Grant lifecycle"}),"\n",(0,s.jsx)(n.mermaid,{value:'stateDiagram-v2\r\n  [*] --\x3e Issued: "PDP Permit with obligations"\r\n  Issued --\x3e InUse: "First successful use"\r\n  InUse --\x3e Expired: "ttl elapsed"\r\n  InUse --\x3e MaxUsed: "max_uses reached"\r\n  Issued --\x3e Revoked: "Policy revoke"\r\n  Expired --\x3e [*]\r\n  MaxUsed --\x3e [*]\r\n  Revoked --\x3e [*]'}),"\n",(0,s.jsx)(n.h2,{id:"sender-binding-who-is-really-calling",children:"Sender binding (who is really calling?)"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:["Preferred","\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:["DPoP (proof\u2011of\u2011possession) via ",(0,s.jsx)(n.code,{children:"cnf.jkt"})," (public key thumbprint)"]}),"\n",(0,s.jsx)(n.li,{children:"mTLS client cert thumbprint"}),"\n"]}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["Fallback","\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:["Audience checks enforced at the PEP (ensure token ",(0,s.jsx)(n.code,{children:"aud"})," includes ",(0,s.jsx)(n.code,{children:"SECRETS_AUDIENCE"}),")"]}),"\n"]}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["Behavior","\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:["Binding is attached to the grant; if the binding changes during ",(0,s.jsx)(n.code,{children:"ttl"}),", further uses are denied"]}),"\n",(0,s.jsx)(n.li,{children:"Binding + obligations constrain token theft/replay utility even if a bearer leaks"}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,s.jsx)(n.h2,{id:"antireplay-jti",children:"Anti\u2011replay (JTI)"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"When a token JTI is present, the PEP tracks JTI usage within the grant window"}),"\n",(0,s.jsx)(n.li,{children:"Replays with the same JTI are denied"}),"\n",(0,s.jsxs)(n.li,{children:["Correlate denials with traces using ",(0,s.jsx)(n.code,{children:"correlation_id"})," and ",(0,s.jsx)(n.code,{children:"trace_id"})]}),"\n"]}),"\n",(0,s.jsx)(n.h2,{id:"tenantmount-safety",children:"Tenant/mount safety"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:["Canonical Secret URIs encode ",(0,s.jsx)(n.code,{children:"provider[+engine]://<mount>/<path>#<fragment>"})]}),"\n",(0,s.jsxs)(n.li,{children:["A tenant guard ensures ",(0,s.jsx)(n.code,{children:"mount"})," \u2208 ",(0,s.jsx)(n.code,{children:"TENANT_ALLOWED_MOUNTS"})," before PDP authorization"]}),"\n",(0,s.jsx)(n.li,{children:"Prevents cross\u2011tenant access by construction"}),"\n"]}),"\n",(0,s.jsx)(n.h2,{id:"least-privilege-on-the-api-surface",children:"Least privilege on the API surface"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:["The Secrets API supports optional OAuth scopes (enable with ",(0,s.jsx)(n.code,{children:"SECRETS_ENFORCE_SCOPES=true"}),"):","\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"secrets.read"}),", ",(0,s.jsx)(n.code,{children:"secrets.write"}),", ",(0,s.jsx)(n.code,{children:"secrets.delete"}),", ",(0,s.jsx)(n.code,{children:"secrets.destroy"}),", ",(0,s.jsx)(n.code,{children:"secrets.rotate"}),", ",(0,s.jsx)(n.code,{children:"secrets.read_metadata"}),", ",(0,s.jsx)(n.code,{children:"secrets.set_owner"})]}),"\n"]}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["Combine with PDP purposes for defense in depth:","\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:["Example: POST ",(0,s.jsx)(n.code,{children:"/api/secrets/metadata/owner"})," requires scope ",(0,s.jsx)(n.code,{children:"secrets.set_owner"})," and PDP purpose ",(0,s.jsx)(n.code,{children:"owner_update"})]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,s.jsx)(n.h2,{id:"provider-specifics-and-metadata",children:"Provider specifics and metadata"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:["KVv2 (OpenBao/HashiCorp)","\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"Versioned lifecycle (read pin by version; delete/undelete/destroy versions)"}),"\n",(0,s.jsxs)(n.li,{children:["Custom metadata used as resource attributes in PDP context: ",(0,s.jsx)(n.code,{children:"owner"})," (mutable), ",(0,s.jsx)(n.code,{children:"created_by"}),", ",(0,s.jsx)(n.code,{children:"created_at"})]}),"\n",(0,s.jsx)(n.li,{children:"First write/rotate stamps metadata best\u2011effort; owner can be updated via dedicated endpoint"}),"\n"]}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["YAML (dev only)","\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"File\u2011backed for local development; writes/deletes blocked in non\u2011dev"}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,s.jsx)(n.h2,{id:"enforcement-flow-permit-branch",children:"Enforcement flow (permit branch)"}),"\n",(0,s.jsx)(n.mermaid,{value:'flowchart TD\r\n  A["Request with canonical URI"] --\x3e B{"Tenant/mount guard"}\r\n  B -- "fail" --\x3e E1["400 Bad Request"]\r\n  B -- "ok" --\x3e C["Authorize with PDP (purpose) + obligations"]\r\n  C --\x3e D{"Decision"}\r\n  D -- "Deny" --\x3e E2["403 Forbidden"]\r\n  D -- "Permit" --\x3e F["Enforce obligations (ttl, max_uses) & binding"]\r\n  F --\x3e G["Anti\u2011replay (jti), audience/DPoP/mTLS checks"]\r\n  G --\x3e H["Provider call"]\r\n  H --\x3e I["Audit (HMAC resource_ref) + metrics + traces"]\r\n  I --\x3e J["200 Response"]'}),"\n",(0,s.jsx)(n.h2,{id:"configuration-summary-ops",children:"Configuration summary (ops)"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:["Authorization and guards","\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.code,{children:"ENABLE_AUTHORIZATION=true"})}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"TENANT_ID"})," and ",(0,s.jsx)(n.code,{children:"TENANT_ALLOWED_MOUNTS"})]}),"\n"]}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["API hardening (optional but recommended outside dev)","\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.code,{children:"SECRETS_API_REQUIRE_AUTH=true"})}),"\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.code,{children:"SECRETS_ENFORCE_SCOPES=true"})}),"\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.code,{children:"SECRETS_AUDIENCE=crud.secrets"})}),"\n"]}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["Auditing","\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:["Set ",(0,s.jsx)(n.code,{children:"TENANT_SALT"})," to enable non\u2011leaky ",(0,s.jsx)(n.code,{children:"resource_ref"})," (HMAC)"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,s.jsx)(n.h2,{id:"auditing-and-redaction",children:"Auditing and redaction"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:["Kafka events include: ",(0,s.jsx)(n.code,{children:"subject"}),", ",(0,s.jsx)(n.code,{children:"purpose"}),", ",(0,s.jsx)(n.code,{children:"effect"}),", ",(0,s.jsx)(n.code,{children:"resource_ref"}),", ",(0,s.jsx)(n.code,{children:"decision_id"}),", correlation and trace identifiers"]}),"\n",(0,s.jsx)(n.li,{children:"Secret values are never logged; request/response logs are masked centrally"}),"\n",(0,s.jsx)(n.li,{children:"Analytics service ingests audit topics for UI and reporting"}),"\n"]})]})}function h(e={}){const{wrapper:n}={...(0,t.R)(),...e.components};return n?(0,s.jsx)(n,{...e,children:(0,s.jsx)(o,{...e})}):o(e)}},28453:(e,n,i)=>{i.d(n,{R:()=>l,x:()=>d});var r=i(96540);const s={},t=r.createContext(s);function l(e){const n=r.useContext(t);return r.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function d(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(s):e.components||s:l(e.components),r.createElement(t.Provider,{value:n},e.children)}}}]);