"use strict";(self.webpackChunkempowernow_docs=self.webpackChunkempowernow_docs||[]).push([[6249],{19433:(e,s,n)=>{n.r(s),n.d(s,{assets:()=>d,contentTitle:()=>l,default:()=>h,frontMatter:()=>c,metadata:()=>i,toc:()=>t});const i=JSON.parse('{"id":"services/bff/how-to/deploy-k8s","title":"Deploy on Kubernetes","description":"Deployment spec highlights (from k8s/deployment.yaml):","source":"@site/docs/services/bff/how-to/deploy-k8s.md","sourceDirName":"services/bff/how-to","slug":"/services/bff/how-to/deploy-k8s","permalink":"/empowernow_docs/docs/services/bff/how-to/deploy-k8s","draft":false,"unlisted":false,"editUrl":"https://github.com/facebook/docusaurus/tree/main/packages/create-docusaurus/templates/shared/docs/services/bff/how-to/deploy-k8s.md","tags":[],"version":"current","frontMatter":{"title":"Deploy on Kubernetes"},"sidebar":"tutorialSidebar","previous":{"title":"DCR: wire IAT in compose","permalink":"/empowernow_docs/docs/services/bff/how-to/dcr-compose-wiring"},"next":{"title":"Designing New SPA API Surfaces in the BFF","permalink":"/empowernow_docs/docs/services/bff/how-to/designing-new-apis"}}');var o=n(74848),r=n(28453);const c={title:"Deploy on Kubernetes"},l=void 0,d={},t=[];function a(e){const s={code:"code",li:"li",p:"p",ul:"ul",...(0,r.R)(),...e.components};return(0,o.jsxs)(o.Fragment,{children:[(0,o.jsxs)(s.p,{children:["Deployment spec highlights (from ",(0,o.jsx)(s.code,{children:"k8s/deployment.yaml"}),"):"]}),"\n",(0,o.jsxs)(s.ul,{children:["\n",(0,o.jsxs)(s.li,{children:["Image: ",(0,o.jsx)(s.code,{children:"empowernow/bff:2.1.0"})," (Always pull)"]}),"\n",(0,o.jsx)(s.li,{children:"Replicas: 3; rolling update (maxUnavailable: 1, maxSurge: 1)"}),"\n",(0,o.jsxs)(s.li,{children:["Probes: liveness/readiness/startup \u2192 ",(0,o.jsx)(s.code,{children:"GET /auth/health"})]}),"\n",(0,o.jsx)(s.li,{children:"Resources: requests 256Mi/250m; limits 512Mi/500m; readOnlyRootFilesystem"}),"\n",(0,o.jsx)(s.li,{children:"Security: drop ALL capabilities, runAsNonRoot: 1000"}),"\n",(0,o.jsxs)(s.li,{children:["Prometheus annotations: scrape ",(0,o.jsx)(s.code,{children:"/metrics"})," on 8000"]}),"\n",(0,o.jsxs)(s.li,{children:["EnvFrom: ",(0,o.jsx)(s.code,{children:"bff-config"})," (ConfigMap), ",(0,o.jsx)(s.code,{children:"bff-secrets"})," (Secret)"]}),"\n",(0,o.jsxs)(s.li,{children:["Volumes: ",(0,o.jsx)(s.code,{children:"emptyDir"})," for ",(0,o.jsx)(s.code,{children:"/tmp"})," and ",(0,o.jsx)(s.code,{children:"/app/cache"})]}),"\n",(0,o.jsx)(s.li,{children:"TerminationGracePeriodSeconds: 30; preStop sleep: 15s"}),"\n",(0,o.jsx)(s.li,{children:"Anti-affinity across nodes"}),"\n"]}),"\n",(0,o.jsxs)(s.p,{children:["Ingress and middlewares (from ",(0,o.jsx)(s.code,{children:"k8s/ingress.yaml"}),"):"]}),"\n",(0,o.jsxs)(s.ul,{children:["\n",(0,o.jsx)(s.li,{children:"TLS and entrypoints configured"}),"\n",(0,o.jsxs)(s.li,{children:[(0,o.jsx)(s.code,{children:"bff-forwardauth"})," middleware -> ",(0,o.jsx)(s.code,{children:"/auth/verify"})]}),"\n",(0,o.jsxs)(s.li,{children:[(0,o.jsx)(s.code,{children:"ratelimit"})," and ",(0,o.jsx)(s.code,{children:"security-headers"})," middlewares"]}),"\n"]}),"\n",(0,o.jsxs)(s.p,{children:["ConfigMap (from ",(0,o.jsx)(s.code,{children:"k8s/configmap.yaml"}),"):"]}),"\n",(0,o.jsxs)(s.ul,{children:["\n",(0,o.jsx)(s.li,{children:(0,o.jsx)(s.code,{children:"SESSION_COOKIE_NAME: bff_session"})}),"\n",(0,o.jsxs)(s.li,{children:[(0,o.jsx)(s.code,{children:"OIDC_ISSUER"}),", ",(0,o.jsx)(s.code,{children:"OIDC_SCOPES"})]}),"\n",(0,o.jsxs)(s.li,{children:["Security flags: ",(0,o.jsx)(s.code,{children:"CSRF_PROTECTION"}),", ",(0,o.jsx)(s.code,{children:"SESSION_BINDING"})]}),"\n"]}),"\n",(0,o.jsx)(s.p,{children:"Checklist:"}),"\n",(0,o.jsxs)(s.ul,{children:["\n",(0,o.jsxs)(s.li,{children:["Set secrets (client credentials) in ",(0,o.jsx)(s.code,{children:"bff-secrets"})]}),"\n",(0,o.jsxs)(s.li,{children:["Configure ",(0,o.jsx)(s.code,{children:"OIDC_ISSUER"}),", callback mode (dynamic/static), cookie domain, allowed redirect hosts"]}),"\n",(0,o.jsxs)(s.li,{children:["Validate ",(0,o.jsx)(s.code,{children:"/health"})," and metrics"]}),"\n"]})]})}function h(e={}){const{wrapper:s}={...(0,r.R)(),...e.components};return s?(0,o.jsx)(s,{...e,children:(0,o.jsx)(a,{...e})}):a(e)}},28453:(e,s,n)=>{n.d(s,{R:()=>c,x:()=>l});var i=n(96540);const o={},r=i.createContext(o);function c(e){const s=i.useContext(r);return i.useMemo(function(){return"function"==typeof e?e(s):{...s,...e}},[s,e])}function l(e){let s;return s=e.disableParentContext?"function"==typeof e.components?e.components(o):e.components||o:c(e.components),i.createElement(r.Provider,{value:s},e.children)}}}]);