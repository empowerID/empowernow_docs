"use strict";(self.webpackChunkempowernow_docs=self.webpackChunkempowernow_docs||[]).push([[6387],{28453:(e,n,i)=>{i.d(n,{R:()=>t,x:()=>l});var r=i(96540);const s={},o=r.createContext(s);function t(e){const n=r.useContext(o);return r.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function l(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(s):e.components||s:t(e.components),r.createElement(o.Provider,{value:n},e.children)}},37516:(e,n,i)=>{i.r(n),i.d(n,{assets:()=>c,contentTitle:()=>l,default:()=>h,frontMatter:()=>t,metadata:()=>r,toc:()=>a});const r=JSON.parse('{"id":"services/bff/how-to/bff-config-routing","title":"BFF Configuration and Routing Guide","description":"Source of truth","source":"@site/docs/services/bff/how-to/bff-config-routing.md","sourceDirName":"services/bff/how-to","slug":"/services/bff/how-to/bff-config-routing","permalink":"/empowernow_docs/docs/services/bff/how-to/bff-config-routing","draft":false,"unlisted":false,"editUrl":"https://github.com/facebook/docusaurus/tree/main/packages/create-docusaurus/templates/shared/docs/services/bff/how-to/bff-config-routing.md","tags":[],"version":"current","frontMatter":{"title":"BFF Configuration and Routing Guide"},"sidebar":"tutorialSidebar","previous":{"title":"Backup and Restore Sessions (Redis)","permalink":"/empowernow_docs/docs/services/bff/how-to/backup-restore-sessions"},"next":{"title":"Blue/Green Rollout \u2014 Sessions and Capacity","permalink":"/empowernow_docs/docs/services/bff/how-to/blue-green-rollout"}}');var s=i(74848),o=i(28453);const t={title:"BFF Configuration and Routing Guide"},l=void 0,c={},a=[{value:"Source of truth",id:"source-of-truth",level:2},{value:"Internal routes (target_service: internal)",id:"internal-routes-target_service-internal",level:2},{value:"Required endpoints for Experience",id:"required-endpoints-for-experience",level:2},{value:"CORS and redirect origins",id:"cors-and-redirect-origins",level:2},{value:"Traefik expectations",id:"traefik-expectations",level:2},{value:"Payload behavior for AuthZEN",id:"payload-behavior-for-authzen",level:2},{value:"PDP authorization mapping (single source)",id:"pdp-authorization-mapping-single-source",level:2},{value:"Migration from external pdp.yaml",id:"migration-from-external-pdpyaml",level:2},{value:"Observability and troubleshooting",id:"observability-and-troubleshooting",level:2},{value:"Health checklist",id:"health-checklist",level:2},{value:"Routing flows",id:"routing-flows",level:2}];function d(e){const n={code:"code",h2:"h2",li:"li",mermaid:"mermaid",pre:"pre",ul:"ul",...(0,o.R)(),...e.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(n.h2,{id:"source-of-truth",children:"Source of truth"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"ServiceConfigs/BFF/config/routes.yaml"}),": defines endpoints, upstream targets, auth, and inline PDP authorization mapping (",(0,s.jsx)(n.code,{children:"authz_map"}),")"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"ServiceConfigs/BFF/config/settings.yaml"}),": CORS, allowed origins, redirect origins, and other runtime settings"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"ServiceConfigs/BFF/config/pdp.yaml"})," (legacy): external endpoint_map. Deprecated once inline ",(0,s.jsx)(n.code,{children:"authz_map"})," is adopted"]}),"\n"]}),"\n",(0,s.jsx)(n.h2,{id:"internal-routes-target_service-internal",children:"Internal routes (target_service: internal)"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"Internal endpoints are dispatched directly to FastAPI handlers (no HTTP loopback), preserving session context"}),"\n",(0,s.jsxs)(n.li,{children:["Keep ",(0,s.jsx)(n.code,{children:"auth: session"})," on Experience internal endpoints so they remain cookie/session protected"]}),"\n"]}),"\n",(0,s.jsx)(n.h2,{id:"required-endpoints-for-experience",children:"Required endpoints for Experience"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:["PDP:","\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.code,{children:"POST /access/v1/evaluation"})}),"\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.code,{children:"POST /access/v1/evaluations"})}),"\n"]}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["UI Config:","\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"GET /api/configs/ui"})," (JSON)"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"GET /api/configs/stream"})," (SSE)"]}),"\n"]}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["Plugins:","\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.code,{children:"GET /api/plugins/manifests"})}),"\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.code,{children:"GET /api/plugins/bundle"})}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,s.jsx)(n.h2,{id:"cors-and-redirect-origins",children:"CORS and redirect origins"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:["Add ",(0,s.jsx)(n.code,{children:"https://experience.ocg.labs.empowernow.ai"})," to ",(0,s.jsx)(n.code,{children:"cors.allow_origins"})]}),"\n",(0,s.jsxs)(n.li,{children:["Add ",(0,s.jsx)(n.code,{children:"http://localhost:5177"})," to ",(0,s.jsx)(n.code,{children:"cors.dev_origins"})]}),"\n",(0,s.jsxs)(n.li,{children:["Add Experience host to ",(0,s.jsx)(n.code,{children:"ALLOWED_REDIRECT_ORIGINS"})]}),"\n"]}),"\n",(0,s.jsx)(n.h2,{id:"traefik-expectations",children:"Traefik expectations"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"Experience SPA router excludes API/auth/stream/PDP routes to avoid intercepting API traffic"}),"\n",(0,s.jsxs)(n.li,{children:["Separate routers on the BFF service for Experience ",(0,s.jsx)(n.code,{children:"Host()"})," that forward ",(0,s.jsx)(n.code,{children:"/api/"}),", ",(0,s.jsx)(n.code,{children:"/auth/"}),", ",(0,s.jsx)(n.code,{children:"/access/v1/"}),", and stream paths to the BFF app"]}),"\n"]}),"\n",(0,s.jsx)(n.h2,{id:"payload-behavior-for-authzen",children:"Payload behavior for AuthZEN"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"The BFF does not rewrite SPA AuthZEN payloads"}),"\n",(0,s.jsxs)(n.li,{children:["Minimal normalization only: provide a default ",(0,s.jsx)(n.code,{children:"resource.id"})," for collection-level checks when omitted"]}),"\n"]}),"\n",(0,s.jsx)(n.h2,{id:"pdp-authorization-mapping-single-source",children:"PDP authorization mapping (single source)"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"Prefer inline mapping on each route requiring PDP checks:"}),"\n"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-yaml",children:'- id: "crud-tasks-exact"\r\n  path: "/api/crud/tasks"\r\n  target_service: "crud_service"\r\n  upstream_path: "/tasks"\r\n  methods: ["GET", "POST"]\r\n  auth: "session"\r\n  authz: "pdp"\r\n  authz_map:\r\n    GET:\r\n      resource: "task_list"\r\n      action: "read"\r\n    POST:\r\n      resource: "task"\r\n      action: "create"\n'})}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:["Resolver precedence: inline ",(0,s.jsx)(n.code,{children:"authz_map"})," \u2192 external ",(0,s.jsx)(n.code,{children:"pdp.yaml"})," \u2192 derived defaults (if enabled)"]}),"\n",(0,s.jsxs)(n.li,{children:["Feature flags in settings:","\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"authz_validation_strict"}),": fail startup when PDP-protected routes lack a mapping"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"authz_default_mapping_enabled"}),": allow resolver to derive defaults (GET\u2192read, POST\u2192create, ...)"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,s.jsx)(n.h2,{id:"migration-from-external-pdpyaml",children:"Migration from external pdp.yaml"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:["A helper is provided to migrate exact-path endpoint_map entries into inline ",(0,s.jsx)(n.code,{children:"authz_map"}),":"]}),"\n"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:"python -m ms_bff.src.tools.migrate_pdp_to_routes \\\r\n  --routes ServiceConfigs/BFF/config/routes.yaml \\\r\n  --pdp ServiceConfigs/BFF/config/pdp.yaml \\\r\n  --out ServiceConfigs/BFF/config/routes.migrated.yaml\n"})}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:["Review the output, then replace the original or use ",(0,s.jsx)(n.code,{children:"--in-place"}),"."]}),"\n",(0,s.jsxs)(n.li,{children:["After migration, enable ",(0,s.jsx)(n.code,{children:"authz_validation_strict: true"})," and consider disabling defaults."]}),"\n"]}),"\n",(0,s.jsx)(n.h2,{id:"observability-and-troubleshooting",children:"Observability and troubleshooting"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"Inspect logs for PDP forwards to verify payloads"}),"\n",(0,s.jsxs)(n.li,{children:["Common misconfigurations:","\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"Experience origin missing from CORS \u2192 browser preflight failures"}),"\n",(0,s.jsxs)(n.li,{children:["Routes missing or not ",(0,s.jsx)(n.code,{children:"auth: session"})," \u2192 404/401"]}),"\n",(0,s.jsx)(n.li,{children:"ForwardAuth enabled for BFF API paths \u2192 cookies stripped (disable for these routers)"}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,s.jsx)(n.h2,{id:"health-checklist",children:"Health checklist"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"Internal routes load without validation errors"}),"\n",(0,s.jsx)(n.li,{children:"CORS origins include Experience"}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"/api/configs/ui"})," and ",(0,s.jsx)(n.code,{children:"/api/plugins/manifests"})," return 200 with a valid session"]}),"\n",(0,s.jsx)(n.li,{children:"PDP responds 200 for allow and deny test cases through BFF"}),"\n"]}),"\n",(0,s.jsx)(n.h2,{id:"routing-flows",children:"Routing flows"}),"\n",(0,s.jsx)(n.mermaid,{value:'sequenceDiagram\r\nautonumber\r\nparticipant SPA as "Experience SPA"\r\nparticipant BFF as "BFF"\r\nparticipant INT as "Internal Handler"\r\nparticipant PDP as "PDP"\r\nSPA->>BFF: GET /api/configs/ui (cookies)\r\nBFF->>INT: Dispatch (target_service: internal)\r\nINT--\x3e>BFF: 200 JSON\r\nBFF--\x3e>SPA: 200 JSON\r\nSPA->>BFF: POST /access/v1/evaluation {subject,resource,action,context}\r\nBFF->>PDP: Forward AuthZEN request\r\nPDP--\x3e>BFF: 200 {decision|allowed}\r\nBFF--\x3e>SPA: 200 decision'})]})}function h(e={}){const{wrapper:n}={...(0,o.R)(),...e.components};return n?(0,s.jsx)(n,{...e,children:(0,s.jsx)(d,{...e})}):d(e)}}}]);