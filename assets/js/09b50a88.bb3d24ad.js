"use strict";(self.webpackChunkempowernow_docs=self.webpackChunkempowernow_docs||[]).push([[380],{28453:(e,r,n)=>{n.d(r,{R:()=>t,x:()=>d});var s=n(96540);const c={},i=s.createContext(c);function t(e){const r=s.useContext(i);return s.useMemo(function(){return"function"==typeof e?e(r):{...r,...e}},[r,e])}function d(e){let r;return r=e.disableParentContext?"function"==typeof e.components?e.components(c):e.components||c:t(e.components),s.createElement(i.Provider,{value:r},e.children)}},70459:(e,r,n)=>{n.r(r),n.d(r,{assets:()=>o,contentTitle:()=>d,default:()=>u,frontMatter:()=>t,metadata:()=>s,toc:()=>a});const s=JSON.parse('{"id":"services/crud-service/reference/kafka-events","title":"CRUD Service Kafka events (business and error)","description":"Topics, payload shapes, and emission points for CRUD Service business/error events, plus guidance on consuming them for troubleshooting.","source":"@site/docs/services/crud-service/reference/kafka-events.md","sourceDirName":"services/crud-service/reference","slug":"/services/crud-service/reference/kafka-events","permalink":"/empowernow_docs/docs/services/crud-service/reference/kafka-events","draft":false,"unlisted":false,"editUrl":"https://github.com/facebook/docusaurus/tree/main/packages/create-docusaurus/templates/shared/docs/services/crud-service/reference/kafka-events.md","tags":[],"version":"current","frontMatter":{"id":"kafka-events","title":"CRUD Service Kafka events (business and error)","description":"Topics, payload shapes, and emission points for CRUD Service business/error events, plus guidance on consuming them for troubleshooting.","sidebar_label":"Kafka events"},"sidebar":"tutorialSidebar","previous":{"title":"CRUD Service \u2014 FAQ","permalink":"/empowernow_docs/docs/services/crud-service/reference/faq"},"next":{"title":"kpis_metrics","permalink":"/empowernow_docs/docs/services/crud-service/reference/kpis_metrics"}}');var c=n(74848),i=n(28453);const t={id:"kafka-events",title:"CRUD Service Kafka events (business and error)",description:"Topics, payload shapes, and emission points for CRUD Service business/error events, plus guidance on consuming them for troubleshooting.",sidebar_label:"Kafka events"},d=void 0,o={},a=[{value:"Topics used",id:"topics-used",level:2},{value:"Event shapes and when they are emitted",id:"event-shapes-and-when-they-are-emitted",level:2},{value:"CRUD operation events (topic <code>crud.operations</code>)",id:"crud-operation-events-topic-crudoperations",level:3},{value:"Validation error events (topic <code>crud.errors</code>)",id:"validation-error-events-topic-cruderrors",level:3},{value:"Workflow events (topic <code>crud.workflows</code>)",id:"workflow-events-topic-crudworkflows",level:3},{value:"Secret/vault events (topics <code>crud.secrets</code> and <code>crud.secrets.audit</code>)",id:"secretvault-events-topics-crudsecrets-and-crudsecretsaudit",level:3},{value:"Masking and PII",id:"masking-and-pii",level:2},{value:"Correlation and tracing",id:"correlation-and-tracing",level:2},{value:"Example event (failure on <code>crud.operations</code>)",id:"example-event-failure-on-crudoperations",level:2},{value:"Consuming for troubleshooting",id:"consuming-for-troubleshooting",level:2}];function l(e){const r={code:"code",h2:"h2",h3:"h3",li:"li",p:"p",pre:"pre",ul:"ul",...(0,i.R)(),...e.components};return(0,c.jsxs)(c.Fragment,{children:[(0,c.jsx)(r.h2,{id:"topics-used",children:"Topics used"}),"\n",(0,c.jsxs)(r.p,{children:["Note: Actual topic names are prefixed by ",(0,c.jsx)(r.code,{children:"KAFKA_TOPIC_PREFIX"})," (default ",(0,c.jsx)(r.code,{children:"crud"}),"). Examples below assume the default prefix."]}),"\n",(0,c.jsxs)(r.ul,{children:["\n",(0,c.jsxs)(r.li,{children:[(0,c.jsx)(r.code,{children:"crud.operations"}),": per\u2011command success/failure"]}),"\n",(0,c.jsxs)(r.li,{children:[(0,c.jsx)(r.code,{children:"crud.errors"}),": validation errors from ",(0,c.jsx)(r.code,{children:"/execute"})," (and general error events when targeted)"]}),"\n",(0,c.jsxs)(r.li,{children:[(0,c.jsx)(r.code,{children:"crud.workflows"}),": workflow started/completed/failed"]}),"\n",(0,c.jsxs)(r.li,{children:[(0,c.jsx)(r.code,{children:"crud.secrets"}),", ",(0,c.jsx)(r.code,{children:"crud.secrets.audit"}),": vault/secret retrieval successes, cache hits, errors"]}),"\n",(0,c.jsxs)(r.li,{children:[(0,c.jsx)(r.code,{children:"crud.metrics"}),": operational metrics (not errors; useful for monitoring)"]}),"\n"]}),"\n",(0,c.jsx)(r.h2,{id:"event-shapes-and-when-they-are-emitted",children:"Event shapes and when they are emitted"}),"\n",(0,c.jsxs)(r.h3,{id:"crud-operation-events-topic-crudoperations",children:["CRUD operation events (topic ",(0,c.jsx)(r.code,{children:"crud.operations"}),")"]}),"\n",(0,c.jsxs)(r.ul,{children:["\n",(0,c.jsx)(r.li,{children:"Emitted on both success and failure of a command."}),"\n",(0,c.jsxs)(r.li,{children:["Payload (data):","\n",(0,c.jsxs)(r.ul,{children:["\n",(0,c.jsxs)(r.li,{children:[(0,c.jsx)(r.code,{children:"operation"}),": action name (for example, ",(0,c.jsx)(r.code,{children:"create_user"}),")"]}),"\n",(0,c.jsxs)(r.li,{children:[(0,c.jsx)(r.code,{children:"system"}),", ",(0,c.jsx)(r.code,{children:"object_type"}),", ",(0,c.jsx)(r.code,{children:"object_id"})]}),"\n",(0,c.jsxs)(r.li,{children:[(0,c.jsx)(r.code,{children:"params"}),": masked parameters"]}),"\n",(0,c.jsxs)(r.li,{children:[(0,c.jsx)(r.code,{children:"result"}),": present on success"]}),"\n",(0,c.jsxs)(r.li,{children:[(0,c.jsx)(r.code,{children:"error"}),": present on failure (string)"]}),"\n",(0,c.jsxs)(r.li,{children:[(0,c.jsx)(r.code,{children:"success"}),": boolean"]}),"\n",(0,c.jsx)(r.li,{children:(0,c.jsx)(r.code,{children:"timestamp"})}),"\n"]}),"\n"]}),"\n",(0,c.jsxs)(r.li,{children:["Context added by producer (envelope):","\n",(0,c.jsxs)(r.ul,{children:["\n",(0,c.jsxs)(r.li,{children:[(0,c.jsx)(r.code,{children:"event_id"}),", ",(0,c.jsx)(r.code,{children:"event_type"})," (create/read/update/delete/list)"]}),"\n",(0,c.jsxs)(r.li,{children:[(0,c.jsx)(r.code,{children:"correlation_id"}),", ",(0,c.jsx)(r.code,{children:"service"}),", ",(0,c.jsx)(r.code,{children:"trace_id"}),", ",(0,c.jsx)(r.code,{children:"span_id"}),", ",(0,c.jsx)(r.code,{children:"user_context"})]}),"\n"]}),"\n"]}),"\n",(0,c.jsx)(r.li,{children:"Where emitted (examples):"}),"\n"]}),"\n",(0,c.jsx)(r.pre,{children:(0,c.jsx)(r.code,{className:"language-python",children:"# execute_routes.py\nawait producer.publish_crud_operation(\n  operation=execute_request.action,\n  system=execute_request.system,\n  object_type=execute_request.object_type,\n  object_id=object_id,\n  params=masked_params,\n  error=str(http_exc.detail),  # on failure\n  correlation_id=correlation_id,\n  execution_context=ExecutionContext(request),\n)\n"})}),"\n",(0,c.jsx)(r.pre,{children:(0,c.jsx)(r.code,{className:"language-python",children:"# command_executor.py\nawait kafka_producer.publish_crud_operation(\n  operation=action,\n  system=system_name,\n  object_type=object_type,\n  object_id=object_id,\n  params=params,\n  error=str(e),  # on failure\n  correlation_id=correlation_id,\n  execution_context=execution_context,\n)\n"})}),"\n",(0,c.jsxs)(r.h3,{id:"validation-error-events-topic-cruderrors",children:["Validation error events (topic ",(0,c.jsx)(r.code,{children:"crud.errors"}),")"]}),"\n",(0,c.jsxs)(r.ul,{children:["\n",(0,c.jsxs)(r.li,{children:["Emitted by the global handler when FastAPI raises ",(0,c.jsx)(r.code,{children:"RequestValidationError"})," for ",(0,c.jsx)(r.code,{children:"/execute"}),"."]}),"\n",(0,c.jsxs)(r.li,{children:["Payload (data):","\n",(0,c.jsxs)(r.ul,{children:["\n",(0,c.jsxs)(r.li,{children:[(0,c.jsx)(r.code,{children:"path"}),", ",(0,c.jsx)(r.code,{children:"errors"})," (FastAPI validation details)"]}),"\n",(0,c.jsxs)(r.li,{children:[(0,c.jsx)(r.code,{children:"system"}),", ",(0,c.jsx)(r.code,{children:"object_type"}),", ",(0,c.jsx)(r.code,{children:"action"}),", ",(0,c.jsx)(r.code,{children:"object_id"})]}),"\n"]}),"\n"]}),"\n",(0,c.jsxs)(r.li,{children:["Context: ",(0,c.jsx)(r.code,{children:"correlation_id"})," added by producer wrapper"]}),"\n",(0,c.jsx)(r.li,{children:"Where emitted (example):"}),"\n"]}),"\n",(0,c.jsx)(r.pre,{children:(0,c.jsx)(r.code,{className:"language-python",children:'# main.py\nawait producer.publish_event(\n  event_type="validation_error",\n  data=data,\n  correlation_id=str(getattr(request.state, "correlation_id", "")) or None,\n  topic=producer.topics.get("errors"),\n  execution_context=None,\n)\n'})}),"\n",(0,c.jsxs)(r.h3,{id:"workflow-events-topic-crudworkflows",children:["Workflow events (topic ",(0,c.jsx)(r.code,{children:"crud.workflows"}),")"]}),"\n",(0,c.jsxs)(r.ul,{children:["\n",(0,c.jsx)(r.li,{children:"Emitted when a workflow starts and when it completes/fails/waits."}),"\n",(0,c.jsxs)(r.li,{children:["Payload (data):","\n",(0,c.jsxs)(r.ul,{children:["\n",(0,c.jsxs)(r.li,{children:[(0,c.jsx)(r.code,{children:"workflow_name"}),", ",(0,c.jsx)(r.code,{children:"step_name"})," (optional), ",(0,c.jsx)(r.code,{children:"status"}),", ",(0,c.jsx)(r.code,{children:"error"})," (on failure), ",(0,c.jsx)(r.code,{children:"metadata"}),", ",(0,c.jsx)(r.code,{children:"started_by"}),", ",(0,c.jsx)(r.code,{children:"timestamp"})]}),"\n"]}),"\n"]}),"\n",(0,c.jsx)(r.li,{children:"Where emitted (example):"}),"\n"]}),"\n",(0,c.jsx)(r.pre,{children:(0,c.jsx)(r.code,{className:"language-python",children:"# final_executor.py\nawait producer.publish_workflow_event(\n  event_type=evt,\n  workflow_name=self.workflow_name,\n  status=self.context.status.value,\n  correlation_id=self.context.id,\n  started_by=self.context.started_by_arn,\n)\n"})}),"\n",(0,c.jsxs)(r.h3,{id:"secretvault-events-topics-crudsecrets-and-crudsecretsaudit",children:["Secret/vault events (topics ",(0,c.jsx)(r.code,{children:"crud.secrets"})," and ",(0,c.jsx)(r.code,{children:"crud.secrets.audit"}),")"]}),"\n",(0,c.jsxs)(r.ul,{children:["\n",(0,c.jsx)(r.li,{children:"Emitted on cache hits, successful retrievals, and errors when fetching secrets from vault providers."}),"\n",(0,c.jsxs)(r.li,{children:["Payload (data):","\n",(0,c.jsxs)(r.ul,{children:["\n",(0,c.jsxs)(r.li,{children:[(0,c.jsx)(r.code,{children:"vault_type"}),", ",(0,c.jsx)(r.code,{children:"credential_id"}),", ",(0,c.jsx)(r.code,{children:"success"}),", ",(0,c.jsx)(r.code,{children:"error"})," (on failure), ",(0,c.jsx)(r.code,{children:"cached"}),", ",(0,c.jsx)(r.code,{children:"timestamp"})]}),"\n"]}),"\n"]}),"\n",(0,c.jsx)(r.li,{children:"Emitted to both functional and audit topics."}),"\n",(0,c.jsx)(r.li,{children:"Where emitted (examples):"}),"\n"]}),"\n",(0,c.jsx)(r.pre,{children:(0,c.jsx)(r.code,{className:"language-python",children:'# vault_service.py (error path)\nawait producer.publish_secret_event(\n  event_type=EventType.SECRET_ERROR,\n  vault_type=vault_type,\n  credential_id=pointer.credential_id,\n  success=False,\n  error="Vault strategy not found",\n)\n'})}),"\n",(0,c.jsx)(r.pre,{children:(0,c.jsx)(r.code,{className:"language-python",children:'# crud_producer.py (audit fan\u2011out)\nawait self.publish_event(\n  event_type=event_type,\n  data=data,\n  topic=self.topics["secrets_audit"],\n  # ...\n)\n'})}),"\n",(0,c.jsx)(r.h2,{id:"masking-and-pii",children:"Masking and PII"}),"\n",(0,c.jsxs)(r.ul,{children:["\n",(0,c.jsx)(r.li,{children:"Parameters are masked before being passed to the producer; sinks also mask sensitive fields."}),"\n",(0,c.jsxs)(r.li,{children:["Secrets and headers are sanitized by callers. ",(0,c.jsx)(r.code,{children:"credential_id"})," is included as\u2011is; secret values are never included."]}),"\n"]}),"\n",(0,c.jsx)(r.h2,{id:"correlation-and-tracing",children:"Correlation and tracing"}),"\n",(0,c.jsxs)(r.ul,{children:["\n",(0,c.jsxs)(r.li,{children:["Each event includes a ",(0,c.jsx)(r.code,{children:"correlation_id"})," (request or workflow id)."]}),"\n",(0,c.jsxs)(r.li,{children:["If OpenTelemetry is active, ",(0,c.jsx)(r.code,{children:"trace_id"})," and ",(0,c.jsx)(r.code,{children:"span_id"})," are attached."]}),"\n",(0,c.jsxs)(r.li,{children:[(0,c.jsx)(r.code,{children:"user_context"})," carries subject/issuer when available. The subject/unique_id uses the canonical provider alias from IdP config for ARNs (provider falls back to IdP entry ",(0,c.jsx)(r.code,{children:"name"}),")."]}),"\n"]}),"\n",(0,c.jsxs)(r.h2,{id:"example-event-failure-on-crudoperations",children:["Example event (failure on ",(0,c.jsx)(r.code,{children:"crud.operations"}),")"]}),"\n",(0,c.jsx)(r.pre,{children:(0,c.jsx)(r.code,{className:"language-json",children:'{\n  "event_id": "...",\n  "event_type": "update",\n  "timestamp": "...",\n  "correlation_id": "b1e-...",\n  "service": "crud-service",\n  "trace_id": "...",\n  "span_id": "...",\n  "user_context": {"unique_id": "...", "subject": "auth:account:...", "issuer": "..."},\n  "data": {\n    "operation": "update",\n    "system": "entraid_contractors",\n    "object_type": "user",\n    "object_id": "E123456",\n    "params": {"Password": "****MASKED****", "Email": "john@example.com"},\n    "error": "Validation failed: missing field \'LastName\'",\n    "success": false,\n    "timestamp": "..."\n  }\n}\n'})}),"\n",(0,c.jsx)(r.h2,{id:"consuming-for-troubleshooting",children:"Consuming for troubleshooting"}),"\n",(0,c.jsxs)(r.ul,{children:["\n",(0,c.jsxs)(r.li,{children:["CRUD failures: read ",(0,c.jsx)(r.code,{children:"crud.operations"})," filtering where ",(0,c.jsx)(r.code,{children:"success=false"})," or ",(0,c.jsx)(r.code,{children:"error"})," present; group by ",(0,c.jsx)(r.code,{children:"correlation_id"})," or ",(0,c.jsx)(r.code,{children:"object_id"}),"."]}),"\n",(0,c.jsxs)(r.li,{children:["Validation problems: read last N from ",(0,c.jsx)(r.code,{children:"crud.errors"}),"."]}),"\n",(0,c.jsxs)(r.li,{children:["Workflow issues: read ",(0,c.jsx)(r.code,{children:"crud.workflows"})," where ",(0,c.jsx)(r.code,{children:"status=FAILED"})," or an ",(0,c.jsx)(r.code,{children:"error"})," is present."]}),"\n",(0,c.jsxs)(r.li,{children:["Vault issues: read ",(0,c.jsx)(r.code,{children:"crud.secrets"})," and ",(0,c.jsx)(r.code,{children:"crud.secrets.audit"})," where ",(0,c.jsx)(r.code,{children:"success=false"}),"."]}),"\n"]}),"\n",(0,c.jsx)(r.p,{children:"Examples (host with kcat):"}),"\n",(0,c.jsx)(r.pre,{children:(0,c.jsx)(r.code,{className:"language-bash",children:"kcat -b <broker> -t crud.errors -C -o -10\nkcat -b <broker> -t crud.operations -C -o -10 | jq 'select(.data.success==false)'\n"})})]})}function u(e={}){const{wrapper:r}={...(0,i.R)(),...e.components};return r?(0,c.jsx)(r,{...e,children:(0,c.jsx)(l,{...e})}):l(e)}}}]);