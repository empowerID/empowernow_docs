"use strict";(self.webpackChunkempowernow_docs=self.webpackChunkempowernow_docs||[]).push([[5651],{28453:(e,r,n)=>{n.d(r,{R:()=>c,x:()=>a});var s=n(96540);const i={},t=s.createContext(i);function c(e){const r=s.useContext(t);return s.useMemo(function(){return"function"==typeof e?e(r):{...r,...e}},[r,e])}function a(e){let r;return r=e.disableParentContext?"function"==typeof e.components?e.components(i):e.components||i:c(e.components),s.createElement(t.Provider,{value:r},e.children)}},80254:(e,r,n)=>{n.r(r),n.d(r,{assets:()=>o,contentTitle:()=>a,default:()=>h,frontMatter:()=>c,metadata:()=>s,toc:()=>d});const s=JSON.parse('{"id":"services/bff/explanation/architecture","title":"Architecture","description":"The EmpowerNow BFF uses a hybrid\u2011edge pattern:","source":"@site/docs/services/bff/explanation/architecture.md","sourceDirName":"services/bff/explanation","slug":"/services/bff/explanation/architecture","permalink":"/empowernow_docs/docs/services/bff/explanation/architecture","draft":false,"unlisted":false,"editUrl":"https://github.com/facebook/docusaurus/tree/main/packages/create-docusaurus/templates/shared/docs/services/bff/explanation/architecture.md","tags":[],"version":"current","frontMatter":{"title":"Architecture"},"sidebar":"tutorialSidebar","previous":{"title":"Backend\u2011for\u2011Frontend (BFF) Design Pattern","permalink":"/empowernow_docs/docs/services/bff/explanation/bff-design-pattern"},"next":{"title":"bff_gateway","permalink":"/empowernow_docs/docs/services/bff/explanation/bff_gateway"}}');var i=n(74848),t=n(28453);const c={title:"Architecture"},a=void 0,o={},d=[{value:"How <code>/api/**</code> is routed",id:"how-api-is-routed",level:2}];function l(e){const r={code:"code",h2:"h2",li:"li",mermaid:"mermaid",p:"p",pre:"pre",ul:"ul",...(0,t.R)(),...e.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(r.p,{children:"The EmpowerNow BFF uses a hybrid\u2011edge pattern:"}),"\n",(0,i.jsxs)(r.ul,{children:["\n",(0,i.jsx)(r.li,{children:"Traefik handles routing, security headers, optional ForwardAuth, and rate limiting"}),"\n",(0,i.jsx)(r.li,{children:"The BFF terminates OAuth (PKCE/PAR/DPoP), manages sessions and CSRF, and authorizes requests via the PDP"}),"\n",(0,i.jsx)(r.li,{children:"Backend services receive proxied requests with the right auth context"}),"\n"]}),"\n",(0,i.jsx)(r.mermaid,{value:"flowchart LR\r\n  Browser --\x3e|Cookie| Traefik\r\n  Traefik --\x3e|/auth/verify| BFF\r\n  BFF --\x3e|lookup| Redis\r\n  BFF <--\x3e|OIDC| IdP\r\n  BFF --\x3e|Bearer| Services"}),"\n",(0,i.jsx)(r.p,{children:"Why this design"}),"\n",(0,i.jsxs)(r.ul,{children:["\n",(0,i.jsx)(r.li,{children:"Security: tokens never reach the browser; session validation happens at the edge"}),"\n",(0,i.jsx)(r.li,{children:"Performance: 1ms session checks and PDP decision caching reduce latency"}),"\n",(0,i.jsxs)(r.li,{children:["Simplicity for SPAs: call ",(0,i.jsx)(r.code,{children:"/api/**"})," on the same origin; no SDK token plumbing"]}),"\n"]}),"\n",(0,i.jsx)(r.p,{children:"Key configuration"}),"\n",(0,i.jsxs)(r.ul,{children:["\n",(0,i.jsxs)(r.li,{children:["Traefik dynamic config: ",(0,i.jsx)(r.code,{children:"CRUDService/traefik/dynamic.yml"})]}),"\n",(0,i.jsxs)(r.li,{children:["BFF routes/config: ",(0,i.jsx)(r.code,{children:"ServiceConfigs/BFF/config/routes.yaml"}),", ",(0,i.jsx)(r.code,{children:"pdp.yaml"}),", ",(0,i.jsx)(r.code,{children:"idps.yaml"})]}),"\n"]}),"\n",(0,i.jsxs)(r.h2,{id:"how-api-is-routed",children:["How ",(0,i.jsx)(r.code,{children:"/api/**"})," is routed"]}),"\n",(0,i.jsxs)(r.ul,{children:["\n",(0,i.jsxs)(r.li,{children:["Edge: Traefik router matches ",(0,i.jsx)(r.code,{children:"PathPrefix(/api/*)"})," for SPA hosts and forwards to the BFF (ForwardAuth is disabled for these; the BFF handles auth and returns JSON 401/403 when needed)."]}),"\n",(0,i.jsxs)(r.li,{children:["BFF: consults ",(0,i.jsx)(r.code,{children:"routes.yaml"})," where ",(0,i.jsx)(r.code,{children:"path"})," is the client path and ",(0,i.jsx)(r.code,{children:"upstream_path"})," is the backend path (templated with ",(0,i.jsx)(r.code,{children:"{path}"})," for wildcards)."]}),"\n"]}),"\n",(0,i.jsx)(r.p,{children:"Example"}),"\n",(0,i.jsx)(r.pre,{children:(0,i.jsx)(r.code,{className:"language-text",children:'Client: GET /api/myapp/items/42\r\nBFF \u2192 routes.yaml: \r\n  path "/api/myapp/items/*" \u2192 target_service "my_service" (base_url http://my-service:8080)\r\n  upstream_path "/items/{path}"\r\nBFF \u2192 calls GET http://my-service:8080/items/42 (adds auth/context headers) \u2192 returns JSON\n'})}),"\n",(0,i.jsx)(r.p,{children:"Headers contract (edge and downstream)"}),"\n",(0,i.jsxs)(r.ul,{children:["\n",(0,i.jsxs)(r.li,{children:["ForwardAuth request \u2192 BFF: includes ",(0,i.jsx)(r.code,{children:"Cookie"})," (session), may include ",(0,i.jsx)(r.code,{children:"X-Forwarded-*"})," headers"]}),"\n",(0,i.jsxs)(r.li,{children:["ForwardAuth response \u2190 BFF: sets ",(0,i.jsx)(r.code,{children:"X-Session-ID"}),", ",(0,i.jsx)(r.code,{children:"X-Auth-Time"}),", and ",(0,i.jsx)(r.code,{children:"X-Correlation-ID"}),"; Traefik uses 200/401 to allow/deny"]}),"\n",(0,i.jsxs)(r.li,{children:["Downstream from BFF to services:","\n",(0,i.jsxs)(r.ul,{children:["\n",(0,i.jsxs)(r.li,{children:["Always includes ",(0,i.jsx)(r.code,{children:"X-Correlation-ID"})]}),"\n",(0,i.jsxs)(r.li,{children:["Includes ",(0,i.jsx)(r.code,{children:"X-Original-User"})," when ARN/subject is available"]}),"\n",(0,i.jsxs)(r.li,{children:["Adds ",(0,i.jsx)(r.code,{children:"Authorization: Bearer ..."})," for service calls when required by the target"]}),"\n"]}),"\n"]}),"\n"]})]})}function h(e={}){const{wrapper:r}={...(0,t.R)(),...e.components};return r?(0,i.jsx)(r,{...e,children:(0,i.jsx)(l,{...e})}):l(e)}}}]);