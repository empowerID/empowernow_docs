"use strict";(self.webpackChunkempowernow_docs=self.webpackChunkempowernow_docs||[]).push([[9393],{28453:(e,s,i)=>{i.d(s,{R:()=>r,x:()=>o});var n=i(96540);const c={},t=n.createContext(c);function r(e){const s=n.useContext(t);return n.useMemo(function(){return"function"==typeof e?e(s):{...s,...e}},[s,e])}function o(e){let s;return s=e.disableParentContext?"function"==typeof e.components?e.components(c):e.components||c:r(e.components),n.createElement(t.Provider,{value:s},e.children)}},53366:(e,s,i)=>{i.r(s),i.d(s,{assets:()=>l,contentTitle:()=>o,default:()=>h,frontMatter:()=>r,metadata:()=>n,toc:()=>d});const n=JSON.parse('{"id":"services/bff/how-to/session-to-service-token-bridging","title":"Session-to-service token bridging in the BFF","description":"How the BFF validates the SPA session and proxies to backend services using per\u2011service OAuth access tokens, plus the configuration required across BFF and IdP.","source":"@site/docs/services/bff/how-to/session-to-service-token-bridging.md","sourceDirName":"services/bff/how-to","slug":"/services/bff/how-to/session-to-service-token-bridging","permalink":"/empowernow_docs/docs/services/bff/how-to/session-to-service-token-bridging","draft":false,"unlisted":false,"editUrl":"https://github.com/facebook/docusaurus/tree/main/packages/create-docusaurus/templates/shared/docs/services/bff/how-to/session-to-service-token-bridging.md","tags":[],"version":"current","frontMatter":{"id":"session-to-service-token-bridging","title":"Session-to-service token bridging in the BFF","description":"How the BFF validates the SPA session and proxies to backend services using per\u2011service OAuth access tokens, plus the configuration required across BFF and IdP.","sidebar_label":"Session \u2192 service token bridging"},"sidebar":"tutorialSidebar","previous":{"title":"Secure IdP admin proxy","permalink":"/empowernow_docs/docs/services/bff/how-to/secure-idp-admin-proxy"},"next":{"title":"SPA Auth Flows with the BFF","permalink":"/empowernow_docs/docs/services/bff/how-to/spa-auth-flows"}}');var c=i(74848),t=i(28453);const r={id:"session-to-service-token-bridging",title:"Session-to-service token bridging in the BFF",description:"How the BFF validates the SPA session and proxies to backend services using per\u2011service OAuth access tokens, plus the configuration required across BFF and IdP.",sidebar_label:"Session \u2192 service token bridging"},o=void 0,l={},d=[{value:"What this process is",id:"what-this-process-is",level:2},{value:"Why it\u2019s needed",id:"why-its-needed",level:2},{value:"How it works (runtime flow)",id:"how-it-works-runtime-flow",level:2},{value:"What must be configured (BFF + IdP)",id:"what-must-be-configured-bff--idp",level:2},{value:"1) BFF route to target_service",id:"1-bff-route-to-target_service",level:3},{value:"2) IdP: allow audience issuance for that service",id:"2-idp-allow-audience-issuance-for-that-service",level:3},{value:"3) IdP: allow the BFF client to request that audience",id:"3-idp-allow-the-bff-client-to-request-that-audience",level:3},{value:"4) BFF: service \u2192 audience mapping (token minting/validation)",id:"4-bff-service--audience-mapping-token-mintingvalidation",level:3},{value:"Example: Analytics",id:"example-analytics",level:2},{value:"Troubleshooting",id:"troubleshooting",level:2},{value:"Quick checklist",id:"quick-checklist",level:2},{value:"See also",id:"see-also",level:2}];function a(e){const s={code:"code",h2:"h2",h3:"h3",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,t.R)(),...e.components};return(0,c.jsxs)(c.Fragment,{children:[(0,c.jsx)(s.h2,{id:"what-this-process-is",children:"What this process is"}),"\n",(0,c.jsxs)(s.ul,{children:["\n",(0,c.jsxs)(s.li,{children:[(0,c.jsx)(s.strong,{children:"Session-to-service token bridging in the BFF"}),"."]}),"\n",(0,c.jsxs)(s.li,{children:["The BFF validates the SPA\u2019s session cookie, then proxies the request to a backend ",(0,c.jsx)(s.code,{children:"target_service"})," using a service\u2011scoped access token (audience\u2011bound to that service). It maps tokens per service name and attaches the correct ",(0,c.jsx)(s.code,{children:"Authorization"})," header on the upstream hop."]}),"\n"]}),"\n",(0,c.jsx)(s.p,{children:"What this is not"}),"\n",(0,c.jsxs)(s.ul,{children:["\n",(0,c.jsxs)(s.li,{children:["The service token is not the user\u2019s identity. The user identity comes from ",(0,c.jsx)(s.code,{children:"id_token.sub"})," stored in the BFF session. Service tokens often have ",(0,c.jsx)(s.code,{children:"sub = client_id"})," (e.g., ",(0,c.jsx)(s.code,{children:"bff-server"}),"), which is expected."]}),"\n"]}),"\n",(0,c.jsx)(s.h2,{id:"why-its-needed",children:"Why it\u2019s needed"}),"\n",(0,c.jsxs)(s.ul,{children:["\n",(0,c.jsxs)(s.li,{children:[(0,c.jsx)(s.strong,{children:"Backends require OAuth access tokens"})," and will not accept your browser cookie (e.g., Analytics, CRUD, PDP)."]}),"\n",(0,c.jsxs)(s.li,{children:["The BFF holds the user session and, on behalf of the user, ",(0,c.jsx)(s.strong,{children:"mints/keeps per\u2011service tokens"}),". Without a mapped token for the specific ",(0,c.jsx)(s.code,{children:"target_service"}),", the BFF logs ",(0,c.jsx)(s.code,{children:"NO_TOKEN_AVAILABLE"})," and returns ",(0,c.jsx)(s.code,{children:"401"}),"."]}),"\n"]}),"\n",(0,c.jsx)(s.h2,{id:"how-it-works-runtime-flow",children:"How it works (runtime flow)"}),"\n",(0,c.jsxs)(s.ol,{children:["\n",(0,c.jsxs)(s.li,{children:["SPA calls a canonical BFF route (for example, ",(0,c.jsx)(s.code,{children:"GET /api/v1/analytics/workflows"}),")."]}),"\n",(0,c.jsxs)(s.li,{children:["BFF matches the YAML route, sets ",(0,c.jsx)(s.code,{children:"target_service=analytics_service"}),", and requires session auth."]}),"\n",(0,c.jsxs)(s.li,{children:["BFF looks up a token in the session store keyed by ",(0,c.jsx)(s.code,{children:"target_service"}),".","\n",(0,c.jsxs)(s.ul,{children:["\n",(0,c.jsxs)(s.li,{children:["If a token exists and its ",(0,c.jsx)(s.code,{children:"aud"})," matches Analytics, the BFF injects ",(0,c.jsx)(s.code,{children:"Authorization: Bearer <token>"})," and forwards."]}),"\n",(0,c.jsxs)(s.li,{children:["If not, you see in logs: ",(0,c.jsx)(s.code,{children:"service=analytics_service NO_TOKEN_AVAILABLE \u2192 401"}),"."]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,c.jsx)(s.h2,{id:"what-must-be-configured-bff--idp",children:"What must be configured (BFF + IdP)"}),"\n",(0,c.jsxs)(s.p,{children:["Goal: Align audiences/scopes so the BFF can mint and map a token for the service name used in ",(0,c.jsx)(s.code,{children:"routes.yaml"}),"."]}),"\n",(0,c.jsx)(s.h3,{id:"1-bff-route-to-target_service",children:"1) BFF route to target_service"}),"\n",(0,c.jsxs)(s.ul,{children:["\n",(0,c.jsxs)(s.li,{children:["File: ",(0,c.jsx)(s.code,{children:"ServiceConfigs/BFF/config/routes.yaml"})]}),"\n",(0,c.jsx)(s.li,{children:"Ensure a route exists and points to the logical service name the BFF uses for token lookup:"}),"\n"]}),"\n",(0,c.jsx)(s.pre,{children:(0,c.jsx)(s.code,{className:"language-yaml",children:'# Already correct\nservices:\n  analytics_service:\n    base_url: "http://analytics:8100"\nroutes:\n  - id: "api-analytics"\n    path: "/api/v1/analytics/*"\n    target_service: "analytics_service"\n    upstream_path: "/api/v1/analytics/{path}"\n    auth: "session"\n'})}),"\n",(0,c.jsx)(s.h3,{id:"2-idp-allow-audience-issuance-for-that-service",children:"2) IdP: allow audience issuance for that service"}),"\n",(0,c.jsxs)(s.ul,{children:["\n",(0,c.jsxs)(s.li,{children:["File: ",(0,c.jsx)(s.code,{children:"ServiceConfigs/IdP/config/settings.yaml"})]}),"\n",(0,c.jsxs)(s.li,{children:["Map a scope you grant at login (for example, ",(0,c.jsx)(s.code,{children:"application.all"}),") to include the Analytics audience so the IdP can issue a token for it."]}),"\n"]}),"\n",(0,c.jsx)(s.pre,{children:(0,c.jsx)(s.code,{className:"language-yaml",children:"token:\n  audience_mappings:\n    scope_mappings:\n      - scope: application.all\n        audiences:\n          - https://idp.ocg.labs.empowernow.ai/api/admin\n          - https://idp.ocg.labs.empowernow.ai/api/v1\n          - https://crud.ocg.labs.empowernow.ai\n          - empowernow\n          - https://analytics.ocg.labs.empowernow.ai   # added\n"})}),"\n",(0,c.jsx)(s.h3,{id:"3-idp-allow-the-bff-client-to-request-that-audience",children:"3) IdP: allow the BFF client to request that audience"}),"\n",(0,c.jsxs)(s.ul,{children:["\n",(0,c.jsxs)(s.li,{children:["File: ",(0,c.jsx)(s.code,{children:"ServiceConfigs/IdP/config/clients.yaml"})," (client: ",(0,c.jsx)(s.code,{children:"bff-server"}),")"]}),"\n"]}),"\n",(0,c.jsx)(s.pre,{children:(0,c.jsx)(s.code,{className:"language-yaml",children:"bff-server:\n  # ...\n  scopes: [openid, profile, email, offline_access, admin.api, application.all]\n  allowed_audiences:\n    - empowernow\n    - https://analytics.ocg.labs.empowernow.ai        # added\n"})}),"\n",(0,c.jsx)(s.h3,{id:"4-bff-service--audience-mapping-token-mintingvalidation",children:"4) BFF: service \u2192 audience mapping (token minting/validation)"}),"\n",(0,c.jsxs)(s.ul,{children:["\n",(0,c.jsxs)(s.li,{children:["File: ",(0,c.jsx)(s.code,{children:"ServiceConfigs/BFF/config/<settings file>"})," (the BFF reads a ",(0,c.jsx)(s.code,{children:"service_audiences"})," map used by ",(0,c.jsx)(s.code,{children:"session_manager.get_service_audience(service)"}),")"]}),"\n",(0,c.jsxs)(s.li,{children:["Add Analytics mapping so the BFF knows which audience to request/validate for ",(0,c.jsx)(s.code,{children:"analytics_service"}),":"]}),"\n"]}),"\n",(0,c.jsx)(s.pre,{children:(0,c.jsx)(s.code,{className:"language-yaml",children:"service_audiences:\n  crud_service:       https://crud.ocg.labs.empowernow.ai\n  pdp_service:        https://authz.ocg.labs.empowernow.ai/api/v1\n  idp_service:        https://idp.ocg.labs.empowernow.ai/api/v1\n  analytics_service:  https://analytics.ocg.labs.empowernow.ai    # add this\nservice_scopes:\n  analytics_service:  application.all    # or api.read if you enforce finer scope\n"})}),"\n",(0,c.jsxs)(s.ul,{children:["\n",(0,c.jsxs)(s.li,{children:["Names must match the ",(0,c.jsx)(s.code,{children:"target_service"})," in ",(0,c.jsx)(s.code,{children:"routes.yaml"})," (",(0,c.jsx)(s.code,{children:"analytics_service"}),")."]}),"\n"]}),"\n",(0,c.jsx)(s.h2,{id:"example-analytics",children:"Example: Analytics"}),"\n",(0,c.jsxs)(s.ul,{children:["\n",(0,c.jsxs)(s.li,{children:["Symptom: BFF logs show ",(0,c.jsx)(s.code,{children:"NO_TOKEN_AVAILABLE service=analytics_service \u2192 401"}),"."]}),"\n",(0,c.jsxs)(s.li,{children:["Fix you made:","\n",(0,c.jsxs)(s.ul,{children:["\n",(0,c.jsxs)(s.li,{children:["Added Analytics audience to IdP ",(0,c.jsx)(s.code,{children:"application.all"})," and to ",(0,c.jsx)(s.code,{children:"bff-server.allowed_audiences"}),"."]}),"\n"]}),"\n"]}),"\n",(0,c.jsxs)(s.li,{children:["Remaining step (BFF config):","\n",(0,c.jsxs)(s.ul,{children:["\n",(0,c.jsxs)(s.li,{children:["Add ",(0,c.jsx)(s.code,{children:"analytics_service \u2192 https://analytics.ocg.labs.empowernow.ai"})," in BFF ",(0,c.jsx)(s.code,{children:"service_audiences"})," (and optional ",(0,c.jsx)(s.code,{children:"service_scopes"}),")."]}),"\n"]}),"\n"]}),"\n",(0,c.jsx)(s.li,{children:"Restart IdP and BFF; log out/in once so the session refreshes and tokens are minted."}),"\n",(0,c.jsxs)(s.li,{children:["Re\u2011test. BFF logs should show ",(0,c.jsx)(s.code,{children:"token_found=True"})," for ",(0,c.jsx)(s.code,{children:"analytics_service"})," and upstream ",(0,c.jsx)(s.code,{children:"200"}),"."]}),"\n"]}),"\n",(0,c.jsx)(s.h2,{id:"troubleshooting",children:"Troubleshooting"}),"\n",(0,c.jsxs)(s.ul,{children:["\n",(0,c.jsxs)(s.li,{children:["If route is correct but still 401:","\n",(0,c.jsxs)(s.ul,{children:["\n",(0,c.jsxs)(s.li,{children:["Check BFF log line: ",(0,c.jsx)(s.code,{children:"NO_TOKEN_AVAILABLE service=analytics_service"}),". That means the ",(0,c.jsx)(s.code,{children:"service_audiences"})," map or IdP audience/scopes are not aligned."]}),"\n"]}),"\n"]}),"\n",(0,c.jsxs)(s.li,{children:["If ",(0,c.jsx)(s.code,{children:"token_found=True"})," but upstream ",(0,c.jsx)(s.code,{children:"401"}),":","\n",(0,c.jsxs)(s.ul,{children:["\n",(0,c.jsxs)(s.li,{children:["Check the audience value matches the backend\u2019s required ",(0,c.jsx)(s.code,{children:"aud"})," exactly."]}),"\n"]}),"\n"]}),"\n",(0,c.jsxs)(s.li,{children:["Verify ",(0,c.jsx)(s.code,{children:"services_count"})," in \u201cSession status check successful\u201d includes analytics after login."]}),"\n"]}),"\n",(0,c.jsx)(s.h2,{id:"quick-checklist",children:"Quick checklist"}),"\n",(0,c.jsxs)(s.ul,{children:["\n",(0,c.jsxs)(s.li,{children:["BFF ",(0,c.jsx)(s.code,{children:"routes.yaml"}),": ",(0,c.jsx)(s.code,{children:"target_service"})," present and correct."]}),"\n",(0,c.jsxs)(s.li,{children:["IdP ",(0,c.jsx)(s.code,{children:"settings.yaml"}),": scope \u2192 audience mapping includes the service audience."]}),"\n",(0,c.jsxs)(s.li,{children:["IdP ",(0,c.jsx)(s.code,{children:"clients.yaml"})," (",(0,c.jsx)(s.code,{children:"bff-server"}),"): ",(0,c.jsx)(s.code,{children:"allowed_audiences"})," includes the service audience."]}),"\n",(0,c.jsxs)(s.li,{children:["BFF settings: ",(0,c.jsx)(s.code,{children:"service_audiences"})," (and ",(0,c.jsx)(s.code,{children:"service_scopes"}),") include the service name used by routes."]}),"\n",(0,c.jsx)(s.li,{children:"Restart IdP and BFF; re\u2011authenticate."}),"\n"]}),"\n",(0,c.jsx)(s.h2,{id:"see-also",children:"See also"}),"\n",(0,c.jsxs)(s.ul,{children:["\n",(0,c.jsx)(s.li,{children:(0,c.jsx)(s.code,{children:"services/bff/explanation/authentication.md"})}),"\n",(0,c.jsx)(s.li,{children:(0,c.jsx)(s.code,{children:"services/bff/how-to/spa-with-bff.md"})}),"\n"]})]})}function h(e={}){const{wrapper:s}={...(0,t.R)(),...e.components};return s?(0,c.jsx)(s,{...e,children:(0,c.jsx)(a,{...e})}):a(e)}}}]);