"use strict";(self.webpackChunkempowernow_docs=self.webpackChunkempowernow_docs||[]).push([[3477],{11227:(e,r,n)=>{n.r(r),n.d(r,{assets:()=>l,contentTitle:()=>i,default:()=>h,frontMatter:()=>c,metadata:()=>s,toc:()=>d});const s=JSON.parse('{"id":"services/bff/how-to/opentelemetry","title":"OpenTelemetry \u2014 Traces and Correlation","description":"What and where","source":"@site/docs/services/bff/how-to/opentelemetry.md","sourceDirName":"services/bff/how-to","slug":"/services/bff/how-to/opentelemetry","permalink":"/empowernow_docs/docs/services/bff/how-to/opentelemetry","draft":false,"unlisted":false,"editUrl":"https://github.com/facebook/docusaurus/tree/main/packages/create-docusaurus/templates/shared/docs/services/bff/how-to/opentelemetry.md","tags":[],"version":"current","frontMatter":{"title":"OpenTelemetry \u2014 Traces and Correlation"},"sidebar":"tutorialSidebar","previous":{"title":"Observability","permalink":"/empowernow_docs/docs/services/bff/how-to/observability"},"next":{"title":"Operations","permalink":"/empowernow_docs/docs/services/bff/how-to/operations"}}');var t=n(74848),o=n(28453);const c={title:"OpenTelemetry \u2014 Traces and Correlation"},i=void 0,l={},d=[];function a(e){const r={code:"code",li:"li",mermaid:"mermaid",p:"p",pre:"pre",ul:"ul",...(0,o.R)(),...e.components};return(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(r.p,{children:"What and where"}),"\n",(0,t.jsxs)(r.ul,{children:["\n",(0,t.jsxs)(r.li,{children:["Code: ",(0,t.jsx)(r.code,{children:"ms_bff_spike/ms_bff/src/observability/telemetry.py"})," (primary) and ",(0,t.jsx)(r.code,{children:"ms_bff_spike/ms_bff/src/observability.py"})," (compat path) configure OpenTelemetry exporters and auto\u2011instrumentation for FastAPI, httpx, and Redis."]}),"\n",(0,t.jsxs)(r.li,{children:["Collector: defined in ",(0,t.jsx)(r.code,{children:"CRUDService/docker-compose-authzen4.yml"})," as ",(0,t.jsx)(r.code,{children:"otel-collector"})," exposing OTLP gRPC ",(0,t.jsx)(r.code,{children:"4317"})," and OTLP HTTP ",(0,t.jsx)(r.code,{children:"4318"}),". Vector can forward traces to Jaeger."]}),"\n"]}),"\n",(0,t.jsx)(r.p,{children:"How it\u2019s configured"}),"\n",(0,t.jsxs)(r.ul,{children:["\n",(0,t.jsxs)(r.li,{children:["Enablement: ",(0,t.jsx)(r.code,{children:"TELEMETRY_ENABLED=true"})," (default) turns tracing/metrics on in the BFF when OTEL libs are present."]}),"\n",(0,t.jsxs)(r.li,{children:["Exporter endpoint (BFF picks the first that is set):","\n",(0,t.jsxs)(r.ul,{children:["\n",(0,t.jsxs)(r.li,{children:[(0,t.jsx)(r.code,{children:"OTLP_ENDPOINT"})," (preferred in ",(0,t.jsx)(r.code,{children:"telemetry.py"}),", e.g., ",(0,t.jsx)(r.code,{children:"http://otel-collector:4317"}),")"]}),"\n",(0,t.jsxs)(r.li,{children:[(0,t.jsx)(r.code,{children:"OTEL_EXPORTER_OTLP_ENDPOINT"})," (alternate, supported by ",(0,t.jsx)(r.code,{children:"observability.py"}),")"]}),"\n"]}),"\n"]}),"\n",(0,t.jsxs)(r.li,{children:["Resource attributes: ",(0,t.jsx)(r.code,{children:"service.name=bff-auth-service"}),", plus ",(0,t.jsx)(r.code,{children:"service.version"})," from ",(0,t.jsx)(r.code,{children:"BFF_VERSION"})," and ",(0,t.jsx)(r.code,{children:"deployment.environment"})," from ",(0,t.jsx)(r.code,{children:"ENVIRONMENT"}),"."]}),"\n"]}),"\n",(0,t.jsx)(r.p,{children:"Minimal setup (compose)"}),"\n",(0,t.jsx)(r.pre,{children:(0,t.jsx)(r.code,{className:"language-yaml",children:'# CRUDService/docker-compose-authzen4.yml (excerpt)\r\notel-collector:\r\n  image: otel/opentelemetry-collector-contrib:0.96.0\r\n  ports: ["4317:4317", "4318:4318"]\r\n  volumes:\r\n    - ./otel-collector-config.yaml:/etc/otelcol/config.yaml:ro\r\n\r\n# BFF service (env excerpt)\r\nenvironment:\r\n  - TELEMETRY_ENABLED=true\r\n  - OTLP_ENDPOINT=http://otel-collector:4317\r\n  - BFF_VERSION=1.0.0\r\n  - ENVIRONMENT=development\n'})}),"\n",(0,t.jsx)(r.p,{children:"What gets instrumented"}),"\n",(0,t.jsxs)(r.ul,{children:["\n",(0,t.jsxs)(r.li,{children:["FastAPI requests (",(0,t.jsx)(r.code,{children:"/auth/*"}),", ",(0,t.jsx)(r.code,{children:"/api/*"}),"), httpx client calls (IdP, PDP, backends), and Redis calls create spans automatically."]}),"\n",(0,t.jsxs)(r.li,{children:["Manual spans and metrics are available via helpers: ",(0,t.jsx)(r.code,{children:"start_span"}),", ",(0,t.jsx)(r.code,{children:"record_forwardauth_metrics"}),", ",(0,t.jsx)(r.code,{children:"record_session_metrics"}),"."]}),"\n"]}),"\n",(0,t.jsx)(r.p,{children:"Flow"}),"\n",(0,t.jsx)(r.mermaid,{value:"flowchart LR\r\n  Client--\x3eBFF\r\n  subgraph BFF\r\n    F[FastAPI + httpx + Redis\\nOTEL auto\u2011instrumented]\r\n  end\r\n  BFF--\x3e|OTLP gRPC 4317| Collector[OTel Collector]\r\n  Collector--\x3e|export| Jaeger"}),"\n",(0,t.jsx)(r.p,{children:"How to verify"}),"\n",(0,t.jsxs)(r.ul,{children:["\n",(0,t.jsxs)(r.li,{children:["Start the stack with the collector; set ",(0,t.jsx)(r.code,{children:"OTLP_ENDPOINT"})," in the BFF env."]}),"\n",(0,t.jsxs)(r.li,{children:["Hit ",(0,t.jsx)(r.code,{children:"/auth/login"})," then any ",(0,t.jsx)(r.code,{children:"/api/**"})," route; you should see spans in Jaeger."]}),"\n",(0,t.jsx)(r.li,{children:"Check logs for connection messages from telemetry setup."}),"\n"]}),"\n",(0,t.jsx)(r.p,{children:"References"}),"\n",(0,t.jsxs)(r.ul,{children:["\n",(0,t.jsx)(r.li,{children:"Reference \u2192 Observability (Metrics, Tracing, Health)"}),"\n",(0,t.jsx)(r.li,{children:"Explanation \u2192 Security Model (correlation ID propagation)"}),"\n",(0,t.jsxs)(r.li,{children:["Code: ",(0,t.jsx)(r.code,{children:"ms_bff_spike/ms_bff/src/observability/telemetry.py"}),", ",(0,t.jsx)(r.code,{children:"ms_bff_spike/ms_bff/src/observability.py"})]}),"\n"]})]})}function h(e={}){const{wrapper:r}={...(0,o.R)(),...e.components};return r?(0,t.jsx)(r,{...e,children:(0,t.jsx)(a,{...e})}):a(e)}},28453:(e,r,n)=>{n.d(r,{R:()=>c,x:()=>i});var s=n(96540);const t={},o=s.createContext(t);function c(e){const r=s.useContext(o);return s.useMemo(function(){return"function"==typeof e?e(r):{...r,...e}},[r,e])}function i(e){let r;return r=e.disableParentContext?"function"==typeof e.components?e.components(t):e.components||t:c(e.components),s.createElement(o.Provider,{value:r},e.children)}}}]);