"use strict";(self.webpackChunkempowernow_docs=self.webpackChunkempowernow_docs||[]).push([[7016],{26760:(e,n,i)=>{i.r(n),i.d(n,{assets:()=>t,contentTitle:()=>c,default:()=>h,frontMatter:()=>l,metadata:()=>s,toc:()=>o});const s=JSON.parse('{"id":"services/bff/explanation/fapi2-production-design","title":"BFF \u2014 FAPI 2.0 Production Design and Delivery Plan","description":"Summary","source":"@site/docs/services/bff/explanation/fapi2-production-design.md","sourceDirName":"services/bff/explanation","slug":"/services/bff/explanation/fapi2-production-design","permalink":"/empowernow_docs/docs/services/bff/explanation/fapi2-production-design","draft":false,"unlisted":false,"editUrl":"https://github.com/facebook/docusaurus/tree/main/packages/create-docusaurus/templates/shared/docs/services/bff/explanation/fapi2-production-design.md","tags":[{"inline":true,"label":"service:bff","permalink":"/empowernow_docs/docs/tags/service-bff"},{"inline":true,"label":"type:explanation","permalink":"/empowernow_docs/docs/tags/type-explanation"},{"inline":true,"label":"security","permalink":"/empowernow_docs/docs/tags/security"}],"version":"current","frontMatter":{"id":"fapi2-production-design","title":"BFF \u2014 FAPI 2.0 Production Design and Delivery Plan","sidebar_label":"FAPI 2.0 design & plan","tags":["service:bff","type:explanation","security"]},"sidebar":"tutorialSidebar","previous":{"title":"bff_gateway_technical","permalink":"/empowernow_docs/docs/services/bff/explanation/bff_gateway_technical"},"next":{"title":"Golden Path","permalink":"/empowernow_docs/docs/services/bff/explanation/golden-path"}}');var r=i(74848),d=i(28453);const l={id:"fapi2-production-design",title:"BFF \u2014 FAPI 2.0 Production Design and Delivery Plan",sidebar_label:"FAPI 2.0 design & plan",tags:["service:bff","type:explanation","security"]},c=void 0,t={},o=[{value:"Summary",id:"summary",level:2},{value:"Compliance matrix (profile \u2192 control)",id:"compliance-matrix-profile--control",level:2},{value:"Requirements (FAPI 2.0 \u2013 practical mapping)",id:"requirements-fapi-20--practical-mapping",level:2},{value:"Design",id:"design",level:2},{value:"1) JAR in the BFF (request objects)",id:"1-jar-in-the-bff-request-objects",level:3},{value:"2) JARM in the BFF (response_mode=jwt)",id:"2-jarm-in-the-bff-response_modejwt",level:3},{value:"3) Token endpoint and sender constraint",id:"3-token-endpoint-and-sender-constraint",level:3},{value:"4) Client registration (DCR)",id:"4-client-registration-dcr",level:3},{value:"5) Keys and storage",id:"5-keys-and-storage",level:3},{value:"6) Backward compatibility",id:"6-backward-compatibility",level:3},{value:"7) Observability/ops",id:"7-observabilityops",level:3},{value:"8) Discovery/registration capability checks",id:"8-discoveryregistration-capability-checks",level:3},{value:"9) PKCE &amp; transaction binding",id:"9-pkce--transaction-binding",level:3},{value:"10) Session &amp; cookie hygiene",id:"10-session--cookie-hygiene",level:3},{value:"11) JOSE hardening",id:"11-jose-hardening",level:3},{value:"12) Error handling &amp; redaction",id:"12-error-handling--redaction",level:3},{value:"Delivery Plan",id:"delivery-plan",level:2},{value:"Test Plan (high\u2011level)",id:"test-plan-highlevel",level:2},{value:"Risks and mitigations",id:"risks-and-mitigations",level:2},{value:"References",id:"references",level:2},{value:"Appendix A \u2014 JARM verifier checklist (pseudocode)",id:"appendix-a--jarm-verifier-checklist-pseudocode",level:2},{value:"Appendix B \u2014 Unified client\u2011auth helper (token/introspect/revoke)",id:"appendix-b--unified-clientauth-helper-tokenintrospectrevoke",level:2}];function a(e){const n={code:"code",h2:"h2",h3:"h3",hr:"hr",li:"li",p:"p",pre:"pre",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,d.R)(),...e.components};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(n.h2,{id:"summary",children:"Summary"}),"\n",(0,r.jsxs)(n.p,{children:["Goal: make the BFF a production\u2011grade FAPI 2.0 client gateway for SPAs and services. Today we support PKCE, PAR, DPoP, ",(0,r.jsx)(n.code,{children:"private_key_jwt"}),", and mTLS paths; this design adds JAR and JARM in the BFF and defines conformance, rollout, and ops."]}),"\n",(0,r.jsx)(n.p,{children:"Target profiles: Phase 1 \u2014 FAPI 2.0 Baseline; Phase 2 \u2014 Advanced (where applicable)."}),"\n",(0,r.jsxs)(n.p,{children:["Non\u2011goals: turning the BFF into an authorization server; replacing the IdP; changing SPA contracts (SPAs still call same\u2011origin ",(0,r.jsx)(n.code,{children:"/api/**"}),")."]}),"\n",(0,r.jsxs)(n.p,{children:["Assumptions: our IdP already supports PAR, JAR, and JARM; ",(0,r.jsx)(n.code,{children:"empowernow_common.oauth"})," provides JAR/JARM helpers, with JWE decryption to be completed for encrypted JARM."]}),"\n",(0,r.jsx)(n.h2,{id:"compliance-matrix-profile--control",children:"Compliance matrix (profile \u2192 control)"}),"\n",(0,r.jsxs)(n.table,{children:[(0,r.jsx)(n.thead,{children:(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.th,{children:"Requirement"}),(0,r.jsx)(n.th,{children:"Baseline"}),(0,r.jsx)(n.th,{children:"Advanced"}),(0,r.jsx)(n.th,{children:"Our control"})]})}),(0,r.jsxs)(n.tbody,{children:[(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:"PKCE S256"}),(0,r.jsx)(n.td,{children:"Required"}),(0,r.jsx)(n.td,{children:"Required"}),(0,r.jsx)(n.td,{children:"Enforced; verifier 43\u2013128, S256 only"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:"PAR"}),(0,r.jsx)(n.td,{children:"Recommended/Required"}),(0,r.jsx)(n.td,{children:"Required"}),(0,r.jsxs)(n.td,{children:["PAR\u2011first; ",(0,r.jsx)(n.code,{children:"request_uri"})," redirect"]})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:"JAR"}),(0,r.jsx)(n.td,{children:"Recommended"}),(0,r.jsx)(n.td,{children:"Required"}),(0,r.jsxs)(n.td,{children:["BFF signs ",(0,r.jsx)(n.code,{children:"request"})," (or pushes signed)"]})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:"JARM"}),(0,r.jsx)(n.td,{children:"Optional"}),(0,r.jsx)(n.td,{children:"Recommended/Required"}),(0,r.jsxs)(n.td,{children:["BFF verifies ",(0,r.jsx)(n.code,{children:"response_mode=jwt"})]})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:"Sender constraint"}),(0,r.jsx)(n.td,{children:"One of DPoP/mTLS"}),(0,r.jsx)(n.td,{children:"Often mTLS"}),(0,r.jsx)(n.td,{children:"Configurable (DPoP or mTLS)"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:"Client auth"}),(0,r.jsxs)(n.td,{children:[(0,r.jsx)(n.code,{children:"private_key_jwt"})," or mTLS"]}),(0,r.jsxs)(n.td,{children:["mTLS or ",(0,r.jsx)(n.code,{children:"private_key_jwt"})]}),(0,r.jsx)(n.td,{children:"Unified helper selects per env"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:"Discovery metadata"}),(0,r.jsx)(n.td,{children:"Required"}),(0,r.jsx)(n.td,{children:"Required"}),(0,r.jsx)(n.td,{children:"Startup capability check"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:"Error redaction"}),(0,r.jsx)(n.td,{children:"Required"}),(0,r.jsx)(n.td,{children:"Required"}),(0,r.jsx)(n.td,{children:"Structured logs; secrets redacted"})]})]})]}),"\n",(0,r.jsx)(n.h2,{id:"requirements-fapi-20--practical-mapping",children:"Requirements (FAPI 2.0 \u2013 practical mapping)"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["Authorization request hardening","\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["PKCE (S256), ",(0,r.jsx)(n.code,{children:"state"}),"/",(0,r.jsx)(n.code,{children:"nonce"}),", redirect URI binding"]}),"\n",(0,r.jsx)(n.li,{children:"PAR required (request_uri) \u2013 already present"}),"\n",(0,r.jsx)(n.li,{children:"JAR (signed request objects) \u2013 add in BFF"}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["Authorization response hardening","\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["JARM (",(0,r.jsx)(n.code,{children:"response_mode=jwt"})," variants) \u2013 add in BFF; verify/decrypt"]}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["Token endpoint","\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Sender constraint: mTLS and/or DPoP (present)"}),"\n",(0,r.jsxs)(n.li,{children:["Client auth: ",(0,r.jsx)(n.code,{children:"private_key_jwt"})," (present) and/or mTLS"]}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["Discovery/registration","\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Advertise/declare JAR/JARM capabilities in DCR payloads and client metadata"}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["Crypto/compliance","\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"FIPS paths (runtime checks documented in FIPS startup guard)"}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(n.h2,{id:"design",children:"Design"}),"\n",(0,r.jsx)(n.h3,{id:"1-jar-in-the-bff-request-objects",children:"1) JAR in the BFF (request objects)"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["In ",(0,r.jsx)(n.code,{children:"/auth/login"})," flow, build a signed JWT request object using ",(0,r.jsx)(n.code,{children:"empowernow_common.oauth.jar"}),":","\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["Payload includes ",(0,r.jsx)(n.code,{children:"client_id, redirect_uri, scope, response_type, response_mode (if JARM), state, nonce, code_challenge(S256), code_challenge_method"}),"."]}),"\n",(0,r.jsxs)(n.li,{children:["Sign with BFF client key (use ",(0,r.jsx)(n.code,{children:"BFF_JWT_SIGNING_KEY"}),"); choose alg from ",(0,r.jsx)(n.code,{children:"MS_BFF_JAR_SIGNING_ALG"}),"."]}),"\n",(0,r.jsx)(n.li,{children:"Optional encryption (config\u2011gated) if IdP mandates encrypted JAR."}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["Submit via PAR (preferred): push the signed request object, obtain ",(0,r.jsx)(n.code,{children:"request_uri"}),", redirect to IdP ",(0,r.jsx)(n.code,{children:"/authorize?client_id=...&request_uri=..."}),"."]}),"\n",(0,r.jsxs)(n.li,{children:["Fallback (config): inline ",(0,r.jsx)(n.code,{children:"request=..."})," if PAR is unavailable."]}),"\n",(0,r.jsxs)(n.li,{children:["Validation/duplication rules: IdP\u2019s claims override URL duplicates; ensure we don\u2019t pass conflicting params when using ",(0,r.jsx)(n.code,{children:"request"}),"."]}),"\n"]}),"\n",(0,r.jsx)(n.p,{children:"Policy"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["Algorithm allowlist per environment: ",(0,r.jsx)(n.code,{children:"MS_BFF_JAR_ALGS_ALLOWED=PS256,ES256"})," (avoid weak/legacy). Reject ",(0,r.jsx)(n.code,{children:"alg=none"}),"."]}),"\n",(0,r.jsxs)(n.li,{children:["Duplicate parameters: when using ",(0,r.jsx)(n.code,{children:"request"}),"/",(0,r.jsx)(n.code,{children:"request_uri"}),", omit top\u2011level duplicates or ensure exact match with the request object; otherwise fail early."]}),"\n",(0,r.jsxs)(n.li,{children:["Encrypted JAR (off by default): if enabled, pin strong ",(0,r.jsx)(n.code,{children:"alg/enc"})," suites; reject unknown ",(0,r.jsx)(n.code,{children:"crit"})," headers."]}),"\n"]}),"\n",(0,r.jsx)(n.p,{children:"Config"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.code,{children:"MS_BFF_JAR_ENABLED=true|false"})}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"MS_BFF_JAR_SIGNING_ALG=RS256|PS256|ES256"})," (per IdP policy)"]}),"\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.code,{children:"BFF_JWT_SIGNING_KEY=/app/keys/bff-sig.pem"})}),"\n",(0,r.jsxs)(n.li,{children:["Optional: ",(0,r.jsx)(n.code,{children:"MS_BFF_JAR_ENC_ALG"}),", ",(0,r.jsx)(n.code,{children:"MS_BFF_JAR_ENC_METHOD"}),", ",(0,r.jsx)(n.code,{children:"BFF_JAR_ENC_KEY=/app/keys/jar-enc.pub"})]}),"\n"]}),"\n",(0,r.jsx)(n.p,{children:"Metrics"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.code,{children:"jar_request_objects_created_total{alg}"})}),"\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.code,{children:"jar_request_push_failures_total{reason}"})}),"\n"]}),"\n",(0,r.jsx)(n.h3,{id:"2-jarm-in-the-bff-response_modejwt",children:"2) JARM in the BFF (response_mode=jwt)"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["Request path: set ",(0,r.jsx)(n.code,{children:"response_mode"})," to configured JARM mode (",(0,r.jsx)(n.code,{children:"jwt"}),", ",(0,r.jsx)(n.code,{children:"query.jwt"}),", ",(0,r.jsx)(n.code,{children:"fragment.jwt"}),", or ",(0,r.jsx)(n.code,{children:"form_post.jwt"}),")."]}),"\n",(0,r.jsxs)(n.li,{children:["Callback handler:","\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Detect JARM: presence of JWT in response (mode\u2011specific param)."}),"\n",(0,r.jsxs)(n.li,{children:["JOSE header checks: ",(0,r.jsx)(n.code,{children:"alg"})," in allowlist; ",(0,r.jsx)(n.code,{children:"kid"})," present/pinned; ",(0,r.jsx)(n.code,{children:"typ"})," matches JARM if provided (e.g., ",(0,r.jsx)(n.code,{children:"oauth-authz-resp+jwt"}),"). Reject ",(0,r.jsx)(n.code,{children:"alg=none"}),", unknown ",(0,r.jsx)(n.code,{children:"crit"}),", unvetted ",(0,r.jsx)(n.code,{children:"x5u/jku"}),"."]}),"\n",(0,r.jsxs)(n.li,{children:["Claims checks: ",(0,r.jsx)(n.code,{children:"iss"})," (equals IdP), ",(0,r.jsx)(n.code,{children:"aud == client_id"}),", ",(0,r.jsx)(n.code,{children:"exp/iat"})," with \u2264120s skew, bind ",(0,r.jsx)(n.code,{children:"state"})," to transaction, optional ",(0,r.jsx)(n.code,{children:"jti"})," replay cache (cache until ",(0,r.jsx)(n.code,{children:"exp"}),")."]}),"\n",(0,r.jsx)(n.li,{children:"Encrypted JARM (optional): decrypt JWE with client key, then verify inner JWS; reject nested/plaintext mismatches."}),"\n",(0,r.jsxs)(n.li,{children:["Extract ",(0,r.jsx)(n.code,{children:"code"}),"/",(0,r.jsx)(n.code,{children:"error"})," and continue; structured logging for decisions."]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(n.p,{children:"Config"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.code,{children:"MS_BFF_JARM_ENABLED=true|false"})}),"\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.code,{children:"MS_BFF_JARM_MODE=jwt|query.jwt|fragment.jwt|form_post.jwt"})}),"\n",(0,r.jsxs)(n.li,{children:["Optional JWE:","\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.code,{children:"MS_BFF_JARM_ENC_ALG=RSA-OAEP-256|ECDH-ES|..."})}),"\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.code,{children:"MS_BFF_JARM_ENC_ENC=A256GCM|A256CBC-HS512|..."})}),"\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.code,{children:"BFF_JARM_PRIV_KEY=/app/keys/bff-jarm-key.pem"})}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(n.p,{children:"Metrics"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.code,{children:"jarm_responses_verified_total{mode}"})}),"\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.code,{children:"jarm_decryption_failures_total{alg}"})}),"\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.code,{children:"jarm_validation_failures_total{reason}"})}),"\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.code,{children:"jarm_replay_denied_total"})}),"\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.code,{children:"jarm_typ_invalid_total"})}),"\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.code,{children:"jarm_aud_mismatch_total"})}),"\n"]}),"\n",(0,r.jsx)(n.h3,{id:"3-token-endpoint-and-sender-constraint",children:"3) Token endpoint and sender constraint"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Choose a primary sender\u2011constraint per client (DPoP or mTLS) and document exclusivity; test token binding end\u2011to\u2011end."}),"\n",(0,r.jsxs)(n.li,{children:["DPoP specifics: verify ",(0,r.jsx)(n.code,{children:"typ=dpop+jwt"}),", ",(0,r.jsx)(n.code,{children:"htu/htm"}),", ",(0,r.jsx)(n.code,{children:"jti"})," uniqueness (short\u2011lived cache), nonce challenge (401 + ",(0,r.jsx)(n.code,{children:"DPoP-Nonce"}),") with retry."]}),"\n",(0,r.jsxs)(n.li,{children:["Keep ",(0,r.jsx)(n.code,{children:"private_key_jwt"})," as default client\u2011auth in prod; allow ",(0,r.jsx)(n.code,{children:"client_secret_post"})," only in non\u2011prod."]}),"\n",(0,r.jsxs)(n.li,{children:["Use the same client\u2011auth selection helper for token, introspection, and revocation; tag metrics with ",(0,r.jsx)(n.code,{children:"{auth_method}"}),"."]}),"\n",(0,r.jsx)(n.li,{children:"Ensure PKCE S256 enforced always; bind JARM state/nonce to token exchange for audit correlation."}),"\n"]}),"\n",(0,r.jsx)(n.h3,{id:"4-client-registration-dcr",children:"4) Client registration (DCR)"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["Extend DCR payload for the BFF client to declare:","\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"request_object_signing_alg"})," (JAR)"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"require_signed_request_object"})," (per environment policy)"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"response_modes_supported"})," incl. JARM modes"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"authorization_encryption_alg/enc"})," if encrypted JARM used"]}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(n.li,{children:"Ensure rotation/replace flows update client metadata."}),"\n"]}),"\n",(0,r.jsx)(n.h3,{id:"5-keys-and-storage",children:"5) Keys and storage"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["Store signing/decryption keys in mounted secrets (",(0,r.jsx)(n.code,{children:"/app/keys"}),"), rotated via SOP."]}),"\n",(0,r.jsx)(n.li,{children:"JWKS exposure (client) if needed by IdP; or out\u2011of\u2011band key distribution."}),"\n",(0,r.jsx)(n.li,{children:"FIPS startup guard applies."}),"\n",(0,r.jsxs)(n.li,{children:["Pre\u2011rotation: publish new ",(0,r.jsx)(n.code,{children:"kid"})," before switching signer; cache JWKS with TTL and background refresh."]}),"\n"]}),"\n",(0,r.jsx)(n.h3,{id:"6-backward-compatibility",children:"6) Backward compatibility"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["Default: ",(0,r.jsx)(n.code,{children:"MS_BFF_JAR_ENABLED=false"}),", ",(0,r.jsx)(n.code,{children:"MS_BFF_JARM_ENABLED=false"})," \u2192 current PAR+PKCE flow unchanged."]}),"\n",(0,r.jsx)(n.li,{children:"Feature flags per environment; canary SPAs first."}),"\n"]}),"\n",(0,r.jsx)(n.h3,{id:"7-observabilityops",children:"7) Observability/ops"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"New Prometheus counters/gauges and structured logs around JAR build, JARM verify/decrypt, failure reasons, and IdP JWKS rotation issues."}),"\n",(0,r.jsxs)(n.li,{children:["Add gauges for JWKS cache age and background refresh outcomes; metrics: ",(0,r.jsx)(n.code,{children:"jwks_refresh_failures_total"}),"."]}),"\n",(0,r.jsx)(n.li,{children:"Runbooks: key rotation, JWKS fetch failure, decrypt failures, fallback behavior, and kill\u2011switch flags to disable JAR/JARM quickly."}),"\n"]}),"\n",(0,r.jsx)(n.h3,{id:"8-discoveryregistration-capability-checks",children:"8) Discovery/registration capability checks"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["On startup, fetch IdP discovery and validate presence of:","\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.code,{children:"pushed_authorization_request_endpoint"})}),"\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.code,{children:"request_object_signing_alg_values_supported"})}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"response_modes_supported"})," (including JARM variants)"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"authorization_signing_alg_values_supported"}),", optionally ",(0,r.jsx)(n.code,{children:"_encryption_*"})]}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(n.li,{children:"Fail fast if required capabilities are missing for enabled flags (config\u2011gate in non\u2011prod)."}),"\n"]}),"\n",(0,r.jsx)(n.h3,{id:"9-pkce--transaction-binding",children:"9) PKCE & transaction binding"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Enforce verifier length 43\u2013128; method S256 only."}),"\n",(0,r.jsxs)(n.li,{children:["Persist and bind ",(0,r.jsx)(n.code,{children:"state"}),", ",(0,r.jsx)(n.code,{children:"nonce"}),", PKCE verifier, and optional JARM ",(0,r.jsx)(n.code,{children:"jti"})," to one transaction/session record."]}),"\n"]}),"\n",(0,r.jsx)(n.h3,{id:"10-session--cookie-hygiene",children:"10) Session & cookie hygiene"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["Cookies: ",(0,r.jsx)(n.code,{children:"HttpOnly"}),", ",(0,r.jsx)(n.code,{children:"Secure"}),", ",(0,r.jsx)(n.code,{children:"SameSite=Lax"})," (or ",(0,r.jsx)(n.code,{children:"Strict"})," as policy); short path scope; rotate session ID at login."]}),"\n",(0,r.jsxs)(n.li,{children:["CSRF: require token for state\u2011changing BFF APIs, or enforce ",(0,r.jsx)(n.code,{children:"SameSite=Strict"})," + double\u2011submit."]}),"\n"]}),"\n",(0,r.jsx)(n.h3,{id:"11-jose-hardening",children:"11) JOSE hardening"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["Reject ",(0,r.jsx)(n.code,{children:"alg=none"}),", unknown ",(0,r.jsx)(n.code,{children:"alg"}),", unknown ",(0,r.jsx)(n.code,{children:"crit"}),", and untrusted ",(0,r.jsx)(n.code,{children:"x5u/jku"}),"."]}),"\n",(0,r.jsxs)(n.li,{children:["JWKS: cache with ",(0,r.jsx)(n.code,{children:"{kid}"})," pinning and background refresh; handle rollover via pre\u2011fetch."]}),"\n"]}),"\n",(0,r.jsx)(n.h3,{id:"12-error-handling--redaction",children:"12) Error handling & redaction"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["Never log request bodies when using ",(0,r.jsx)(n.code,{children:"client_secret_post"}),"."]}),"\n",(0,r.jsx)(n.li,{children:"Redact tokens/secrets consistently; log correlation IDs and decision points only."}),"\n"]}),"\n",(0,r.jsx)(n.h2,{id:"delivery-plan",children:"Delivery Plan"}),"\n",(0,r.jsx)(n.p,{children:"Milestone 0 \u2014 Prereqs"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Discovery capability check wired to flags; CI gate reads IdP metadata and fails when required capability is missing for enabled features."}),"\n",(0,r.jsx)(n.li,{children:"Generate the compliance matrix artifact per environment."}),"\n"]}),"\n",(0,r.jsx)(n.p,{children:"Milestone 1 \u2014 JAR (signed request objects)"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["Implement request\u2011object builder integration in ",(0,r.jsx)(n.code,{children:"/auth/login"}),"."]}),"\n",(0,r.jsx)(n.li,{children:"Add config, metrics, logs, and unit/integration tests."}),"\n",(0,r.jsxs)(n.li,{children:["Verify with IdP in PAR + JAR mode.","\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["Negative test: top\u2011level params differ from ",(0,r.jsx)(n.code,{children:"request"})," \u2192 expect rejection, or ensure we omit duplicates."]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(n.p,{children:"Milestone 2 \u2014 JARM (signed responses)"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Implement callback parsing, signature verification against IdP JWKS, claim validation."}),"\n",(0,r.jsxs)(n.li,{children:["Add config/metrics/logs and tests for ",(0,r.jsx)(n.code,{children:"jwt"}),", ",(0,r.jsx)(n.code,{children:"query.jwt"}),", ",(0,r.jsx)(n.code,{children:"fragment.jwt"}),", ",(0,r.jsx)(n.code,{children:"form_post.jwt"}),".","\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Add replay tests (reuse same JARM JWT), clock\u2011skew tests, and aud/state binding tests."}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(n.p,{children:"Milestone 3 \u2014 Encrypted JARM (JWE)"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["Complete JWE decrypt path in ",(0,r.jsx)(n.code,{children:"empowernow_common"})," (if not already complete) and integrate in BFF."]}),"\n",(0,r.jsxs)(n.li,{children:["Keys management and rotation SOP.","\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["Pin ",(0,r.jsx)(n.code,{children:"alg/enc"}),"; tests for wrong key/alg; verify inner JWS after decrypt."]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(n.p,{children:"Milestone 4 \u2014 Conformance & hardening"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Run OpenID FAPI 2.0 conformance tests (Baseline + Advanced where applicable)."}),"\n",(0,r.jsx)(n.li,{children:"Capture results and publish doc; fix gaps."}),"\n",(0,r.jsx)(n.li,{children:"Add rate\u2011limit/CSP refinements if flagged by tests."}),"\n"]}),"\n",(0,r.jsx)(n.p,{children:"Milestone 5 \u2014 Rollout"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Staged enablement via flags per environment and per application."}),"\n",(0,r.jsxs)(n.li,{children:["Production readiness checklist (keys, DCR metadata, JWKS cache/refresh, dashboards, alerts).","\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"SLOs: <0.1% JARM validation failures, zero replays, no increase in token errors; canary + kill switch."}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(n.h2,{id:"test-plan-highlevel",children:"Test Plan (high\u2011level)"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Unit tests: JAR builder (claims, algs), JARM processor (sig/claims, mode variants, error cases)."}),"\n",(0,r.jsx)(n.li,{children:"Integration: end\u2011to\u2011end auth with IdP for each JARM mode; PAR + signed request."}),"\n",(0,r.jsxs)(n.li,{children:["Negative: expired/iat/skew, mismatched ",(0,r.jsx)(n.code,{children:"iss/aud"}),", replayed JWT, invalid ",(0,r.jsx)(n.code,{children:"state/nonce"}),", JWE wrong key."]}),"\n",(0,r.jsx)(n.li,{children:"Performance: added overhead \u2264 few ms; measure callback verification cost."}),"\n"]}),"\n",(0,r.jsx)(n.h2,{id:"risks-and-mitigations",children:"Risks and mitigations"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"JWE decryption gaps in SDK \u2192 start with signed\u2011only JARM; schedule JWE completion."}),"\n",(0,r.jsx)(n.li,{children:"Key management complexity \u2192 standardize on vault/secret mounts; rotate via SOP."}),"\n",(0,r.jsx)(n.li,{children:"Interop variance across IdPs \u2192 provide per\u2011IdP presets (Okta/Auth0/Ping/Curity)."}),"\n"]}),"\n",(0,r.jsx)(n.h2,{id:"references",children:"References"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["IdP JAR/JARM support (authorize/discovery), SDK ",(0,r.jsx)(n.code,{children:"oauth/jar.py"}),", ",(0,r.jsx)(n.code,{children:"oauth/jarm.py"}),"."]}),"\n",(0,r.jsxs)(n.li,{children:["BFF FAPI features status: ",(0,r.jsx)(n.code,{children:"Reference / FAPI 2.0 Features"}),"."]}),"\n"]}),"\n",(0,r.jsx)(n.hr,{}),"\n",(0,r.jsx)(n.h2,{id:"appendix-a--jarm-verifier-checklist-pseudocode",children:"Appendix A \u2014 JARM verifier checklist (pseudocode)"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-python",children:'def verify_jarm(jwt_token: str, client_id: str, jwks_cache: JwksCache) -> Claims:\r\n    header = peek_header(jwt_token)\r\n    assert header.alg in ALLOWLIST_ALGS\r\n    assert header.kid and jwks_cache.has_kid(header.kid)\r\n    if header.typ:\r\n        assert header.typ in {"oauth-authz-resp+jwt", "JWT"}\r\n\r\n    claims = verify_signature_and_decode(jwt_token, jwks_cache)\r\n    now = now_utc()\r\n    assert claims.iss == IDP_ISSUER\r\n    assert claims.aud == client_id\r\n    assert abs(claims.iat - now) <= 120\r\n    assert claims.exp >= now\r\n    assert claims.state == load_bound_state()\r\n\r\n    if claims.jti and replay_cache.contains(claims.jti):\r\n        metrics.jarm_replay_denied_total.inc()\r\n        raise ReplayError()\r\n    replay_cache.store(claims.jti, ttl=claims.exp - now)\r\n    return claims\n'})}),"\n",(0,r.jsx)(n.h2,{id:"appendix-b--unified-clientauth-helper-tokenintrospectrevoke",children:"Appendix B \u2014 Unified client\u2011auth helper (token/introspect/revoke)"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-python",children:'def get_client_auth(config: Env) -> ClientAuth:\r\n    method = config.MS_BFF_TOKEN_AUTH_METHOD  # private_key_jwt|client_secret_post|mtls\r\n    if method == "private_key_jwt":\r\n        return PrivateKeyJwt(key_path=config.BFF_JWT_SIGNING_KEY, alg=config.BFF_JWT_SIGNING_ALG)\r\n    if method == "client_secret_post":\r\n        return ClientSecretPost()\r\n    if method == "mtls":\r\n        return Mtls(cert=config.MTLS_CERT, key=config.MTLS_KEY)\r\n    raise ValueError("Unsupported client auth method")\n'})})]})}function h(e={}){const{wrapper:n}={...(0,d.R)(),...e.components};return n?(0,r.jsx)(n,{...e,children:(0,r.jsx)(a,{...e})}):a(e)}},28453:(e,n,i)=>{i.d(n,{R:()=>l,x:()=>c});var s=i(96540);const r={},d=s.createContext(r);function l(e){const n=s.useContext(d);return s.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function c(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(r):e.components||r:l(e.components),s.createElement(d.Provider,{value:n},e.children)}}}]);