"use strict";(self.webpackChunkempowernow_docs=self.webpackChunkempowernow_docs||[]).push([[2362],{28453:(e,n,s)=>{s.d(n,{R:()=>l,x:()=>d});var r=s(96540);const i={},c=r.createContext(i);function l(e){const n=r.useContext(c);return r.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function d(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(i):e.components||i:l(e.components),r.createElement(c.Provider,{value:n},e.children)}},50815:(e,n,s)=>{s.r(n),s.d(n,{assets:()=>o,contentTitle:()=>d,default:()=>h,frontMatter:()=>l,metadata:()=>r,toc:()=>a});const r=JSON.parse('{"id":"services/crud-service/how-to/secrets-usage-guide","title":"Secrets usage guide \u2014 YAML, OpenBao/HashiCorp, Canonical URIs","description":"Practical, end\u2011to\u2011end guide for using Canonical Secret URIs across YAML (dev) and OpenBao/HashiCorp KVv2 (prod) with app config pointers and REST API examples.","source":"@site/docs/services/crud-service/how-to/secrets-usage-guide.md","sourceDirName":"services/crud-service/how-to","slug":"/services/crud-service/how-to/secrets-usage-guide","permalink":"/empowernow_docs/docs/services/crud-service/how-to/secrets-usage-guide","draft":false,"unlisted":false,"editUrl":"https://github.com/facebook/docusaurus/tree/main/packages/create-docusaurus/templates/shared/docs/services/crud-service/how-to/secrets-usage-guide.md","tags":[],"version":"current","frontMatter":{"title":"Secrets usage guide \u2014 YAML, OpenBao/HashiCorp, Canonical URIs","description":"Practical, end\u2011to\u2011end guide for using Canonical Secret URIs across YAML (dev) and OpenBao/HashiCorp KVv2 (prod) with app config pointers and REST API examples."}}');var i=s(74848),c=s(28453);const l={title:"Secrets usage guide \u2014 YAML, OpenBao/HashiCorp, Canonical URIs",description:"Practical, end\u2011to\u2011end guide for using Canonical Secret URIs across YAML (dev) and OpenBao/HashiCorp KVv2 (prod) with app config pointers and REST API examples."},d=void 0,o={},a=[{value:"TL;DR",id:"tldr",level:2},{value:"Canonical Secret URIs",id:"canonical-secret-uris",level:2},{value:"Providers",id:"providers",level:2},{value:"YAML Vault (dev\u2011only)",id:"yaml-vault-devonly",level:3},{value:"OpenBao / HashiCorp (KVv2)",id:"openbao--hashicorp-kvv2",level:3},{value:"Application configuration pointers",id:"application-configuration-pointers",level:2},{value:"Managing secrets via REST API",id:"managing-secrets-via-rest-api",level:2},{value:"Bootstrapping dev secrets",id:"bootstrapping-dev-secrets",level:2},{value:"Security model highlights",id:"security-model-highlights",level:2},{value:"Troubleshooting",id:"troubleshooting",level:2}];function t(e){const n={code:"code",h2:"h2",h3:"h3",hr:"hr",li:"li",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,c.R)(),...e.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(n.h2,{id:"tldr",children:"TL;DR"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["Use Canonical URIs everywhere (YAML in dev, OpenBao/HashiCorp in prod):","\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["YAML (dev\u2011only): ",(0,i.jsx)(n.code,{children:"yaml://secret/<path>#<key>"})]}),"\n",(0,i.jsxs)(n.li,{children:["OpenBao/HashiCorp KVv2: ",(0,i.jsx)(n.code,{children:"openbao+kv2://<mount>/<path>#<key>"})," or ",(0,i.jsx)(n.code,{children:"hashicorp+kv2://..."})]}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["App config pointers: set ",(0,i.jsx)(n.code,{children:"CREDENTIAL_ENCRYPTION_KEY_POINTER"})," to the Canonical URI."]}),"\n",(0,i.jsxs)(n.li,{children:["API management: ",(0,i.jsx)(n.code,{children:"/api/secrets"})," for create/read/delete/rotate. YAML is dev\u2011only; KVv2 supported when enabled."]}),"\n",(0,i.jsxs)(n.li,{children:["Tenant guard: set ",(0,i.jsx)(n.code,{children:"TENANT_ID"})," and ",(0,i.jsx)(n.code,{children:"TENANT_ALLOWED_MOUNTS"})," (e.g., ",(0,i.jsx)(n.code,{children:"secret"}),")."]}),"\n"]}),"\n",(0,i.jsx)(n.hr,{}),"\n",(0,i.jsx)(n.h2,{id:"canonical-secret-uris",children:"Canonical Secret URIs"}),"\n",(0,i.jsxs)(n.p,{children:["Format: ",(0,i.jsx)(n.code,{children:"[provider][+engine]://<mount>/<path>#<fragment>?key1=value1&key2=value2"})]}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"provider"}),": ",(0,i.jsx)(n.code,{children:"yaml"}),", ",(0,i.jsx)(n.code,{children:"openbao"}),", ",(0,i.jsx)(n.code,{children:"hashicorp"})]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"engine"}),": ",(0,i.jsx)(n.code,{children:"kv2"})," (for OpenBao/HashiCorp KVv2). Omit for YAML."]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"mount"}),": first path segment (e.g., ",(0,i.jsx)(n.code,{children:"secret"}),")."]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"path"}),": remaining segments (case\u2011sensitive); no empty segments."]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"fragment"}),": the map key within the secret object (e.g., ",(0,i.jsx)(n.code,{children:"#password"}),")."]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"params"}),": optional query params. For KVv2, supports ",(0,i.jsx)(n.code,{children:"version=<n>"})," on reads."]}),"\n"]}),"\n",(0,i.jsxs)(n.p,{children:["Normalization and validation (enforced by ",(0,i.jsx)(n.code,{children:"SecretURI"}),"):"]}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["Lowercase ",(0,i.jsx)(n.code,{children:"provider"})," and ",(0,i.jsx)(n.code,{children:"engine"}),"."]}),"\n",(0,i.jsxs)(n.li,{children:["Reject invalid forms: empty segments, duplicate slashes, ",(0,i.jsx)(n.code,{children:".."}),", percent\u2011encoded slashes, mid\u2011path ",(0,i.jsx)(n.code,{children:"*"}),"."]}),"\n",(0,i.jsxs)(n.li,{children:["Require explicit mount; no authority (no ",(0,i.jsx)(n.code,{children:"//host"}),")."]}),"\n",(0,i.jsx)(n.li,{children:"Query keys must be unique and sorted when normalized."}),"\n"]}),"\n",(0,i.jsx)(n.p,{children:"Examples:"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["YAML dev: ",(0,i.jsx)(n.code,{children:"yaml://secret/crud#CREDENTIAL_ENCRYPTION_KEY"})]}),"\n",(0,i.jsxs)(n.li,{children:["OpenBao KVv2 latest: ",(0,i.jsx)(n.code,{children:"openbao+kv2://secret/app/test#value"})]}),"\n",(0,i.jsxs)(n.li,{children:["HashiCorp KVv2 pinned version: ",(0,i.jsx)(n.code,{children:"hashicorp+kv2://secret/payments/stripe#api_key?version=12"})]}),"\n"]}),"\n",(0,i.jsx)(n.p,{children:"Provider path mapping:"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"YAML: file tree under top\u2011level key = mount. Path segments traverse nested dicts; fragment is the final key."}),"\n",(0,i.jsxs)(n.li,{children:["KVv2: provider path is ",(0,i.jsx)(n.code,{children:"<mount>/<path>"}),". The returned map contains keys (e.g., ",(0,i.jsx)(n.code,{children:'{ value: "..." }'}),"); fragment picks a key from that map."]}),"\n"]}),"\n",(0,i.jsx)(n.hr,{}),"\n",(0,i.jsx)(n.h2,{id:"providers",children:"Providers"}),"\n",(0,i.jsx)(n.h3,{id:"yaml-vault-devonly",children:"YAML Vault (dev\u2011only)"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["File path: set ",(0,i.jsx)(n.code,{children:"YAML_VAULT_PATH"})," (e.g., ",(0,i.jsx)(n.code,{children:"/app/config/data/dev_secrets.yaml"}),")."]}),"\n",(0,i.jsx)(n.li,{children:"Structure:"}),"\n"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-yaml",children:"secret:\r\n  crud:\r\n    CREDENTIAL_ENCRYPTION_KEY: test-key-123\n"})}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["Canonical example: ",(0,i.jsx)(n.code,{children:"yaml://secret/crud#CREDENTIAL_ENCRYPTION_KEY"})]}),"\n",(0,i.jsx)(n.li,{children:"Notes: Writes are disabled outside dev/test environments."}),"\n"]}),"\n",(0,i.jsx)(n.h3,{id:"openbao--hashicorp-kvv2",children:"OpenBao / HashiCorp (KVv2)"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["Minimal env (URL+token):","\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:(0,i.jsx)(n.code,{children:"VAULT_URL=http://openbao:8200"})}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"VAULT_TOKEN=root"})," (or AppRole via ROLE_ID/SECRET_ID)"]}),"\n",(0,i.jsxs)(n.li,{children:["optional: ",(0,i.jsx)(n.code,{children:"VAULT_TIMEOUT"}),", ",(0,i.jsx)(n.code,{children:"VAULT_VERIFY_SSL"}),", ",(0,i.jsx)(n.code,{children:"VAULT_POOL_SIZE"}),", ",(0,i.jsx)(n.code,{children:"VAULT_TOKEN_RENEWAL_THRESHOLD"}),", ",(0,i.jsx)(n.code,{children:"VAULT_MAX_CONCURRENT_OPERATIONS"})]}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["Canonical example: ",(0,i.jsx)(n.code,{children:"openbao+kv2://secret/crud#CREDENTIAL_ENCRYPTION_KEY"})]}),"\n",(0,i.jsxs)(n.li,{children:["Versioned reads: ",(0,i.jsx)(n.code,{children:"openbao+kv2://secret/app/test#value?version=2"})]}),"\n",(0,i.jsxs)(n.li,{children:["Delete vs destroy:","\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"Soft delete latest: provider records a deleted version (recoverable until destroyed)"}),"\n",(0,i.jsx)(n.li,{children:"Destroy all versions: permanent removal of metadata and data"}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,i.jsx)(n.hr,{}),"\n",(0,i.jsx)(n.h2,{id:"application-configuration-pointers",children:"Application configuration pointers"}),"\n",(0,i.jsx)(n.p,{children:"Compose \u2014 YAML pointer"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-yaml",children:"environment:\r\n  - CREDENTIAL_ENCRYPTION_KEY_POINTER=yaml://secret/crud#CREDENTIAL_ENCRYPTION_KEY\r\n  - YAML_VAULT_PATH=/app/config/data/dev_secrets.yaml\r\n  - TENANT_ID=dev\r\n  - TENANT_ALLOWED_MOUNTS=secret\n"})}),"\n",(0,i.jsx)(n.p,{children:"Compose \u2014 OpenBao pointer"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-yaml",children:"environment:\r\n  - CREDENTIAL_ENCRYPTION_KEY_POINTER=openbao+kv2://secret/crud#CREDENTIAL_ENCRYPTION_KEY\r\n  - VAULT_URL=http://openbao:8200\r\n  - VAULT_TOKEN=root\r\n  - TENANT_ID=dev\r\n  - TENANT_ALLOWED_MOUNTS=secret\n"})}),"\n",(0,i.jsx)(n.p,{children:"Notes:"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["The application resolves the pointer at startup via ",(0,i.jsx)(n.code,{children:"VaultService"})," (PEP). The plaintext is not exported as an environment variable."]}),"\n",(0,i.jsxs)(n.li,{children:["Tenant guard enforces allowed mounts based on ",(0,i.jsx)(n.code,{children:"TENANT_ALLOWED_MOUNTS"}),"."]}),"\n"]}),"\n",(0,i.jsx)(n.hr,{}),"\n",(0,i.jsx)(n.h2,{id:"managing-secrets-via-rest-api",children:"Managing secrets via REST API"}),"\n",(0,i.jsxs)(n.p,{children:["Base router: ",(0,i.jsx)(n.code,{children:"/api/secrets"})]}),"\n",(0,i.jsx)(n.p,{children:"Security toggles (safe defaults off for dev):"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"SECRETS_API_REQUIRE_AUTH=true"})," to require auth"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"SECRETS_ENFORCE_SCOPES=true"})," to enforce scopes (",(0,i.jsx)(n.code,{children:"secrets.read"}),", ",(0,i.jsx)(n.code,{children:"secrets.write"}),", ",(0,i.jsx)(n.code,{children:"secrets.delete"}),", ",(0,i.jsx)(n.code,{children:"secrets.destroy"}),", ",(0,i.jsx)(n.code,{children:"secrets.rotate"}),", ",(0,i.jsx)(n.code,{children:"secrets.read_metadata"}),")"]}),"\n",(0,i.jsx)(n.li,{children:"PDP purposes enforced: write/delete/rotate/read_metadata"}),"\n"]}),"\n",(0,i.jsx)(n.p,{children:"Endpoints:"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"Create/Update (YAML, OpenBao/HashiCorp KVv2)"}),"\n"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:'POST /api/secrets\r\n{\r\n  "uri": "openbao+kv2://secret/app/test#value",\r\n  "value": { "value": "hello-live" }\r\n}\n'})}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["Read (YAML via ",(0,i.jsx)(n.code,{children:"/api/secrets"}),", all providers via VaultService callers)"]}),"\n"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:"GET /api/secrets?uri=yaml://secret/crud#CREDENTIAL_ENCRYPTION_KEY\n"})}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"Delete / Destroy (KVv2 supported in providers; YAML deletes file entries)"}),"\n"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:"DELETE /api/secrets?uri=openbao+kv2://secret/app/test#value          # soft\r\nDELETE /api/secrets?uri=openbao+kv2://secret/app/test#value&destroy=true  # hard\n"})}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"Rotate (KVv2 and YAML)"}),"\n"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:'POST /api/secrets/rotate\r\n{\r\n  "uri": "openbao+kv2://secret/app/test#value",\r\n  "value": { "value": "new" }\r\n}\n'})}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"Metadata and keys listing (YAML only \u2013 dev tooling)"}),"\n"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:"GET /api/secrets/metadata?prefix=yaml://secret/crud/\r\nGET /api/secrets/keys?uri=yaml://secret/crud\n"})}),"\n",(0,i.jsx)(n.p,{children:"Provider payload expectations:"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["KVv2: if a fragment is given, the body should map that fragment to a value (e.g., ",(0,i.jsx)(n.code,{children:'{ "value": "hello" }'}),"). Without a fragment, body must be a map of keys."]}),"\n",(0,i.jsx)(n.li,{children:"YAML: mirrors nested mappings in the YAML file."}),"\n"]}),"\n",(0,i.jsx)(n.hr,{}),"\n",(0,i.jsx)(n.h2,{id:"bootstrapping-dev-secrets",children:"Bootstrapping dev secrets"}),"\n",(0,i.jsx)(n.p,{children:"YAML bootstrap script (dev\u2011only)"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:'python scripts/yaml_dev_bootstrap.py --out /app/config/data/dev_secrets.yaml --mount secret --prefix crud --include "CREDENTIAL_ENCRYPTION_KEY"\n'})}),"\n",(0,i.jsxs)(n.p,{children:["Manifest for multiple ",(0,i.jsx)(n.code,{children:".env"})," sources: ",(0,i.jsx)(n.code,{children:"scripts/bootstrap_manifest.yaml"})]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:"python scripts/yaml_dev_bootstrap.py --manifest scripts/bootstrap_manifest.yaml --out /app/config/data/dev_secrets.yaml --mount secret --clear\n"})}),"\n",(0,i.jsx)(n.p,{children:"OpenBao quick seed (dev mode, root token)"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:'curl -H "X-Vault-Token: root" \\\r\n     -H "Content-Type: application/json" \\\r\n     -X POST http://localhost:8200/v1/secret/data/crud \\\r\n     -d \'{"data": {"CREDENTIAL_ENCRYPTION_KEY": "test-bao-key-123"}}\'\n'})}),"\n",(0,i.jsx)(n.hr,{}),"\n",(0,i.jsx)(n.h2,{id:"security-model-highlights",children:"Security model highlights"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["PEP at ",(0,i.jsx)(n.code,{children:"VaultService"})," authorizes every use (grant w/ TTL/max\u2011uses; sender\u2011binding via DPoP/mTLS where available; JTI anti\u2011replay)."]}),"\n",(0,i.jsxs)(n.li,{children:["Audits include non\u2011leaky ",(0,i.jsx)(n.code,{children:"resource_ref"})," (HMAC of Canonical URI), provider metadata, and decision details."]}),"\n",(0,i.jsx)(n.li,{children:"Response wrapping support exists for providers; unwrap happens in PEP."}),"\n",(0,i.jsx)(n.li,{children:"YAML writes are blocked outside dev/test."}),"\n"]}),"\n",(0,i.jsx)(n.h2,{id:"troubleshooting",children:"Troubleshooting"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"501 on writes: older build or provider not enabled; redeploy with updated secrets routes."}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"Unsupported provider/engine"}),": check provider and ",(0,i.jsx)(n.code,{children:"+kv2"})," in Canonical URI."]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"SECRET_AUTHZ_FAILED"}),": PDP policy or audience/binding/jti conditions not met."]}),"\n",(0,i.jsxs)(n.li,{children:["Ensure ",(0,i.jsx)(n.code,{children:"TENANT_ALLOWED_MOUNTS"})," includes the mount (e.g., ",(0,i.jsx)(n.code,{children:"secret"}),")."]}),"\n"]})]})}function h(e={}){const{wrapper:n}={...(0,c.R)(),...e.components};return n?(0,i.jsx)(n,{...e,children:(0,i.jsx)(t,{...e})}):t(e)}}}]);