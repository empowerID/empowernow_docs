"use strict";(self.webpackChunkempowernow_docs=self.webpackChunkempowernow_docs||[]).push([[4367],{19762:(e,n,s)=>{s.r(n),s.d(n,{assets:()=>t,contentTitle:()=>l,default:()=>h,frontMatter:()=>d,metadata:()=>r,toc:()=>o});const r=JSON.parse('{"id":"services/bff/reference/logging-events","title":"Logging, Events, and Publishers","description":"This page documents what the BFF logs and where it sends events, based on the current code.","source":"@site/docs/services/bff/reference/logging-events.md","sourceDirName":"services/bff/reference","slug":"/services/bff/reference/logging-events","permalink":"/empowernow_docs/docs/services/bff/reference/logging-events","draft":false,"unlisted":false,"editUrl":"https://github.com/facebook/docusaurus/tree/main/packages/create-docusaurus/templates/shared/docs/services/bff/reference/logging-events.md","tags":[],"version":"current","frontMatter":{"title":"Logging, Events, and Publishers"},"sidebar":"tutorialSidebar","previous":{"title":"LLM Routing PDP Reference","permalink":"/empowernow_docs/docs/services/bff/reference/llm-routing-pdp"},"next":{"title":"logging.yaml Reference","permalink":"/empowernow_docs/docs/services/bff/reference/logging-reference"}}');var i=s(74848),c=s(28453);const d={title:"Logging, Events, and Publishers"},l=void 0,t={},o=[];function a(e){const n={code:"code",li:"li",mermaid:"mermaid",ol:"ol",p:"p",pre:"pre",ul:"ul",...(0,c.R)(),...e.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(n.p,{children:"This page documents what the BFF logs and where it sends events, based on the current code."}),"\n",(0,i.jsx)(n.p,{children:"Kafka producers (two layers)"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsxs)(n.p,{children:["Platform producer wrapper (",(0,i.jsx)(n.code,{children:"ms_bff_spike/ms_bff/src/core/kafka_producer.py"}),")"]}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["Publishes structured events via a shared platform utility (",(0,i.jsx)(n.code,{children:"publish_structured"}),")"]}),"\n",(0,i.jsxs)(n.li,{children:["Topic names used:","\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:(0,i.jsx)(n.code,{children:"empowernow.bff.audit"})}),"\n",(0,i.jsx)(n.li,{children:(0,i.jsx)(n.code,{children:"empowernow.bff.auth"})}),"\n",(0,i.jsx)(n.li,{children:(0,i.jsx)(n.code,{children:"empowernow.bff.sessions"})}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["Helper functions (async):","\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:(0,i.jsx)(n.code,{children:"publish_audit_event(event_type, payload)"})}),"\n",(0,i.jsx)(n.li,{children:(0,i.jsx)(n.code,{children:"publish_auth_event(event_type, request_context)"})}),"\n",(0,i.jsx)(n.li,{children:(0,i.jsx)(n.code,{children:"publish_session_event(event_type, session_context)"})}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["Expected context keys are visible in the helpers (e.g., ",(0,i.jsx)(n.code,{children:"user_id"}),", ",(0,i.jsx)(n.code,{children:"session_id"}),", ",(0,i.jsx)(n.code,{children:"correlation_id"}),")."]}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsxs)(n.p,{children:["Application producer (",(0,i.jsx)(n.code,{children:"ms_bff_spike/ms_bff/src/services/kafka_producer.py"}),")"]}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["Uses ",(0,i.jsx)(n.code,{children:"aiokafka.AIOKafkaProducer"})]}),"\n",(0,i.jsxs)(n.li,{children:["Standard topics (prefixed):","\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"events"})," \u2192 ",(0,i.jsx)(n.code,{children:"<prefix>.events"})]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"requests"})," \u2192 ",(0,i.jsx)(n.code,{children:"<prefix>.requests"})]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"errors"})," \u2192 ",(0,i.jsx)(n.code,{children:"<prefix>.errors"})]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"metrics"})," \u2192 ",(0,i.jsx)(n.code,{children:"<prefix>.metrics"})]}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["Event envelope (from ",(0,i.jsx)(n.code,{children:"publish_event"}),"):","\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"event_id"})," (uuid)"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"event_type"})," (string)"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"timestamp"})," (ISO-8601, UTC)"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"correlation_id"})," (uuid)"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"service"})," = ",(0,i.jsx)(n.code,{children:"ms-bff"})]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"data"})," (payload)"]}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["API events (",(0,i.jsx)(n.code,{children:"publish_api_event"}),"): method, path, status_code, elapsed_ms, optional ",(0,i.jsx)(n.code,{children:"user_id"}),"; sent to ",(0,i.jsx)(n.code,{children:"requests"})," topic; partition key defaults to ",(0,i.jsx)(n.code,{children:"path"}),"."]}),"\n",(0,i.jsxs)(n.li,{children:["Error events (",(0,i.jsx)(n.code,{children:"publish_error"}),"): type, message, source, optional details; sent to ",(0,i.jsx)(n.code,{children:"errors"})," topic; partition key ",(0,i.jsx)(n.code,{children:"<source>:<error_type>"}),"."]}),"\n",(0,i.jsxs)(n.li,{children:["Metrics (",(0,i.jsx)(n.code,{children:"publish_metrics"}),"): ",(0,i.jsx)(n.code,{children:"metric_type"}),", ",(0,i.jsx)(n.code,{children:"values"}),"; sent to ",(0,i.jsx)(n.code,{children:"metrics"})," topic; partition key ",(0,i.jsx)(n.code,{children:"metric_type"}),"."]}),"\n",(0,i.jsxs)(n.li,{children:["JSON serializer: handles ",(0,i.jsx)(n.code,{children:"datetime"})," (UTC ISO), ",(0,i.jsx)(n.code,{children:"Enum"}),", ",(0,i.jsx)(n.code,{children:"UUID"}),", sets, pydantic models, and circular references."]}),"\n",(0,i.jsxs)(n.li,{children:["Lifecycle: ",(0,i.jsx)(n.code,{children:"init_kafka_producer(...)"})," creates a singleton; ",(0,i.jsx)(n.code,{children:"start()"})," must be called to connect; ",(0,i.jsx)(n.code,{children:"stop()"})," closes the producer."]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,i.jsx)(n.p,{children:"CAEP publisher (Redis queue)"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["Module: ",(0,i.jsx)(n.code,{children:"ms_bff_spike/ms_bff/src/shared_signals/publisher.py"})]}),"\n",(0,i.jsxs)(n.li,{children:["Queue: Redis list ",(0,i.jsx)(n.code,{children:"caep:outbound"})]}),"\n",(0,i.jsxs)(n.li,{children:["Functions enqueue CAEP events (async):","\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"send_session_created(user_id, session_id)"})," \u2192 event type ",(0,i.jsx)(n.code,{children:".../session-created"})]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"send_session_terminated(user_id, session_id, everywhere=False)"})," \u2192 ",(0,i.jsx)(n.code,{children:".../session-terminated"})]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"send_token_rotated(user_id, session_id)"})," \u2192 ",(0,i.jsx)(n.code,{children:".../token-claims-change"})]}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["Payload format:","\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["If ",(0,i.jsx)(n.code,{children:"CAEP_SIGNING_KEY"})," is set: a signed JWT is produced with claims ",(0,i.jsx)(n.code,{children:"{ iss: BFF_BASE_URL, iat, jti, events: { <type>: payload } }"})," (alg RS256, header ",(0,i.jsx)(n.code,{children:"kid"})," from ",(0,i.jsx)(n.code,{children:"CAEP_KID"}),", default ",(0,i.jsx)(n.code,{children:"bff-caep"}),")."]}),"\n",(0,i.jsxs)(n.li,{children:["Otherwise: JSON object ",(0,i.jsx)(n.code,{children:"{ event_type, payload, ts }"}),"."]}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["Metrics: Prometheus counter ",(0,i.jsx)(n.code,{children:"caep_enqueued_total{event_type=...}"})," increments per enqueued event."]}),"\n"]}),"\n",(0,i.jsx)(n.p,{children:"Configuration (relevant keys)"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["Kafka (see ",(0,i.jsx)(n.code,{children:"settings.yaml"})," and environment):","\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"kafka.bootstrap_servers"}),", ",(0,i.jsx)(n.code,{children:"kafka.client_id"}),", ",(0,i.jsx)(n.code,{children:"kafka.topic_prefix"}),", ",(0,i.jsx)(n.code,{children:"kafka.acks"}),", ",(0,i.jsx)(n.code,{children:"kafka.compression_type"}),", ",(0,i.jsx)(n.code,{children:"kafka.enabled"})]}),"\n",(0,i.jsxs)(n.li,{children:["Environment examples: ",(0,i.jsx)(n.code,{children:"KAFKA_BOOTSTRAP_SERVERS"}),", ",(0,i.jsx)(n.code,{children:"KAFKA_CLIENT_ID"}),", ",(0,i.jsx)(n.code,{children:"KAFKA_TOPIC_PREFIX"}),", ",(0,i.jsx)(n.code,{children:"KAFKA_ACKS"}),", ",(0,i.jsx)(n.code,{children:"KAFKA_COMPRESSION_TYPE"})]}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["CAEP:","\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"CAEP_SIGNING_KEY"})," (PEM/JWK), ",(0,i.jsx)(n.code,{children:"CAEP_KID"})," (default ",(0,i.jsx)(n.code,{children:"bff-caep"}),"), ",(0,i.jsx)(n.code,{children:"BFF_BASE_URL"})," for ",(0,i.jsx)(n.code,{children:"iss"})]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,i.jsx)(n.p,{children:"Operational notes"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["Start/stop: the application startup should call ",(0,i.jsx)(n.code,{children:"init_kafka_producer(...)"})," and then ",(0,i.jsx)(n.code,{children:"start()"}),"; shutdown path calls ",(0,i.jsx)(n.code,{children:"stop()"}),"."]}),"\n",(0,i.jsxs)(n.li,{children:["Partitioning: API events use path as key; errors use ",(0,i.jsx)(n.code,{children:"<source>:<type>"}),"; metrics use metric type \u2014 this keeps related data co\u2011located."]}),"\n",(0,i.jsxs)(n.li,{children:["Backpressure: Producer uses ",(0,i.jsx)(n.code,{children:"send_and_wait"})," (awaits broker ACKs per ",(0,i.jsx)(n.code,{children:"acks"}),")."]}),"\n"]}),"\n",(0,i.jsx)(n.mermaid,{value:"flowchart LR\r\n  subgraph BFF\r\n    A[Request handling]\r\n    K[KafkaProducer]\r\n    P[CAEP Publisher]\r\n  end\r\n  subgraph Kafka\r\n    T1[(<prefix>.events)]\r\n    T2[(<prefix>.requests)]\r\n    T3[(<prefix>.errors)]\r\n    T4[(<prefix>.metrics)]\r\n  end\r\n  subgraph Redis\r\n    Q[(caep:outbound)]\r\n  end\r\n  A --\x3e|audit/auth/session ctx| K\r\n  K --\x3e T1\r\n  A --\x3e|api metrics/errors| K\r\n  K --\x3e T2 & T3 & T4\r\n  A --\x3e|session events| P\r\n  P --\x3e Q"}),"\n",(0,i.jsx)(n.p,{children:"Example payloads"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["Generic event envelope (Kafka ",(0,i.jsx)(n.code,{children:"<prefix>.events"}),"):"]}),"\n"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-json",children:'{\r\n  "event_id": "5a3b9e2e-2d7e-4d7f-9a6a-0a1e9e5b2d17",\r\n  "event_type": "session_created",\r\n  "timestamp": "2025-08-10T22:01:02.345Z",\r\n  "correlation_id": "c46e5bb1-9c3a-4a3a-9c8a-0e5b8c2f1a77",\r\n  "service": "ms-bff",\r\n  "data": {\r\n    "user_id": "user@example.com",\r\n    "session_id": "abc123def",\r\n    "ip": "203.0.113.10"\r\n  }\r\n}\n'})}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["API request event (",(0,i.jsx)(n.code,{children:"<prefix>.requests"}),"):"]}),"\n"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-json",children:'{\r\n  "event_id": "e2f0b4c3-2fd2-4c9e-9a9d-1a2b3c4d5e6f",\r\n  "event_type": "api_request",\r\n  "timestamp": "2025-08-10T22:02:10.100Z",\r\n  "correlation_id": "a2d4e6f8-10ab-42cd-9ef0-112233445566",\r\n  "service": "ms-bff",\r\n  "data": {\r\n    "method": "GET",\r\n    "path": "/api/crud/workflows",\r\n    "status_code": 200,\r\n    "elapsed_ms": 42.7,\r\n    "user_id": "user@example.com"\r\n  }\r\n}\n'})}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["Error event (",(0,i.jsx)(n.code,{children:"<prefix>.errors"}),"):"]}),"\n"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-json",children:'{\r\n  "event_id": "1f2e3d4c-5b6a-7081-92a3-b4c5d6e7f809",\r\n  "event_type": "error",\r\n  "timestamp": "2025-08-10T22:03:55.000Z",\r\n  "correlation_id": "c0ffee00-1234-4abc-9def-777777777777",\r\n  "service": "ms-bff",\r\n  "data": {\r\n    "error_type": "UpstreamTimeout",\r\n    "message": "crud_service: /workflows timed out",\r\n    "source": "proxy",\r\n    "timestamp": "2025-08-10T22:03:55.000Z",\r\n    "details": {\r\n      "target_service": "crud_service",\r\n      "path": "/workflows",\r\n      "timeout_ms": 5000\r\n    }\r\n  }\r\n}\n'})}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["Metrics event (",(0,i.jsx)(n.code,{children:"<prefix>.metrics"}),"):"]}),"\n"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-json",children:'{\r\n  "event_id": "0b1c2d3e-4f50-6172-8394-a5b6c7d8e9f0",\r\n  "event_type": "metrics",\r\n  "timestamp": "2025-08-10T22:04:20.000Z",\r\n  "correlation_id": "f00ba4-55aa-46d2-b9f1-1122aa33bb44",\r\n  "service": "ms-bff",\r\n  "data": {\r\n    "metric_type": "auth_flow",\r\n    "timestamp": "2025-08-10T22:04:20.000Z",\r\n    "values": {\r\n      "oauth_flow_duration_ms": 820,\r\n      "token_refresh_success": 1\r\n    }\r\n  }\r\n}\n'})}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["Platform audit/auth/session events (topic ",(0,i.jsx)(n.code,{children:"empowernow.bff.*"}),"): payloads are app\u2011defined JSON; typical fields include ",(0,i.jsx)(n.code,{children:"user_id"}),", ",(0,i.jsx)(n.code,{children:"session_id"}),", ",(0,i.jsx)(n.code,{children:"correlation_id"}),", and event\u2011specific data. Example audit:"]}),"\n"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-json",children:'{\r\n  "event": "bff_startup",\r\n  "version": "1.0.0",\r\n  "node": "bff-0",\r\n  "correlation_id": "b0a1a2a3-a4a5-46b7-88c9-d0e1f2a3b4c5"\r\n}\n'})}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["CAEP message enqueued to Redis (",(0,i.jsx)(n.code,{children:"caep:outbound"}),") when unsigned mode is used:"]}),"\n"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-json",children:'{\r\n  "event_type": "https://schemas.openid.net/secevent/caep/event-type/session-created",\r\n  "payload": {"sub": "user@example.com", "sid": "abc123def"},\r\n  "ts": 1723332000\r\n}\n'})}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"CAEP signed JWT (header + claims structure):"}),"\n"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-json",children:'{\r\n  "header": {"alg": "RS256", "kid": "bff-caep"},\r\n  "claims": {\r\n    "iss": "https://api.ocg.labs.empowernow.ai",\r\n    "iat": 1723332000,\r\n    "jti": "session-created:abc123def:1723332000",\r\n    "events": {\r\n      "https://schemas.openid.net/secevent/caep/event-type/session-created": {\r\n        "sub": "user@example.com",\r\n        "sid": "abc123def"\r\n      }\r\n    }\r\n  }\r\n}\n'})}),"\n",(0,i.jsx)(n.p,{children:"How to test locally"}),"\n",(0,i.jsxs)(n.ol,{children:["\n",(0,i.jsxs)(n.li,{children:["Ensure Kafka is up (see compose stack) and set ",(0,i.jsx)(n.code,{children:"KAFKA_BOOTSTRAP_SERVERS"})," and ",(0,i.jsx)(n.code,{children:"KAFKA_TOPIC_PREFIX"}),"."]}),"\n",(0,i.jsxs)(n.li,{children:["On app startup, initialize and start the producer; call an API route to generate a ",(0,i.jsx)(n.code,{children:"requests"})," event and inspect the topic with your Kafka UI."]}),"\n",(0,i.jsxs)(n.li,{children:["For CAEP, set ",(0,i.jsx)(n.code,{children:"CAEP_SIGNING_KEY"})," (PEM) to emit signed JWTs, or omit to send JSON to the Redis list ",(0,i.jsx)(n.code,{children:"caep:outbound"}),"."]}),"\n"]})]})}function h(e={}){const{wrapper:n}={...(0,c.R)(),...e.components};return n?(0,i.jsx)(n,{...e,children:(0,i.jsx)(a,{...e})}):a(e)}},28453:(e,n,s)=>{s.d(n,{R:()=>d,x:()=>l});var r=s(96540);const i={},c=r.createContext(i);function d(e){const n=r.useContext(c);return r.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function l(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(i):e.components||i:d(e.components),r.createElement(c.Provider,{value:n},e.children)}}}]);