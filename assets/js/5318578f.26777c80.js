"use strict";(self.webpackChunkempowernow_docs=self.webpackChunkempowernow_docs||[]).push([[2694],{28453:(e,n,s)=>{s.d(n,{R:()=>c,x:()=>o});var r=s(96540);const i={},t=r.createContext(i);function c(e){const n=r.useContext(t);return r.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function o(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(i):e.components||i:c(e.components),r.createElement(t.Provider,{value:n},e.children)}},97648:(e,n,s)=>{s.r(n),s.d(n,{assets:()=>d,contentTitle:()=>o,default:()=>h,frontMatter:()=>c,metadata:()=>r,toc:()=>l});const r=JSON.parse('{"id":"services/bff/how-to/secret-rotation","title":"Rotate IdP Client Secrets and JWKS","description":"What this covers","source":"@site/docs/services/bff/how-to/secret-rotation.md","sourceDirName":"services/bff/how-to","slug":"/services/bff/how-to/secret-rotation","permalink":"/empowernow_docs/docs/services/bff/how-to/secret-rotation","draft":false,"unlisted":false,"editUrl":"https://github.com/facebook/docusaurus/tree/main/packages/create-docusaurus/templates/shared/docs/services/bff/how-to/secret-rotation.md","tags":[],"version":"current","frontMatter":{"title":"Rotate IdP Client Secrets and JWKS"},"sidebar":"tutorialSidebar","previous":{"title":"Admin Runbooks","permalink":"/empowernow_docs/docs/services/bff/how-to/runbooks"},"next":{"title":"Secure IdP admin proxy","permalink":"/empowernow_docs/docs/services/bff/how-to/secure-idp-admin-proxy"}}');var i=s(74848),t=s(28453);const c={title:"Rotate IdP Client Secrets and JWKS"},o=void 0,d={},l=[];function a(e){const n={code:"code",li:"li",ol:"ol",p:"p",pre:"pre",ul:"ul",...(0,t.R)(),...e.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(n.p,{children:"What this covers"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"IdP client credentials used by the BFF (client_id/client_secret for token and introspection calls)"}),"\n",(0,i.jsx)(n.li,{children:"BFF signing key and JWKS for private_key_jwt (if used)"}),"\n",(0,i.jsxs)(n.li,{children:["Other BFF secrets: ",(0,i.jsx)(n.code,{children:"TOKEN_HASH_SALT"}),", ",(0,i.jsx)(n.code,{children:"UA_HASH_SALT"}),", ",(0,i.jsx)(n.code,{children:"CSRF_SECRET_KEY"}),", ",(0,i.jsx)(n.code,{children:"STATE_TOKEN_KEY"})]}),"\n"]}),"\n",(0,i.jsx)(n.p,{children:"Where secrets live (compose default)"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["Docker secrets under ",(0,i.jsx)(n.code,{children:"/run/secrets"})," (see ",(0,i.jsx)(n.code,{children:"CRUDService/docker-compose-authzen4.yml"}),") and env vars for non-secrets."]}),"\n",(0,i.jsxs)(n.li,{children:["BFF reads:","\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"AUTH_CLIENT_ID"}),", ",(0,i.jsx)(n.code,{children:"AUTH_CLIENT_SECRET"})," for IdP calls"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"TOKEN_HASH_SALT"})," (required at startup) and ",(0,i.jsx)(n.code,{children:"UA_HASH_SALT"})]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"CSRF_SECRET_KEY"}),", ",(0,i.jsx)(n.code,{children:"STATE_TOKEN_KEY"})]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"BFF_JWT_SIGNING_KEY"})," or key material in ",(0,i.jsx)(n.code,{children:"BFF_KEYS_DIR"})," for JWKS"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,i.jsx)(n.p,{children:"Rotate IdP client secrets"}),"\n",(0,i.jsxs)(n.ol,{children:["\n",(0,i.jsxs)(n.li,{children:["Create a new secret material in your secrets store and update your compose/K8s secrets:","\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["Docker secret ",(0,i.jsx)(n.code,{children:"oidc-client-secret"})," or env ",(0,i.jsx)(n.code,{children:"AUTH_CLIENT_SECRET"})]}),"\n"]}),"\n"]}),"\n",(0,i.jsx)(n.li,{children:"Deploy the BFF with both old and new credentials valid at the IdP."}),"\n",(0,i.jsx)(n.li,{children:"Verify bearer introspection and code\u2011flow token exchange still succeed."}),"\n"]}),"\n",(0,i.jsx)(n.p,{children:"Rotate BFF signing key (JWKS)"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["Code paths: ",(0,i.jsx)(n.code,{children:"ms_bff_spike/ms_bff/src/routes/jwks.py"}),", ",(0,i.jsx)(n.code,{children:"ms_bff_spike/ms_bff/src/crypto/jwks_manager.py"}),", ",(0,i.jsx)(n.code,{children:"ms_bff_spike/ms_bff/scripts/rotate_keys.py"}),"."]}),"\n",(0,i.jsxs)(n.li,{children:["By default, the BFF ensures a key exists under ",(0,i.jsx)(n.code,{children:"BFF_KEYS_DIR"})," and serves JWKS at ",(0,i.jsx)(n.code,{children:"/.well-known/jwks.json"}),"."]}),"\n",(0,i.jsxs)(n.li,{children:["Recommended: configure the IdP client to use ",(0,i.jsx)(n.code,{children:"jwks_uri: https://<your-bff-host>/.well-known/jwks.json"})," so the IdP fetches keys automatically."]}),"\n"]}),"\n",(0,i.jsx)(n.p,{children:"Manual rotation procedure"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:"# In the BFF container or sidecar with the same volume mount\r\nexport BFF_KEYS_DIR=/app/keys\r\nexport AUTO_KEY_ROTATION=1\r\npython -m ms_bff.scripts.rotate_keys\r\n\r\n# In most setups no DCR call is required when using jwks_uri; the IdP will fetch new keys.\r\n# If your IdP does not poll jwks_uri, consult IdP docs for a cache-bust endpoint.\n"})}),"\n",(0,i.jsx)(n.p,{children:"Zero\u2011downtime tips"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"Serve both old and new keys in JWKS during the grace window (jwks_manager preserves previous entries when you write the new JWKS)."}),"\n",(0,i.jsx)(n.li,{children:"Keep old client credentials valid at IdP until all pods/instances are rolled."}),"\n",(0,i.jsxs)(n.li,{children:["Stagger restarts; validate ",(0,i.jsx)(n.code,{children:"/auth/login"}),", ",(0,i.jsx)(n.code,{children:"/auth/callback"}),", and bearer calls."]}),"\n"]}),"\n",(0,i.jsx)(n.p,{children:"FAQ"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["Why not rotate ",(0,i.jsx)(n.code,{children:"client_secret"})," automatically?","\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["Shared secrets are weaker and harder to distribute/rotate safely. Prefer ",(0,i.jsx)(n.code,{children:"private_key_jwt"})," with ",(0,i.jsx)(n.code,{children:"jwks_uri"})," so rotation is done by updating JWKS."]}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["Can I update ",(0,i.jsx)(n.code,{children:"client_secret"})," via DCR PATCH?","\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"Not via the public endpoint in our IdP. Use an admin/out-of-band update if absolutely necessary."}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,i.jsx)(n.p,{children:"Rotate salts and CSRF/state secrets"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"TOKEN_HASH_SALT"}),": restart required; BFF refuses startup if missing. Rotate during a maintenance window."]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"UA_HASH_SALT"}),": safe to rotate with restart; affects analytics hashing only."]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"CSRF_SECRET_KEY"}),": rotate with coordinated SPA downtime as existing CSRF tokens will be invalidated."]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"STATE_TOKEN_KEY"}),": rotate with caution; affects in\u2011flight login state."]}),"\n"]}),"\n",(0,i.jsx)(n.p,{children:"Verification checklist"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["After rotation, test:","\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["SPA login/callback flow and subsequent ",(0,i.jsx)(n.code,{children:"/api/**"})," calls (session)"]}),"\n",(0,i.jsxs)(n.li,{children:["Bearer flow to an ",(0,i.jsx)(n.code,{children:"auth: bearer"})," route (introspection)"]}),"\n",(0,i.jsx)(n.li,{children:"JWKS endpoint responds and IdP accepts private_key_jwt if enabled"}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,i.jsx)(n.p,{children:"References"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"How\u2011to \u2192 Configure IdPs (idps.yaml)"}),"\n",(0,i.jsx)(n.li,{children:"How\u2011to \u2192 Configure PDP (pdp.yaml)"}),"\n",(0,i.jsx)(n.li,{children:"Reference \u2192 Observability (monitor auth errors during rotation)"}),"\n"]})]})}function h(e={}){const{wrapper:n}={...(0,t.R)(),...e.components};return n?(0,i.jsx)(n,{...e,children:(0,i.jsx)(a,{...e})}):a(e)}}}]);