"use strict";(self.webpackChunkempowernow_docs=self.webpackChunkempowernow_docs||[]).push([[6636],{9539:(e,s,r)=>{r.r(s),r.d(s,{assets:()=>l,contentTitle:()=>c,default:()=>h,frontMatter:()=>o,metadata:()=>n,toc:()=>d});const n=JSON.parse('{"id":"services/bff/how-to/register-bff-private-key-jwt","title":"Register BFF with private_key_jwt (via DCR)","description":"Goal: Register/update the bff-server client using the code-flow-pkjwt profile with JWKS and exact redirect URIs.","source":"@site/docs/services/bff/how-to/register-bff-private-key-jwt.md","sourceDirName":"services/bff/how-to","slug":"/services/bff/how-to/register-bff-private-key-jwt","permalink":"/empowernow_docs/docs/services/bff/how-to/register-bff-private-key-jwt","draft":false,"unlisted":false,"editUrl":"https://github.com/facebook/docusaurus/tree/main/packages/create-docusaurus/templates/shared/docs/services/bff/how-to/register-bff-private-key-jwt.md","tags":[],"version":"current","frontMatter":{"id":"register-bff-private-key-jwt","title":"Register BFF with private_key_jwt (via DCR)","sidebar_label":"Register BFF (PKJWT)"},"sidebar":"tutorialSidebar","previous":{"title":"Enable Redis TLS for Sessions","permalink":"/empowernow_docs/docs/services/bff/how-to/redis-tls"},"next":{"title":"Run EmpowerID workflow","permalink":"/empowernow_docs/docs/services/bff/how-to/run-empowerid-workflow"}}');var i=r(74848),t=r(28453);const o={id:"register-bff-private-key-jwt",title:"Register BFF with private_key_jwt (via DCR)",sidebar_label:"Register BFF (PKJWT)"},c=void 0,l={},d=[{value:"Prereqs",id:"prereqs",level:2},{value:"Steps",id:"steps",level:2},{value:"Troubleshooting",id:"troubleshooting",level:2}];function a(e){const s={code:"code",h2:"h2",li:"li",ol:"ol",p:"p",pre:"pre",ul:"ul",...(0,t.R)(),...e.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsxs)(s.p,{children:["Goal: Register/update the ",(0,i.jsx)(s.code,{children:"bff-server"})," client using the ",(0,i.jsx)(s.code,{children:"code-flow-pkjwt"})," profile with JWKS and exact redirect URIs."]}),"\n",(0,i.jsx)(s.p,{children:"Short answer"}),"\n",(0,i.jsxs)(s.ul,{children:["\n",(0,i.jsxs)(s.li,{children:["One-time DCR with a fresh IAT; then remove ",(0,i.jsx)(s.code,{children:"DCR_IAT"})," going forward."]}),"\n",(0,i.jsxs)(s.li,{children:[(0,i.jsx)(s.code,{children:"token_endpoint_auth_method: private_key_jwt"})," with ",(0,i.jsx)(s.code,{children:"jwks_uri"})," pointing at the BFF JWKS endpoint: ",(0,i.jsx)(s.code,{children:"https://<your-bff-host>/.well-known/jwks.json"}),"."]}),"\n",(0,i.jsx)(s.li,{children:"Let the BFF handle access-token auto-refresh; no extra config."}),"\n",(0,i.jsx)(s.li,{children:"For ongoing key rotation, update the BFF JWKS; no need to re-DCR."}),"\n"]}),"\n",(0,i.jsx)(s.h2,{id:"prereqs",children:"Prereqs"}),"\n",(0,i.jsxs)(s.ul,{children:["\n",(0,i.jsxs)(s.li,{children:["IdP ",(0,i.jsx)(s.code,{children:"policy.allowed_scopes"})," covers BFF scopes (edit ",(0,i.jsx)(s.code,{children:"ServiceConfigs/IdP/config/dcr_config.yaml"}),")"]}),"\n",(0,i.jsxs)(s.li,{children:["BFF PEM available in the ",(0,i.jsx)(s.code,{children:"bff-keys"})," volume"]}),"\n",(0,i.jsxs)(s.li,{children:["DCR Initial Access Token (see ",(0,i.jsx)(s.code,{children:"services/crud-service/how-to/bff-startup-dcr-iat"}),")"]}),"\n"]}),"\n",(0,i.jsx)(s.h2,{id:"steps",children:"Steps"}),"\n",(0,i.jsxs)(s.ol,{children:["\n",(0,i.jsxs)(s.li,{children:["Ensure IdP policy contains required scopes and ",(0,i.jsx)(s.code,{children:"client_profiles.code-flow-pkjwt"})," is enabled; restart IdP"]}),"\n",(0,i.jsxs)(s.li,{children:["Set BFF env in ",(0,i.jsx)(s.code,{children:"CRUDService/docker-compose-authzen4.yml"})," (service: bff):"]}),"\n"]}),"\n",(0,i.jsx)(s.pre,{children:(0,i.jsx)(s.code,{className:"language-yaml",children:'environment:\r\n  AUTH_CLIENT_ID: bff-server\r\n  MS_BFF_TOKEN_AUTH_METHOD: "private_key_jwt"\r\n  BFF_JWT_SIGNING_KEY: /app/keys/fapi-adv-key-1.pem\r\n\r\n  DCR_IAT: "<paste iat>"\r\n  DCR_CLIENT_ID: bff-server\r\n  DCR_CLIENT_PROFILE: code-flow-pkjwt\r\n  DCR_SIGNING_KEY: /app/keys/fapi-adv-key-1.pem\r\n  DCR_REDIRECT_URIS: https://automate.ocg.labs.empowernow.ai/auth/callback,https://authn.ocg.labs.empowernow.ai/auth/callback,https://authz.ocg.labs.empowernow.ai/auth/callback\r\n  DCR_FORCE_REPLACE: "true"\r\n  # Optional but recommended: explicitly set the client\'s jwks_uri to BFF JWKS\r\n  # If your IdP supports jwks_uri in DCR payloads, it should be\r\n  # https://<your-bff-host>/.well-known/jwks.json\n'})}),"\n",(0,i.jsxs)(s.ol,{start:"3",children:["\n",(0,i.jsxs)(s.li,{children:["Restart BFF and watch logs for ",(0,i.jsx)(s.code,{children:"201 Created"})," and \u201cClient registered: bff-server\u201d"]}),"\n",(0,i.jsxs)(s.li,{children:["Verify ",(0,i.jsx)(s.code,{children:"ServiceConfigs/IdP/config/clients.yaml"})," has:","\n",(0,i.jsxs)(s.ul,{children:["\n",(0,i.jsx)(s.li,{children:(0,i.jsx)(s.code,{children:"client_id: bff-server"})}),"\n",(0,i.jsx)(s.li,{children:(0,i.jsx)(s.code,{children:"token_endpoint_auth_method: private_key_jwt"})}),"\n",(0,i.jsxs)(s.li,{children:["Either ",(0,i.jsx)(s.code,{children:"jwks_uri: https://<your-bff-host>/.well-known/jwks.json"})," or inline ",(0,i.jsx)(s.code,{children:"jwks.keys"})," with a ",(0,i.jsx)(s.code,{children:"kid"})," matching your PEM"]}),"\n",(0,i.jsxs)(s.li,{children:[(0,i.jsx)(s.code,{children:"redirect_uris:"})," entries for each host with ",(0,i.jsx)(s.code,{children:"/auth/callback"})]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,i.jsx)(s.h2,{id:"troubleshooting",children:"Troubleshooting"}),"\n",(0,i.jsxs)(s.ul,{children:["\n",(0,i.jsxs)(s.li,{children:[(0,i.jsx)(s.code,{children:"invalid_scope"}),": add scope to ",(0,i.jsx)(s.code,{children:"policy.allowed_scopes"}),"; restart IdP"]}),"\n",(0,i.jsxs)(s.li,{children:[(0,i.jsx)(s.code,{children:"invalid_redirect_uri"}),": fix host/path; re\u2011DCR with ",(0,i.jsx)(s.code,{children:"DCR_FORCE_REPLACE=true"})]}),"\n",(0,i.jsxs)(s.li,{children:[(0,i.jsx)(s.code,{children:"invalid_client"})," (jwt-bearer): align method and PEM/JWKS; ensure key pair matches"]}),"\n"]}),"\n",(0,i.jsx)(s.p,{children:"After success"}),"\n",(0,i.jsxs)(s.ul,{children:["\n",(0,i.jsxs)(s.li,{children:["Remove ",(0,i.jsx)(s.code,{children:"DCR_IAT"})," from the BFF environment. Keep DCR enabled; startup becomes a no-op unless metadata changes."]}),"\n"]}),"\n",(0,i.jsxs)(s.p,{children:["See also: ",(0,i.jsx)(s.code,{children:"services/bff/reference/bff-idp-oauth-e2e"})," and ",(0,i.jsx)(s.code,{children:"services/bff/how-to/switch-auth-methods"}),"."]})]})}function h(e={}){const{wrapper:s}={...(0,t.R)(),...e.components};return s?(0,i.jsx)(s,{...e,children:(0,i.jsx)(a,{...e})}):a(e)}},28453:(e,s,r)=>{r.d(s,{R:()=>o,x:()=>c});var n=r(96540);const i={},t=n.createContext(i);function o(e){const s=n.useContext(t);return n.useMemo(function(){return"function"==typeof e?e(s):{...s,...e}},[s,e])}function c(e){let s;return s=e.disableParentContext?"function"==typeof e.components?e.components(i):e.components||i:o(e.components),n.createElement(t.Provider,{value:s},e.children)}}}]);