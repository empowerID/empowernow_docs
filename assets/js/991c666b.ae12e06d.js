"use strict";(self.webpackChunkempowernow_docs=self.webpackChunkempowernow_docs||[]).push([[3597],{28453:(e,s,n)=>{n.d(s,{R:()=>l,x:()=>o});var r=n(96540);const i={},c=r.createContext(i);function l(e){const s=r.useContext(c);return r.useMemo(function(){return"function"==typeof e?e(s):{...s,...e}},[s,e])}function o(e){let s;return s=e.disableParentContext?"function"==typeof e.components?e.components(i):e.components||i:l(e.components),r.createElement(c.Provider,{value:s},e.children)}},87836:(e,s,n)=>{n.r(s),n.d(s,{assets:()=>d,contentTitle:()=>o,default:()=>a,frontMatter:()=>l,metadata:()=>r,toc:()=>t});const r=JSON.parse('{"id":"services/bff/how-to/compose-local","title":"Docker Compose (authzen4)","description":"This summarizes the verified BFF-related settings from CRUDService/docker-compose-authzen4.yml for local/dev stacks.","source":"@site/docs/services/bff/how-to/compose-local.md","sourceDirName":"services/bff/how-to","slug":"/services/bff/how-to/compose-local","permalink":"/empowernow_docs/docs/services/bff/how-to/compose-local","draft":false,"unlisted":false,"editUrl":"https://github.com/facebook/docusaurus/tree/main/packages/create-docusaurus/templates/shared/docs/services/bff/how-to/compose-local.md","tags":[],"version":"current","frontMatter":{"title":"Docker Compose (authzen4)"},"sidebar":"tutorialSidebar","previous":{"title":"Call EmpowerID WebUI","permalink":"/empowernow_docs/docs/services/bff/how-to/call-empowerid-webui"},"next":{"title":"Config Change SOP \u2014 Source of Truth and Promotion","permalink":"/empowernow_docs/docs/services/bff/how-to/config-sop"}}');var i=n(74848),c=n(28453);const l={title:"Docker Compose (authzen4)"},o=void 0,d={},t=[{value:"Top services used by BFF",id:"top-services-used-by-bff",level:2},{value:"Traefik routers (labels on bff)",id:"traefik-routers-labels-on-bff",level:2},{value:"ForwardAuth in Compose",id:"forwardauth-in-compose",level:2},{value:"BFF environment (selected)",id:"bff-environment-selected",level:2},{value:"Other services commonly present",id:"other-services-commonly-present",level:2},{value:"Request flow (compose stack)",id:"request-flow-compose-stack",level:2},{value:"Bring-up checklist",id:"bring-up-checklist",level:2}];function h(e){const s={code:"code",h2:"h2",li:"li",mermaid:"mermaid",p:"p",ul:"ul",...(0,c.R)(),...e.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsxs)(s.p,{children:["This summarizes the verified BFF-related settings from ",(0,i.jsx)(s.code,{children:"CRUDService/docker-compose-authzen4.yml"})," for local/dev stacks."]}),"\n",(0,i.jsx)(s.h2,{id:"top-services-used-by-bff",children:"Top services used by BFF"}),"\n",(0,i.jsxs)(s.ul,{children:["\n",(0,i.jsxs)(s.li,{children:["Traefik (reverse proxy)","\n",(0,i.jsxs)(s.ul,{children:["\n",(0,i.jsxs)(s.li,{children:["image: ",(0,i.jsx)(s.code,{children:"traefik:v3.4.3"})]}),"\n",(0,i.jsx)(s.li,{children:"ports: 80, 443, 8080 (dashboard)"}),"\n",(0,i.jsxs)(s.li,{children:["volumes: ",(0,i.jsx)(s.code,{children:"./traefik/traefik.yml"}),", ",(0,i.jsx)(s.code,{children:"./traefik/dynamic.yml"})]}),"\n",(0,i.jsxs)(s.li,{children:["labels: dashboard router protected by ",(0,i.jsx)(s.code,{children:"bff-forwardauth@file"})]}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(s.li,{children:["shared_redis (session store)","\n",(0,i.jsxs)(s.ul,{children:["\n",(0,i.jsxs)(s.li,{children:["image: ",(0,i.jsx)(s.code,{children:"redis:7-alpine"})]}),"\n",(0,i.jsxs)(s.li,{children:["healthcheck: ",(0,i.jsx)(s.code,{children:"redis-cli ping"})]}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(s.li,{children:["bff (Backend for Frontend)","\n",(0,i.jsxs)(s.ul,{children:["\n",(0,i.jsxs)(s.li,{children:["build: ",(0,i.jsx)(s.code,{children:"ms_bff_spike/ms_bff/Dockerfile"})," (target ",(0,i.jsx)(s.code,{children:"runtime"}),")"]}),"\n",(0,i.jsxs)(s.li,{children:["ports: ",(0,i.jsx)(s.code,{children:"8000:8000"})]}),"\n",(0,i.jsxs)(s.li,{children:["env_file: ",(0,i.jsx)(s.code,{children:"../ms_bff_spike/.env"})]}),"\n",(0,i.jsxs)(s.li,{children:["volumes: ",(0,i.jsx)(s.code,{children:"../ServiceConfigs/BFF/config:/app/config:ro"}),", ",(0,i.jsx)(s.code,{children:"bff-keys:/app/keys"})]}),"\n",(0,i.jsxs)(s.li,{children:["depends_on: ",(0,i.jsx)(s.code,{children:"shared_redis"}),", ",(0,i.jsx)(s.code,{children:"idp"}),", ",(0,i.jsx)(s.code,{children:"kafka"})]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,i.jsx)(s.h2,{id:"traefik-routers-labels-on-bff",children:"Traefik routers (labels on bff)"}),"\n",(0,i.jsxs)(s.ul,{children:["\n",(0,i.jsxs)(s.li,{children:["Primary API router (api host)","\n",(0,i.jsxs)(s.ul,{children:["\n",(0,i.jsxs)(s.li,{children:["rule: ",(0,i.jsx)(s.code,{children:"Host(\\"}),"api.ocg.labs.empowernow.ai`) && (PathPrefix(`/auth/`) || PathPrefix(`/api/`))`"]}),"\n",(0,i.jsxs)(s.li,{children:["service: ",(0,i.jsx)(s.code,{children:"api"})," \u2192 port 8000"]}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(s.li,{children:["SPA hosts (automate, authz, authn)","\n",(0,i.jsxs)(s.ul,{children:["\n",(0,i.jsxs)(s.li,{children:["Streaming routers (priority 100): intercept ",(0,i.jsx)(s.code,{children:"/events/"}),", ",(0,i.jsx)(s.code,{children:"/stream/"}),", etc."]}),"\n",(0,i.jsx)(s.li,{children:"OAuth/API routers with security headers & rate limit (priority ~90\u201395)"}),"\n",(0,i.jsxs)(s.li,{children:["Public auth router: ",(0,i.jsx)(s.code,{children:"/auth/login"}),", ",(0,i.jsx)(s.code,{children:"/auth/callback"}),", ",(0,i.jsx)(s.code,{children:"/auth/forward"}),", ",(0,i.jsx)(s.code,{children:"/auth/logout"}),", ",(0,i.jsx)(s.code,{children:"/health"})]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,i.jsx)(s.h2,{id:"forwardauth-in-compose",children:"ForwardAuth in Compose"}),"\n",(0,i.jsxs)(s.ul,{children:["\n",(0,i.jsxs)(s.li,{children:["Traefik dashboard: ",(0,i.jsx)(s.code,{children:"traefik.http.routers.traefik-dashboard.middlewares=bff-forwardauth@file"})]}),"\n",(0,i.jsxs)(s.li,{children:["Dynamic file must define ",(0,i.jsx)(s.code,{children:"bff-forwardauth"})," pointing to BFF ",(0,i.jsx)(s.code,{children:"/auth/forward"})," or ",(0,i.jsx)(s.code,{children:"/auth/verify"}),"."]}),"\n"]}),"\n",(0,i.jsx)(s.h2,{id:"bff-environment-selected",children:"BFF environment (selected)"}),"\n",(0,i.jsxs)(s.ul,{children:["\n",(0,i.jsxs)(s.li,{children:["Core","\n",(0,i.jsxs)(s.ul,{children:["\n",(0,i.jsx)(s.li,{children:(0,i.jsx)(s.code,{children:"ENVIRONMENT=development"})}),"\n",(0,i.jsxs)(s.li,{children:[(0,i.jsx)(s.code,{children:"HOST=0.0.0.0"}),", ",(0,i.jsx)(s.code,{children:"PORT=8000"})]}),"\n",(0,i.jsx)(s.li,{children:(0,i.jsx)(s.code,{children:"REDIS_URL=redis://shared_redis:6379/5"})}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(s.li,{children:["OAuth/IdP","\n",(0,i.jsxs)(s.ul,{children:["\n",(0,i.jsx)(s.li,{children:(0,i.jsx)(s.code,{children:"OIDC_ISSUER=http://idp-app:8002/api/oidc"})}),"\n",(0,i.jsx)(s.li,{children:(0,i.jsx)(s.code,{children:"IDP_PUBLIC_BASE=https://idp.ocg.labs.empowernow.ai/api/oidc"})}),"\n",(0,i.jsxs)(s.li,{children:[(0,i.jsx)(s.code,{children:"AUTH_CLIENT_ID"}),", ",(0,i.jsx)(s.code,{children:"AUTH_CLIENT_SECRET"})," (secrets)"]}),"\n",(0,i.jsxs)(s.li,{children:[(0,i.jsx)(s.code,{children:"MS_BFF_PAR_ENABLED=true"}),", ",(0,i.jsx)(s.code,{children:"MS_BFF_DPOP_ENABLED=true"})]}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(s.li,{children:["Cookie/Session","\n",(0,i.jsxs)(s.ul,{children:["\n",(0,i.jsx)(s.li,{children:(0,i.jsx)(s.code,{children:"BFF_COOKIE_DOMAIN=.ocg.labs.empowernow.ai"})}),"\n",(0,i.jsx)(s.li,{children:(0,i.jsx)(s.code,{children:"SESSION_LIFETIME=3600"})}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(s.li,{children:["Callback mode","\n",(0,i.jsxs)(s.ul,{children:["\n",(0,i.jsx)(s.li,{children:(0,i.jsx)(s.code,{children:"BFF_DYNAMIC_CALLBACK=true"})}),"\n",(0,i.jsx)(s.li,{children:(0,i.jsx)(s.code,{children:"BFF_CALLBACK_URL=https://api.ocg.labs.empowernow.ai/auth/callback"})}),"\n",(0,i.jsxs)(s.li,{children:[(0,i.jsx)(s.code,{children:"BFF_DEFAULT_HOST=api.ocg.labs.empowernow.ai"}),", ",(0,i.jsx)(s.code,{children:"BFF_DEFAULT_SCHEME=https"})]}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(s.li,{children:["Security & CORS","\n",(0,i.jsxs)(s.ul,{children:["\n",(0,i.jsx)(s.li,{children:(0,i.jsx)(s.code,{children:"BFF_ALLOWED_REDIRECT_HOSTS=automate...,authn...,authz...,localhost,127.0.0.1"})}),"\n",(0,i.jsx)(s.li,{children:(0,i.jsx)(s.code,{children:'CORS__ALLOW_ORIGINS=\'["https://authn...","https://authz...","https://automate..."]\''})}),"\n",(0,i.jsxs)(s.li,{children:[(0,i.jsx)(s.code,{children:"CSRF_SECRET_KEY"})," (secret)"]}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(s.li,{children:["Headers & keys","\n",(0,i.jsxs)(s.ul,{children:["\n",(0,i.jsxs)(s.li,{children:[(0,i.jsx)(s.code,{children:"BFF_JWT_SIGNING_KEY=/app/keys/bff-sig-001.pem"})," (mounted volume)"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,i.jsx)(s.h2,{id:"other-services-commonly-present",children:"Other services commonly present"}),"\n",(0,i.jsxs)(s.ul,{children:["\n",(0,i.jsxs)(s.li,{children:[(0,i.jsx)(s.code,{children:"idp"})," (../IdP), ",(0,i.jsx)(s.code,{children:"crud-service"})," (../CRUDService), ",(0,i.jsx)(s.code,{children:"pdp"})," (../pdp), ",(0,i.jsx)(s.code,{children:"membership"}),", ",(0,i.jsx)(s.code,{children:"analytics"}),", Kafka, ClickHouse, Prometheus/Grafana/Jaeger, etc. Traefik routes are defined by labels per service."]}),"\n"]}),"\n",(0,i.jsx)(s.h2,{id:"request-flow-compose-stack",children:"Request flow (compose stack)"}),"\n",(0,i.jsx)(s.mermaid,{value:"flowchart LR\r\n  subgraph Traefik\r\n    R1[api.ocg... /api/**]\r\n    R2[automate.ocg... /auth/**]\r\n    FA[bff-forwardauth]\r\n  end\r\n  subgraph BFF\r\n    V[/auth/verify/]\r\n    F[/auth/forward/]\r\n    A[/auth/login|callback|logout/]\r\n    API[/api/**/]\r\n  end\r\n  R1 --\x3e FA --\x3e V\r\n  R2 --\x3e A\r\n  V --\x3e API"}),"\n",(0,i.jsx)(s.h2,{id:"bring-up-checklist",children:"Bring-up checklist"}),"\n",(0,i.jsxs)(s.ul,{children:["\n",(0,i.jsxs)(s.li,{children:["Ensure ",(0,i.jsx)(s.code,{children:"./traefik/dynamic.yml"})," defines ",(0,i.jsx)(s.code,{children:"bff-forwardauth"})," middleware targeting BFF ",(0,i.jsx)(s.code,{children:"/auth/forward"})," or ",(0,i.jsx)(s.code,{children:"/auth/verify"})]}),"\n",(0,i.jsx)(s.li,{children:"Set secrets (client secrets, salts, keys) via Docker secrets/volumes; do not embed plaintext"}),"\n",(0,i.jsxs)(s.li,{children:["Confirm health endpoints: ",(0,i.jsx)(s.code,{children:"GET https://api.ocg.../auth/health"})]}),"\n",(0,i.jsxs)(s.li,{children:["Verify session flow: SPAs call same-origin ",(0,i.jsx)(s.code,{children:"/api/**"}),", unauthenticated 401 JSON, then ",(0,i.jsx)(s.code,{children:"/auth/login"})]}),"\n"]})]})}function a(e={}){const{wrapper:s}={...(0,c.R)(),...e.components};return s?(0,i.jsx)(s,{...e,children:(0,i.jsx)(h,{...e})}):h(e)}}}]);