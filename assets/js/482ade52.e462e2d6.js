"use strict";(self.webpackChunkempowernow_docs=self.webpackChunkempowernow_docs||[]).push([[1456],{28453:(e,r,s)=>{s.d(r,{R:()=>o,x:()=>d});var n=s(96540);const i={},c=n.createContext(i);function o(e){const r=n.useContext(c);return n.useMemo(function(){return"function"==typeof e?e(r):{...r,...e}},[r,e])}function d(e){let r;return r=e.disableParentContext?"function"==typeof e.components?e.components(i):e.components||i:o(e.components),n.createElement(c.Provider,{value:r},e.children)}},39572:(e,r,s)=>{s.r(r),s.d(r,{assets:()=>t,contentTitle:()=>d,default:()=>h,frontMatter:()=>o,metadata:()=>n,toc:()=>l});const n=JSON.parse('{"id":"services/bff/reference/legacy-proxy","title":"Legacy services proxy","description":"Purpose: stable fa\xe7ade to legacy C# microservices with circuit breaker, caching, limits, and metrics.","source":"@site/docs/services/bff/reference/legacy-proxy.md","sourceDirName":"services/bff/reference","slug":"/services/bff/reference/legacy-proxy","permalink":"/empowernow_docs/docs/services/bff/reference/legacy-proxy","draft":false,"unlisted":false,"editUrl":"https://github.com/facebook/docusaurus/tree/main/packages/create-docusaurus/templates/shared/docs/services/bff/reference/legacy-proxy.md","tags":[{"inline":true,"label":"service:bff","permalink":"/empowernow_docs/docs/tags/service-bff"},{"inline":true,"label":"type:reference","permalink":"/empowernow_docs/docs/tags/type-reference"},{"inline":true,"label":"roles:admin","permalink":"/empowernow_docs/docs/tags/roles-admin"},{"inline":true,"label":"roles:devops","permalink":"/empowernow_docs/docs/tags/roles-devops"},{"inline":true,"label":"roles:developer","permalink":"/empowernow_docs/docs/tags/roles-developer"}],"version":"current","frontMatter":{"id":"legacy-proxy","title":"Legacy services proxy","sidebar_label":"Legacy proxy","tags":["service:bff","type:reference","roles:admin","roles:devops","roles:developer"]},"sidebar":"tutorialSidebar","previous":{"title":"idps.yaml Reference","permalink":"/empowernow_docs/docs/services/bff/reference/idps-reference"},"next":{"title":"legacy_services.yaml Reference","permalink":"/empowernow_docs/docs/services/bff/reference/legacy-services-reference"}}');var i=s(74848),c=s(28453);const o={id:"legacy-proxy",title:"Legacy services proxy",sidebar_label:"Legacy proxy",tags:["service:bff","type:reference","roles:admin","roles:devops","roles:developer"]},d=void 0,t={},l=[];function a(e){const r={code:"code",li:"li",mermaid:"mermaid",p:"p",pre:"pre",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,c.R)(),...e.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(r.p,{children:"Purpose: stable fa\xe7ade to legacy C# microservices with circuit breaker, caching, limits, and metrics."}),"\n",(0,i.jsxs)(r.ul,{children:["\n",(0,i.jsxs)(r.li,{children:["Code: ",(0,i.jsx)(r.code,{children:"ms_bff_spike/ms_bff/src/api/v1/endpoints/legacy_proxy.py"})]}),"\n",(0,i.jsxs)(r.li,{children:["Config: ",(0,i.jsx)(r.code,{children:"ServiceConfigs/BFF/config/legacy_services.yaml"}),"\n",(0,i.jsxs)(r.ul,{children:["\n",(0,i.jsxs)(r.li,{children:[(0,i.jsx)(r.code,{children:"legacy_services"}),": service\u2192base URL (override via ",(0,i.jsx)(r.code,{children:"LEGACY_SERVICE_{NAME}_URL"}),")"]}),"\n",(0,i.jsxs)(r.li,{children:[(0,i.jsx)(r.code,{children:"legacy_service_timeouts"}),": per\u2011service timeouts"]}),"\n",(0,i.jsxs)(r.li,{children:[(0,i.jsx)(r.code,{children:"circuit_breaker.threshold"}),", ",(0,i.jsx)(r.code,{children:"circuit_breaker.reset_time"})]}),"\n",(0,i.jsxs)(r.li,{children:[(0,i.jsx)(r.code,{children:"response_cache.enabled"}),", ",(0,i.jsx)(r.code,{children:"default_ttl"}),", ",(0,i.jsx)(r.code,{children:"max_size"})]}),"\n",(0,i.jsx)(r.li,{children:(0,i.jsx)(r.code,{children:"request_limits.max_body_size"})}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,i.jsx)(r.p,{children:"Auth: BFF session or bearer token. The legacy route accepts either an authenticated BFF session (cookie) or a caller-supplied EmpowerID bearer token. BFF injects downstream bearer and headers."}),"\n",(0,i.jsx)(r.p,{children:"Authentication model"}),"\n",(0,i.jsxs)(r.ul,{children:["\n",(0,i.jsxs)(r.li,{children:["Front-door: the legacy route is protected by ",(0,i.jsx)(r.code,{children:"Depends(get_current_user)"}),"; callers can authenticate with either a valid BFF session (cookie) or by sending ",(0,i.jsx)(r.code,{children:"Authorization: Bearer <access_token>"})," from EmpowerID."]}),"\n",(0,i.jsxs)(r.li,{children:["Downstream: the proxy forwards the caller's token unchanged in ",(0,i.jsx)(r.code,{children:"Authorization: Bearer ..."})," when ",(0,i.jsx)(r.code,{children:"request.state.token"})," exists; for ",(0,i.jsx)(r.code,{children:"service=empowerid"}),", it also injects ",(0,i.jsx)(r.code,{children:"X-EmpowerID-Api-Key"})," if configured."]}),"\n",(0,i.jsxs)(r.li,{children:["Identity propagation: when a validated user ARN is available, ",(0,i.jsx)(r.code,{children:"X-Original-User"})," is added for auditing/attribution."]}),"\n"]}),"\n",(0,i.jsx)(r.p,{children:"Endpoints"}),"\n",(0,i.jsxs)(r.ul,{children:["\n",(0,i.jsxs)(r.li,{children:["Any method ",(0,i.jsx)(r.code,{children:"/api/v1/proxy/{service}/{path}"})]}),"\n",(0,i.jsxs)(r.li,{children:["GET ",(0,i.jsx)(r.code,{children:"/api/v1/proxy/health"})," (proxy health and cache stats)"]}),"\n"]}),"\n",(0,i.jsx)(r.p,{children:"Headers injected"}),"\n",(0,i.jsxs)(r.ul,{children:["\n",(0,i.jsxs)(r.li,{children:[(0,i.jsx)(r.code,{children:"X-Correlation-ID"})," when available"]}),"\n",(0,i.jsxs)(r.li,{children:[(0,i.jsx)(r.code,{children:"X-Original-User"})," when ARN present"]}),"\n",(0,i.jsxs)(r.li,{children:[(0,i.jsx)(r.code,{children:"Authorization: Bearer ..."})," from BFF state when available (caller token pass-through)"]}),"\n",(0,i.jsxs)(r.li,{children:["For ",(0,i.jsx)(r.code,{children:"service=empowerid"}),", ",(0,i.jsx)(r.code,{children:"X-EmpowerID-Api-Key"})," if configured"]}),"\n"]}),"\n",(0,i.jsx)(r.p,{children:"How SPA, BFF, and EmpowerID work together (legacy route)"}),"\n",(0,i.jsxs)(r.ul,{children:["\n",(0,i.jsxs)(r.li,{children:["\n",(0,i.jsx)(r.p,{children:"SPA login (EmpowerID IdP)"}),"\n",(0,i.jsxs)(r.ul,{children:["\n",(0,i.jsx)(r.li,{children:"Use OIDC Authorization Code + PKCE to authenticate against EmpowerID."}),"\n",(0,i.jsxs)(r.li,{children:["After login, you have two options to call the BFF:","\n",(0,i.jsxs)(r.ul,{children:["\n",(0,i.jsxs)(r.li,{children:["Bearer mode: SPA sends ",(0,i.jsx)(r.code,{children:"Authorization: Bearer <access_token_from_EmpowerID>"})," to the BFF."]}),"\n",(0,i.jsx)(r.li,{children:"Session mode (recommended for SPAs): BFF does the code exchange server-side and issues an HttpOnly secure session cookie; SPA calls the BFF without storing tokens."}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(r.li,{children:["\n",(0,i.jsx)(r.p,{children:"Auth to the BFF"}),"\n",(0,i.jsxs)(r.ul,{children:["\n",(0,i.jsxs)(r.li,{children:["The legacy route requires ",(0,i.jsx)(r.code,{children:"Depends(get_current_user)"}),"; the BFF accepts either the user's bearer token or an authenticated session."]}),"\n",(0,i.jsxs)(r.li,{children:["The BFF then exposes the user info as ",(0,i.jsx)(r.code,{children:"TokenPayload"})," and sets ",(0,i.jsx)(r.code,{children:"request.state.token"})," (when available)."]}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(r.li,{children:["\n",(0,i.jsx)(r.p,{children:"Calling EmpowerID through the legacy route"}),"\n",(0,i.jsxs)(r.ul,{children:["\n",(0,i.jsxs)(r.li,{children:["SPA calls the BFF at ",(0,i.jsx)(r.code,{children:"/{service_name}/{path}"})," with ",(0,i.jsx)(r.code,{children:"service_name = empowerid"})," (e.g., ",(0,i.jsx)(r.code,{children:"/api/v1/proxy/empowerid/v1/users/me"}),")."]}),"\n",(0,i.jsxs)(r.li,{children:["The BFF's proxy behavior:","\n",(0,i.jsxs)(r.ul,{children:["\n",(0,i.jsxs)(r.li,{children:["Forwards the caller's token unchanged in ",(0,i.jsx)(r.code,{children:"Authorization: Bearer <token>"})," if ",(0,i.jsx)(r.code,{children:"request.state.token"})," exists."]}),"\n",(0,i.jsxs)(r.li,{children:["Injects ",(0,i.jsx)(r.code,{children:"X-EmpowerID-Api-Key"})," when ",(0,i.jsx)(r.code,{children:"service_name == 'empowerid'"})," and ",(0,i.jsx)(r.code,{children:"settings.empowerid_api_key"})," is set."]}),"\n",(0,i.jsxs)(r.li,{children:["Adds ",(0,i.jsx)(r.code,{children:"X-Original-User"})," with the validated user ARN for audit."]}),"\n"]}),"\n"]}),"\n",(0,i.jsx)(r.li,{children:"There is no token exchange; it is pass-through of the user's EmpowerID token plus an API key."}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,i.jsx)(r.p,{children:"Examples"}),"\n",(0,i.jsx)(r.pre,{children:(0,i.jsx)(r.code,{className:"language-bash",children:'curl "https://.../api/v1/proxy/res-admin/services/v1/resadmin/resources/people/getsearch?top=25" \\\r\n  --cookie "_eid_sid=..."\r\n\r\ncurl -X POST "https://.../api/v1/proxy/res-admin/services/v1/resadmin/resources/People/create" \\\r\n  -H "Content-Type: application/json" \\\r\n  --cookie "_eid_sid=..." \\\r\n  -d \'{"FirstName":"Ada","LastName":"Lovelace","Email":"ada@example.com","UserName":"ada"}\'\n'})}),"\n",(0,i.jsx)(r.p,{children:"Minimal SPA example (legacy EmpowerID via BFF)"}),"\n",(0,i.jsx)(r.pre,{children:(0,i.jsx)(r.code,{className:"language-javascript",children:"// After OIDC login with EmpowerID (Auth Code + PKCE)\r\n// Bearer mode\r\nconst res = await fetch('/api/v1/proxy/empowerid/v1/users/me', {\r\n  method: 'GET',\r\n  headers: { Authorization: `Bearer ${accessToken}` }\r\n});\r\n\r\n// Session mode: omit Authorization, include cookies\r\nconst resSession = await fetch('/api/v1/proxy/empowerid/v1/users/me', {\r\n  credentials: 'include'\r\n});\n"})}),"\n",(0,i.jsx)(r.p,{children:"Mermaid"}),"\n",(0,i.jsx)(r.mermaid,{value:"sequenceDiagram\r\n  participant SPA\r\n  participant BFF\r\n  participant Legacy as Legacy Service\r\n  SPA->>BFF: /api/v1/proxy/{service}/{path}\r\n  BFF->>BFF: CB check + cache lookup (GET)\r\n  alt cache hit\r\n    BFF--\x3e>SPA: 200 (X-Cache: HIT)\r\n  else cache miss\r\n    BFF->>Legacy: request (headers injected)\r\n    Legacy--\x3e>BFF: response\r\n    BFF->>BFF: cache write (GET 200)\r\n    BFF--\x3e>SPA: response (X-Cache: MISS)\r\n  end"}),"\n",(0,i.jsx)(r.p,{children:"Failure modes"}),"\n",(0,i.jsxs)(r.ul,{children:["\n",(0,i.jsxs)(r.li,{children:["Circuit open: 503 with ",(0,i.jsx)(r.code,{children:"Retry-After"})]}),"\n",(0,i.jsxs)(r.li,{children:["Body too large: 413 based on ",(0,i.jsx)(r.code,{children:"max_body_size"})]}),"\n",(0,i.jsx)(r.li,{children:"Unknown service: 404 from proxy"}),"\n"]}),"\n",(0,i.jsx)(r.p,{children:"Observability"}),"\n",(0,i.jsxs)(r.ul,{children:["\n",(0,i.jsx)(r.li,{children:"Prometheus counters/timers for requests/errors/CB state and cache hits/misses"}),"\n"]}),"\n",(0,i.jsx)(r.p,{children:"Change control"}),"\n",(0,i.jsxs)(r.ul,{children:["\n",(0,i.jsxs)(r.li,{children:["Add a service in ",(0,i.jsx)(r.code,{children:"legacy_services"})," with base URL, optional timeout; adjust CB/cache as needed. Promote via config SOP."]}),"\n"]}),"\n",(0,i.jsxs)(r.p,{children:["See also: ",(0,i.jsx)(r.code,{children:"../how-to/add-legacy-service"}),", ",(0,i.jsx)(r.code,{children:"../how-to/tune-legacy-circuit-cache"})]}),"\n",(0,i.jsx)(r.p,{children:"For SPA developers"}),"\n",(0,i.jsxs)(r.ul,{children:["\n",(0,i.jsxs)(r.li,{children:["\n",(0,i.jsx)(r.p,{children:"How to call from React (same-origin recommended):"}),"\n",(0,i.jsx)(r.pre,{children:(0,i.jsx)(r.code,{className:"language-ts",children:"// GET with query params (cookies sent automatically)\r\nconst res = await apiClient.get(\r\n  '/api/v1/proxy/res-admin/services/v1/resadmin/resources/people/getsearch',\r\n  { params: { top: 25 } }\r\n);\r\n\r\n// POST JSON\r\nawait apiClient.post(\r\n  '/api/v1/proxy/res-admin/services/v1/resadmin/resources/People/create',\r\n  { FirstName: 'Ada', LastName: 'Lovelace', Email: 'ada@example.com', UserName: 'ada' }\r\n);\r\n\r\n// POST file upload (watch 10MB default body limit)\r\nconst form = new FormData();\r\nform.append('file', file);\r\nawait apiClient.post('/api/v1/proxy/my-service/upload', form);\n"})}),"\n"]}),"\n",(0,i.jsxs)(r.li,{children:["\n",(0,i.jsxs)(r.p,{children:["Cross-origin dev: set ",(0,i.jsx)(r.code,{children:"VITE_BFF_BASE_URL"})," to the BFF origin and ensure your client uses ",(0,i.jsx)(r.code,{children:"credentials: 'include'"})," so cookies flow. See Dev vs Prod setup."]}),"\n"]}),"\n",(0,i.jsxs)(r.li,{children:["\n",(0,i.jsxs)(r.p,{children:["If using session mode, do not add Authorization headers in the browser; the BFF injects downstream credentials. If using bearer mode, include your EmpowerID access token in the ",(0,i.jsx)(r.code,{children:"Authorization"})," header."]}),"\n"]}),"\n",(0,i.jsxs)(r.li,{children:["\n",(0,i.jsxs)(r.p,{children:["Prefer YAML-driven canonical routes under ",(0,i.jsx)(r.code,{children:"/api/..."})," when available; the legacy proxy is a compatibility bridge."]}),"\n"]}),"\n"]}),"\n",(0,i.jsx)(r.p,{children:"Common errors and UX"}),"\n",(0,i.jsxs)(r.table,{children:[(0,i.jsx)(r.thead,{children:(0,i.jsxs)(r.tr,{children:[(0,i.jsx)(r.th,{children:"Status"}),(0,i.jsx)(r.th,{children:"Meaning"}),(0,i.jsx)(r.th,{children:"Suggested UX"})]})}),(0,i.jsxs)(r.tbody,{children:[(0,i.jsxs)(r.tr,{children:[(0,i.jsx)(r.td,{children:"401"}),(0,i.jsx)(r.td,{children:"No/expired session"}),(0,i.jsx)(r.td,{children:"Redirect to login"})]}),(0,i.jsxs)(r.tr,{children:[(0,i.jsx)(r.td,{children:"403"}),(0,i.jsx)(r.td,{children:"PDP/authorization deny"}),(0,i.jsx)(r.td,{children:"Show Access Denied (no retry)"})]}),(0,i.jsxs)(r.tr,{children:[(0,i.jsx)(r.td,{children:"413"}),(0,i.jsx)(r.td,{children:"Body too large"}),(0,i.jsx)(r.td,{children:"Show guidance; split upload or contact admin"})]}),(0,i.jsxs)(r.tr,{children:[(0,i.jsx)(r.td,{children:"502"}),(0,i.jsx)(r.td,{children:"Upstream error"}),(0,i.jsx)(r.td,{children:"Toast error; log correlation ID; retry optional"})]}),(0,i.jsxs)(r.tr,{children:[(0,i.jsx)(r.td,{children:"503"}),(0,i.jsx)(r.td,{children:"Circuit open/backoff"}),(0,i.jsx)(r.td,{children:"Show retry with backoff; try later"})]})]})]}),"\n",(0,i.jsxs)(r.p,{children:["Helpful links: ",(0,i.jsx)(r.code,{children:"../how-to/uploads-downloads-streaming"}),", ",(0,i.jsx)(r.code,{children:"../reference/frontend-errors"}),", ",(0,i.jsx)(r.code,{children:"../how-to/dev-vs-prod-setup"}),", ",(0,i.jsx)(r.code,{children:"./proxy-yaml-reference"}),"."]})]})}function h(e={}){const{wrapper:r}={...(0,c.R)(),...e.components};return r?(0,i.jsx)(r,{...e,children:(0,i.jsx)(a,{...e})}):a(e)}}}]);