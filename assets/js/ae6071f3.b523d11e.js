"use strict";(self.webpackChunkempowernow_docs=self.webpackChunkempowernow_docs||[]).push([[6554],{28453:(e,s,n)=>{n.d(s,{R:()=>c,x:()=>o});var t=n(96540);const r={},i=t.createContext(r);function c(e){const s=t.useContext(i);return t.useMemo(function(){return"function"==typeof e?e(s):{...s,...e}},[s,e])}function o(e){let s;return s=e.disableParentContext?"function"==typeof e.components?e.components(r):e.components||r:c(e.components),t.createElement(i.Provider,{value:s},e.children)}},47030:(e,s,n)=>{n.r(s),n.d(s,{assets:()=>d,contentTitle:()=>o,default:()=>f,frontMatter:()=>c,metadata:()=>t,toc:()=>l});const t=JSON.parse('{"id":"services/bff/reference/observability","title":"Observability (Metrics, Tracing, Health)","description":"Prometheus metrics","source":"@site/docs/services/bff/reference/observability.md","sourceDirName":"services/bff/reference","slug":"/services/bff/reference/observability","permalink":"/empowernow_docs/docs/services/bff/reference/observability","draft":false,"unlisted":false,"editUrl":"https://github.com/facebook/docusaurus/tree/main/packages/create-docusaurus/templates/shared/docs/services/bff/reference/observability.md","tags":[],"version":"current","frontMatter":{"title":"Observability (Metrics, Tracing, Health)"},"sidebar":"tutorialSidebar","previous":{"title":"logging.yaml Reference","permalink":"/empowernow_docs/docs/services/bff/reference/logging-reference"},"next":{"title":"PDP mapping (pdp.yaml)","permalink":"/empowernow_docs/docs/services/bff/reference/pdp-mapping"}}');var r=n(74848),i=n(28453);const c={title:"Observability (Metrics, Tracing, Health)"},o=void 0,d={},l=[];function a(e){const s={code:"code",li:"li",p:"p",ul:"ul",...(0,i.R)(),...e.components};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(s.p,{children:"Prometheus metrics"}),"\n",(0,r.jsxs)(s.ul,{children:["\n",(0,r.jsxs)(s.li,{children:["Endpoint: ",(0,r.jsx)(s.code,{children:"GET /metrics"})," (text exposition) \u2013 exported from ",(0,r.jsx)(s.code,{children:"prometheus_client"}),"."]}),"\n",(0,r.jsxs)(s.li,{children:["Built\u2011in HTTP metrics: ",(0,r.jsx)(s.code,{children:"http_requests_total{method,endpoint,status}"}),", ",(0,r.jsx)(s.code,{children:"http_request_duration_seconds{...}"}),"."]}),"\n",(0,r.jsxs)(s.li,{children:["Authentication/session metrics: ",(0,r.jsx)(s.code,{children:"bff_active_sessions_total"}),", ",(0,r.jsx)(s.code,{children:"bff_sessions_created_total"}),", ",(0,r.jsx)(s.code,{children:"bff_sessions_destroyed_total{reason}"}),", ",(0,r.jsx)(s.code,{children:"bff_verify_duration_seconds{status}"}),", ",(0,r.jsx)(s.code,{children:"bff_oauth_flow_duration_seconds{flow_type}"}),", ",(0,r.jsx)(s.code,{children:"bff_session_binding_failures_total{reason}"}),"."]}),"\n",(0,r.jsxs)(s.li,{children:["Token workflow: ",(0,r.jsx)(s.code,{children:"bff_token_refresh_success_total{user_id}"}),", ",(0,r.jsx)(s.code,{children:"bff_token_refresh_failed_total{reason}"}),", ",(0,r.jsx)(s.code,{children:"bff_token_refresh_total{service,status}"}),", ",(0,r.jsx)(s.code,{children:"bff_token_exchange_total{grant_type,status}"}),", ",(0,r.jsx)(s.code,{children:"bff_token_validation_total{token_type,status}"}),", ",(0,r.jsx)(s.code,{children:"bff_token_expiry_total{service}"}),"."]}),"\n",(0,r.jsxs)(s.li,{children:["PDP: ",(0,r.jsx)(s.code,{children:"bff_authz_requests_total{resource,action,decision}"}),", ",(0,r.jsx)(s.code,{children:"bff_authz_latency_seconds{resource}"}),"."]}),"\n",(0,r.jsxs)(s.li,{children:["Dependencies: ",(0,r.jsx)(s.code,{children:"bff_redis_operations_total{operation,status}"}),", ",(0,r.jsx)(s.code,{children:"bff_redis_latency_seconds{operation}"}),", ",(0,r.jsx)(s.code,{children:"bff_idp_requests_total{endpoint,status}"}),", ",(0,r.jsx)(s.code,{children:"bff_idp_latency_seconds{endpoint}"}),", ",(0,r.jsx)(s.code,{children:"bff_kafka_messages_total{topic,status}"}),", ",(0,r.jsx)(s.code,{children:"circuit_breaker_status{service}"}),", ",(0,r.jsx)(s.code,{children:"circuit_breaks_total{service}"}),"."]}),"\n",(0,r.jsxs)(s.li,{children:["Security: ",(0,r.jsx)(s.code,{children:"bff_csrf_violations_total{reason}"}),", ",(0,r.jsx)(s.code,{children:"bff_rate_limit_violations_total{client_id}"}),", ",(0,r.jsx)(s.code,{children:"bff_security_events_total{event_type,severity}"}),"."]}),"\n",(0,r.jsxs)(s.li,{children:["Background: ",(0,r.jsx)(s.code,{children:"bff_background_tasks_total{task_type,status}"}),", ",(0,r.jsx)(s.code,{children:"bff_background_task_duration_seconds{task_type}"}),"."]}),"\n",(0,r.jsxs)(s.li,{children:["Public SPA metrics ingestion: ",(0,r.jsx)(s.code,{children:"POST /api/v1/metrics"})," increments ",(0,r.jsx)(s.code,{children:"bff_public_metrics_total{event}"}),"; payload is validated and PII/secret keys are rejected."]}),"\n"]}),"\n",(0,r.jsx)(s.p,{children:"OpenTelemetry (tracing and metrics)"}),"\n",(0,r.jsxs)(s.ul,{children:["\n",(0,r.jsxs)(s.li,{children:["Module: ",(0,r.jsx)(s.code,{children:"observability/telemetry.py"}),"."]}),"\n",(0,r.jsxs)(s.li,{children:["Enable via env: ",(0,r.jsx)(s.code,{children:"TELEMETRY_ENABLED=true"})," (default) and ",(0,r.jsx)(s.code,{children:"OTLP_ENDPOINT"})," (e.g., ",(0,r.jsx)(s.code,{children:"http://otel-collector:4317"}),")."]}),"\n",(0,r.jsxs)(s.li,{children:["Tracing: FastAPI, httpx, and Redis auto\u2011instrumented; spans exported via OTLP gRPC with ",(0,r.jsx)(s.code,{children:"service.name=bff-service"}),", ",(0,r.jsx)(s.code,{children:"service.version"})," from ",(0,r.jsx)(s.code,{children:"BFF_VERSION"}),", and ",(0,r.jsx)(s.code,{children:"deployment.environment"})," from ",(0,r.jsx)(s.code,{children:"ENVIRONMENT"}),"."]}),"\n",(0,r.jsxs)(s.li,{children:["Custom OTEL metrics (exported via OTLP):","\n",(0,r.jsxs)(s.ul,{children:["\n",(0,r.jsxs)(s.li,{children:[(0,r.jsx)(s.code,{children:"bff_forwardauth_duration_ms"})," (histogram)"]}),"\n",(0,r.jsxs)(s.li,{children:[(0,r.jsx)(s.code,{children:"bff_session_validation_duration_ms"})," (histogram)"]}),"\n",(0,r.jsxs)(s.li,{children:[(0,r.jsx)(s.code,{children:"bff_auth_requests_total"})," (counter)"]}),"\n",(0,r.jsxs)(s.li,{children:[(0,r.jsx)(s.code,{children:"bff_token_refresh_duration_ms"})," (histogram)"]}),"\n",(0,r.jsxs)(s.li,{children:[(0,r.jsx)(s.code,{children:"bff_session_binding_failures_total"})," (counter)"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(s.p,{children:"Dashboards"}),"\n",(0,r.jsxs)(s.ul,{children:["\n",(0,r.jsxs)(s.li,{children:["Prometheus \u2192 Grafana: use histogram quantiles and rate functions, e.g.:","\n",(0,r.jsxs)(s.ul,{children:["\n",(0,r.jsxs)(s.li,{children:["P95 verify latency: ",(0,r.jsx)(s.code,{children:"histogram_quantile(0.95, sum(rate(bff_verify_duration_seconds_bucket[5m])) by (le))"})]}),"\n",(0,r.jsxs)(s.li,{children:["OAuth flow error rate: ",(0,r.jsx)(s.code,{children:"rate(bff_token_refresh_failed_total[5m])"})]}),"\n",(0,r.jsxs)(s.li,{children:["PDP allow/deny: ",(0,r.jsx)(s.code,{children:'sum(rate(bff_authz_requests_total{decision="allow"}[5m])) by (resource) / sum(rate(bff_authz_requests_total[5m])) by (resource)'})]}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(s.li,{children:"OTEL traces: visualize end\u2011to\u2011end auth flows (ForwardAuth \u2192 Redis \u2192 IdP \u2192 backend) in Jaeger/Tempo."}),"\n"]}),"\n",(0,r.jsx)(s.p,{children:"Health"}),"\n",(0,r.jsxs)(s.ul,{children:["\n",(0,r.jsx)(s.li,{children:"Health endpoint in BFF returns JSON with component checks (Redis, IdP) and HTTP 200/503 for readiness."}),"\n"]}),"\n",(0,r.jsx)(s.p,{children:"Configuration summary"}),"\n",(0,r.jsxs)(s.ul,{children:["\n",(0,r.jsxs)(s.li,{children:["Prometheus scrape: add annotations or static job to scrape ",(0,r.jsx)(s.code,{children:":8000/metrics"}),"."]}),"\n",(0,r.jsxs)(s.li,{children:["OTEL: set ",(0,r.jsx)(s.code,{children:"OTLP_ENDPOINT"}),", ",(0,r.jsx)(s.code,{children:"BFF_VERSION"}),", ",(0,r.jsx)(s.code,{children:"ENVIRONMENT"}),", and ensure collector is reachable."]}),"\n"]})]})}function f(e={}){const{wrapper:s}={...(0,i.R)(),...e.components};return s?(0,r.jsx)(s,{...e,children:(0,r.jsx)(a,{...e})}):a(e)}}}]);