"use strict";(self.webpackChunkempowernow_docs=self.webpackChunkempowernow_docs||[]).push([[9472],{17653:(e,n,i)=>{i.r(n),i.d(n,{assets:()=>d,contentTitle:()=>t,default:()=>p,frontMatter:()=>c,metadata:()=>s,toc:()=>a});const s=JSON.parse('{"id":"services/bff/how-to/configure-idps","title":"Configure IdPs (idps.yaml)","description":"What this file is","source":"@site/docs/services/bff/how-to/configure-idps.md","sourceDirName":"services/bff/how-to","slug":"/services/bff/how-to/configure-idps","permalink":"/empowernow_docs/docs/services/bff/how-to/configure-idps","draft":false,"unlisted":false,"editUrl":"https://github.com/facebook/docusaurus/tree/main/packages/create-docusaurus/templates/shared/docs/services/bff/how-to/configure-idps.md","tags":[],"version":"current","frontMatter":{"title":"Configure IdPs (idps.yaml)"},"sidebar":"tutorialSidebar","previous":{"title":"Config Change SOP \u2014 Source of Truth and Promotion","permalink":"/empowernow_docs/docs/services/bff/how-to/config-sop"},"next":{"title":"Configure PDP (legacy pdp.yaml)","permalink":"/empowernow_docs/docs/services/bff/how-to/configure-pdp"}}');var r=i(74848),o=i(28453);const c={title:"Configure IdPs (idps.yaml)"},t=void 0,d={},a=[];function l(e){const n={code:"code",li:"li",mermaid:"mermaid",p:"p",pre:"pre",ul:"ul",...(0,o.R)(),...e.components};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(n.p,{children:"What this file is"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"ServiceConfigs/BFF/config/idps.yaml"})," defines Identity Providers and audiences the BFF trusts for bearer token validation and server\u2011side OAuth operations."]}),"\n",(0,r.jsxs)(n.li,{children:["Each entry pairs an ",(0,r.jsx)(n.code,{children:"issuer"})," with a specific ",(0,r.jsx)(n.code,{children:"audience"})," so the BFF can validate and normalize tokens from multiple clients/services, even if they share the same issuer."]}),"\n"]}),"\n",(0,r.jsx)(n.p,{children:"What authentication the BFF supports"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Session (for SPAs): OAuth2 Authorization Code with PKCE (+ PAR). Optional DPoP and enterprise mTLS per env flags. Tokens stay server\u2011side; BFF issues an HttpOnly session cookie and enforces CSRF."}),"\n",(0,r.jsxs)(n.li,{children:["Bearer (for services/APIs): Requests present ",(0,r.jsx)(n.code,{children:"Authorization: Bearer <token>"}),". The BFF validates against configured IdPs (primarily via introspection) and normalizes roles/permissions via ",(0,r.jsx)(n.code,{children:"claims_mapping"}),"."]}),"\n",(0,r.jsxs)(n.li,{children:["ForwardAuth at edge: Traefik calls BFF ",(0,r.jsx)(n.code,{children:"/auth/verify"})," (",(0,r.jsx)(n.code,{children:"/auth/forward"}),") to gate requests for selected hosts. See Traefik ForwardAuth reference."]}),"\n"]}),"\n",(0,r.jsx)(n.p,{children:"File structure (fields)"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"name"}),": logical name used in logs/telemetry."]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"provider"}),": canonical alias for identity/ARNs. Use the same alias for IdP entries that share an issuer but differ by audience. If omitted, identity falls back to ",(0,r.jsx)(n.code,{children:"name"}),"."]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"issuer"}),": OIDC issuer URL."]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"audience"}),": expected ",(0,r.jsx)(n.code,{children:"aud"})," for tokens in this context."]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"jwks_url"}),": JWKS for signature keys (used when signature verification is enabled)."]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"introspection_url"}),": OAuth2 introspection endpoint the BFF calls to verify bearer tokens."]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"token_url"}),": OAuth2 token endpoint (used by BFF server\u2011side flows like code exchange or client credentials)."]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"client_id"}),", ",(0,r.jsx)(n.code,{children:"client_secret"}),": client credentials for introspection/token calls. You can reference env with ",(0,r.jsx)(n.code,{children:"${VAR}"}),"."]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"enable_token_exchange"}),": whether BFF may use OAuth token exchange for certain flows."]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"api_key"}),": optional key for IdPs that require it."]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"claims_mapping"}),":","\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"roles"}),": where to read roles (e.g., ",(0,r.jsx)(n.code,{children:"roles"}),", ",(0,r.jsx)(n.code,{children:"groups"}),", or Keycloak ",(0,r.jsx)(n.code,{children:"resource_access"})," client roles)."]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"permissions"}),": where to read permissions; supports ",(0,r.jsx)(n.code,{children:"format: space_delimited"})," for ",(0,r.jsx)(n.code,{children:"scope"}),"."]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(n.p,{children:"Example"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-yaml",children:"idps:\n  - name: empowernow\n    provider: empowernow\n    issuer: https://idp.ocg.labs.empowernow.ai/api/oidc\n    audience: https://idp.ocg.labs.empowernow.ai/api/admin\n    jwks_url: https://idp.ocg.labs.empowernow.ai/api/oidc/jwks\n    introspection_url: http://idp-app:8002/api/oidc/introspect\n    token_url: https://idp.ocg.labs.empowernow.ai/api/oidc/token\n    client_id: service-client\n    client_secret: ${IDP_CLIENT_SECRET}\n    enable_token_exchange: false\n    claims_mapping:\n      roles:\n        - source: roles\n        - source: groups\n      permissions:\n        - source: scope\n          format: space_delimited\n        - source: permissions\n\n  # Same issuer, different audience (CRUD)\n  - name: empowernow-crud\n    provider: empowernow\n    issuer: https://idp.ocg.labs.empowernow.ai/api/oidc\n    audience: https://crud-service:8000\n    jwks_url: https://idp.ocg.labs.empowernow.ai/api/oidc/jwks\n    introspection_url: http://idp-app:8002/api/oidc/introspect\n    token_url: https://idp.ocg.labs.empowernow.ai/api/oidc/token\n    client_id: service-client\n    client_secret: ${IDP_CLIENT_SECRET}\n    claims_mapping:\n      roles:\n        - source: roles\n        - source: groups\n      permissions:\n        - source: scope\n          format: space_delimited\n"})}),"\n",(0,r.jsx)(n.p,{children:"Flow (bearer path)"}),"\n",(0,r.jsx)(n.mermaid,{value:"sequenceDiagram\n  autonumber\n  participant Client\n  participant BFF\n  participant IdP\n  Client->>BFF: GET /api/... Authorization: Bearer <jwt>\n  BFF->>BFF: Decode iss, aud; select IdP entry by issuer+audience\n  BFF->>IdP: POST introspect (with client_id/secret)\n  IdP--\x3e>BFF: { active: true, scope, roles... }\n  BFF->>BFF: Map claims \u2192 roles/permissions per claims_mapping\n  BFF--\x3e>Client: 200 JSON (or 401/403)"}),"\n",(0,r.jsx)(n.p,{children:"Environment and secrets"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["You can reference environment variables for secrets (e.g., ",(0,r.jsx)(n.code,{children:"client_secret: ${IDP_CLIENT_SECRET}"}),"); these are resolved on load."]}),"\n",(0,r.jsxs)(n.li,{children:["In compose, prefer Docker secrets or env\u2011files and mount ",(0,r.jsx)(n.code,{children:"ServiceConfigs/BFF/config"})," as read\u2011only."]}),"\n"]}),"\n",(0,r.jsx)(n.p,{children:"Testing and verification"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["Session flow: use your SPA and confirm login/callback works; BFF issues ",(0,r.jsx)(n.code,{children:"bff_session"})," and CSRF cookie."]}),"\n",(0,r.jsxs)(n.li,{children:["Bearer flow: call any route marked ",(0,r.jsx)(n.code,{children:"auth: bearer"})," in ",(0,r.jsx)(n.code,{children:"routes.yaml"})," with ",(0,r.jsx)(n.code,{children:"Authorization: Bearer <token>"})," and expect 200/401 accordingly. See routes reference to mark routes as bearer\u2011protected."]}),"\n"]}),"\n",(0,r.jsx)(n.p,{children:"ARNs (identity propagation)"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["The BFF represents unique identities as ARNs to standardize attribution and auditing, and may emit ",(0,r.jsx)(n.code,{children:"X-Original-User"})," downstream when available."]}),"\n",(0,r.jsxs)(n.li,{children:["Provider selection prefers the IdP entry ",(0,r.jsx)(n.code,{children:"provider"})," field, falling back to ",(0,r.jsx)(n.code,{children:"name"}),". This stabilizes ARNs across audiences of the same issuer, e.g., ",(0,r.jsx)(n.code,{children:"auth:account:empowernow:{sub}"})," for both admin and CRUD audiences."]}),"\n",(0,r.jsxs)(n.li,{children:["Learn more: Authentication \u2014 Unique Identity and ARNs, and Security Model \u2014 Headers contract (",(0,r.jsx)(n.code,{children:"X-Original-User"}),")."]}),"\n"]}),"\n",(0,r.jsx)(n.p,{children:"See also"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Explanation \u2192 Authentication Options and Flow"}),"\n",(0,r.jsx)(n.li,{children:"Explanation \u2192 Security Model"}),"\n",(0,r.jsx)(n.li,{children:"Reference \u2192 routes.yaml Reference"}),"\n",(0,r.jsx)(n.li,{children:"Reference \u2192 Traefik ForwardAuth"}),"\n"]})]})}function p(e={}){const{wrapper:n}={...(0,o.R)(),...e.components};return n?(0,r.jsx)(n,{...e,children:(0,r.jsx)(l,{...e})}):l(e)}},28453:(e,n,i)=>{i.d(n,{R:()=>c,x:()=>t});var s=i(96540);const r={},o=s.createContext(r);function c(e){const n=s.useContext(o);return s.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function t(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(r):e.components||r:c(e.components),s.createElement(o.Provider,{value:n},e.children)}}}]);