"use strict";(self.webpackChunkempowernow_docs=self.webpackChunkempowernow_docs||[]).push([[5974],{28453:(e,n,r)=>{r.d(n,{R:()=>o,x:()=>c});var s=r(96540);const a={},i=s.createContext(a);function o(e){const n=s.useContext(i);return s.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function c(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(a):e.components||a:o(e.components),s.createElement(i.Provider,{value:n},e.children)}},43360:(e,n,r)=>{r.r(n),r.d(n,{assets:()=>t,contentTitle:()=>c,default:()=>u,frontMatter:()=>o,metadata:()=>s,toc:()=>l});const s=JSON.parse('{"id":"services/crud-service/how-to/secrets-canonical-uris","title":"Canonical Secret URIs and tenant guards","description":"Grammar, validation rules, error taxonomy, and tenant mount guards for secret pointers.","source":"@site/docs/services/crud-service/how-to/secrets-canonical-uris.md","sourceDirName":"services/crud-service/how-to","slug":"/services/crud-service/how-to/secrets-canonical-uris","permalink":"/empowernow_docs/docs/services/crud-service/how-to/secrets-canonical-uris","draft":false,"unlisted":false,"editUrl":"https://github.com/facebook/docusaurus/tree/main/packages/create-docusaurus/templates/shared/docs/services/crud-service/how-to/secrets-canonical-uris.md","tags":[],"version":"current","frontMatter":{"title":"Canonical Secret URIs and tenant guards","description":"Grammar, validation rules, error taxonomy, and tenant mount guards for secret pointers."}}');var a=r(74848),i=r(28453);const o={title:"Canonical Secret URIs and tenant guards",description:"Grammar, validation rules, error taxonomy, and tenant mount guards for secret pointers."},c=void 0,t={},l=[{value:"Canonical URI grammar",id:"canonical-uri-grammar",level:3},{value:"Visual: canonicalization and guards",id:"visual-canonicalization-and-guards",level:3},{value:"Error taxonomy",id:"error-taxonomy",level:3},{value:"Tenant guard",id:"tenant-guard",level:3},{value:"Identifiers",id:"identifiers",level:3},{value:"Defaults",id:"defaults",level:3},{value:"Copyable examples",id:"copyable-examples",level:3},{value:"HTTP error mapping",id:"http-error-mapping",level:3}];function d(e){const n={code:"code",h3:"h3",li:"li",mermaid:"mermaid",p:"p",pre:"pre",ul:"ul",...(0,i.R)(),...e.components};return(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)(n.h3,{id:"canonical-uri-grammar",children:"Canonical URI grammar"}),"\n",(0,a.jsxs)(n.ul,{children:["\n",(0,a.jsx)(n.li,{children:"No authority; first path segment is the mount."}),"\n",(0,a.jsx)(n.li,{children:"Lowercase scheme/engine; case-sensitive path."}),"\n",(0,a.jsxs)(n.li,{children:["Forbid ",(0,a.jsx)(n.code,{children:".."}),", ",(0,a.jsx)(n.code,{children:"%2F"}),", duplicate slashes, empty segments; disallow mid-path ",(0,a.jsx)(n.code,{children:"*"}),"."]}),"\n",(0,a.jsxs)(n.li,{children:["Allow only terminal ",(0,a.jsx)(n.code,{children:"/*"})," when policy allow-lists it."]}),"\n",(0,a.jsx)(n.li,{children:"Query keys must be unique and sorted; duplicates rejected."}),"\n"]}),"\n",(0,a.jsx)(n.p,{children:"Examples"}),"\n",(0,a.jsxs)(n.ul,{children:["\n",(0,a.jsxs)(n.li,{children:["Accept: ",(0,a.jsx)(n.code,{children:"openbao+kv2://secret/jira/api#token?version=12"})]}),"\n",(0,a.jsxs)(n.li,{children:["Reject: ",(0,a.jsx)(n.code,{children:"hashicorp+kv2://secret//path"}),", ",(0,a.jsx)(n.code,{children:"openbao+kv2://secret/jira/*/token"})]}),"\n"]}),"\n",(0,a.jsx)(n.h3,{id:"visual-canonicalization-and-guards",children:"Visual: canonicalization and guards"}),"\n",(0,a.jsx)(n.mermaid,{value:"flowchart TD\r\n  A[Input pointer] --\x3e B[Parse scheme/engine]\r\n  B --\x3e C[Split path \u2192 mount + path]\r\n  C --\x3e D[Normalize: lowercase scheme/engine; sort query]\r\n  D --\x3e E{Validate segments}\r\n  E --\x3e|ok| F{Wildcard allowed?}\r\n  E --\x3e|.., %2F, //, empty| X[Error: ILLEGAL_SEGMENT]\r\n  F --\x3e|mid\u2011path *| X2[Error: INVALID_WILDCARD]\r\n  F --\x3e|terminal /* ok| G[Proceed]\r\n  G --\x3e H{Tenant guard}\r\n  H --\x3e|mount \u2209 allowed| X3[Error: TENANT_MOUNT_MISMATCH]\r\n  H --\x3e|mount \u2208 allowed| I[Canonical URI]\r\n  I --\x3e J[Derive resource_ref (HMAC)]"}),"\n",(0,a.jsx)(n.h3,{id:"error-taxonomy",children:"Error taxonomy"}),"\n",(0,a.jsxs)(n.ul,{children:["\n",(0,a.jsxs)(n.li,{children:[(0,a.jsx)(n.code,{children:"INVALID_WILDCARD"}),", ",(0,a.jsx)(n.code,{children:"ILLEGAL_SEGMENT"}),", ",(0,a.jsx)(n.code,{children:"TENANT_MOUNT_MISMATCH"}),", ",(0,a.jsx)(n.code,{children:"UNSUPPORTED_ENGINE"}),", ",(0,a.jsx)(n.code,{children:"AMBIGUOUS_MOUNT"}),", ",(0,a.jsx)(n.code,{children:"AMBIGUOUS_QUERY"}),", ",(0,a.jsx)(n.code,{children:"DOUBLE_MOUNT_SOURCE"}),", ",(0,a.jsx)(n.code,{children:"PROVIDER_TRAILING_SLASH_MISMATCH"}),"."]}),"\n"]}),"\n",(0,a.jsx)(n.h3,{id:"tenant-guard",children:"Tenant guard"}),"\n",(0,a.jsxs)(n.ul,{children:["\n",(0,a.jsxs)(n.li,{children:["Derive ",(0,a.jsx)(n.code,{children:"tenant_id"})," from ",(0,a.jsx)(n.code,{children:"ExecutionContext"})," and validate ",(0,a.jsx)(n.code,{children:"mount"})," membership in an allowed list from config."]}),"\n",(0,a.jsxs)(n.li,{children:["Fail-closed on missing map or outage; metric: ",(0,a.jsx)(n.code,{children:"tenant_mount_violation_total"}),"."]}),"\n"]}),"\n",(0,a.jsx)(n.h3,{id:"identifiers",children:"Identifiers"}),"\n",(0,a.jsxs)(n.ul,{children:["\n",(0,a.jsxs)(n.li,{children:["Policy ARN: ",(0,a.jsx)(n.code,{children:"auth:v1:resource:secret:<namespace>:<short-id>"}),"."]}),"\n",(0,a.jsxs)(n.li,{children:["Non-leaky ",(0,a.jsx)(n.code,{children:"resource_ref = base64url(HMAC-SHA256(tenant_salt, canonical_uri))"}),"."]}),"\n"]}),"\n",(0,a.jsx)(n.h3,{id:"defaults",children:"Defaults"}),"\n",(0,a.jsxs)(n.ul,{children:["\n",(0,a.jsxs)(n.li,{children:[(0,a.jsx)(n.code,{children:"SECRET_URI_ACCEPT_LEGACY=false"})," (dev: true), strict parsing enabled by default."]}),"\n"]}),"\n",(0,a.jsx)(n.h3,{id:"copyable-examples",children:"Copyable examples"}),"\n",(0,a.jsx)(n.p,{children:"Valid"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-text",children:"openbao+kv2://secret/app/api#token?version=12\r\nyaml://secret/env#MY_API_KEY\n"})}),"\n",(0,a.jsx)(n.p,{children:"Invalid \u2192 reason"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-text",children:"hashicorp+kv2://secret//path           # ILLEGAL_SEGMENT (empty segment)\r\nopenbao+kv2://secret/jira/*/token      # INVALID_WILDCARD (mid-path *)\r\nopenbao+kv2://secret/a%2Fb#key         # ILLEGAL_SEGMENT (%2F)\n"})}),"\n",(0,a.jsx)(n.h3,{id:"http-error-mapping",children:"HTTP error mapping"}),"\n",(0,a.jsx)(n.p,{children:"When parsing fails, responses return 400 with a typed code, for example:"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-json",children:'{"error":"Bad Request","code":"TENANT_MOUNT_MISMATCH","message":"mount not allowed for tenant"}\n'})})]})}function u(e={}){const{wrapper:n}={...(0,i.R)(),...e.components};return n?(0,a.jsx)(n,{...e,children:(0,a.jsx)(d,{...e})}):d(e)}}}]);